<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Notebook - Engineering Math Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Indie+Flower&family=Patrick+Hand&family=Caveat:wght@400;700&family=Shadows+Into+Light&family=Permanent+Marker&family=Kalam:wght@300;400;700&family=Architects+Daughter&family=Fira+Code:wght@400;600&display=swap"
        rel="stylesheet">

    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <!-- PDF.js for Lecture Mode 2.0 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- Prism.js for Syntax Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>

    <!-- PWA MANIFEST & SETTINGS -->
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Notebook">
    <link rel="icon" id="appIcon" href="">
    <link rel="apple-touch-icon" id="appleIcon" href="">
    <link rel="manifest" id="appManifest" href="">

    <style>
        :root {
            --paper-bg: #fdfbf7;
            --grid-line: #e3e0d9;
            --ink-color: #2c3e50;
            --pencil-color: #5a5a5a;
            --pen-color: #1a1a1a;
            --marker-color: #000000;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --accent-color: #e74c3c;
            --cs-accent: #3498db;
            --med-accent: #2ecc71;
            --dent-accent: #9b59b6;
            --eng-accent: #d35400;
            --code-bg: #282c34;
            --code-text: #abb2bf;
            --toolbar-bg: #d4a373;
            --voice-active: #e67e22;
            --template-color: #3498db;
            --workspace-bg: #e0e0e0;
            --workspace-dot: #bebebe;
            --highlight-bg: #fff9c4;
            --chalk-bg: #2d3436;
            --chalk-text: #dfe6e9;
            --save-color: #27ae60;
            --highlighter-color: rgba(255, 235, 59, 0.4);
            --math-cluster-color: rgba(52, 152, 219, 0.1);
            --math-border-color: rgba(52, 152, 219, 0.5);
        }

        body.dark-mode {
            --paper-bg: #2c3e50;
            --grid-line: #34495e;
            --ink-color: #ecf0f1;
            --pencil-color: #bdc3c7;
            --pen-color: #ffffff;
            --marker-color: #ffffff;
            --workspace-bg: #1a1a1a;
            --workspace-dot: #333333;
            --highlight-bg: #4a4a4a;
            --sidebar-bg: #1a1a1a;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Patrick Hand', cursive;
            color: var(--ink-color);
            background-color: var(--workspace-bg);
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        /* --- STYLES --- */
        .writing-tool-pencil {
            font-family: 'Caveat', cursive;
            color: var(--pencil-color);
        }

        .writing-tool-pen {
            font-family: 'Patrick Hand', cursive;
            color: var(--pen-color);
        }

        .writing-tool-marker {
            font-family: 'Permanent Marker', cursive;
            color: var(--marker-color);
        }

        .writing-tool-brush {
            font-family: 'Shadows Into Light', cursive;
            color: var(--ink-color);
        }

        .writing-tool-chalk {
            font-family: 'Architects Daughter', cursive;
            color: #4a4a4a;
        }

        .writing-tool-elegant {
            font-family: 'Kalam', cursive;
            color: var(--ink-color);
        }

        /* Tagging System & Stream UI (NEW) */
        .tag-chip {
            background: var(--template-color);
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 2px;
        }

        .tag-remove {
            font-weight: bold;
            opacity: 0.7;
            margin-left: 5px;
        }

        .tag-remove:hover {
            opacity: 1;
        }

        /* Pomodoro Timer Styles - Improved UX */
        .pomodoro-container {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.15), rgba(192, 57, 43, 0.1));
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 12px;
            padding: 16px 12px;
            margin: 0;
            text-align: center;
        }

        .pomodoro-display {
            font-size: 2.4rem;
            font-family: 'Fira Code', monospace;
            color: var(--sidebar-text);
            margin: 10px 0;
            font-weight: bold;
            letter-spacing: 3px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            line-height: 1;
        }

        .pomodoro-mode {
            font-size: 0.85rem;
            color: var(--sidebar-text);
            opacity: 0.9;
            margin-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pomodoro-controls {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .pomodoro-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.25);
            color: var(--sidebar-text);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            flex: 1;
            min-width: 65px;
            font-weight: 500;
            white-space: nowrap;
        }

        .pomodoro-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .pomodoro-btn:active {
            transform: translateY(0);
        }

        .pomodoro-btn.active {
            background: var(--accent-color);
            border-color: var(--accent-color);
            box-shadow: 0 2px 12px rgba(231, 76, 60, 0.4);
        }

        .pomodoro-progress {
            width: 100%;
            height: 5px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .pomodoro-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), #ff6b6b);
            transition: width 0.5s linear;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
        }

        .pomodoro-dnd-container {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pomodoro-dnd-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            color: var(--sidebar-text);
            opacity: 0.9;
            transition: opacity 0.2s;
            padding: 5px;
            border-radius: 6px;
        }

        .pomodoro-dnd-label:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.05);
        }

        .pomodoro-dnd-label input[type="checkbox"] {
            cursor: pointer;
            width: 15px;
            height: 15px;
            margin: 0;
        }

        .pomodoro-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .pomodoro-stat-item {
            text-align: center;
        }

        .pomodoro-stat-value {
            font-weight: bold;
            font-size: 0.95rem;
            display: block;
            margin-top: 2px;
            color: var(--accent-color);
        }

        .dnd-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(44, 62, 80, 0.95), rgba(52, 73, 94, 0.95));
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
            font-size: 2rem;
            backdrop-filter: blur(10px);
        }

        .dnd-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .dnd-message {
            margin-bottom: 20px;
            font-weight: 600;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .dnd-timer {
            font-size: 5rem;
            font-family: 'Fira Code', monospace;
            margin: 20px 0;
            font-weight: bold;
            letter-spacing: 4px;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .dnd-exit-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 30px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .dnd-exit-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);
        }

        .dnd-exit-btn:active {
            transform: translateY(0);
        }

        .dnd-subtitle {
            opacity: 0.8;
            font-size: 1.1rem;
            margin-top: 10px;
            font-weight: 400;
        }

        /* Anatomy Atlas Styles */
        .anatomy-container {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .anatomy-svg {
            height: 90%;
            width: auto;
            transition: transform 0.3s ease;
        }

        .anatomy-region {
            fill: #ecf0f1;
            stroke: #2c3e50;
            stroke-width: 2;
            cursor: pointer;
            transition: all 0.2s;
        }

        .anatomy-region:hover {
            fill: var(--med-accent);
            fill-opacity: 0.3;
        }

        .anatomy-region.active {
            fill: var(--med-accent);
            fill-opacity: 0.6;
        }

        .atlas-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            justify-content: center;
        }

        /* Logic Gates Simulator Styles */
        #logicGatesSimulator {
            background: #f8f9fa;
            border: 2px solid var(--cs-accent);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            min-height: 400px;
            position: relative;
        }

        .logic-toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .logic-gate-btn {
            background: white;
            border: 2px solid var(--cs-accent);
            color: var(--cs-accent);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logic-gate-btn:hover {
            background: var(--cs-accent);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        .logic-gate-btn.active {
            background: var(--cs-accent);
            color: white;
        }

        .logic-canvas-area {
            background: white;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            min-height: 350px;
            position: relative;
            overflow: hidden;
        }

        .logic-gate {
            position: absolute;
            background: white;
            border: 3px solid var(--cs-accent);
            border-radius: 8px;
            padding: 15px 20px;
            cursor: move;
            font-weight: bold;
            color: var(--cs-accent);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            user-select: none;
            min-width: 80px;
            text-align: center;
            transition: box-shadow 0.2s;
        }

        .logic-gate:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .logic-gate.selected {
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.3);
        }

        .logic-input {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #27ae60;
            border: 3px solid #229954;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.9rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            user-select: none;
        }

        .logic-input:hover {
            transform: scale(1.1);
        }

        .logic-input.off {
            background: #e74c3c;
            border-color: #c0392b;
        }

        .logic-output {
            position: absolute;
            width: 50px;
            height: 50px;
            background: #f39c12;
            border: 3px solid #d68910;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.2rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            user-select: none;
        }

        .logic-output.on {
            background: #27ae60;
            border-color: #229954;
            box-shadow: 0 0 20px rgba(39, 174, 96, 0.5);
        }

        .logic-wire {
            position: absolute;
            height: 3px;
            background: var(--cs-accent);
            transform-origin: left center;
            pointer-events: none;
            z-index: 1;
        }

        .logic-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #dee2e6;
        }

        .logic-control-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .logic-control-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .logic-control-btn.danger {
            background: #e74c3c;
        }

        .logic-control-btn.danger:hover {
            background: #c0392b;
        }

        .logic-info {
            background: #e8f4f8;
            border-left: 4px solid var(--cs-accent);
            padding: 12px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #2c3e50;
        }

        /* Enhanced Logic Gates - Wiring */
        .logic-connection-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #3498db;
            border: 2px solid #2980b9;
            border-radius: 50%;
            cursor: crosshair;
            z-index: 20;
            transition: all 0.2s;
        }

        .logic-connection-point:hover {
            background: #2ecc71;
            border-color: #27ae60;
            transform: scale(1.3);
        }

        .logic-connection-point.input {
            left: -6px;
        }

        .logic-connection-point.output {
            right: -6px;
        }

        .logic-wire-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .logic-wire-path {
            fill: none;
            stroke: var(--cs-accent);
            stroke-width: 3;
            transition: stroke 0.3s;
        }

        .logic-wire-path.active {
            stroke: #2ecc71;
            stroke-width: 4;
            filter: drop-shadow(0 0 4px #2ecc71);
        }

        .logic-wire-path.drawing {
            stroke: #e67e22;
            stroke-dasharray: 5, 5;
            animation: dash 0.5s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -10;
            }
        }

        .logic-gate-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: #7f8c8d;
            white-space: nowrap;
        }

        /* Circuit Symbols Tray */
        .circuit-symbols-tray {
            position: fixed;
            left: 80px;
            top: 120px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            padding: 15px;
            max-width: 140px;
            z-index: 1000;
            display: none;
            max-height: 70vh;
            overflow-y: auto;
        }

        .circuit-symbols-tray.active {
            display: block;
        }

        .circuit-symbols-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .circuit-symbols-title {
            font-weight: bold;
            font-size: 0.9rem;
            color: var(--ink-color);
        }

        .circuit-symbols-close {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: #7f8c8d;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .circuit-symbols-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--accent-color);
        }

        .circuit-symbols-subtitle {
            margin-bottom: 10px;
            color: var(--ink-color);
            text-align: center;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
        }

        .circuit-symbol-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: grab;
            transition: all 0.2s;
        }

        .circuit-symbol-item:hover {
            border-color: var(--cs-accent);
            background: rgba(52, 152, 219, 0.1);
            transform: scale(1.05);
        }

        .circuit-symbol-item:active {
            cursor: grabbing;
        }

        .circuit-symbol-icon {
            font-size: 1.8rem;
            margin-bottom: 4px;
        }

        .circuit-symbol-svg {
            width: 40px;
            height: 40px;
            margin-bottom: 4px;
        }

        .circuit-symbol-name {
            font-size: 0.7rem;
            color: #555;
            text-align: center;
            font-weight: 600;
        }

        .circuit-component {
            position: absolute;
            cursor: move;
            user-select: none;
        }

        .circuit-component svg {
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .circuit-component:hover svg {
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        .circuit-component.selected svg {
            filter: drop-shadow(0 0 8px rgba(52, 152, 219, 0.8));
        }

        .circuit-wire {
            stroke: #2c3e50;
            stroke-width: 2;
            fill: none;
        }

        .circuit-wire.selected {
            stroke: var(--accent-color);
            stroke-width: 3;
        }

        .circuit-connection-dot {
            fill: #e74c3c;
            r: 4;
        }

        /* Knowledge Base Styles */
        .knowledge-base-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 10px;
            margin: 0;
        }

        .kb-category {
            margin-bottom: 15px;
        }

        .kb-category-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 8px;
            padding: 5px 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kb-category-title:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .kb-content {
            font-size: 0.75rem;
            line-height: 1.5;
            color: var(--sidebar-text);
            opacity: 0.9;
            padding: 8px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 4px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
        }

        .kb-content.collapsed {
            display: none;
        }

        .kb-content::-webkit-scrollbar {
            width: 4px;
        }

        .kb-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        .kb-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .kb-table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            font-size: 0.7rem;
        }

        .kb-table th {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 6px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 600;
        }

        .kb-table td {
            padding: 4px 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .kb-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .kb-list {
            list-style: none;
            padding-left: 0;
            margin: 5px 0;
        }

        .kb-list li {
            padding: 3px 0;
            padding-left: 12px;
            position: relative;
        }

        .kb-list li:before {
            content: "â—";
            position: absolute;
            left: 0;
            color: var(--accent-color);
            font-size: 0.6rem;
        }

        .kb-code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Fira Code', monospace;
            font-size: 0.7rem;
            display: inline-block;
            margin: 2px 0;
        }

        .kb-section-header {
            font-weight: bold;
            color: var(--accent-color);
            margin-top: 10px;
            margin-bottom: 5px;
            font-size: 0.75rem;
        }

        .kb-arrow {
            transition: transform 0.3s;
            font-size: 0.7rem;
        }

        .kb-arrow.collapsed {
            transform: rotate(-90deg);
        }

        /* ==================== ADVANCED TEMPLATES STYLES ==================== */

        /* Cornell Notes */
        .cornell-container {
            display: grid;
            grid-template-columns: 25% 75%;
            grid-template-rows: auto 1fr auto;
            gap: 0;
            min-height: 600px;
            border: 2px solid var(--accent-color);
            background: var(--paper-bg);
            margin: 20px 0;
        }

        .cornell-header {
            grid-column: 1 / -1;
            padding: 15px;
            background: rgba(231, 76, 60, 0.1);
            border-bottom: 2px solid var(--accent-color);
        }

        .cornell-header input {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--ink-color);
            padding: 5px;
            margin-bottom: 8px;
        }

        .cornell-header input::placeholder {
            opacity: 0.5;
        }

        .cornell-meta {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .cornell-cues {
            padding: 20px 15px;
            background: rgba(52, 152, 219, 0.05);
            border-right: 2px solid var(--accent-color);
            overflow-y: auto;
        }

        .cornell-cues-title {
            font-weight: bold;
            color: var(--cs-accent);
            margin-bottom: 15px;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .cornell-cue-item {
            background: white;
            border-left: 3px solid var(--cs-accent);
            padding: 8px 10px;
            margin-bottom: 10px;
            border-radius: 3px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cornell-cue-item:hover {
            background: rgba(52, 152, 219, 0.1);
            transform: translateX(3px);
        }

        .cornell-notes {
            padding: 20px;
            overflow-y: auto;
        }

        .cornell-summary {
            grid-column: 1 / -1;
            padding: 20px;
            background: rgba(46, 204, 113, 0.05);
            border-top: 2px solid var(--accent-color);
            min-height: 100px;
        }

        .cornell-summary-title {
            font-weight: bold;
            color: var(--save-color);
            margin-bottom: 10px;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .cornell-summary[contenteditable="false"] {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .cornell-study-mode .cornell-notes {
            filter: blur(10px);
            pointer-events: none;
            user-select: none;
        }

        .cornell-toolbar {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
        }

        .cornell-btn {
            background: var(--cs-accent);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .cornell-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        /* Zettelkasten */
        .zettel-container {
            max-width: 700px;
            margin: 20px auto;
            background: var(--paper-bg);
            border: 2px solid var(--template-color);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .zettel-id {
            font-family: 'Fira Code', monospace;
            font-size: 0.75rem;
            color: var(--template-color);
            margin-bottom: 10px;
            opacity: 0.7;
        }

        .zettel-title {
            font-size: 1.5rem;
            font-weight: bold;
            border: none;
            border-bottom: 2px solid var(--template-color);
            width: 100%;
            padding: 10px 0;
            margin-bottom: 20px;
            background: transparent;
            color: var(--ink-color);
        }

        .zettel-content {
            min-height: 200px;
            padding: 15px;
            background: rgba(52, 152, 219, 0.03);
            border-radius: 5px;
            margin-bottom: 20px;
            line-height: 1.8;
        }

        .zettel-wordcount {
            font-size: 0.75rem;
            text-align: right;
            margin-top: 5px;
            opacity: 0.6;
        }

        .zettel-wordcount.warning {
            color: #f39c12;
            font-weight: bold;
        }

        .zettel-wordcount.error {
            color: #e74c3c;
            font-weight: bold;
        }

        .zettel-section {
            background: rgba(255, 255, 255, 0.5);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .zettel-section-title {
            font-weight: bold;
            color: var(--template-color);
            margin-bottom: 10px;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .zettel-tag-input {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .zettel-tag {
            background: var(--template-color);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .zettel-tag-remove {
            cursor: pointer;
            font-weight: bold;
        }

        .zettel-link-item {
            background: white;
            border-left: 3px solid var(--template-color);
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .zettel-permanence {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .zettel-permanence label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* Outline Method */
        .outline-container {
            background: var(--paper-bg);
            padding: 30px;
            max-width: 900px;
            margin: 20px auto;
            border: 2px solid #95a5a6;
            border-radius: 8px;
        }

        .outline-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #95a5a6;
        }

        .outline-title {
            font-size: 1.5rem;
            font-weight: bold;
            border: none;
            background: transparent;
            width: 100%;
            padding: 10px 0;
            color: var(--ink-color);
        }

        .outline-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .outline-item {
            margin-left: 0;
            padding: 8px 12px;
            margin-bottom: 5px;
            border-left: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
        }

        .outline-item:hover {
            background: rgba(149, 165, 166, 0.1);
            border-left-color: #95a5a6;
        }

        .outline-item.level-1 {
            font-size: 1.1rem;
            font-weight: bold;
            margin-left: 0;
        }

        .outline-item.level-2 {
            font-size: 1rem;
            margin-left: 30px;
        }

        .outline-item.level-3 {
            font-size: 0.95rem;
            margin-left: 60px;
        }

        .outline-item.level-4 {
            font-size: 0.9rem;
            margin-left: 90px;
            opacity: 0.9;
        }

        .outline-label {
            display: inline-block;
            min-width: 40px;
            font-weight: bold;
            color: #7f8c8d;
            margin-right: 10px;
        }

        .outline-item.collapsed>.outline-children {
            display: none;
        }

        .outline-toggle {
            cursor: pointer;
            margin-right: 5px;
            color: #95a5a6;
            font-size: 0.8rem;
        }

        /* Mind Map */
        .mindmap-container {
            position: relative;
            background: #f8f9fa;
            border: 2px solid #9b59b6;
            border-radius: 8px;
            min-height: 600px;
            margin: 20px 0;
            overflow: hidden;
        }

        .mindmap-toolbar {
            position: absolute;
            top: 15px;
            left: 15px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
            display: flex;
            gap: 8px;
        }

        .mindmap-canvas {
            width: 100%;
            height: 100%;
            position: relative;
            cursor: grab;
        }

        .mindmap-canvas.grabbing {
            cursor: grabbing;
        }

        .mindmap-node {
            position: absolute;
            background: white;
            border: 3px solid #9b59b6;
            border-radius: 10px;
            padding: 12px 18px;
            min-width: 100px;
            max-width: 200px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: move;
            transition: box-shadow 0.2s;
            z-index: 5;
        }

        .mindmap-node:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
            z-index: 6;
        }

        .mindmap-node.central {
            background: #9b59b6;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            border-color: #8e44ad;
        }

        .mindmap-node.selected {
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.3);
        }

        .mindmap-node input {
            border: none;
            background: transparent;
            width: 100%;
            font-size: inherit;
            color: inherit;
            text-align: center;
        }

        .mindmap-connection {
            position: absolute;
            height: 3px;
            background: #9b59b6;
            transform-origin: left center;
            pointer-events: none;
            z-index: 1;
        }

        .mindmap-connection.cross-link {
            background: #e74c3c;
            border-top: 2px dashed #e74c3c;
            height: 0;
        }

        /* SQ3R */
        .sq3r-container {
            background: var(--paper-bg);
            max-width: 900px;
            margin: 20px auto;
            border: 2px solid #16a085;
            border-radius: 8px;
            overflow: hidden;
        }

        .sq3r-header {
            background: linear-gradient(135deg, #16a085, #1abc9c);
            color: white;
            padding: 20px;
        }

        .sq3r-source {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .sq3r-section {
            padding: 25px;
            border-bottom: 2px solid #e0e0e0;
            position: relative;
        }

        .sq3r-section.locked {
            opacity: 0.5;
            pointer-events: none;
            background: repeating-linear-gradient(45deg,
                    transparent,
                    transparent 10px,
                    rgba(0, 0, 0, 0.03) 10px,
                    rgba(0, 0, 0, 0.03) 20px);
        }

        .sq3r-section-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .sq3r-section-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #16a085;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .sq3r-question-item {
            background: white;
            border-left: 4px solid #16a085;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 3px;
        }

        .sq3r-difficulty {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .sq3r-difficulty label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .sq3r-recite-compare {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
        }

        .sq3r-review-tracker {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(22, 160, 133, 0.1);
            padding: 15px;
            border-radius: 5px;
        }

        .sq3r-stars {
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Feynman Technique */
        .feynman-container {
            background: var(--paper-bg);
            max-width: 900px;
            margin: 20px auto;
            border: 2px solid #e67e22;
            border-radius: 8px;
        }

        .feynman-header {
            background: linear-gradient(135deg, #e67e22, #f39c12);
            color: white;
            padding: 20px;
        }

        .feynman-concept {
            font-size: 1.4rem;
            font-weight: bold;
        }

        .feynman-step {
            padding: 25px;
            border-bottom: 2px solid #e0e0e0;
            position: relative;
        }

        .feynman-step.locked {
            opacity: 0.5;
            pointer-events: none;
        }

        .feynman-step-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .feynman-step-number {
            background: #e67e22;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .feynman-step-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #e67e22;
        }

        .feynman-readability {
            background: rgba(230, 126, 34, 0.1);
            padding: 12px;
            border-radius: 5px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .feynman-readability.good {
            background: rgba(46, 204, 113, 0.1);
            border-left: 4px solid #2ecc71;
        }

        .feynman-readability.bad {
            background: rgba(231, 76, 60, 0.1);
            border-left: 4px solid #e74c3c;
        }

        .feynman-jargon {
            background: #fff3cd;
            padding: 3px 8px;
            border-radius: 3px;
            color: #856404;
            font-weight: bold;
            cursor: help;
        }

        .feynman-gap-item {
            background: rgba(231, 76, 60, 0.1);
            border-left: 4px solid #e74c3c;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 3px;
        }

        .feynman-iteration {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-top: 10px;
        }

        /* Template Picker Modal */
        .template-picker-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .template-picker-overlay.active {
            display: flex;
        }

        .template-picker {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .template-picker-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--ink-color);
        }

        .template-picker-subtitle {
            color: #7f8c8d;
            margin-bottom: 25px;
        }

        .template-section-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 20px 0 15px 0;
            color: var(--ink-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .template-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .template-card:hover {
            border-color: var(--template-color);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .template-card-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .template-card-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--ink-color);
        }

        .template-card-purpose {
            font-size: 0.85rem;
            color: #7f8c8d;
        }

        .template-guide-link {
            text-align: center;
            margin-top: 20px;
            color: var(--template-color);
            cursor: pointer;
            text-decoration: underline;
        }

        /* MY REFERENCES */
        .my-refs-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 10px;
            margin: 0
        }

        .my-refs-empty {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(155, 89, 182, 0.1));
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 20px;
            text-align: center
        }

        .my-refs-empty-icon {
            font-size: 2.5rem;
            margin-bottom: 10px
        }

        .my-refs-create-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold
        }

        .ref-item {
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid var(--accent-color);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s
        }

        .ref-item:hover {
            background: rgba(255, 255, 255, 0.1)
        }

        .ref-item.pinned {
            background: rgba(241, 196, 15, 0.15);
            border-left-color: #f1c40f
        }

        .ref-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        .ref-item-title {
            font-weight: bold;
            font-size: 0.85rem;
            color: var(--sidebar-text);
            flex: 1
        }

        .ref-item-pin {
            cursor: pointer;
            opacity: 0.6
        }

        .ref-item-pin.active {
            opacity: 1;
            color: #f1c40f
        }

        .ref-item-preview {
            font-size: 0.75rem;
            opacity: 0.7
        }

        .ref-tag {
            background: rgba(52, 152, 219, 0.3);
            padding: 2px 6px;
            border-radius: 10px
        }

        .ref-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            z-index: 2000;
            display: none
        }

        .ref-modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center
        }

        .ref-modal {
            background: white;
            border-radius: 12px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto
        }

        .ref-modal-header {
            padding: 20px 25px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between
        }

        .ref-modal-title {
            font-size: 1.5rem;
            font-weight: bold
        }

        .ref-modal-body {
            padding: 25px
        }

        .ref-form-label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px
        }

        .ref-form-input,
        .ref-form-textarea,
        .ref-form-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px
        }

        .ref-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer
        }

        .ref-btn-primary {
            background: var(--accent-color);
            color: white
        }

        .ref-btn-secondary {
            background: #95a5a6;
            color: white
        }

        .my-refs-section-title {
            font-weight: bold;
            font-size: 0.85rem;
            color: var(--accent-color);
            margin: 15px 0 10px 0
        }

        .continuation-break {
            position: relative;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            user-select: none;
            pointer-events: none;
        }

        /* No lines - clean separation */
        .continuation-break::before {
            content: none;
        }

        .continuation-label {
            background: rgba(0, 0, 0, 0.5);
            padding: 4px 12px;
            font-size: 0.75rem;
            color: white;
            font-weight: bold;
            z-index: 1;
            border-radius: 20px;
            opacity: 0.8;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* PAGE STYLE SEPARATION */
        .sequence-editor-block {
            position: relative;
            min-height: 1050px;
            /* A4 Ratio */
            width: 100%;
            background-color: var(--paper-bg);
            /* Each page gets its own grid */
            background-image: linear-gradient(var(--grid-line) 1px, transparent 1px), linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 25px 25px;

            padding: 4rem;
            margin-bottom: 40px;
            /* Gap between pages */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            /* Drop shadow for paper effect */
            border-radius: 2px;
            transition: box-shadow 0.3s ease;
        }

        .sequence-editor-block.active-focus {
            box-shadow: 0 0 0 2px var(--accent-color), 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        /* Main Paper Container is now just a transparent wrapper */
        .paper {
            width: 100%;
            max-width: 850px;
            background-color: var(--paper-bg);
            background-image: none;
            min-height: auto;
            padding: 0;
            box-shadow: none;
            position: relative;
        }

        .paper.infinite {
            max-width: none;
            width: 3000px;
            height: 3000px;
            background: var(--paper-bg);
        }

        /* Paper Textures */
        .paper.grid-texture {
            background-image:
                linear-gradient(rgba(0, 0, 0, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            background-color: var(--paper-bg);
        }

        .paper.lined-texture {
            background-image: repeating-linear-gradient(transparent,
                    transparent 29px,
                    rgba(0, 0, 0, 0.1) 29px,
                    rgba(0, 0, 0, 0.1) 30px);
            background-color: var(--paper-bg);
        }

        .paper.dotted-texture {
            background-image: radial-gradient(circle, rgba(0, 0, 0, 0.15) 1px, transparent 1px);
            background-size: 20px 20px;
            background-color: var(--paper-bg);
        }

        .paper.plain-texture {
            background-image: none;
            background-color: var(--paper-bg);
        }

        /* Dark mode adjustments */
        body.dark-mode .sequence-editor-block {
            background-color: var(--paper-bg);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .tag-mini {
            font-size: 0.65rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 1px 5px;
            border-radius: 4px;
            color: #ccc;
            margin-right: 4px;
        }

        /* CS Code Block */
        .cs-code-container {
            font-family: 'Fira Code', monospace;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
            margin: 15px 0;
            background: var(--code-bg);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .cs-code-header {
            background: #21252b;
            color: #9da5b4;
            padding: 5px 10px;
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #181a1f;
        }

        .cs-code-editor {
            padding: 15px;
            color: var(--code-text);
            font-size: 0.9rem;
            min-height: 60px;
            outline: none;
            white-space: pre-wrap;
        }

        /* Prism overrides */
        .cs-code-editor code,
        .cs-code-editor pre {
            font-family: 'Fira Code', monospace !important;
            text-shadow: none !important;
        }

        .cs-code-output {
            background: #1e2127;
            color: #98c379;
            padding: 10px;
            font-size: 0.8rem;
            border-top: 1px dashed #3e4451;
        }

        .cs-code-output::before {
            content: "âžœ OUTPUT:";
            display: block;
            font-size: 0.7rem;
            opacity: 0.5;
            margin-bottom: 5px;
        }

        .cs-lang-select {
            background: #2c3e50;
            color: white;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-right: 5px;
            padding: 2px;
        }

        .cs-format-btn {
            background: #e67e22;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.7rem;
            padding: 2px 8px;
            cursor: pointer;
        }

        .cs-format-btn:hover {
            background: #d35400;
        }

        /* Trace Table */
        .trace-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
        }

        .trace-table th,
        .trace-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .trace-table th {
            background: rgba(0, 0, 0, 0.05);
        }

        /* Dynamic Trace Table & Widget Controls */
        .trace-table-container,
        .timeline-wrapper,
        .comparison-wrapper {
            position: relative;
        }

        .btn-trace-add {
            position: absolute;
            top: -10px;
            right: 0;
            width: 22px;
            height: 22px;
            background: var(--cs-accent);
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            font-weight: bold;
            font-size: 14px;
            line-height: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 5;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }

        .trace-table-container:hover .btn-trace-add,
        .timeline-wrapper:hover .btn-trace-add,
        .comparison-wrapper:hover .btn-trace-add {
            opacity: 1;
        }

        @media (hover: none) {
            .btn-trace-add {
                opacity: 0.6;
            }
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 0;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.3);
            z-index: 20;
            flex-shrink: 0;
            transition: background-color 0.3s ease, transform 0.3s ease;
            position: absolute;
            left: 0;
            top: 0;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                width: 80%;
                max-width: 300px;
            }

            .sidebar.open {
                transform: translateX(0);
            }
        }

        .sidebar-header {
            padding: 1.5rem 1.5rem 1rem 1.5rem;
            flex-shrink: 0;
        }

        .sidebar-scrollable {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0 1.5rem 1.5rem 1.5rem;
        }

        .sidebar-scrollable::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar-scrollable::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .sidebar-scrollable::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        .sidebar-scrollable::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .app-title {
            font-size: 1.6rem;
            margin-bottom: 1rem;
            text-align: center;
            flex-shrink: 0;
            font-family: 'Fira Code', monospace;
        }

        .search-container {
            margin-bottom: 0.5rem;
            position: relative;
            flex-shrink: 0;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            border-radius: 20px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-family: inherit;
            font-size: 0.95rem;
        }

        .category-filter {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-family: inherit;
        }

        .category-filter option {
            background: var(--sidebar-bg);
            color: white;
        }

        optgroup {
            font-style: normal;
            font-weight: bold;
            color: #ccc;
        }

        .sidebar-section {
            display: flex;
            flex-direction: column;
            margin-bottom: 12px;
            min-height: 0;
            flex-shrink: 0;
        }

        .sidebar-section.pages-section {
            flex-grow: 0;
            max-height: none;
        }

        .section-header {
            padding: 8px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 5px;
            user-select: none;
            flex-shrink: 0;
        }

        .arrow {
            transition: transform 0.3s ease;
            font-size: 0.8rem;
        }

        .section-content {
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .section-content.collapsed {
            display: none !important;
        }

        /* Tag Cloud Styling */
        .tag-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 5px;
        }

        .tag-cloud-item {
            background: rgba(255, 255, 255, 0.1);
            color: var(--sidebar-text);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid transparent;
        }

        .tag-cloud-item:hover {
            background: var(--template-color);
            color: white;
        }

        .tag-cloud-item.active {
            border-color: var(--accent-color);
            background: rgba(255, 255, 255, 0.15);
        }

        /* Install Button (Hidden by default) */
        #installAppBtn {
            display: none;
            background: #27ae60;
            color: white;
            font-weight: bold;
            margin-bottom: 10px;
        }

        #pagesContent {
            overflow-y: auto;
            flex-grow: 1;
            padding-right: 2px;
        }

        #pagesContent::-webkit-scrollbar {
            width: 4px;
        }

        #pagesContent::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        /* New Scroll for Tags Content */
        #tagsContent {
            overflow-y: auto;
            max-height: 200px;
            padding-right: 2px;
        }

        #tagsContent::-webkit-scrollbar {
            width: 4px;
        }

        #tagsContent::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        #toolsContent {
            overflow-y: auto;
            max-height: 45vh;
            padding-right: 2px;
        }

        #toolsContent::-webkit-scrollbar {
            width: 4px;
        }

        #toolsContent::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .chapter-list {
            list-style: none;
            margin-bottom: 0;
            padding-bottom: 10px;
            max-height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .chapter-list::-webkit-scrollbar {
            width: 6px;
        }

        .chapter-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        .chapter-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .chapter-list::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .nav-item {
            padding: 12px;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .nav-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            overflow: hidden;
            flex-grow: 1;
            min-width: 0;
            margin-right: 8px;
        }

        .nav-item.active {
            border-left: 4px solid var(--accent-color);
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item-title {
            font-weight: bold;
            font-size: 1.1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .nav-item-snippet {
            font-size: 0.8rem;
            opacity: 0.7;
            font-family: sans-serif;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cat-badge {
            font-size: 0.7rem;
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            align-self: flex-start;
            margin-top: 2px;
        }

        .btn-delete {
            background: transparent;
            border: none;
            color: var(--sidebar-text);
            font-size: 1.2rem;
            opacity: 0.6;
            cursor: pointer;
            padding: 0 12px;
            height: 40px;
            transition: all 0.2s;
            z-index: 10;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .btn-delete:hover {
            opacity: 1;
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .btn {
            position: relative;
            border: none;
            padding: 10px;
            border-radius: 6px;
            font-family: inherit;
            cursor: pointer;
            transition: 0.3s;
            width: 100%;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-add {
            background: var(--accent-color);
            color: white;
        }

        .btn-save-sidebar {
            background: var(--save-color);
            color: white;
            margin-top: 5px;
        }

        .btn-sketch {
            background: var(--toolbar-bg);
            color: white;
        }

        .btn-sketch.active {
            background: #e67e22;
            border: 2px solid white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.15);
            color: #ecf0f1;
            font-size: 0.9rem;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .btn-danger {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            font-size: 0.8rem;
            margin-top: 10px;
        }

        .btn-danger:hover {
            background: rgba(231, 76, 60, 0.4);
        }

        /* New Stream Button Styles */
        #streamControls {
            margin: 20px 0 80px 0;
            width: 100%;
            max-width: 800px;
            display: flex;
            justify-content: center;
        }

        .btn-stream-add {
            background: transparent;
            border: 2px dashed var(--accent-color);
            color: var(--accent-color);
            padding: 12px 30px;
            border-radius: 30px;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.7;
            font-size: 1rem;
        }

        .btn-stream-add:hover {
            opacity: 1;
            background: var(--accent-color);
            color: white;
            transform: scale(1.05);
        }

        .btn-dark-circle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: 0.3s;
        }

        body.dark-mode .btn-dark-circle {
            background: var(--sidebar-bg);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .btn-dark-circle:hover {
            transform: scale(1.1);
        }

        .btn-exit-focus {
            position: fixed;
            top: 20px;
            right: 80px;
            background: var(--accent-color);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            border: none;
            cursor: pointer;
            z-index: 60;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            font-weight: bold;
        }

        .btn-menu-mobile {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--sidebar-bg);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            z-index: 60;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .btn-menu-mobile {
                display: flex;
            }
        }

        /* Layout */
        .main-container {
            display: flex;
            flex-grow: 1;
            margin-left: 280px;
            transition: margin-left 0.3s;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .main-container {
                margin-left: 0;
            }
        }

        body.focus-mode .main-container {
            margin-left: 0;
        }

        .workspace {
            flex-grow: 1;
            padding: 2rem;
            overflow: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-image: radial-gradient(var(--workspace-dot) 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
            width: 100%;
            transition: width 0.3s;
        }

        .lecture-pane {
            width: 0;
            height: 100%;
            background: #333;
            transition: width 0.3s;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #ccc;
            overflow: hidden;
        }

        body.split-mode .workspace {
            width: 50%;
        }

        body.split-mode .lecture-pane {
            width: 50%;
        }

        @media (max-width: 768px) {
            body.split-mode .workspace {
                display: none;
            }

            body.split-mode .lecture-pane {
                width: 100%;
            }
        }

        .lecture-frame {
            flex-grow: 1;
            border: none;
            background: white;
        }

        .lecture-header {
            background: var(--sidebar-bg);
            color: white;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        @media (max-width: 768px) {
            .workspace {
                padding: 1rem;
                padding-top: 5rem;
            }
        }

        .workspace.grabbing {
            cursor: grabbing;
            cursor: -webkit-grabbing;
        }

        body.focus-mode .sidebar {
            transform: translateX(-100%);
        }

        body.focus-mode .tool-tray-container {
            display: none;
        }

        body.focus-mode .btn-exit-focus {
            display: block;
        }

        body.focus-mode .btn-menu-mobile {
            display: none;
        }

        /* Paper */
        #sketchCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
            pointer-events: none;
        }

        /* FIX: Added touch-action: none to prevent iPad scrolling while drawing */
        body.sketch-mode #sketchCanvas {
            pointer-events: auto;
            cursor: crosshair;
            touch-action: none;
        }

        /* PDF Background Layer */
        #pdfBackground {
            display: none;
            /* No longer used - PDFs now inject directly into content-area */
        }

        .pdf-page-render {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            background: white;
            max-width: 95%;
        }

        /* Toolbar */
        .writing-tools {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px 20px;
            border-radius: 40px;
            display: flex;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 15;
            overflow-x: auto;
            max-width: 90%;
            transition: opacity 0.3s, transform 0.3s;
        }

        .paper.infinite .writing-tools {
            position: fixed;
            top: 20px;
            left: calc(50% + 140px);
        }

        body.focus-mode .paper.infinite .writing-tools {
            left: 50%;
        }

        .writing-tools.collapsed {
            transform: translateX(-50%) scale(0);
            opacity: 0;
            pointer-events: none;
        }

        .show-tools-btn {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            z-index: 14;
            font-size: 1.2rem;
        }

        body.dark-mode .show-tools-btn {
            background: #2c3e50;
            color: white;
        }

        body.tools-hidden .show-tools-btn {
            display: flex;
        }

        .tool-opt {
            cursor: pointer;
            font-size: 1.5rem;
            transition: transform 0.2s;
            padding: 5px;
            border-radius: 50%;
        }

        .tool-opt.active {
            background: #eee;
            transform: scale(1.2);
        }

        .tool-opt.highlighter {
            color: #f1c40f;
            text-shadow: 1px 1px 0 #999;
            filter: hue-rotate(60deg) drop-shadow(0 0 2px rgba(255, 255, 0, 0.5));
        }

        .sketch-only {
            display: none;
        }

        body.sketch-mode .sketch-only {
            display: block;
        }

        .tool-divider {
            width: 1px;
            background: #e0e0e0;
            margin: 0 5px;
            align-self: center;
            height: 30px;
            display: none;
        }

        body.sketch-mode .tool-divider {
            display: block;
        }

        .tool-tray-container {
            position: fixed;
            left: 295px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 40;
            display: flex;
            align-items: center;
            transition: left 0.3s ease, opacity 0.3s;
        }

        @media (max-width: 768px) {
            .tool-tray-container {
                left: 0;
            }
        }

        .tool-tray-container.collapsed {
            left: 280px;
        }

        @media (max-width: 768px) {
            .tool-tray-container.collapsed {
                left: -15px;
            }
        }

        .tool-tray-toggle {
            background: white;
            border: 1px solid #ddd;
            width: 24px;
            height: 60px;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
            font-size: 0.8rem;
            color: #666;
            transition: 0.3s;
        }

        body.dark-mode .tool-tray-toggle {
            background: #34495e;
            color: white;
            border-color: #444;
        }

        /* Updated Tool Tray with Scrollbar */
        .tool-tray {
            background: white;
            padding: 15px 10px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: 4px 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid #eee;
            transition: transform 0.3s ease, opacity 0.3s ease;
            transform-origin: left center;
            max-height: 80vh;
            overflow-y: auto;
        }

        .tool-tray::-webkit-scrollbar {
            width: 4px;
        }

        .tool-tray::-webkit-scrollbar-track {
            background: transparent;
        }

        .tool-tray::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 2px;
        }

        body.dark-mode .tool-tray::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }

        body.dark-mode .tool-tray {
            background: #34495e;
            border-color: #444;
        }

        .tool-tray-container.collapsed .tool-tray {
            transform: scaleX(0);
            opacity: 0;
            pointer-events: none;
            width: 0;
            padding: 0;
            margin: 0;
        }

        .color-picker-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 5;
        }

        /* REFINED TOOL BUTTONS */
        .tool-btn {
            background: transparent;
            border: none;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.95rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
            position: relative;
            color: var(--ink-color);
        }

        .tool-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: translateX(2px);
        }

        body.dark-mode .tool-btn {
            background: transparent;
            color: #ecf0f1;
            border: none;
        }

        body.dark-mode .tool-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tool-btn.active {
            background: var(--toolbar-bg);
            color: white;
            font-weight: bold;
        }

        body.dark-mode .tool-btn.active {
            background: var(--toolbar-bg);
            color: white;
        }

        /* Discipline Specific Styles for Tools */
        #tools-cs .tool-btn {
            color: var(--cs-accent);
        }

        #tools-med .tool-btn {
            color: var(--med-accent);
        }

        #tools-eng .tool-btn {
            color: var(--eng-accent);
        }

        .paper-title {
            font-size: 2.4rem;
            border: none;
            border-bottom: 2px solid var(--accent-color);
            width: 100%;
            background: transparent;
            font-family: inherit;
            margin-bottom: 2rem;
            color: var(--ink-color);
            padding: 0;
        }

        .content-area {
            min-height: 800px;
            outline: none;
            line-height: 1.8;
            font-size: 1.3rem;
            color: var(--ink-color);
            position: relative;
            z-index: 2;
            background: transparent;
        }

        /* UNIFIED PAPER LAYOUT - Remove borders and unify textures */
        .paper,
        #sequentialStream,
        .sequence-editor-block {
            border: none !important;
            box-shadow: none !important;
        }

        /* Ensure the paper container has unified styling */
        .paper {
            background-color: var(--paper-bg);
            padding: 4rem;
            max-width: 850px;
            width: 100%;
            margin: 0 auto;
        }

        /* Apply texture to the entire paper, not individual blocks */
        .paper.grid-texture {
            background-image:
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 25px 25px;
        }

        .paper.lined-texture {
            background-image: repeating-linear-gradient(transparent,
                    transparent 29px,
                    var(--grid-line) 29px,
                    var(--grid-line) 30px);
        }

        .paper.dotted-texture {
            background-image: radial-gradient(circle, var(--grid-line) 1px, transparent 1px);
            background-size: 25px 25px;
        }

        .paper.plain-texture {
            background-image: none;
        }

        /* Remove gaps between sequential blocks */
        .sequence-editor-block {
            margin-bottom: 0 !important;
            padding: 0 !important;
            background: transparent !important;
        }

        .continuation-break {
            display: none !important;
        }

        /* Ensure sequential stream doesn't add extra spacing */
        #sequentialStream {
            padding: 0;
            margin: 0;
            background: transparent;
        }

        .styled-header {
            color: var(--accent-color);
            border-bottom: 1px dashed #ccc;
            margin: 15px 0;
        }

        .sticky-note {
            background: var(--highlight-bg);
            padding: 15px;
            border-left: 5px solid #f1c40f;
            transform: rotate(-1deg);
            margin: 15px 0;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
        }

        .chalk-code {
            background: var(--chalk-bg);
            color: var(--chalk-text);
            padding: 15px;
            border-radius: 6px;
            font-family: 'Architects Daughter';
            margin: 15px 0;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 8px 0;
        }



        .checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid #555;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .checkbox.checked {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        .checkbox::after {
            content: 'âœ“';
            color: white;
            font-weight: bold;
            transform: scale(0);
            transition: transform 0.2s cubic-bezier(0.5, 0, 0, 1.5);
        }

        .checkbox.checked::after {
            transform: scale(1);
        }

        .checklist-text {
            position: relative;
            transition: opacity 0.3s ease;
        }

        .checklist-text.completed {
            opacity: 0.6;
            text-decoration: line-through;
            text-decoration-thickness: 2px;
        }

        /* Timeline Styles */
        .timeline-container {
            border-left: 3px solid var(--med-accent);
            padding-left: 15px;
            margin: 15px 0;
        }

        .timeline-entry {
            margin-bottom: 6px;
            display: flex;
            gap: 8px;
            align-items: baseline;
        }

        .time-label {
            white-space: nowrap;
            font-family: 'Fira Code', monospace;
            color: var(--med-accent);
            cursor: text;
            min-width: 45px;
        }

        .event-desc {
            flex-grow: 1;
            outline: none;
        }

        /* Compare Table Styles */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .comparison-table th {
            border-bottom: 2px solid var(--med-accent);
            text-align: left;
            padding: 8px;
            color: var(--med-accent);
            width: 50%;
        }

        .comparison-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }

        /* Active Recall Stickers */
        .recall-sticker {
            position: absolute;
            background-color: #2c3e50;
            border-radius: 4px;
            cursor: pointer;
            z-index: 50;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recall-sticker::after {
            content: '?';
            color: rgba(255, 255, 255, 0.3);
            font-weight: bold;
            font-size: 1.2rem;
            pointer-events: none;
        }

        .recall-sticker.revealed {
            background-color: rgba(231, 76, 60, 0.1);
            border: 2px dashed #e74c3c;
            box-shadow: none;
        }

        .recall-sticker.revealed::after {
            content: '';
        }

        .recall-sticker:hover {
            transform: scale(1.02);
        }

        .uploaded-img {
            max-width: 100%;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* Resizable Image Container */
        .uploaded-container {
            display: inline-block;
            resize: both;
            overflow: hidden;
            vertical-align: middle;
            margin: 10px;
            max-width: 100%;
            border: 1px solid transparent;
            position: relative;
            z-index: 10;
            /* Ensure handle is clickable */
        }

        .uploaded-container:hover {
            border: 1px dashed var(--accent-color);
            /* Visual cue */
        }

        .uploaded-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            border-radius: 8px;
        }

        .save-status {
            position: absolute;
            top: 2rem;
            right: 4rem;
            font-family: sans-serif;
            font-size: 0.75rem;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            pointer-events: none;
        }

        .word-count {
            font-family: sans-serif;
            font-size: 0.7rem;
            color: var(--accent-color);
            margin-top: 4px;
            opacity: 0.7;
        }

        .status-bar {
            position: absolute;
            top: 2rem;
            right: 4rem;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            pointer-events: none;
        }

        .floating-pane {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
            min-width: 250px;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            transform: translateY(200%);
            transition: 0.5s;
            z-index: 2000;
        }

        .toast.show {
            transform: translateY(0);
        }

        .storage-footer {
            padding: 15px 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            flex-shrink: 0;
            background: var(--sidebar-bg);
        }

        .storage-bar-bg {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .storage-bar-fill {
            height: 100%;
            background: var(--save-color);
            width: 0%;
            transition: width 0.5s ease;
        }

        .text-bubble {
            position: absolute;
            background: #333;
            border-radius: 8px;
            padding: 5px;
            display: none;
            gap: 5px;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform: translate(-50%, -120%);
        }

        .text-bubble.visible {
            display: flex;
        }

        .text-bubble::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px 5px 0;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .bubble-btn {
            background: none;
            border: none;
            color: white;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            font-family: sans-serif;
        }

        .bubble-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Metadata Modal Styles */
        .meta-group {
            margin-bottom: 15px;
        }

        .meta-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #777;
            margin-bottom: 5px;
            display: block;
        }

        .meta-value {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }

        .meta-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        /* Tag styling handled by global classes above */

        /* Engineering Ruler */
        #engRuler {
            position: absolute;
            width: 400px;
            height: 60px;
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid #999;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            top: 300px;
            left: 200px;
            transform-origin: center;
            display: none;
            z-index: 20;
            cursor: grab;
            backdrop-filter: blur(5px);
            border-radius: 4px;
        }

        #engRuler::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 20px;
            background-image: repeating-linear-gradient(90deg, #333 0, #333 1px, transparent 1px, transparent 10px);
            opacity: 0.5;
        }

        #engRuler .rotate-handle {
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            background: var(--eng-accent);
            border-radius: 50%;
            cursor: col-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        /* Math Cluster Highlight */
        .math-cluster-active {
            border: 2px dashed #d35400;
            background-color: rgba(211, 84, 0, 0.05);
            position: absolute;
            pointer-events: auto;
            cursor: pointer;
            z-index: 6;
            border-radius: 4px;
        }

        /* Structured Math Display */
        .structured-math {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            font-size: 1.5rem;
            position: absolute;
            background: white;
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 7;
        }

        /* Anatomy Pin */
        .anatomy-pin {
            position: absolute;
            width: 24px;
            height: 24px;
            background: var(--med-accent);
            color: white;
            border-radius: 50% 50% 0 50%;
            transform: rotate(45deg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 10;
            cursor: pointer;
        }

        .anatomy-pin span {
            transform: rotate(-45deg);
        }

        /* Math Keyboard Styles */
        .math-keyboard-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--sidebar-bg);
            color: white;
            z-index: 2000;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
            display: none;
            /* Toggled */
            flex-direction: column;
            border-top: 2px solid var(--eng-accent);
        }

        .math-input-bar {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .math-buffer {
            flex-grow: 1;
            background: white;
            color: #333;
            border: none;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            font-size: 1.1rem;
        }

        .math-preview {
            background: white;
            color: black;
            padding: 5px 10px;
            border-radius: 4px;
            min-width: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .math-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
        }

        .math-tab-btn {
            flex: 1;
            padding: 10px;
            background: transparent;
            color: #aaa;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-bottom: 2px solid transparent;
        }

        .math-tab-btn.active {
            color: white;
            background: rgba(255, 255, 255, 0.05);
            border-bottom-color: var(--eng-accent);
        }

        .math-keys-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 5px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .math-key {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 1.2rem;
            cursor: pointer;
            font-family: 'Times New Roman', serif;
        }

        .math-key:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* FLASHCARD OVERLAY */
        .flashcard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(44, 62, 80, 0.95);
            z-index: 5000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .flashcard-container {
            perspective: 1000px;
            width: 100%;
            max-width: 600px;
            height: 400px;
            margin-bottom: 20px;
        }

        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            text-align: center;
            font-size: 1.5rem;
            color: #2c3e50;
        }

        .flashcard-front {
            background: white;
            border-radius: 15px;
        }

        .flashcard-back {
            background: #ecf0f1;
            border-radius: 15px;
            transform: rotateY(180deg);
        }

        .flashcard-label {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #95a5a6;
            letter-spacing: 1px;
        }

        .flashcard-controls {
            display: flex;
            gap: 20px;
        }

        .fc-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.3s;
        }

        .fc-btn:hover {
            background: white;
            color: #2c3e50;
        }

        .fc-btn-exit {
            position: absolute;
            top: 30px;
            right: 30px;
            border: none;
            font-size: 1.5rem;
            background: transparent;
            color: white;
            cursor: pointer;
        }

        .no-cards-msg {
            color: white;
            font-size: 1.2rem;
            text-align: center;
        }

        /* Anatomy Atlas Styles */
        .anatomy-container {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .anatomy-svg {
            height: 90%;
            width: auto;
            transition: transform 0.3s ease;
        }

        .anatomy-region {
            fill: #ecf0f1;
            stroke: #2c3e50;
            stroke-width: 2;
            cursor: pointer;
            transition: all 0.2s;
        }

        .anatomy-region:hover {
            fill: var(--med-accent);
            fill-opacity: 0.3;
        }

        .anatomy-region.active {
            fill: var(--med-accent);
            fill-opacity: 0.6;
        }

        .atlas-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            justify-content: center;
        }

        /* CIRCUIT COMPONENTS TRAY */
        .circuit-components-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .circuit-components-overlay.active {
            display: flex;
        }

        .circuit-components-panel {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .circuit-components-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--eng-accent);
        }

        .circuit-components-subtitle {
            color: #7f8c8d;
            margin-bottom: 25px;
        }

        .circuit-components-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .circuit-component-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            cursor: grab;
            transition: all 0.3s;
            text-align: center;
            user-select: none;
        }

        .circuit-component-card:hover {
            border-color: var(--eng-accent);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .circuit-component-card:active {
            cursor: grabbing;
            transform: translateY(-1px);
        }

        .circuit-component-card::after {
            content: "Click or Drag";
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem;
            color: #999;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .circuit-component-card:hover::after {
            opacity: 1;
        }

        .circuit-component-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .circuit-component-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--ink-color);
            font-size: 0.9rem;
        }

        .circuit-close-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            font-weight: bold;
        }

        /* CIRCUIT ELEMENTS ON CANVAS */
        .circuit-element {
            position: absolute;
            width: 80px;
            height: 80px;
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: move;
            user-select: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .circuit-element:hover {
            border-color: var(--eng-accent);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .circuit-element.selected {
            border-color: #e74c3c;
            border-width: 3px;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
        }

        .circuit-element-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .circuit-element-label {
            font-size: 0.7rem;
            font-weight: bold;
            color: #555;
        }

        .circuit-element-delete {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
            display: none;
        }

        .circuit-element:hover .circuit-element-delete {
            display: block;
        }

        /* CONNECTION POINTS */
        .circuit-connection-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #3498db;
            border: 2px solid white;
            border-radius: 50%;
            cursor: crosshair;
            z-index: 11;
        }

        .circuit-connection-point:hover {
            background: #e74c3c;
            transform: scale(1.3);
        }

        .circuit-connection-point.top {
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
        }

        .circuit-connection-point.bottom {
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
        }

        .circuit-connection-point.left {
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .circuit-connection-point.right {
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* WIRE CONNECTIONS */
        .circuit-wire {
            stroke: #2c3e50;
            stroke-width: 3;
            fill: none;
            cursor: pointer;
        }

        .circuit-wire:hover {
            stroke: #e74c3c;
            stroke-width: 4;
        }

        .circuit-wire.selected {
            stroke: #e74c3c;
            stroke-width: 4;
        }

        /* POWERED COMPONENT STATES */
        .circuit-element.powered {
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
        }

        /* Glowing bulb effect */
        .circuit-element.powered[data-type="bulb"] circle {
            animation: bulb-glow 1s ease-in-out infinite;
        }

        @keyframes bulb-glow {

            0%,
            100% {
                filter: drop-shadow(0 0 8px #ffeb3b);
            }

            50% {
                filter: drop-shadow(0 0 15px #ffeb3b);
            }
        }

        /* Glowing LED effect */
        .circuit-element.powered[data-type="led"] polygon {
            animation: led-glow 0.8s ease-in-out infinite;
        }

        @keyframes led-glow {

            0%,
            100% {
                filter: drop-shadow(0 0 6px #ff5252);
            }

            50% {
                filter: drop-shadow(0 0 12px #ff5252);
            }
        }

        /* Active wire (current flowing) */
        .circuit-wire.active {
            stroke: #4caf50 !important;
            stroke-width: 4 !important;
            animation: current-flow 2s linear infinite;
        }

        @keyframes current-flow {
            0% {
                stroke-dasharray: 10 5;
                stroke-dashoffset: 0;
            }

            100% {
                stroke-dasharray: 10 5;
                stroke-dashoffset: 15;
            }
        }

        /* Component value labels */
        .component-value {
            position: absolute;
            bottom: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            font-weight: bold;
            color: #2c3e50;
            white-space: nowrap;
            pointer-events: none;
        }
    </style>
</head>

<body class="cursor-pen">

    <button class="btn-dark-circle" id="darkModeToggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">ðŸŒ™</button>
    <button class="btn-menu-mobile" id="mobileMenuBtn" onclick="toggleMobileSidebar()" title="Toggle Menu">â˜°</button>
    <button class="btn-exit-focus" onclick="toggleFocusMode()">Exit Focus</button>

    <!-- FLASHCARD OVERLAY -->
    <div id="flashcardOverlay" class="flashcard-overlay">
        <button class="fc-btn-exit" onclick="exitFlashcardMode()">âœ•</button>
        <div id="flashcardContainer" class="flashcard-container">
            <div class="flashcard" onclick="flipCard()">
                <div class="flashcard-face flashcard-front">
                    <span class="flashcard-label">Question</span>
                    <div id="fcQuestion">...</div>
                </div>
                <div class="flashcard-face flashcard-back">
                    <span class="flashcard-label">Answer</span>
                    <div id="fcAnswer">...</div>
                </div>
            </div>
        </div>
        <div class="flashcard-controls">
            <button class="fc-btn" onclick="prevCard()">â† Prev</button>
            <span id="fcCounter" style="color:white; align-self:center; font-family:monospace;">1 / 1</span>
            <button class="fc-btn" onclick="nextCard()">Next â†’</button>
        </div>
        <div id="noCardsMsg" class="no-cards-msg" style="display:none;">
            No flashcards found!<br>
            <span style="font-size:0.8rem; opacity:0.7;">Use "Question :: Answer" format<br>or Headers (H1-H3) followed
                by text.</span>
        </div>
    </div>

    <!-- CIRCUIT COMPONENTS OVERLAY -->
    <div id="circuitComponentsOverlay" class="circuit-components-overlay">
        <div class="circuit-components-panel">
            <div class="circuit-components-title">âš¡ Circuit Components Library</div>
            <div class="circuit-components-subtitle">Click to add or drag for precise placement</div>

            <div class="circuit-components-grid">
                <div class="circuit-component-card" draggable="true" data-component="resistor">
                    <svg class="circuit-component-icon" viewBox="0 0 40 40" style="width: 50px; height: 50px;">
                        <line x1="5" y1="20" x2="15" y2="20" stroke="#2c3e50" stroke-width="2" />
                        <rect x="15" y="15" width="10" height="10" fill="none" stroke="#2c3e50" stroke-width="2" />
                        <line x1="25" y1="20" x2="35" y2="20" stroke="#2c3e50" stroke-width="2" />
                    </svg>
                    <div class="circuit-component-name">Resistor</div>
                </div>

                <div class="circuit-component-card" draggable="true" data-component="capacitor">
                    <svg class="circuit-component-icon" viewBox="0 0 40 40" style="width: 50px; height: 50px;">
                        <line x1="5" y1="20" x2="17" y2="20" stroke="#2c3e50" stroke-width="2" />
                        <line x1="17" y1="10" x2="17" y2="30" stroke="#2c3e50" stroke-width="2" />
                        <line x1="23" y1="10" x2="23" y2="30" stroke="#2c3e50" stroke-width="2" />
                        <line x1="23" y1="20" x2="35" y2="20" stroke="#2c3e50" stroke-width="2" />
                    </svg>
                    <div class="circuit-component-name">Capacitor</div>
                </div>

                <div class="circuit-component-card" draggable="true" data-component="inductor">
                    <svg class="circuit-component-icon" viewBox="0 0 40 40" style="width: 50px; height: 50px;">
                        <path d="M 5 20 Q 10 10, 15 20 T 25 20 T 35 20" fill="none" stroke="#2c3e50" stroke-width="2" />
                    </svg>
                    <div class="circuit-component-name">Inductor</div>
                </div>

                <div class="circuit-component-card" draggable="true" data-component="battery">
                    <svg class="circuit-component-icon" viewBox="0 0 40 40" style="width: 50px; height: 50px;">
                        <line x1="5" y1="20" x2="15" y2="20" stroke="#2c3e50" stroke-width="2" />
                        <line x1="15" y1="12" x2="15" y2="28" stroke="#2c3e50" stroke-width="3" />
                        <line x1="25" y1="15" x2="25" y2="25" stroke="#2c3e50" stroke-width="2" />
                        <line x1="25" y1="20" x2="35" y2="20" stroke="#2c3e50" stroke-width="2" />
                    </svg>
                    <div class="circuit-component-name">Battery</div>
                </div>

                <div class="circuit-component-card" draggable="true" data-component="led">
                    <svg class="circuit-component-icon" viewBox="0 0 40 40" style="width: 50px; height: 50px;">
                        <line x1="5" y1="20" x2="15" y2="20" stroke="#2c3e50" stroke-width="2" />
                        <polygon points="15,10 15,30 25,20" fill="#e74c3c" />
                        <line x1="25" y1="10" x2="25" y2="30" stroke="#2c3e50" stroke-width="2" />
                        <line x1="25" y1="20" x2="35" y2="20" stroke="#2c3e50" stroke-width="2" />
                    </svg>
                    <div class="circuit-component-name">LED</div>
                </div>

                <div class="circuit-component-card" draggable="true" data-component="switch">
                    <svg class="circuit-component-icon" viewBox="0 0 40 40" style="width: 50px; height: 50px;">
                        <line x1="5" y1="20" x2="15" y2="20" stroke="#2c3e50" stroke-width="2" />
                        <line x1="15" y1="20" x2="30" y2="10" stroke="#2c3e50" stroke-width="2" />
                        <circle cx="15" cy="20" r="2" fill="#2c3e50" />
                        <circle cx="30" cy="20" r="2" fill="#2c3e50" />
                        <line x1="30" y1="20" x2="35" y2="20" stroke="#2c3e50" stroke-width="2" />
                    </svg>
                    <div class="circuit-component-name">Switch</div>
                </div>

                <div class="circuit-component-card" draggable="true" data-component="ground">
                    <svg class="circuit-component-icon" viewBox="0 0 40 40" style="width: 50px; height: 50px;">
                        <line x1="20" y1="5" x2="20" y2="20" stroke="#2c3e50" stroke-width="2" />
                        <line x1="10" y1="20" x2="30" y2="20" stroke="#2c3e50" stroke-width="2" />
                        <line x1="13" y1="25" x2="27" y2="25" stroke="#2c3e50" stroke-width="2" />
                        <line x1="16" y1="30" x2="24" y2="30" stroke="#2c3e50" stroke-width="2" />
                    </svg>
                    <div class="circuit-component-name">Ground</div>
                </div>

                <div class="circuit-component-card" draggable="true" data-component="bulb">
                    <svg class="circuit-component-icon" viewBox="0 0 40 40" style="width: 50px; height: 50px;">
                        <line x1="5" y1="20" x2="10" y2="20" stroke="#2c3e50" stroke-width="2" />
                        <circle cx="20" cy="20" r="10" fill="none" stroke="#2c3e50" stroke-width="2" />
                        <path d="M 15 25 L 15 30 M 25 25 L 25 30 M 13 30 L 27 30" stroke="#2c3e50" stroke-width="2"
                            fill="none" />
                        <line x1="30" y1="20" x2="35" y2="20" stroke="#2c3e50" stroke-width="2" />
                    </svg>
                    <div class="circuit-component-name">Light Bulb</div>
                </div>

                <div class="circuit-component-card" draggable="true" data-component="voltmeter">
                    <svg class="circuit-component-icon" viewBox="0 0 40 40" style="width: 50px; height: 50px;">
                        <circle cx="20" cy="20" r="12" fill="none" stroke="#2c3e50" stroke-width="2" />
                        <text x="20" y="25" text-anchor="middle" font-size="12" fill="#2c3e50"
                            font-weight="bold">V</text>
                        <line x1="5" y1="20" x2="8" y2="20" stroke="#2c3e50" stroke-width="2" />
                        <line x1="32" y1="20" x2="35" y2="20" stroke="#2c3e50" stroke-width="2" />
                    </svg>
                    <div class="circuit-component-name">Voltmeter</div>
                </div>

                <div class="circuit-component-card" draggable="true" data-component="ammeter">
                    <svg class="circuit-component-icon" viewBox="0 0 40 40" style="width: 50px; height: 50px;">
                        <circle cx="20" cy="20" r="12" fill="none" stroke="#2c3e50" stroke-width="2" />
                        <text x="20" y="25" text-anchor="middle" font-size="12" fill="#2c3e50"
                            font-weight="bold">A</text>
                        <line x1="5" y1="20" x2="8" y2="20" stroke="#2c3e50" stroke-width="2" />
                        <line x1="32" y1="20" x2="35" y2="20" stroke="#2c3e50" stroke-width="2" />
                    </svg>
                    <div class="circuit-component-name">Ammeter</div>
                </div>
            </div>

            <button class="circuit-close-btn" onclick="toggleCircuitComponents()">Close</button>
        </div>
    </div>

    <!-- ENGINEERING RULER -->
    <div id="engRuler">
        <div class="rotate-handle" id="rulerRotate">âŸ³</div>
    </div>

    <!-- MATH KEYBOARD PANEL -->
    <div id="mathKeyboard" class="math-keyboard-panel">
        <div class="math-input-bar">
            <span style="font-size:0.8rem; font-weight:bold;">âˆ‘</span>
            <input type="text" id="mathBuffer" class="math-buffer" placeholder="Type LaTeX..."
                oninput="updateMathPreview()">
            <div id="mathPreview" class="math-preview"></div>
            <button class="btn btn-secondary" onclick="insertMathFromBuffer()"
                style="width:auto; padding:5px 15px; margin:0; background:var(--save-color); color:white;">Insert</button>
            <button class="btn btn-secondary" onclick="toggleMathMode()"
                style="width:auto; padding:5px 10px; margin:0;">â–¼</button>
        </div>
        <div class="math-tabs">
            <button class="math-tab-btn active" onclick="switchMathTab('basic', this)">Basic</button>
            <button class="math-tab-btn" onclick="switchMathTab('trig', this)">Trig</button>
            <button class="math-tab-btn" onclick="switchMathTab('calc', this)">Calculus</button>
            <button class="math-tab-btn" onclick="switchMathTab('geom', this)">Geometry</button>
            <button class="math-tab-btn" onclick="switchMathTab('struct', this)">Structure</button>
        </div>
        <div id="mathKeys" class="math-keys-grid"></div>
    </div>

    <!-- TRACE TABLE MODAL -->
    <div id="traceModal" class="floating-pane" style="display:none; width: 300px; z-index: 1002;">
        <h3 style="margin-bottom: 15px;">New Trace Table</h3>
        <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">Number of Variables:</p>
        <input type="number" id="traceVarCount" class="meta-value" value="3" min="1" max="10"
            style="margin-bottom:15px;">
        <div style="display:flex; gap:10px;">
            <button class="tool-btn" onclick="confirmTraceTable()"
                style="background: var(--save-color); color: white; justify-content: center; flex:1;">Insert</button>
            <button class="tool-btn" onclick="closeTraceModal()"
                style="background: #eee; justify-content: center; flex:1;">Cancel</button>
        </div>
    </div>

    <!-- CONSTANTS MODAL -->
    <div id="constantModal" class="floating-pane" style="display:none; width: 300px; z-index: 1002;">
        <h3 style="margin-bottom: 15px;">Insert Constant</h3>

        <div style="margin-bottom:10px;">
            <label style="font-size:0.8rem; color:#666; display:block; margin-bottom:5px;">Symbol (e.g. g, pi,
                c)</label>
            <input type="text" id="constInput" class="meta-value" placeholder="Type symbol..."
                oninput="lookupConstant()">
        </div>

        <div style="margin-bottom:15px;">
            <label style="font-size:0.8rem; color:#666; display:block; margin-bottom:5px;">Value (Editable)</label>
            <input type="text" id="constValue" class="meta-value" placeholder="Value will appear here...">
        </div>

        <div style="display:flex; gap:10px;">
            <button class="tool-btn" onclick="confirmConstant()"
                style="background: var(--save-color); color: white; justify-content: center; flex:1;">Insert</button>
            <button class="tool-btn" onclick="closeConstantModal()"
                style="background: #eee; justify-content: center; flex:1;">Cancel</button>
        </div>
    </div>

    <!-- ANATOMY ATLAS MODAL -->
    <div id="anatomyModal" class="floating-pane" style="display:none; width: 500px; max-width: 90vw; z-index: 2006;">
        <h3 style="margin-bottom: 10px;">Anatomy Atlas</h3>
        <div class="atlas-controls">
            <button class="tool-btn" onclick="renderAnatomyMap('body')" style="width:auto;">ðŸ‘¤ Body</button>
            <button class="tool-btn" onclick="renderAnatomyMap('tooth')" style="width:auto;">ðŸ¦· Tooth</button>
            <button class="tool-btn" onclick="renderAnatomyMap('brain')" style="width:auto;">ðŸ§  Brain</button>
        </div>
        <div id="anatomyContainer" class="anatomy-container">
            <!-- SVG injected here -->
        </div>
        <p style="font-size: 0.8rem; color: #666; margin-top: 10px; text-align: center;">Click a region to insert a
            study header.</p>
        <button class="tool-btn" onclick="closeAnatomyModal()"
            style="margin-top: 10px; background: #eee;">Close</button>
    </div>

    <!-- PDF MODE SELECTION MODAL -->
    <div id="pdfModeModal" class="floating-pane" style="display:none; width: 320px; z-index: 2005; text-align: center;">
        <h3 style="margin-bottom: 10px;">ðŸ“š Import PDF</h3>
        <p style="font-size:0.9rem; color:#666; margin-bottom:20px;">How would you like to use this file?</p>

        <button class="tool-btn" onclick="resolvePdfMode('annotate')"
            style="background: var(--template-color); color: white; justify-content: center; width:100%; margin-bottom:5px; font-weight:bold;">
            ðŸ– Annotate on Paper
        </button>
        <p style="font-size:0.75rem; color:#888; margin-bottom: 15px;">Render slides as background to draw over them.
        </p>

        <button class="tool-btn" onclick="resolvePdfMode('split')"
            style="background: var(--sidebar-bg); color: white; justify-content: center; width:100%; margin-bottom:5px; font-weight:bold;">
            ðŸ“– Split Screen Reader
        </button>
        <p style="font-size:0.75rem; color:#888; margin-bottom: 15px;">Open PDF on the side while you take notes.</p>

        <button class="tool-btn" onclick="closePdfModeModal()"
            style="background: #eee; justify-content: center; width:100%;">Cancel</button>
    </div>

    <div class="text-bubble" id="textBubble">
        <button class="bubble-btn" onclick="formatText('bold')">B</button>
        <button class="bubble-btn" onclick="formatText('italic')">I</button>
        <button class="bubble-btn" onclick="formatText('formatBlock', 'h2')">H1</button>
        <button class="bubble-btn" onclick="formatText('formatBlock', 'h3')">H2</button>
        <button class="bubble-btn" onclick="formatText('insertUnorderedList')">â€¢ List</button>
        <button class="bubble-btn" onclick="saveToMyReferences()" title="Save to My References"
            style="background: var(--accent-color); color: white;">â­</button>
    </div>

    <aside class="sidebar" id="mainSidebar">
        <div class="sidebar-header">
            <div class="app-title">Academic Notebook</div>

            <select class="category-filter" id="categoryFilter" onchange="filterChapters()">
                <option value="all">ðŸ“ All Notes</option>
                <optgroup label="General">
                    <option value="General">ðŸ“ General</option>
                    <option value="Projects">ðŸš€ Projects</option>
                </optgroup>
                <optgroup label="Computer Science">
                    <option value="Algorithms">ðŸ“ Algorithms</option>
                    <option value="Systems">âš™ï¸ Systems</option>
                </optgroup>
                <optgroup label="Medical">
                    <option value="Anatomy">ðŸ§  Anatomy</option>
                    <option value="Pathology">ðŸ¦  Pathology</option>
                    <option value="Pharmacology">ðŸ’Š Pharmacology</option>
                    <option value="Clinical">ðŸ¥ Clinical</option>
                </optgroup>
                <optgroup label="Dentistry">
                    <option value="Dental Anatomy">ðŸ¦· Dental Anatomy</option>
                    <option value="Procedures">ðŸ› ï¸ Procedures</option>
                    <option value="Dental Cases">ðŸ§¾ Cases</option>
                </optgroup>
                <optgroup label="Engineering">
                    <option value="Electrical">âš¡ Electrical (EE)</option>
                    <option value="Mechanical">âš™ï¸ Mechanical (ME)</option>
                    <option value="Civil">ðŸ— Civil (CE)</option>
                    <option value="Electronics">ðŸ“¡ Electronics (ECE)</option>
                    <option value="Mechatronics">ðŸ¦¾ Mechatronics</option>
                    <option value="Industrial">ðŸ­ Industrial</option>
                </optgroup>
            </select>

            <div class="search-container">
                <input type="text" class="search-input" id="sidebarSearch" placeholder="Search or #tag..."
                    oninput="renderSidebar()">
            </div>
        </div>

        <div class="sidebar-scrollable">

            <div class="sidebar-section pages-section" id="pagesSectionWrapper">
                <div class="section-header"
                    onclick="toggleSection('pagesContent', 'pagesArrow', 'pagesSectionWrapper')">
                    <span>ðŸ“š Notes</span>
                    <span class="arrow" id="pagesArrow">â–¼</span>
                </div>
                <div class="section-content" id="pagesContent">
                    <ul class="chapter-list" id="chapterList"></ul>
                </div>
            </div>

            <!-- NEW: TAGS SECTION -->
            <div class="sidebar-section tags-section" id="tagsSectionWrapper">
                <div class="section-header" onclick="toggleSection('tagsContent', 'tagsArrow', 'tagsSectionWrapper')">
                    <span>ðŸ·ï¸ Tags</span>
                    <span class="arrow" id="tagsArrow">â–¼</span>
                </div>
                <div class="section-content" id="tagsContent">
                    <div class="tag-cloud" id="tagCloud"></div>
                </div>
            </div>

            <!-- POMODORO TIMER SECTION -->
            <div class="sidebar-section" id="pomodoroSectionWrapper">
                <div class="section-header"
                    onclick="toggleSection('pomodoroContent', 'pomodoroArrow', 'pomodoroSectionWrapper')">
                    <span>ðŸ… Study Timer</span>
                    <span class="arrow" id="pomodoroArrow">â–¼</span>
                </div>
                <div class="section-content" id="pomodoroContent">
                    <div class="pomodoro-container">
                        <div class="pomodoro-mode" id="pomodoroMode">Focus Time</div>
                        <div class="pomodoro-display" id="pomodoroDisplay">25:00</div>
                        <div class="pomodoro-progress">
                            <div class="pomodoro-progress-bar" id="pomodoroProgressBar"></div>
                        </div>
                        <div class="pomodoro-controls">
                            <button class="pomodoro-btn" id="pomodoroStartBtn" onclick="startPomodoro()"
                                title="Start focus session">â–¶ï¸ Start</button>
                            <button class="pomodoro-btn" id="pomodoroPauseBtn" onclick="pausePomodoro()"
                                style="display:none;" title="Pause timer">â¸ï¸ Pause</button>
                            <button class="pomodoro-btn" onclick="resetPomodoro()" title="Reset to 25 minutes">ðŸ”„
                                Reset</button>
                        </div>
                        <div class="pomodoro-dnd-container">
                            <label class="pomodoro-dnd-label" title="Block distractions during focus time">
                                <input type="checkbox" id="dndToggle" onchange="updateDndSetting()">
                                <span>ðŸ”‡ Do Not Disturb</span>
                            </label>
                        </div>
                        <div class="pomodoro-stats">
                            <div class="pomodoro-stat-item">
                                <span>Sessions</span>
                                <span class="pomodoro-stat-value" id="pomodoroSessionCount">0</span>
                            </div>
                            <div class="pomodoro-stat-item">
                                <span>Today</span>
                                <span class="pomodoro-stat-value" id="pomodoroTodayCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KNOWLEDGE BASE SECTION -->
            <div class="sidebar-section" id="knowledgeBaseSectionWrapper">
                <div class="section-header"
                    onclick="toggleSection('knowledgeBaseContent', 'knowledgeBaseArrow', 'knowledgeBaseSectionWrapper')">
                    <span>ðŸ“š Knowledge Base</span>
                    <span class="arrow" id="knowledgeBaseArrow">â–¼</span>
                </div>
                <div class="section-content" id="knowledgeBaseContent">
                    <div class="knowledge-base-container" id="knowledgeBaseContainer">
                        <div style="font-size: 0.75rem; opacity: 0.7; text-align: center; padding: 10px;">
                            Select a page to view relevant references
                        </div>
                    </div>
                </div>
            </div>

            <!-- MY REFERENCES SECTION -->
            <div class="sidebar-section" id="myReferencesSectionWrapper">
                <div class="section-header"
                    onclick="toggleSection('myReferencesContent', 'myReferencesArrow', 'myReferencesSectionWrapper')">
                    <span>â­ My References</span>
                    <span class="arrow" id="myReferencesArrow">â–¼</span>
                </div>
                <div class="section-content" id="myReferencesContent">
                    <div class="my-refs-container" id="myReferencesContainer"></div>
                </div>
            </div>

            <div class="sidebar-section tools-section">
                <div class="section-header" onclick="toggleSection('toolsContent', 'toolsArrow')">
                    <span>ðŸ› ï¸ Tools</span>
                    <span class="arrow" id="toolsArrow">â–¼</span>
                </div>
                <div class="section-content" id="toolsContent">
                    <div class="sidebar-actions">
                        <button class="btn" id="installAppBtn" onclick="installPWA()">ðŸ“² Install App</button>
                        <button class="btn btn-add" onclick="createNewChapter()">+ New Page</button>
                        <button class="btn btn-secondary" onclick="toggleFocusMode()">ðŸ‘ï¸ Focus Mode</button>
                        <button class="btn btn-secondary" onclick="startFlashcardMode()">ðŸ—‚ Flashcards</button>
                        <button class="btn btn-secondary" onclick="cyclePaperStyle()" id="paperStyleBtn">ðŸ“„ Paper:
                            Grid</button>
                        <button class="btn btn-secondary" onclick="shareNote()" title="Share this note">ðŸ“¤
                            Share</button>
                        <button class="btn btn-save-sidebar" onclick="window.print()">ðŸ–¨ï¸ Save as PDF</button>
                        <button class="btn btn-secondary" onclick="toggleReadMode()" id="readModeBtn">ðŸ”“ Lock /
                            Read</button>
                        <button class="btn btn-secondary" onclick="openMetadataModal()">â“˜ Page Details</button>

                        <!-- UPDATED PDF TOOLS: CONSOLIDATED -->
                        <button class="btn btn-secondary"
                            style="position: relative; border: 1px solid var(--template-color);">
                            ðŸ“š Load Lecture
                            <input type="file" onchange="loadLecturePdf(this)" accept="application/pdf"
                                style="position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;">
                        </button>

                        <button class="btn btn-secondary" style="position: relative;">
                            ðŸ“„ Import Background
                            <input type="file" onchange="importBackgroundFile(this)" accept="image/*"
                                style="position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;">
                        </button>

                        <button class="btn btn-sketch" id="sketchToggle" onclick="toggleSketchMode()">ðŸŽ¨ Sketch
                            Mode</button>
                        <button class="btn" style="background: #3498db; color: white;" onclick="toggleTemplates()">ðŸ“‹
                            Templates</button>

                        <div style="margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                            <button class="btn btn-secondary" onclick="exportData()" style="font-size: 0.8rem;">â¬‡ Export
                                Backup</button>
                            <button class="btn btn-secondary" style="font-size: 0.8rem; position: relative;">
                                â¬† Import Backup
                                <input type="file" id="importFile" onchange="importData(this)" accept=".json"
                                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                            </button>

                            <button class="btn btn-danger" onclick="wipeAllData()">âš  Wipe All Data</button>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- End of sidebar-scrollable -->

        <div class="storage-footer">
            <div style="display:flex; justify-content:space-between;">
                <span>Storage Used</span>
                <span id="storageText">Checking...</span>
            </div>
            <div class="storage-bar-bg">
                <div class="storage-bar-fill" id="storageBar"></div>
            </div>
        </div>
    </aside>

    <div class="tool-tray-container" id="trayContainer">
        <div class="tool-tray">
            <!-- Global Tools -->
            <button class="tool-btn" id="voiceBtn" onclick="toggleVoiceTranscription()"><span>ðŸŽ¤</span> Dictate</button>
            <button class="tool-btn" id="handBtn" onclick="selectSketchTool('hand')"><span>âœ‹</span> Pan</button>
            <button class="tool-btn" id="eraserBtn" onclick="selectSketchTool('eraser')"><span>ðŸ§¼</span> Eraser</button>

            <div class="tool-btn" style="position: relative;">
                <span>ðŸŒˆ</span> Color
                <input type="color" id="customColorPicker" class="color-picker-input"
                    onchange="setCustomColor(this.value)">
            </div>

            <hr style="opacity: 0.2;">

            <!-- Standard Block Tools -->
            <button class="tool-btn" onclick="insertBlock('header')"><span>ðŸ·ï¸</span> Title</button>
            <button class="tool-btn" onclick="insertBlock('note')"><span>ðŸ“Œ</span> Note</button>
            <button class="tool-btn" onclick="insertBlock('todo')"><span>âœ…</span> To-Do</button>

            <!-- 1. CS TOOLBAR -->
            <div id="tools-cs" style="display:none; flex-direction:column; gap:8px;">
                <hr style="opacity: 0.2;">
                <button class="tool-btn" onclick="insertCSCodeBlock()"><span>&lt;&gt;</span> Code Block</button>
                <!-- Code button removed here as requested -->
                <button class="tool-btn" onclick="insertAlgoStep()"><span>ðŸ”¢</span> Algorithm Step</button>
                <button class="tool-btn" onclick="insertComplexity()"><span>O(n)</span> Complexity</button>
                <button class="tool-btn" onclick="insertTraceTable()"><span>ðŸ“‰</span> Trace Table</button>
            </div>

            <!-- 2. MEDICAL TOOLBAR -->
            <div id="tools-med" style="display:none; flex-direction:column; gap:8px;">
                <hr style="opacity: 0.2;">
                <button class="tool-btn" onclick="openAnatomyModal()"><span>ðŸ§˜</span> Atlas</button>
                <button class="tool-btn" onclick="activateAnatomyPin()"><span>ðŸ“</span> Pin</button>
                <button class="tool-btn" onclick="setHighlightPreset('symptom')"><span>ðŸŸ¡</span> Sx</button>
                <button class="tool-btn" onclick="setHighlightPreset('drug')"><span>ðŸ”´</span> Rx</button>
                <button class="tool-btn" onclick="insertTimeline()"><span>â³</span> Timeline</button>
                <button class="tool-btn" onclick="insertComparison()"><span>âš–ï¸</span> Compare</button>
            </div>

            <!-- 3. ENGINEERING TOOLBAR -->
            <div id="tools-eng" style="display:none; flex-direction:column; gap:8px;">
                <hr style="opacity: 0.2;">
                <button class="tool-btn" onclick="toggleMathMode()" id="mathModeBtn"><span>âˆ‘</span> Math Mode</button>
                <button class="tool-btn" onclick="toggleRuler()"><span>ðŸ“</span> Ruler</button>
                <button class="tool-btn" onclick="insertEquation()"><span>âˆ‘</span> Eq Block</button>
                <button class="tool-btn" onclick="insertAssumptions()"><span>ðŸ¤”</span> Assume</button>
                <button class="tool-btn" onclick="insertConstants()"><span>Ï€</span> Constants</button>
            </div>

            <!-- Circuit Components Tool (only for Circuit Analysis) -->
            <div id="tools-circuit" style="display:none; flex-direction:column; gap:8px;">
                <hr style="opacity: 0.2;">
                <button class="tool-btn" onclick="toggleCircuitComponents()" id="circuitComponentsBtn">
                    <span>âš¡</span> Components
                </button>
            </div>

            <button class="tool-btn" id="stickerBtn" onclick="toggleStickerMode()"><span>ðŸ‘ï¸</span> Sticker</button>
            <button class="tool-btn" onclick="triggerImageUpload()"><span>ðŸ“¸</span> Photo</button>
            <hr style="opacity: 0.2;">

            <button class="tool-btn" style="color: #e74c3c" onclick="clearSketch()"><span>ðŸ—‘ï¸</span> Clear
                Sketch</button>
        </div>
        <button class="tool-tray-toggle" id="trayToggle" onclick="toggleTray()">â—€</button>
    </div>

    <!-- MAIN CONTAINER FOR SPLIT LAYOUT -->
    <div class="main-container" id="mainContainer">
        <main class="workspace" id="workspace">
            <div class="paper" id="paper">
                <!-- PDF BACKGROUND LAYER -->
                <div id="pdfBackground"></div>

                <!-- MATH LAYER CONTAINER -->
                <div id="mathLayer"
                    style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:6;">
                </div>

                <canvas id="sketchCanvas"></canvas>

                <div class="status-bar">
                    <span class="save-status" id="saveStatus">All changes saved</span>
                    <span class="word-count" id="wordCount">0 Words</span>
                </div>

                <div class="show-tools-btn" onclick="toggleTopTools()">âœŽ</div>

                <div class="writing-tools" id="topTools">
                    <div class="tool-opt active" data-tool="pen" onclick="selectWritingTool('pen')">ðŸ–Šï¸</div>
                    <div class="tool-opt" data-tool="pencil" onclick="selectWritingTool('pencil')">âœï¸</div>
                    <div class="tool-opt highlighter" data-tool="highlighter"
                        onclick="selectWritingTool('highlighter')">ðŸ–Œï¸</div>
                    <div class="tool-opt" data-tool="marker" onclick="selectWritingTool('marker')">ðŸ–ï¸</div>
                    <div class="tool-opt" data-tool="elegant" onclick="selectWritingTool('elegant')">âœ’ï¸</div>
                    <div class="tool-opt" data-tool="brush" onclick="selectWritingTool('brush')">ðŸŽ¨</div>
                    <div class="tool-opt" data-tool="chalk" onclick="selectWritingTool('chalk')">ðŸ“</div>
                    <div class="tool-divider" style="margin: 0 10px;"></div>
                    <div class="tool-opt" onclick="toggleTopTools()" style="font-weight:bold;">_</div>
                    <div class="tool-divider sketch-only"></div>
                    <div class="tool-opt sketch-only" onclick="undoSketch()" title="Undo">â†©ï¸</div>
                    <div class="tool-opt sketch-only" onclick="redoSketch()" title="Redo">â†ªï¸</div>
                </div>

                <input type="file" id="imageInput" style="display: none;" accept="image/*"
                    onchange="handleImageUpload(event)">

                <input type="text" class="paper-title" id="pageTitle" placeholder="Untitled Page"
                    oninput="markUnsaved(); saveCurrentToCloud()">

                <!-- NEW: Sequential Stream Container -->
                <div id="sequentialStream">
                    <!-- Content Area injected here by JS -->
                </div>
            </div>

            <!-- NEW CONTROLS AT END OF STREAM (OUTSIDE PAPER) -->
            <div id="streamControls">
                <button class="btn-stream-add" onclick="addSequentialPage()">
                    âž• Add Page to Stream
                </button>
            </div>
        </main>

        <!-- LECTURE PANE (RIGHT SPLIT) -->
        <div class="lecture-pane" id="lecturePane">
            <div class="lecture-header">
                <span>ðŸ“š Lecture Reader</span>
                <button class="bubble-btn" onclick="closeLecturePane()">âœ– Close</button>
            </div>
            <iframe id="lectureFrame" class="lecture-frame"></iframe>
        </div>
    </div>

    <!-- METADATA MODAL -->
    <div id="metadataModal" class="floating-pane" style="display:none; width: 300px;">
        <h3 style="margin-bottom: 15px;">Page Details</h3>
        <div class="meta-group">
            <label class="meta-label">Tags</label>
            <div class="tag-input-container" style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="text" id="metaTagInput" class="meta-value" placeholder="Add tag..."
                    onkeydown="handleMetaTagInput(event)">
                <button class="btn btn-secondary" style="width:auto; padding:5px 10px; margin:0;"
                    onclick="addTagFromInput()">+</button>
            </div>
            <div id="metaTagsList" class="meta-tags"></div>
        </div>
        <div class="meta-group">
            <label class="meta-label">Discipline</label>
            <select id="metaDiscipline" class="meta-value" disabled>
                <option value="cs">Computer Science</option>
                <option value="medical">Medical</option>
                <option value="engineering">Engineering</option>
                <option value="general">General</option>
            </select>
        </div>
        <div class="meta-group">
            <label class="meta-label">Page Type</label>
            <select id="metaType" class="meta-value" onchange="updatePageMeta()">
                <option value="note">General Note</option>
                <option value="concept">Concept</option>
                <option value="algorithm">Algorithm</option>
                <option value="system">System Design</option>
                <option value="project">Project</option>
                <option value="whiteboard">Whiteboard</option>
                <optgroup label="Medical">
                    <option value="anatomy">Anatomy</option>
                    <option value="disease">Disease Profile</option>
                    <option value="drug">Drug Monograph</option>
                    <option value="pathway">Pathway</option>
                    <option value="clinical_case">Clinical Case</option>
                    <option value="lab">Lab Interpretation</option>
                </optgroup>
                <optgroup label="Dentistry">
                    <option value="dental_anatomy">Dental Anatomy</option>
                    <option value="oral_pathology">Oral Pathology</option>
                    <option value="dental_procedure">Procedure</option>
                    <option value="dental_case">Dental Case</option>
                    <option value="prostho_plan">Prostho Plan</option>
                    <option value="endo_case">Endo Case</option>
                    <option value="perio_case">Perio Case</option>
                    <option value="oral_radiology">Oral Radiology</option>
                </optgroup>
                <!-- ENGINEERING -->
                <optgroup label="Engineering">
                    <option value="problem_solution">Problem Solution</option>
                    <option value="circuit_analysis">Circuit Analysis</option>
                    <option value="mechanical_system">Mechanical System</option>
                    <option value="structural_analysis">Structural Analysis</option>
                    <option value="control_system">Control System</option>
                    <option value="process_flow">Process Flow</option>
                    <option value="design_calculation">Design Calc</option>
                    <option value="lab_experiment">Lab Experiment</option>
                </optgroup>
            </select>
        </div>
        <div class="meta-group">
            <label class="meta-label">System / Course</label>
            <input type="text" id="metaSystem" class="meta-value" placeholder="e.g. Cardio, Neuro..."
                onchange="updatePageMeta()">
        </div>
        <!-- DENTISTRY SPECIFIC METADATA -->
        <div id="dentalMetaGroup"
            style="display:none; border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px;">
            <div class="meta-group">
                <label class="meta-label">Tooth # (FDI/Universal)</label>
                <input type="text" id="metaTooth" class="meta-value" placeholder="e.g. 11, 46, #3..."
                    onchange="updatePageMeta()">
            </div>
            <div class="meta-group">
                <label class="meta-label">Quadrant</label>
                <select id="metaQuadrant" class="meta-value" onchange="updatePageMeta()">
                    <option value="">None</option>
                    <option value="UR">UR (1)</option>
                    <option value="UL">UL (2)</option>
                    <option value="LL">LL (3)</option>
                    <option value="LR">LR (4)</option>
                </select>
            </div>
            <div class="meta-group">
                <label class="meta-label">Specialty</label>
                <select id="metaSpecialty" class="meta-value" onchange="updatePageMeta()">
                    <option value="">General</option>
                    <option value="Endo">Endodontics</option>
                    <option value="Perio">Periodontics</option>
                    <option value="Prostho">Prosthodontics</option>
                    <option value="Ortho">Orthodontics</option>
                    <option value="Surgery">Oral Surgery</option>
                    <option value="Pedo">Pedodontics</option>
                </select>
            </div>
        </div>

        <!-- ENGINEERING SPECIFIC METADATA -->
        <div id="engineeringMetaGroup"
            style="display:none; border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px;">
            <div class="meta-group">
                <label class="meta-label">Engineering Branch</label>
                <select id="metaEngBranch" class="meta-value" onchange="updatePageMeta()">
                    <option value="Electrical">Electrical (EE)</option>
                    <option value="Mechanical">Mechanical (ME)</option>
                    <option value="Civil">Civil (CE)</option>
                    <option value="Electronics">Electronics (ECE)</option>
                    <option value="Mechatronics">Mechatronics</option>
                    <option value="Industrial">Industrial</option>
                    <option value="General">General</option>
                </select>
            </div>
        </div>

        <div class="meta-group">
            <label class="meta-label">Difficulty</label>
            <select id="metaDifficulty" class="meta-value" onchange="updatePageMeta()">
                <option value="easy">Easy</option>
                <option value="medium">Medium</option>
                <option value="hard">Hard</option>
                <option value="exam">Exam Critical</option>
            </select>
        </div>
        <div class="meta-group">
            <label class="meta-label">Created At</label>
            <div id="metaCreated" style="font-size:0.8rem; color:#666;"></div>
        </div>
        <button class="tool-btn" onclick="closeMetadataModal()"
            style="margin-top: 10px; background: #eee;">Close</button>
    </div>

    <!-- UPDATED TEMPLATE POPUP -->
    <div id="templatePopup" class="floating-pane">
        <h3 style="margin-bottom: 10px;">Select Template</h3>

        <!-- Main Menu View -->
        <div id="tmpl-main-view">
            <button class="tool-btn" onclick="showCSTemplates()"
                style="justify-content:space-between; background: var(--cs-accent); color: white; border: none;">
                <span>ðŸ’» Computer Science</span>
                <span>â–¶</span>
            </button>
            <button class="tool-btn" onclick="showMedTemplates()"
                style="justify-content:space-between; background: var(--med-accent); color: white; border: none;">
                <span>âš•ï¸ Medical</span>
                <span>â–¶</span>
            </button>
            <button class="tool-btn" onclick="showDentistryTemplates()"
                style="justify-content:space-between; background: var(--dent-accent); color: white; border: none;">
                <span>ðŸ¦· Dentistry</span>
                <span>â–¶</span>
            </button>
            <button class="tool-btn" onclick="showEngineeringTemplates()"
                style="justify-content:space-between; background: var(--eng-accent); color: white; border: none;">
                <span>âš™ï¸ Engineering</span>
                <span>â–¶</span>
            </button>
            <button class="tool-btn" onclick="showAdvancedTemplates()"
                style="justify-content:space-between; background: var(--accent-color); color: white; border: none; font-weight: bold;">
                <span>âš¡ Advanced Templates</span>
                <span>â–¶</span>
            </button>
            <hr style="width:100%; opacity:0.1; margin: 8px 0;">
            <button class="tool-btn" onclick="applyTemplate('default')">ðŸ“„ Default Page</button>
            <button class="tool-btn" onclick="applyTemplate('whiteboard')">â™¾ï¸ Infinite Whiteboard</button>
            <button class="tool-btn" onclick="applyTemplate('meeting')">ðŸ“… Meeting Notes</button>
            <button class="tool-btn" onclick="applyTemplate('journal')">ðŸ“– Daily Journal</button>
            <button class="tool-btn" onclick="applyTemplate('eisenhower')">âš–ï¸ Eisenhower Matrix</button>
        </div>

        <!-- Advanced Templates View -->
        <div id="tmpl-advanced-view" style="display:none;">
            <button class="tool-btn" onclick="showMainTemplates()"
                style="background:#eee; margin-bottom:5px; justify-content: center;">â—€ Back to Main</button>
            <div
                style="background: rgba(231,76,60,0.1); padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 0.85rem;">
                <strong>âš ï¸ Advanced Templates</strong> enforce structure for deeper learning. Great for exam prep and
                mastery!
            </div>
            <button class="tool-btn" onclick="applyTemplate('cornell')"
                style="border-left: 4px solid var(--cs-accent);">
                <div style="text-align: left;">
                    <div style="font-weight: bold;">ðŸ“ Cornell Notes</div>
                    <div style="font-size: 0.75rem; opacity: 0.7;">Lectures & Active Recall</div>
                </div>
            </button>
            <button class="tool-btn" onclick="applyTemplate('zettelkasten')"
                style="border-left: 4px solid var(--template-color);">
                <div style="text-align: left;">
                    <div style="font-weight: bold;">ðŸ”— Zettelkasten</div>
                    <div style="font-size: 0.75rem; opacity: 0.7;">Atomic Notes & Linking</div>
                </div>
            </button>
            <button class="tool-btn" onclick="applyTemplate('outline')" style="border-left: 4px solid #95a5a6;">
                <div style="text-align: left;">
                    <div style="font-weight: bold;">ðŸ“‹ Outline Method</div>
                    <div style="font-size: 0.75rem; opacity: 0.7;">Hierarchical Topics</div>
                </div>
            </button>
            <button class="tool-btn" onclick="applyTemplate('mindmap')" style="border-left: 4px solid #9b59b6;">
                <div style="text-align: left;">
                    <div style="font-weight: bold;">ðŸ§  Mind Mapping</div>
                    <div style="font-size: 0.75rem; opacity: 0.7;">Visual Connections</div>
                </div>
            </button>
            <button class="tool-btn" onclick="applyTemplate('sq3r')" style="border-left: 4px solid #16a085;">
                <div style="text-align: left;">
                    <div style="font-weight: bold;">ðŸ“– SQ3R Reading</div>
                    <div style="font-size: 0.75rem; opacity: 0.7;">Active Reading Method</div>
                </div>
            </button>
            <button class="tool-btn" onclick="applyTemplate('feynman')" style="border-left: 4px solid #e67e22;">
                <div style="text-align: left;">
                    <div style="font-weight: bold;">ðŸŽ“ Feynman Technique</div>
                    <div style="font-size: 0.75rem; opacity: 0.7;">Deep Understanding</div>
                </div>
            </button>
        </div>

        <!-- CS Sub-Menu View -->
        <div id="tmpl-cs-view" style="display:none;">
            <button class="tool-btn" onclick="showMainTemplates()"
                style="background:#eee; margin-bottom:5px; justify-content: center;">â—€ Back to Main</button>
            <button class="tool-btn" onclick="applyTemplate('algo')">ðŸ“ Algorithm Sheet</button>
            <button class="tool-btn" onclick="applyTemplate('logicGates')">ðŸ”Œ Logic Gates Simulator</button>
            <button class="tool-btn" onclick="applyTemplate('sysDesign')">âš™ï¸ System Design</button>
            <button class="tool-btn" onclick="applyTemplate('codeStudy')">ðŸ’» Code Study</button>
            <button class="tool-btn" onclick="applyTemplate('project')">ðŸš€ Project Log</button>
        </div>

        <!-- Medical Sub-Menu View -->
        <div id="tmpl-med-view" style="display:none;">
            <button class="tool-btn" onclick="showMainTemplates()"
                style="background:#eee; margin-bottom:5px; justify-content: center;">â—€ Back to Main</button>
            <button class="tool-btn" onclick="applyTemplate('anatomy')">ðŸ§  Anatomy Sheet</button>
            <button class="tool-btn" onclick="applyTemplate('disease')">ðŸ¥ Disease Profile</button>
            <button class="tool-btn" onclick="applyTemplate('drug')">ðŸ’Š Drug Monograph</button>
            <button class="tool-btn" onclick="applyTemplate('physio')">ðŸ¦µ Physiotherapy Case</button>
            <button class="tool-btn" onclick="applyTemplate('pathway')">ðŸ§¬ Pathway Breakdown</button>
            <button class="tool-btn" onclick="applyTemplate('lab')">ðŸ§ª Lab Interpretation</button>
        </div>

        <!-- Dentistry Sub-Menu View -->
        <div id="tmpl-dentistry-view" style="display:none;">
            <button class="tool-btn" onclick="showMainTemplates()"
                style="background:#eee; margin-bottom:5px; justify-content: center;">â—€ Back to Main</button>
            <button class="tool-btn" onclick="applyTemplate('dental_anatomy')">ðŸ¦· Dental Anatomy</button>
            <button class="tool-btn" onclick="applyTemplate('oral_pathology')">ðŸ§¬ Oral Pathology</button>
            <button class="tool-btn" onclick="applyTemplate('dental_procedure')">ðŸ› ï¸ Procedure</button>
            <button class="tool-btn" onclick="applyTemplate('dental_case')">ðŸ§¾ Dental Case</button>
            <button class="tool-btn" onclick="applyTemplate('prostho_plan')">ðŸ¦· Prostho Plan</button>
            <button class="tool-btn" onclick="applyTemplate('endo_case')">ðŸ¦  Endo Case</button>
            <button class="tool-btn" onclick="applyTemplate('perio_case')">ðŸª¥ Perio Case</button>
            <button class="tool-btn" onclick="applyTemplate('oral_radiology')">ðŸ©» Oral Radiology</button>
        </div>

        <!-- Engineering Sub-Menu View -->
        <div id="tmpl-eng-view" style="display:none;">
            <button class="tool-btn" onclick="showMainTemplates()"
                style="background:#eee; margin-bottom:5px; justify-content: center;">â—€ Back to Main</button>
            <button class="tool-btn" onclick="applyTemplate('prob_sol')">ðŸ“ Problem Solution</button>
            <button class="tool-btn" onclick="applyTemplate('circuit')">âš¡ Circuit Analysis</button>
            <button class="tool-btn" onclick="applyTemplate('mech_sys')">âš™ï¸ Mechanical System</button>
            <button class="tool-btn" onclick="applyTemplate('struct')">ðŸ— Structural Analysis</button>
            <button class="tool-btn" onclick="applyTemplate('control')">ðŸŽ› Control System</button>
            <button class="tool-btn" onclick="applyTemplate('process')">ðŸ­ Process Flow</button>
            <button class="tool-btn" onclick="applyTemplate('lab_exp')">ðŸ§ª Lab Experiment</button>
        </div>

        <button class="tool-btn" onclick="toggleTemplates()" style="margin-top: 10px; background: #eee;">Close</button>
    </div>

    <div id="toast" class="toast">Action Successful!</div>

    <script>
        // --- CONSTANTS ---
        const MATH_KEYS = {
            basic: ['+', '-', '=', 'â‰ˆ', 'â‰ ', 'Â±', 'Ã—', 'Ã·', '(', ')', '[', ']', '{', '}'],
            trig: ['\\sin', '\\cos', '\\tan', '\\cot', '\\sec', '\\csc', '\\arcsin', '\\arccos', '\\arctan'],
            calc: ['\\int', '\\iint', '\\oint', '\\partial', '\\nabla', '\\sum', '\\prod', '\\lim', '\\to', 'âˆž', 'dx', 'dt'],
            geom: ['\\perp', '\\parallel', 'âˆ ', 'â–³', 'Ï€', 'Î¸', 'Î±', 'Î²', 'Ï†', 'Î»', 'Î”'],
            struct: ['\\frac{}{}', '^{}', '_{}', '\\sqrt{}', '\\vec{}', '\\bar{}', '\\hat{}']
        };

        const DISCIPLINE_REGISTRY = {
            GENERAL: { id: 'general', name: 'General' },
            CS: { id: 'cs', name: 'Computer Science' },
            MEDICAL: { id: 'medical', name: 'Medical' },
            ENGINEERING: { id: 'engineering', name: 'Engineering' }
        };

        const PAGE_TYPES = {
            NOTE: 'note', CONCEPT: 'concept', ALGORITHM: 'algorithm', SYSTEM: 'system', PROJECT: 'project', WHITEBOARD: 'whiteboard',
            ANATOMY: 'anatomy', DISEASE: 'disease', DRUG: 'drug', PATHWAY: 'pathway', CLINICAL_CASE: 'clinical_case', LAB: 'lab',
            DENTAL_ANATOMY: 'dental_anatomy', ORAL_PATHOLOGY: 'oral_pathology', DENTAL_PROCEDURE: 'dental_procedure', DENTAL_CASE: 'dental_case',
            PROSTHO_PLAN: 'prosthodontic_plan', ENDO_CASE: 'endodontic_case', PERIO_CASE: 'periodontal_case', ORAL_RADIOLOGY: 'oral_radiology',
            PROBLEM_SOLUTION: 'problem_solution', CIRCUIT_ANALYSIS: 'circuit_analysis', MECHANICAL_SYSTEM: 'mechanical_system',
            STRUCTURAL_ANALYSIS: 'structural_analysis', CONTROL_SYSTEM: 'control_system', PROCESS_FLOW: 'process_flow',
            DESIGN_CALCULATION: 'design_calculation', LAB_EXPERIMENT: 'lab_experiment', LOGIC_GATES: 'logic_gates',
            // Advanced Templates
            CORNELL: 'cornell', ZETTELKASTEN: 'zettelkasten', OUTLINE: 'outline',
            MINDMAP: 'mindmap', SQ3R: 'sq3r', FEYNMAN: 'feynman'
        };

        // --- SVG DATA FOR ATLAS ---
        const BODY_SVG = `
            <svg viewBox="0 0 300 600" class="anatomy-svg">
                <path id="Head" class="anatomy-region" d="M150,20 C180,20 190,50 190,70 C190,100 170,110 150,110 C130,110 110,100 110,70 C110,50 120,20 150,20 Z" onclick="handleRegionClick('Head')"/>
                <path id="Neck" class="anatomy-region" d="M135,110 L165,110 L170,140 L130,140 Z" onclick="handleRegionClick('Neck')"/>
                <path id="Chest" class="anatomy-region" d="M110,140 L190,140 L200,220 L100,220 Z" onclick="handleRegionClick('Chest')"/>
                <path id="Abdomen" class="anatomy-region" d="M100,220 L200,220 L190,300 L110,300 Z" onclick="handleRegionClick('Abdomen')"/>
                <path id="LeftArm" class="anatomy-region" d="M200,145 L240,180 L230,280 L210,280 L220,180 L195,160 Z" onclick="handleRegionClick('Left Arm')"/>
                <path id="RightArm" class="anatomy-region" d="M100,145 L60,180 L70,280 L90,280 L80,180 L105,160 Z" onclick="handleRegionClick('Right Arm')"/>
                <path id="Pelvis" class="anatomy-region" d="M110,300 L190,300 L180,340 L120,340 Z" onclick="handleRegionClick('Pelvis')"/>
                <path id="LeftLeg" class="anatomy-region" d="M180,340 L210,550 L180,550 L160,340 Z" onclick="handleRegionClick('Left Leg')"/>
                <path id="RightLeg" class="anatomy-region" d="M120,340 L90,550 L120,550 L140,340 Z" onclick="handleRegionClick('Right Leg')"/>
            </svg>
        `;

        const TOOTH_SVG = `
            <svg viewBox="0 0 300 400" class="anatomy-svg">
                <path id="Enamel" class="anatomy-region" d="M70,120 Q150,20 230,120 L210,160 Q150,140 90,160 Z" onclick="handleRegionClick('Enamel')"/>
                <path id="Dentin" class="anatomy-region" d="M90,160 Q150,140 210,160 L200,200 L100,200 Z" onclick="handleRegionClick('Dentin')"/>
                <path id="Pulp" class="anatomy-region" d="M110,200 L190,200 L180,350 L120,350 Z" onclick="handleRegionClick('Pulp Cavity')"/>
                <path id="Root" class="anatomy-region" d="M70,120 L50,350 L120,350 L110,200 L100,200 Z M230,120 L250,350 L180,350 L190,200 L200,200 Z" onclick="handleRegionClick('Root')"/>
                <path id="Gingiva" class="anatomy-region" style="fill:#e57373; stroke:#c0392b;" d="M20,250 Q150,200 280,250 L280,380 L20,380 Z" onclick="handleRegionClick('Gingiva')"/>
            </svg>
        `;

        const BRAIN_SVG = `
            <svg viewBox="0 0 400 300" class="anatomy-svg">
                <path id="Frontal" class="anatomy-region" d="M50,150 Q50,50 150,50 L150,150 Z" onclick="handleRegionClick('Frontal Lobe')"/>
                <path id="Parietal" class="anatomy-region" d="M150,50 Q250,50 250,100 L150,150 Z" onclick="handleRegionClick('Parietal Lobe')"/>
                <path id="Occipital" class="anatomy-region" d="M250,100 Q300,150 250,200 L150,150 Z" onclick="handleRegionClick('Occipital Lobe')"/>
                <path id="Temporal" class="anatomy-region" d="M150,150 L250,200 Q150,250 100,200 Z" onclick="handleRegionClick('Temporal Lobe')"/>
                <path id="Cerebellum" class="anatomy-region" d="M200,220 Q280,220 260,280 Q180,280 200,220 Z" onclick="handleRegionClick('Cerebellum')"/>
                <path id="Brainstem" class="anatomy-region" d="M150,200 L150,280 L180,280 L180,220 Z" onclick="handleRegionClick('Brainstem')"/>
            </svg>
        `;

        // --- INDEXEDDB STORAGE ENGINE (DB v2) ---
        const DB_NAME = 'NotebookDB_vSeq';
        const STORE_NAME = 'chapters';
        let db;

        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 4); // Bumped version for myReferences
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('myReferences')) {
                        const refStore = db.createObjectStore('myReferences', { keyPath: 'id' });
                        refStore.createIndex('discipline', 'discipline', { unique: false });
                        refStore.createIndex('pinned', 'pinned', { unique: false });
                        refStore.createIndex('tags', 'tags', { unique: false, multiEntry: true });
                    }
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onerror = (e) => reject("DB Error");
            });
        }

        function saveChapterToDB(chapter) {
            if (!chapter.metadata) {
                chapter.metadata = { discipline: 'general', type: PAGE_TYPES.NOTE, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() };
            }
            chapter.updatedAt = new Date().toISOString();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.put(chapter);
                tx.oncomplete = () => { updateStorageQuota(); resolve(); };
                tx.onerror = () => reject();
            });
        }

        function loadAllChapters() {
            return new Promise((resolve) => {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result || []);
            });
        }

        function deleteChapterFromDB(id) {
            return new Promise((resolve) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.delete(id);
                tx.oncomplete = () => resolve();
            });
        }

        function clearDB() {
            return new Promise((resolve) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.clear();
                tx.oncomplete = () => resolve();
            });
        }

        async function updateStorageQuota() {
            if (navigator.storage && navigator.storage.estimate) {
                const estimate = await navigator.storage.estimate();
                const usage = estimate.usage || 0;
                const percent = Math.min(100, (usage / (estimate.quota || 1024 * 1024 * 1000)) * 100).toFixed(1);
                const mb = (usage / 1024 / 1024).toFixed(2);
                document.getElementById('storageBar').style.width = percent + '%';
                document.getElementById('storageText').innerText = `${mb} MB (${percent}%)`;
                if (percent > 90) document.getElementById('storageBar').style.background = '#e74c3c';
            }
        }

        // --- APP STATE ---
        let chapters = [];
        let currentId = null;
        let isSketchMode = false;
        let activeSketchTool = 'brush';
        let customStrokeStyle = null;
        let isReadMode = false;
        let isListening = false;
        let recognition = null;
        let sketchData = null;
        let undoStack = [];
        let redoStack = [];
        let isTrayCollapsed = false;
        let isRulerActive = false;
        let rulerX = 200, rulerY = 300, rulerAngle = 0;
        let isDraggingRuler = false, isRotatingRuler = false;
        let rulerDragStartX, rulerDragStartY, rulerStartAngle;
        let isMathMode = false; // Toggles keyboard visibility
        let savedRange = null; // Stores cursor position
        let editingMathElement = null; // Stores reference to math element being edited

        const canvas = document.getElementById('sketchCanvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        const markdownTriggers = { '#': 'h1', '##': 'h2', '###': 'h3', '-': 'unordered-list', '*': 'unordered-list', '1.': 'ordered-list', '>': 'blockquote', '[]': 'checkbox', '---': 'hr' };

        // --- GLOBAL SELECTION HELPER FUNCTIONS ---
        function saveSelection() {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                const range = sel.getRangeAt(0);
                // We need to support multiple editors now in the stream
                const stream = document.getElementById('sequentialStream');
                if (stream.contains(range.commonAncestorContainer)) {
                    savedRange = range;
                }
            }
        }

        function restoreSelection() {
            if (savedRange) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(savedRange);
            }
        }

        function handleMarkdownInput(e) {
            if (e.data === ' ') {
                const selection = window.getSelection();
                if (!selection.rangeCount) return;
                const node = selection.anchorNode;
                if (node.nodeType !== 3) return;
                const text = node.textContent;
                const parts = text.split(/[\s\u00A0]+/);
                const trigger = parts[0];
                if (markdownTriggers[trigger]) {
                    const action = markdownTriggers[trigger];
                    const cleanText = text.substring(trigger.length).trim();
                    node.textContent = cleanText;
                    if (action === 'h1') document.execCommand('formatBlock', false, 'H1');
                    else if (action === 'h2') document.execCommand('formatBlock', false, 'H2');
                    else if (action === 'h3') document.execCommand('formatBlock', false, 'H3');
                    else if (action === 'unordered-list') document.execCommand('insertUnorderedList');
                    else if (action === 'ordered-list') document.execCommand('insertOrderedList');
                    else if (action === 'blockquote') document.execCommand('formatBlock', false, 'BLOCKQUOTE');
                    else if (action === 'hr') document.execCommand('insertHorizontalRule');
                    else if (action === 'checkbox') insertBlock('todo');

                    // Mark unsaved for the specific editor block
                    const block = node.parentElement.closest('.content-area');
                    if (block && block.oninput) block.oninput();
                }
            }
        }

        async function initApp() {
            try {
                await initDB();
                chapters = await loadAllChapters();
                chapters.sort((a, b) => new Date(b.lastEdited) - new Date(a.lastEdited));

                if (chapters.length === 0) {
                    createNewChapter();
                } else {
                    renderSidebar();
                    loadChapter(chapters[0].id);
                }

                setupDragAndDrop();
                updateStorageQuota();

                // Initialize My References
                await initMyReferences();

                // Set default paper texture (Grid)
                const paper = document.getElementById('paper');
                if (paper && !paper.className.includes('-texture')) {
                    paper.classList.add('grid-texture');
                }

                document.addEventListener('selectionchange', () => {
                    saveSelection();
                    handleSelectionChange();
                });

                // Event delegation for checkbox toggles
                document.getElementById('sequentialStream').addEventListener('click', function (e) {
                    if (e.target.classList.contains('checkbox')) {
                        e.preventDefault();
                        e.target.classList.toggle('checked');
                        const wrapper = e.target.parentElement;
                        const textDiv = wrapper.nextElementSibling;
                        if (textDiv && textDiv.classList.contains('checklist-text')) {
                            textDiv.classList.toggle('completed');
                        }
                        // Trigger save on the specific editor block
                        const block = e.target.closest('.content-area');
                        if (block && block.oninput) block.oninput();
                    }
                });

                // Markdown support on stream container
                document.getElementById('sequentialStream').addEventListener('input', handleMarkdownInput);

                setupRulerEvents();
                switchMathTab('basic');

            } catch (err) {
                console.error(err);
            }
        }

        // --- TAGGING LOGIC ---

        // This function builds the tag list in the sidebar based on ALL chapters
        function renderTagsSidebar() {
            const container = document.getElementById('tagCloud');
            if (!container) return;

            const allTags = new Set();
            chapters.forEach(ch => {
                if (ch.tags && Array.isArray(ch.tags)) {
                    ch.tags.forEach(t => allTags.add(t));
                }
            });

            const sortedTags = Array.from(allTags).sort();
            container.innerHTML = '';

            if (sortedTags.length === 0) {
                container.innerHTML = '<div style="font-size:0.8rem; opacity:0.5; padding:5px;">No tags yet...</div>';
                return;
            }

            sortedTags.forEach(tag => {
                const div = document.createElement('div');
                div.className = 'tag-cloud-item';
                div.innerText = '#' + tag;
                div.onclick = () => filterByTag(tag);
                container.appendChild(div);
            });
        }

        function filterByTag(tag) {
            const searchInput = document.getElementById('sidebarSearch');
            searchInput.value = '#' + tag;
            renderSidebar();
        }

        // Functions for Modal-based Tag Management
        function handleMetaTagInput(e) {
            if (e.key === 'Enter') {
                addTagFromInput();
            }
        }

        async function addTagFromInput() {
            const input = document.getElementById('metaTagInput');
            const tag = input.value.trim().replace(/^#/, '');

            if (tag) {
                const chapter = chapters.find(c => c.id === currentId);
                if (chapter) {
                    if (!chapter.tags) chapter.tags = [];
                    if (!chapter.tags.includes(tag)) {
                        chapter.tags.push(tag);
                        await saveChapterToDB(chapter);
                        input.value = '';
                        openMetadataModal(); // Re-render modal to show new tag
                        renderSidebar(); // Update sidebar tags list
                        loadChapter(currentId); // Reload stream to reflect tag grouping
                    }
                }
            }
        }

        async function removeTagFromModal(tag) {
            const chapter = chapters.find(c => c.id === currentId);
            if (chapter && chapter.tags) {
                chapter.tags = chapter.tags.filter(t => t !== tag);
                await saveChapterToDB(chapter);
                openMetadataModal(); // Re-render
                renderSidebar(); // Update sidebar
                loadChapter(currentId); // Reload stream to update grouping
            }
        }

        // --- MATH KEYBOARD LOGIC ---
        function switchMathTab(category, btn) {
            document.querySelectorAll('.math-tab-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            else if (!btn && document.querySelector('.math-tab-btn')) document.querySelector('.math-tab-btn').classList.add('active');

            const container = document.getElementById('mathKeys');
            container.innerHTML = '';

            const keys = MATH_KEYS[category] || [];
            keys.forEach(k => {
                const btn = document.createElement('button');
                btn.className = 'math-key';
                let label = k.replace('\\', '');

                if (category === 'basic') {
                    if (k === '\\approx') label = 'â‰ˆ';
                    else if (k === '\\neq') label = 'â‰ ';
                    else if (k === '\\pm') label = 'Â±';
                    else if (k === '\\times') label = 'Ã—';
                    else if (k === '\\div') label = 'Ã·';
                } else if (category === 'calc') {
                    if (k === '\\int') label = 'âˆ«';
                    else if (k === '\\sum') label = 'Î£';
                    else if (k === '\\prod') label = 'Î ';
                    else if (k === '\\partial') label = 'âˆ‚';
                    else if (k === '\\nabla') label = 'âˆ‡';
                    else if (k === '\\infty') label = 'âˆž';
                } else if (category === 'geom') {
                    if (k === '\\pi') label = 'Ï€';
                    else if (k === '\\theta') label = 'Î¸';
                    else if (k === '\\alpha') label = 'Î±';
                    else if (k === '\\beta') label = 'Î²';
                    else if (k === '\\phi') label = 'Ï†';
                    else if (k === '\\lambda') label = 'Î»';
                    else if (k === '\\Delta') label = 'Î”';
                    else if (k === '\\perp') label = 'âŠ¥';
                    else if (k === '\\parallel') label = 'âˆ¥';
                    else if (k === '\\angle') label = 'âˆ ';
                    else if (k === '\\triangle') label = 'â–³';
                }

                if (k.includes('frac')) label = 'a/b';
                else if (k.includes('sqrt')) label = 'âˆš';
                else if (k.includes('^')) label = 'xÊ¸';
                else if (k.includes('_')) label = 'xâ‚™';
                else if (k === '\\int_{}^{}') label = 'âˆ«â‚áµ‡';
                else if (k === '\\vec{}') label = 'vâƒ—';
                else if (k === '\\bar{}') label = 'xÌ„';
                else if (k === '\\hat{}') label = 'xÌ‚';

                btn.innerText = label;
                btn.onclick = () => {
                    const buffer = document.getElementById('mathBuffer');
                    const val = k.startsWith('\\') && category === 'trig' ? k + ' ' : k;
                    buffer.value += val;
                    updateMathPreview();
                    buffer.focus();
                };
                container.appendChild(btn);
            });
        }

        function updateMathPreview() {
            const input = document.getElementById('mathBuffer').value;
            const preview = document.getElementById('mathPreview');
            try {
                if (window.katex) {
                    preview.innerHTML = katex.renderToString(input, { throwOnError: false });
                } else {
                    preview.innerText = input;
                }
            } catch (e) {
                preview.innerText = "...";
            }
        }

        function insertMathFromBuffer() {
            const buffer = document.getElementById('mathBuffer');
            const latex = buffer.value.trim();
            if (!latex) return;

            const isDisplay = editingMathElement && editingMathElement.classList.contains('math-display');

            let mathHtml = '';
            if (window.katex) {
                mathHtml = katex.renderToString(latex, { throwOnError: false, displayMode: isDisplay });
            } else {
                mathHtml = `<span style="font-family:monospace; background:#eee;">${latex}</span>`;
            }

            if (editingMathElement) {
                editingMathElement.setAttribute('data-latex', latex);
                editingMathElement.innerHTML = mathHtml;
                editingMathElement = null;
            } else {
                const html = `<span class="math-block" contenteditable="false" data-latex="${latex}" style="padding:0 5px; cursor:pointer;" onclick="editMathBlock(this)">${mathHtml}</span>&nbsp;`;

                // Check if active element is an editor
                if (document.activeElement && document.activeElement.classList.contains('content-area')) {
                    document.execCommand('insertHTML', false, html);
                } else {
                    // Fallback to primary editor
                    const editor = document.querySelector('.content-area');
                    editor.focus();
                    document.execCommand('insertHTML', false, html);
                }
            }

            buffer.value = '';
            updateMathPreview();
        }

        window.editMathBlock = (el) => {
            editingMathElement = el;
            const latex = el.getAttribute('data-latex');
            document.getElementById('mathBuffer').value = latex;
            updateMathPreview();
            toggleMathMode(true);
        };

        window.toggleMathMode = (forceOpen = false) => {
            const keyboard = document.getElementById('mathKeyboard');
            const btn = document.getElementById('mathModeBtn');

            if (forceOpen === true) {
                isMathMode = true;
            } else {
                isMathMode = !isMathMode;
            }

            if (isMathMode) {
                keyboard.style.display = 'flex';
                if (btn) btn.classList.add('active');
                document.querySelector('.sidebar').style.bottom = '220px';
            } else {
                keyboard.style.display = 'none';
                if (btn) btn.classList.remove('active');
                document.querySelector('.sidebar').style.bottom = '0';
                editingMathElement = null;
            }
        };

        // --- DISCIPLINE TOOLBAR FUNCTIONS ---
        window.insertAlgoStep = () => { insertHtml(`<div class="chalk-code" contenteditable="true">1. Step description...<br>   â†³ Logic/Condition</div>`); }
        window.insertComplexity = () => { insertHtml(`<span class="algo-badge" contenteditable="true">Time: O(n)</span>&nbsp;`); }

        window.insertTraceTable = () => {
            saveSelection();
            document.getElementById('traceModal').style.display = 'flex';
            document.getElementById('traceVarCount').focus();
        }

        window.closeTraceModal = () => {
            document.getElementById('traceModal').style.display = 'none';
        }

        window.confirmTraceTable = () => {
            const count = document.getElementById('traceVarCount').value;
            const n = parseInt(count);
            if (isNaN(n) || n < 1) return;

            let headers = "";
            let cells = "";

            for (let i = 1; i <= n; i++) {
                headers += `<th>Var ${i}</th>`;
                cells += `<td>-</td>`;
            }

            headers += "<th>Output</th>";
            cells += "<td>-</td>";

            const html = `
                <div class="trace-table-container" style="overflow-x:auto; margin:10px 0;">
                    <button contenteditable="false" onclick="addTraceColumn(this)" class="btn-trace-add" title="Add Variable">+</button>
                    <table class="trace-table" style="width:100%; min-width:100%;">
                        <thead><tr>${headers}</tr></thead>
                        <tbody>
                            <tr>${cells}</tr>
                            <tr>${cells}</tr>
                            <tr>${cells}</tr>
                        </tbody>
                    </table>
                </div>
                <p><br></p>
            `;
            restoreSelection();
            insertHtml(html);
            closeTraceModal();
        }

        window.addTraceColumn = (btn) => {
            const container = btn.closest('.trace-table-container');
            if (!container) return;
            const table = container.querySelector('table');
            if (!table) return;

            const headRow = table.tHead.rows[0];
            const bodyRows = table.tBodies[0].rows;

            let insertIndex = headRow.cells.length - 1;

            let maxVar = 0;
            for (let cell of headRow.cells) {
                const match = cell.innerText.trim().match(/^Var\s+(\d+)/);
                if (match) {
                    const num = parseInt(match[1]);
                    if (num > maxVar) maxVar = num;
                }
            }
            const newVarName = `Var ${maxVar + 1}`;

            const newTh = document.createElement('th');
            newTh.innerText = newVarName;
            headRow.insertBefore(newTh, headRow.cells[insertIndex]);

            for (let row of bodyRows) {
                const newTd = document.createElement('td');
                newTd.innerText = '-';
                row.insertBefore(newTd, row.cells[insertIndex]);
            }

            // Trigger save on the specific editor block
            const block = btn.closest('.content-area');
            if (block && block.oninput) block.oninput();
        };

        // Medical Tools
        window.activeAnatomyPinMode = false;
        window.activateAnatomyPin = () => {
            window.activeAnatomyPinMode = true;
            document.getElementById('paper').style.cursor = 'crosshair';
            showToast("Tap paper to place pin");
        }

        document.getElementById('paper').addEventListener('click', function (e) {
            if (!window.activeAnatomyPinMode) return;
            if (e.target.closest('.writing-tools') || e.target.closest('.tool-tray-container')) return;

            // Fix: Find the specific editor block the user clicked on
            let targetEditor = e.target.closest('.content-area');

            // If user clicked on a pin or something inside an editor, get the editor
            if (!targetEditor) {
                // Fallback: Check if we clicked an element inside the stream
                const streamItem = e.target.closest('.sequence-editor-block');
                if (streamItem) {
                    targetEditor = streamItem.querySelector('.content-area');
                }
            }

            // If still no editor (e.g. clicked margin/gap), default to the closest or active one
            if (!targetEditor) {
                // Try finding the element at the click coordinates again to be sure
                const elements = document.elementsFromPoint(e.clientX, e.clientY);
                targetEditor = elements.find(el => el.classList.contains('content-area'));

                // Ultimate fallback to the primary editor if clicking dead space
                if (!targetEditor) targetEditor = document.querySelector('.content-area');
            }

            const rect = targetEditor.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const globalCount = document.querySelectorAll('.anatomy-pin').length + 1;
            const pin = document.createElement('div');
            pin.className = 'anatomy-pin';
            pin.setAttribute('contenteditable', 'false');
            pin.style.left = (x - 12) + 'px'; // Center the 24px pin
            pin.style.top = (y - 12) + 'px';
            pin.innerHTML = `<span>${globalCount}</span>`;

            targetEditor.appendChild(pin);

            const legendHtml = `<div class="checklist-item">
                <div style="background:var(--med-accent); color:white; width:20px; height:20px; border-radius:50%; text-align:center; font-size:0.7rem; line-height:20px; margin-right:10px;">${globalCount}</div>
                <div class="checklist-text" contenteditable="true">Label...</div>
            </div>`;

            // Use insertAdjacentHTML to avoid breaking existing event listeners (checkboxes, etc)
            targetEditor.insertAdjacentHTML('beforeend', legendHtml);

            window.activeAnatomyPinMode = false;
            document.getElementById('paper').style.cursor = 'default';
            if (targetEditor.oninput) targetEditor.oninput();
        });

        window.setHighlightPreset = (type) => {
            customStrokeStyle = (type === 'symptom') ? 'rgba(255, 235, 59, 0.4)' : 'rgba(231, 76, 60, 0.4)';
            activeSketchTool = 'custom';
            const highlighterBtn = document.querySelector('.tool-opt.highlighter');
            if (highlighterBtn) highlighterBtn.click();
        }

        window.insertTimeline = () => {
            const html = `
                <div class="timeline-wrapper" style="margin:15px 0;">
                    <div class="timeline-container">
                        <div class="timeline-entry">
                            <strong class="time-label" contenteditable="true">00:00</strong> - 
                            <span class="event-desc" contenteditable="true">Event...</span>
                        </div>
                    </div>
                    <button contenteditable="false" onclick="addTimelineEvent(this)" class="btn-trace-add" style="background:var(--med-accent);" title="Add Event (+10m)">+</button>
                </div>
                <p><br></p>
            `;
            insertHtml(html);
        }

        window.addTimelineEvent = (btn) => {
            const wrapper = btn.closest('.timeline-wrapper');
            const container = wrapper.querySelector('.timeline-container');
            const lastEntry = container.lastElementChild;
            let timeStr = "00:00";

            if (lastEntry) {
                const label = lastEntry.querySelector('.time-label');
                if (label) timeStr = label.innerText.trim();
            }

            let [h, m] = timeStr.split(':').map(n => parseInt(n) || 0);
            m += 10;
            if (m >= 60) {
                h += Math.floor(m / 60);
                m = m % 60;
            }
            if (h >= 24) h = h % 24;

            const newTime = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;

            const newEntry = document.createElement('div');
            newEntry.className = 'timeline-entry';
            newEntry.innerHTML = `<strong class="time-label" contenteditable="true">${newTime}</strong> - <span class="event-desc" contenteditable="true">...</span>`;

            container.appendChild(newEntry);

            // Trigger save
            const block = btn.closest('.content-area');
            if (block && block.oninput) block.oninput();
        }

        window.insertComparison = () => {
            const html = `
                <div class="comparison-wrapper" style="margin:15px 0;">
                    <table class="comparison-table">
                        <thead>
                            <tr><th contenteditable="true">Item A</th><th contenteditable="true">Item B</th></tr>
                        </thead>
                        <tbody>
                            <tr><td contenteditable="true">Value</td><td contenteditable="true">Value</td></tr>
                        </tbody>
                    </table>
                    <button contenteditable="false" onclick="addComparisonRow(this)" class="btn-trace-add" style="background:var(--med-accent);" title="Add Row">+</button>
                </div>
                <p><br></p>
            `;
            insertHtml(html);
        }

        window.addComparisonRow = (btn) => {
            const wrapper = btn.closest('.comparison-wrapper');
            const table = wrapper.querySelector('table tbody');
            const colCount = wrapper.querySelector('table thead tr').children.length;

            const row = document.createElement('tr');
            let cells = "";
            for (let i = 0; i < colCount; i++) cells += `<td contenteditable="true">-</td>`;
            row.innerHTML = cells;

            table.appendChild(row);

            const block = btn.closest('.content-area');
            if (block && block.oninput) block.oninput();
        }

        // Engineering Tools
        window.insertEquation = () => {
            const latex = "x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}";
            let mathHtml = "";
            if (window.katex) {
                mathHtml = katex.renderToString(latex, { throwOnError: false, displayMode: true });
            } else {
                mathHtml = latex;
            }
            const html = `<div class="math-display" contenteditable="false" data-latex="${latex}" style="text-align:center; padding:10px; cursor:pointer; background:rgba(0,0,0,0.03); border-radius:4px; margin: 10px 0;" onclick="editMathBlock(this)">${mathHtml}</div><p><br></p>`;
            insertHtml(html);
        }
        window.insertAssumptions = () => { insertHtml(`<h3 style="color:#7f8c8d; border-bottom:1px solid #eee;">Assumptions</h3><ul><li>Steady state</li><li>Adiabatic</li></ul>`); }

        // --- CONSTANTS TOOL LOGIC ---
        const ENG_CONSTANTS = {
            'g': '9.81 m/sÂ²',
            'pi': '3.14159',
            'Ï€': '3.14159',
            'e': '2.71828',
            'c': '3.00 Ã— 10â¸ m/s',
            'h': '6.626 Ã— 10â»Â³â´ JÂ·s',
            'G': '6.674 Ã— 10â»Â¹Â¹ NÂ·mÂ²/kgÂ²',
            'atm': '101,325 Pa',
            'R': '8.314 J/(molÂ·K)',
            'Na': '6.022 Ã— 10Â²Â³ molâ»Â¹',
            'k': '1.380 Ã— 10â»Â²Â³ J/K'
        };

        window.insertConstants = () => {
            saveSelection();
            document.getElementById('constantModal').style.display = 'flex';
            document.getElementById('constInput').value = '';
            document.getElementById('constValue').value = '';
            document.getElementById('constInput').focus();
        }

        window.closeConstantModal = () => {
            document.getElementById('constantModal').style.display = 'none';
        };

        window.lookupConstant = () => {
            const key = document.getElementById('constInput').value.trim();
            const valInput = document.getElementById('constValue');

            if (ENG_CONSTANTS[key]) {
                valInput.value = ENG_CONSTANTS[key];
            } else if (ENG_CONSTANTS[key.toLowerCase()]) {
                valInput.value = ENG_CONSTANTS[key.toLowerCase()];
            }
        };

        window.confirmConstant = () => {
            const sym = document.getElementById('constInput').value.trim();
            const val = document.getElementById('constValue').value.trim();

            if (sym && val) {
                restoreSelection();
                insertHtml(`<div class="chalk-code">${sym} = ${val}</div><p><br></p>`);
            }
            closeConstantModal();
        };

        window.toggleRuler = () => {
            isRulerActive = !isRulerActive;
            document.getElementById('engRuler').style.display = isRulerActive ? 'block' : 'none';
        }

        function setupRulerEvents() {
            const ruler = document.getElementById('engRuler');
            const rotateHandle = document.getElementById('rulerRotate');

            ruler.addEventListener('mousedown', (e) => {
                if (e.target === rotateHandle) return;
                isDraggingRuler = true;
                rulerDragStartX = e.clientX - ruler.offsetLeft;
                rulerDragStartY = e.clientY - ruler.offsetTop;
            });

            rotateHandle.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                isRotatingRuler = true;
                const rect = ruler.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                rulerStartAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) - (rulerAngle * Math.PI / 180);
            });

            window.addEventListener('mousemove', (e) => {
                if (isDraggingRuler) {
                    rulerX = e.clientX - rulerDragStartX;
                    rulerY = e.clientY - rulerDragStartY;
                    ruler.style.left = rulerX + 'px';
                    ruler.style.top = rulerY + 'px';
                }
                if (isRotatingRuler) {
                    const rect = ruler.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    const angle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
                    rulerAngle = (angle - rulerStartAngle) * 180 / Math.PI;
                    ruler.style.transform = `rotate(${rulerAngle}deg)`;
                }
            });

            window.addEventListener('mouseup', () => {
                isDraggingRuler = false;
                isRotatingRuler = false;
            });
        }

        // --- NEW PDF IMPORT LOGIC ---
        window.importPdfToCanvas = async (input) => {
            const file = input.files[0];
            if (!file) return;

            showToast("Rendering PDF...");

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;

                // Get the current content area (where user edits)
                const contentArea = document.querySelector('.content-area');
                if (!contentArea) {
                    showToast("âš ï¸ Please create a page first");
                    return;
                }

                // Clear existing content and prepare for PDF
                contentArea.innerHTML = '';
                contentArea.style.position = 'relative';

                const pdfPagesData = [];
                const pdfContainer = document.createElement('div');
                pdfContainer.style.cssText = 'position: relative; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 20px;';

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const scale = 1.5;
                    const viewport = page.getViewport({ scale });

                    const canvas = document.createElement('canvas');
                    canvas.className = 'pdf-page-render';
                    canvas.style.cssText = 'max-width: 100%; height: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); background: white;';
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;

                    // Create wrapper for each page
                    const pageWrapper = document.createElement('div');
                    pageWrapper.style.cssText = 'position: relative; width: 100%; display: flex; justify-content: center;';
                    pageWrapper.appendChild(canvas);
                    pdfContainer.appendChild(pageWrapper);

                    pdfPagesData.push(canvas.toDataURL('image/jpeg', 0.8));
                }

                // Inject PDF into content area
                contentArea.appendChild(pdfContainer);
                contentArea.contentEditable = 'true'; // Allow annotations on top

                const chapter = chapters.find(c => c.id === currentId);
                if (chapter) {
                    chapter.pdfPages = pdfPagesData;
                    chapter.content = contentArea.innerHTML; // Save the PDF-injected content
                    await saveChapterToDB(chapter);
                }

                setTimeout(resizeCanvas, 100);
                showToast(`âœ“ PDF loaded: ${pdf.numPages} pages. Click to add annotations!`);

            } catch (err) {
                console.error(err);
                showToast("Error reading PDF");
            }
        };

        let pendingPdfInput = null;

        window.loadLecturePdf = (input) => {
            if (!input.files || !input.files[0]) return;
            pendingPdfInput = input;
            document.getElementById('pdfModeModal').style.display = 'flex';
        };

        window.closePdfModeModal = () => {
            document.getElementById('pdfModeModal').style.display = 'none';
            if (pendingPdfInput) {
                pendingPdfInput.value = '';
                pendingPdfInput = null;
            }
        };

        window.resolvePdfMode = (mode) => {
            if (!pendingPdfInput) return;

            if (mode === 'annotate') {
                importPdfToCanvas(pendingPdfInput);
            } else {
                const file = pendingPdfInput.files[0];
                const url = URL.createObjectURL(file);
                document.getElementById('lectureFrame').src = url;
                document.body.classList.add('split-mode');
                showToast("Lecture Loaded in Split View");
            }
            document.getElementById('pdfModeModal').style.display = 'none';
            pendingPdfInput = null;
        };

        // --- TOOLBAR SWITCHING ---
        function updateToolVisibility(chapter) {
            const csTools = document.getElementById('tools-cs');
            if (csTools) csTools.style.display = 'none';

            const medTools = document.getElementById('tools-med');
            if (medTools) medTools.style.display = 'none';

            const engTools = document.getElementById('tools-eng');
            if (engTools) engTools.style.display = 'none';

            const circuitTools = document.getElementById('tools-circuit');
            if (circuitTools) circuitTools.style.display = 'none';

            document.getElementById('engRuler').style.display = 'none';
            isRulerActive = false;
            isMathMode = false;
            const mathBtn = document.getElementById('mathModeBtn');
            if (mathBtn) mathBtn.classList.remove('active');

            const disc = chapter?.metadata?.discipline;
            const pageType = chapter?.metadata?.type;

            if (disc === 'cs' && csTools) csTools.style.display = 'flex';
            if (disc === 'medical' && medTools) medTools.style.display = 'flex';
            if (disc === 'engineering' && engTools) engTools.style.display = 'flex';

            // Show circuit components tool only for Circuit Analysis template
            if (pageType === PAGE_TYPES.CIRCUIT_ANALYSIS && circuitTools) {
                circuitTools.style.display = 'flex';
            }

            // Update Knowledge Base based on discipline
            updateKnowledgeBase(disc);
        }

        window.insertCSCodeBlock = () => {
            const html = `
                <div class="cs-code-container" contenteditable="false">
                    <div class="cs-code-header">
                        <div style="display:flex; align-items:center;">
                            <span style="margin-right:10px;">Code Snippet</span>
                            <select class="cs-lang-select" onchange="updateCodeLanguage(this)">
                                <option value="javascript">JS</option>
                                <option value="python">Python</option>
                                <option value="java">Java</option>
                                <option value="cpp">C++</option>
                                <option value="html">HTML</option>
                                <option value="css">CSS</option>
                                <option value="sql">SQL</option>
                            </select>
                        </div>
                        <div>
                            <span style="font-size:0.7rem; opacity:0.7; margin-right:5px;">Editable</span>
                            <button class="cs-format-btn" onclick="formatCodeBlock(this)">âš¡ Format</button>
                        </div>
                    </div>
                    <div class="cs-code-editor language-javascript" contenteditable="true" onfocus="unformatCode(this)" onblur="formatCodeBlock(this)">// Write code here...</div>
                    <div class="cs-code-output" contenteditable="true">Result...</div>
                </div>
                <p><br></p>
            `;
            insertHtml(html);
        };

        window.updateCodeLanguage = (select) => {
            const container = select.closest('.cs-code-container');
            const editor = container.querySelector('.cs-code-editor');
            editor.classList.forEach(cls => {
                if (cls.startsWith('language-')) editor.classList.remove(cls);
            });
            editor.classList.add(`language-${select.value}`);
            if (document.activeElement !== editor) {
                formatCodeBlock(select);
            }
        };

        window.formatCodeBlock = (el) => {
            const container = el.closest('.cs-code-container');
            const editor = container.querySelector('.cs-code-editor');
            const langSelect = container.querySelector('.cs-lang-select');
            const lang = langSelect.value;
            const code = editor.innerText;

            if (Prism && Prism.languages[lang]) {
                const highlighted = Prism.highlight(code, Prism.languages[lang], lang);
                editor.innerHTML = highlighted;
            }
        };

        window.unformatCode = (editor) => {
            const code = editor.innerText;
            editor.innerText = code;
        };

        window.filterChapters = () => {
            renderSidebar();
        }

        // --- METADATA MODAL ---
        window.openMetadataModal = () => {
            const chapter = chapters.find(c => c.id === currentId);
            if (!chapter) return;

            document.getElementById('metaDiscipline').value = chapter.metadata?.discipline || 'general';
            document.getElementById('metaType').value = chapter.metadata?.type || 'note';
            document.getElementById('metaDifficulty').value = chapter.metadata?.difficulty || 'medium';
            document.getElementById('metaSystem').value = chapter.metadata?.system || '';
            document.getElementById('metaCreated').innerText = new Date(chapter.metadata?.createdAt).toLocaleString();

            // Populate Tags List in Modal
            const tagsList = document.getElementById('metaTagsList');
            tagsList.innerHTML = '';
            (chapter.tags || []).forEach(tag => {
                const chip = document.createElement('div');
                chip.className = 'tag-chip';
                chip.innerHTML = `<span>#${tag}</span><span class="tag-remove" onclick="removeTagFromModal('${tag}')">Ã—</span>`;
                tagsList.appendChild(chip);
            });

            const dentalTypes = [
                PAGE_TYPES.DENTAL_ANATOMY, PAGE_TYPES.ORAL_PATHOLOGY, PAGE_TYPES.DENTAL_PROCEDURE,
                PAGE_TYPES.DENTAL_CASE, PAGE_TYPES.PROSTHO_PLAN, PAGE_TYPES.ENDO_CASE,
                PAGE_TYPES.PERIO_CASE, PAGE_TYPES.ORAL_RADIOLOGY
            ];
            const dentalGroup = document.getElementById('dentalMetaGroup');
            if (dentalTypes.includes(chapter.metadata?.type)) {
                dentalGroup.style.display = 'block';
                document.getElementById('metaTooth').value = chapter.metadata?.toothNumber || '';
                document.getElementById('metaQuadrant').value = chapter.metadata?.quadrant || '';
                document.getElementById('metaSpecialty').value = chapter.metadata?.specialty || '';
            } else {
                dentalGroup.style.display = 'none';
            }

            const engTypes = [
                PAGE_TYPES.PROBLEM_SOLUTION, PAGE_TYPES.CIRCUIT_ANALYSIS, PAGE_TYPES.MECHANICAL_SYSTEM,
                PAGE_TYPES.STRUCTURAL_ANALYSIS, PAGE_TYPES.CONTROL_SYSTEM, PAGE_TYPES.PROCESS_FLOW,
                PAGE_TYPES.DESIGN_CALCULATION, PAGE_TYPES.LAB_EXPERIMENT
            ];
            const engGroup = document.getElementById('engineeringMetaGroup');
            if (engTypes.includes(chapter.metadata?.type) || chapter.metadata?.discipline === 'engineering') {
                engGroup.style.display = 'block';
                document.getElementById('metaEngBranch').value = chapter.metadata?.branch || 'General';
            } else {
                engGroup.style.display = 'none';
            }

            document.getElementById('metadataModal').style.display = 'flex';
        };

        window.closeMetadataModal = () => {
            document.getElementById('metadataModal').style.display = 'none';
        };

        // --- ACTIVE RECALL STICKER LOGIC ---
        let isStickerMode = false;
        let stickerStartX = 0;
        let stickerStartY = 0;
        let stickerPreview = null;

        window.toggleStickerMode = () => {
            isStickerMode = !isStickerMode;
            const btn = document.getElementById('stickerBtn');
            const editor = document.querySelector('.content-area');

            if (isStickerMode) {
                btn.classList.add('active');
                if (editor) editor.contentEditable = "false";
                document.getElementById('paper').style.cursor = "crosshair";
                showToast("Draw stickers over text/images");
                if (isSketchMode) toggleSketchMode();
            } else {
                btn.classList.remove('active');
                if (editor) editor.contentEditable = "true";
                document.getElementById('paper').style.cursor = "default";
            }
        };

        const paper = document.getElementById('paper');

        function getEventCoords(e) {
            if (e.touches && e.touches.length > 0) {
                return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
            return { x: e.clientX, y: e.clientY };
        }

        function startSticker(e) {
            if (!isStickerMode) return;
            // Allow interactions with tools
            if (e.target.closest('.tool-tray') || e.target.closest('.writing-tools')) return;
            // Don't start drawing a new sticker if clicking an existing one (handled by drag logic)
            if (e.target.classList.contains('recall-sticker')) return;

            // Prevent scrolling on touch
            if (e.type === 'touchstart') {
                e.preventDefault();
            } else {
                e.preventDefault(); // Prevent text selection on mouse
            }

            const coords = getEventCoords(e);

            // Get active editor block in the stream to attach sticker to
            let targetEl = document.elementFromPoint(coords.x, coords.y);

            if (!targetEl) return;

            const editor = targetEl.closest('.content-area') || document.querySelector('.content-area');
            if (!editor) return;

            const rect = editor.getBoundingClientRect();
            stickerStartX = coords.x - rect.left;
            stickerStartY = coords.y - rect.top;

            stickerPreview = document.createElement('div');
            stickerPreview.className = 'recall-sticker';
            stickerPreview.style.left = stickerStartX + 'px';
            stickerPreview.style.top = stickerStartY + 'px';
            stickerPreview.style.width = '0px';
            stickerPreview.style.height = '0px';
            stickerPreview.style.opacity = '0.5';
            stickerPreview.style.pointerEvents = 'none';

            editor.appendChild(stickerPreview);
        }

        function moveSticker(e) {
            if (!isStickerMode || !stickerPreview) return;

            if (e.type === 'touchmove') e.preventDefault();

            const coords = getEventCoords(e);
            const editor = stickerPreview.parentElement;
            const rect = editor.getBoundingClientRect();

            const currentX = coords.x - rect.left;
            const currentY = coords.y - rect.top;

            const width = currentX - stickerStartX;
            const height = currentY - stickerStartY;

            stickerPreview.style.width = Math.abs(width) + 'px';
            stickerPreview.style.height = Math.abs(height) + 'px';
            stickerPreview.style.left = (width < 0 ? currentX : stickerStartX) + 'px';
            stickerPreview.style.top = (height < 0 ? currentY : stickerStartY) + 'px';
        }

        function endSticker(e) {
            if (!isStickerMode || !stickerPreview) return;

            const width = parseFloat(stickerPreview.style.width);
            const height = parseFloat(stickerPreview.style.height);

            if (width > 20 && height > 20) {
                stickerPreview.style.opacity = '1';
                stickerPreview.style.pointerEvents = 'auto';
                stickerPreview.setAttribute('contenteditable', 'false');

                // Add right click / long press handler for removal
                stickerPreview.oncontextmenu = (ev) => {
                    ev.preventDefault();
                    if (confirm('Remove this sticker?')) ev.target.remove();
                    // Save trigger
                    const block = ev.target.closest('.content-area');
                    if (block && block.oninput) block.oninput();
                };

                const block = stickerPreview.closest('.content-area');
                if (block && block.oninput) block.oninput();
            } else {
                stickerPreview.remove();
            }
            stickerPreview = null;
        }

        paper.addEventListener('mousedown', startSticker);
        paper.addEventListener('mousemove', moveSticker);
        paper.addEventListener('mouseup', endSticker);

        paper.addEventListener('touchstart', startSticker, { passive: false });
        paper.addEventListener('touchmove', moveSticker, { passive: false });
        paper.addEventListener('touchend', endSticker);

        // Sticker Drag Logic
        let dragItem = null;
        let dragStartX = 0;
        let dragStartY = 0;
        let dragInitialLeft = 0;
        let dragInitialTop = 0;
        let isDraggingObject = false;

        function handleObjectDragStart(e) {
            if (!e.target.classList.contains('recall-sticker')) return;

            e.preventDefault();
            e.stopPropagation();

            dragItem = e.target;
            const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);

            dragStartX = clientX;
            dragStartY = clientY;

            dragInitialLeft = parseFloat(dragItem.style.left) || 0;
            dragInitialTop = parseFloat(dragItem.style.top) || 0;

            isDraggingObject = false;
        }

        function handleObjectDragMove(e) {
            if (!dragItem) return;
            e.preventDefault();
            const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
            const dx = clientX - dragStartX;
            const dy = clientY - dragStartY;

            if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                isDraggingObject = true;
            }
            if (isDraggingObject) {
                dragItem.style.left = (dragInitialLeft + dx) + 'px';
                dragItem.style.top = (dragInitialTop + dy) + 'px';
            }
        }

        function handleObjectDragEnd(e) {
            if (!dragItem) return;
            if (!isDraggingObject) {
                dragItem.classList.toggle('revealed');
            } else {
                // Save position
                const block = dragItem.closest('.content-area');
                if (block && block.oninput) block.oninput();
            }
            dragItem = null;
            isDraggingObject = false;
        }

        // Apply drag listeners to the stream container
        const streamEl = document.getElementById('sequentialStream');
        streamEl.addEventListener('mousedown', handleObjectDragStart);
        window.addEventListener('mousemove', handleObjectDragMove);
        window.addEventListener('mouseup', handleObjectDragEnd);

        streamEl.addEventListener('touchstart', handleObjectDragStart, { passive: false });
        window.addEventListener('touchmove', handleObjectDragMove, { passive: false });
        window.addEventListener('touchend', handleObjectDragEnd);

        window.updatePageMeta = () => {
            const chapter = chapters.find(c => c.id === currentId);
            if (chapter) {
                chapter.metadata.type = document.getElementById('metaType').value;
                chapter.metadata.difficulty = document.getElementById('metaDifficulty').value;
                chapter.metadata.system = document.getElementById('metaSystem').value;
                chapter.metadata.toothNumber = document.getElementById('metaTooth').value;
                chapter.metadata.quadrant = document.getElementById('metaQuadrant').value;
                chapter.metadata.specialty = document.getElementById('metaSpecialty').value;
                chapter.metadata.branch = document.getElementById('metaEngBranch').value;

                saveChapterToDB(chapter);
                openMetadataModal();
            }
        };

        // --- CORE FUNCTIONS ---

        window.toggleTopTools = () => {
            document.body.classList.toggle('tools-hidden');
            const tools = document.getElementById('topTools');
            if (document.body.classList.contains('tools-hidden')) {
                tools.classList.add('collapsed');
            } else {
                tools.classList.remove('collapsed');
            }
        };

        window.wipeAllData = async () => {
            if (confirm("DANGER: This will delete ALL notes forever. Are you sure?")) {
                await clearDB();
                location.reload();
            }
        }

        window.closeLecturePane = () => {
            document.body.classList.remove('split-mode');
        };

        window.toggleSection = (contentId, arrowId, wrapperId = null) => {
            const content = document.getElementById(contentId);
            const arrow = document.getElementById(arrowId);
            const isCollapsed = content.classList.contains('collapsed');
            if (isCollapsed) {
                content.classList.remove('collapsed');
                arrow.style.transform = 'rotate(0deg)';
                if (wrapperId) document.getElementById(wrapperId).classList.remove('collapsed-wrapper');
            } else {
                content.classList.add('collapsed');
                arrow.style.transform = 'rotate(-90deg)';
                if (wrapperId) document.getElementById(wrapperId).classList.add('collapsed-wrapper');
            }
        };

        window.toggleTray = () => {
            isTrayCollapsed = !isTrayCollapsed;
            const container = document.getElementById('trayContainer');
            const toggleBtn = document.getElementById('trayToggle');
            container.classList.toggle('collapsed', isTrayCollapsed);
            toggleBtn.innerText = isTrayCollapsed ? 'â–¶' : 'â—€';
        };

        window.toggleMobileSidebar = () => {
            document.getElementById('mainSidebar').classList.toggle('open');
        };

        window.toggleFocusMode = () => {
            document.body.classList.toggle('focus-mode');
        };

        // Paper texture cycling
        let currentPaperStyle = 0;
        const paperStyles = ['grid-texture', 'lined-texture', 'dotted-texture', 'plain-texture'];
        const paperNames = ['Grid', 'Lines', 'Dots', 'Plain'];

        window.cyclePaperStyle = () => {
            const paper = document.getElementById('paper');
            const btn = document.getElementById('paperStyleBtn');

            // Remove all texture classes
            paperStyles.forEach(style => paper.classList.remove(style));

            // Cycle to next style
            currentPaperStyle = (currentPaperStyle + 1) % paperStyles.length;

            // Apply new style
            paper.classList.add(paperStyles[currentPaperStyle]);
            btn.textContent = `ðŸ“„ Paper: ${paperNames[currentPaperStyle]}`;

            showToast(`Paper: ${paperNames[currentPaperStyle]}`);
        };

        window.toggleReadMode = () => {
            isReadMode = !isReadMode;
            document.body.classList.toggle('read-mode', isReadMode);
            const btn = document.getElementById('readModeBtn');
            const editors = document.querySelectorAll('.content-area');
            if (isReadMode) {
                btn.innerText = "ðŸ”’ Unlock / Edit";
                editors.forEach(e => e.contentEditable = "false");
                showToast("Read Mode Enabled");
            } else {
                btn.innerText = "ðŸ”“ Lock / Read";
                editors.forEach(e => e.contentEditable = "true");
                showToast("Editing Enabled");
            }
        };

        // Share note function
        window.shareNote = async () => {
            const chapter = chapters.find(c => c.id === currentId);
            if (!chapter) {
                showToast('âš ï¸ No note selected');
                return;
            }

            const title = chapter.title || 'Untitled Note';
            const content = chapter.content || '';

            // Create plain text version
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            const textContent = tempDiv.innerText || tempDiv.textContent;

            const shareText = `${title}\n\n${textContent.substring(0, 500)}${textContent.length > 500 ? '...' : ''}`;

            // Try native share API (mobile/modern browsers)
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: title,
                        text: shareText,
                    });
                    showToast('âœ“ Shared successfully');
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        copyToClipboardFallback(shareText);
                    }
                }
            } else {
                // Fallback: copy to clipboard
                copyToClipboardFallback(shareText);
            }
        };

        function copyToClipboardFallback(text) {
            // Create temporary textarea
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();

            try {
                document.execCommand('copy');
                showToast('âœ“ Copied to clipboard! Paste to share.');
            } catch (err) {
                showToast('âš ï¸ Could not copy to clipboard');
            }

            document.body.removeChild(textarea);
        }

        function handleSelectionChange() {
            const bubble = document.getElementById('textBubble');
            const selection = window.getSelection();
            const stream = document.getElementById('sequentialStream');

            if (selection.isCollapsed || !stream.contains(selection.anchorNode)) {
                bubble.classList.remove('visible');
                return;
            }

            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();

            bubble.classList.add('visible');
            bubble.style.top = (rect.top + window.scrollY - 10) + 'px';
            bubble.style.left = (rect.left + (rect.width / 2)) + 'px';
        }

        window.formatText = (command, value = null) => {
            document.execCommand(command, false, value);

            // Find which editor block is active to save
            const sel = window.getSelection();
            if (sel.anchorNode) {
                const block = sel.anchorNode.parentElement.closest('.content-area');
                if (block && block.oninput) block.oninput();
            }
        };

        function setupDragAndDrop() {
            const paper = document.getElementById('paper');
            let dragCounter = 0;

            paper.addEventListener('dragenter', (e) => {
                e.preventDefault();
                dragCounter++;
                paper.classList.add('drag-over');
                if (e.dataTransfer) e.dataTransfer.dropEffect = 'copy';
            });

            paper.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (e.dataTransfer) e.dataTransfer.dropEffect = 'copy';
            });

            paper.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dragCounter--;
                if (dragCounter <= 0) paper.classList.remove('drag-over');
            });

            paper.addEventListener('drop', (e) => {
                e.preventDefault();
                dragCounter = 0;
                paper.classList.remove('drag-over');

                let range = null;
                if (document.caretRangeFromPoint) {
                    range = document.caretRangeFromPoint(e.clientX, e.clientY);
                } else if (document.caretPositionFromPoint) {
                    const pos = document.caretPositionFromPoint(e.clientX, e.clientY);
                    if (pos) {
                        range = document.createRange();
                        range.setStart(pos.offsetNode, pos.offset);
                        range.collapse(true);
                    }
                }

                // Determine active editor
                const stream = document.getElementById('sequentialStream');
                let editor = document.querySelector('.content-area');

                if (range && stream.contains(range.commonAncestorContainer)) {
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                    editor = range.commonAncestorContainer.closest('.content-area') || editor;
                } else {
                    editor.focus();
                }

                // Handle Files
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    Array.from(files).forEach(file => {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                const html = `<div class="uploaded-container" contenteditable="false"><img src="${event.target.result}" /></div>`;
                                document.execCommand('insertHTML', false, html);
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                    return;
                }
            });
        }

        window.importBackgroundFile = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const chapter = chapters.find(c => c.id === currentId);
                if (chapter) {
                    chapter.backgroundImage = e.target.result;
                    await saveChapterToDB(chapter);
                    loadChapter(currentId);
                    showToast("Background Set");
                }
            };
            reader.readAsDataURL(file);
        };

        window.setCustomColor = (val) => {
            customStrokeStyle = val;
            activeSketchTool = 'custom';
            document.querySelectorAll('.tool-opt').forEach(o => o.classList.remove('active'));
            if (!isSketchMode) toggleSketchMode();
        };

        function resizeCanvas() {
            const paper = document.getElementById('paper');
            const dpr = window.devicePixelRatio || 1;

            if (canvas.width !== paper.offsetWidth * dpr || canvas.height !== paper.offsetHeight * dpr) {
                canvas.width = paper.offsetWidth * dpr;
                canvas.height = paper.offsetHeight * dpr;
                ctx.scale(dpr, dpr);
                if (sketchData) drawSavedSketch(sketchData);
            }
        }
        window.addEventListener('resize', resizeCanvas);

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);

        canvas.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) return;
            if (isSketchMode) e.preventDefault();
            startDrawing(e.touches[0]);
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            if (isSketchMode) e.preventDefault();
            draw(e.touches[0]);
        }, { passive: false });

        canvas.addEventListener('touchend', stopDrawing);

        let isPanning = false;
        let startPanX = 0; let startPanY = 0;
        let scrollStartX = 0; let scrollStartY = 0;

        function getCanvasCoordinates(inputEvent) {
            let clientX = inputEvent.clientX;
            let clientY = inputEvent.clientY;

            // RULER SNAPPING LOGIC
            if (isRulerActive && !isDraggingRuler && !isRotatingRuler) {
                const ruler = document.getElementById('engRuler');
                const rRect = ruler.getBoundingClientRect();
                const rCx = rRect.left + rRect.width / 2;
                const rCy = rRect.top + rRect.height / 2;

                // Convert degrees to radians
                const rad = rulerAngle * (Math.PI / 180);

                // Calculate position relative to ruler center
                const dx = clientX - rCx;
                const dy = clientY - rCy;

                // Rotate to local alignment (un-rotate by rulerAngle)
                // localX is along ruler length, localY is along width/height
                const localX = dx * Math.cos(-rad) - dy * Math.sin(-rad);
                const localY = dx * Math.sin(-rad) + dy * Math.cos(-rad);

                // Ruler height is 60px (top at -30, bottom at +30)
                // Snap if within 15px of an edge
                const SNAP_DIST = 20;

                // Ruler is 400px wide, so localX extends from -200 to +200
                if (Math.abs(localX) < 250) { // Allow snapping slightly beyond tips
                    if (Math.abs(localY - 30) < SNAP_DIST) {
                        // Snap to bottom edge
                        const snappedX = localX * Math.cos(rad) - 30 * Math.sin(rad);
                        const snappedY = localX * Math.sin(rad) + 30 * Math.cos(rad);
                        clientX = rCx + snappedX;
                        clientY = rCy + snappedY;
                    } else if (Math.abs(localY + 30) < SNAP_DIST) {
                        // Snap to top edge
                        const snappedX = localX * Math.cos(rad) - (-30) * Math.sin(rad);
                        const snappedY = localX * Math.sin(rad) + (-30) * Math.cos(rad);
                        clientX = rCx + snappedX;
                        clientY = rCy + snappedY;
                    }
                }
            }

            const rect = canvas.getBoundingClientRect();
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function startDrawing(e) {
            if (activeSketchTool === 'hand') {
                isPanning = true;
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                startPanX = clientX; startPanY = clientY;
                const ws = document.getElementById('workspace');
                scrollStartX = ws.scrollLeft; scrollStartY = ws.scrollTop;
                ws.classList.add('grabbing');
                if (e.type === 'touchstart') e.preventDefault();
                return;
            }

            if (!isSketchMode || isReadMode) return;
            if (e.type === 'touchstart') e.preventDefault();

            saveStateToStack();
            drawing = true;

            const coords = getCanvasCoordinates(e.clientX ? e : e.touches[0]);
            ctx.beginPath();
            ctx.moveTo(coords.x, coords.y);
        }

        function draw(e) {
            if (activeSketchTool === 'hand') {
                if (!isPanning) return;
                e.preventDefault();
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                const walkX = (clientX - startPanX);
                const walkY = (clientY - startPanY);
                const ws = document.getElementById('workspace');
                ws.scrollLeft = scrollStartX - walkX;
                ws.scrollTop = scrollStartY - walkY;
                return;
            }

            if (!drawing || !isSketchMode || isReadMode) return;
            if (e.type === 'touchmove') e.preventDefault();

            const coords = getCanvasCoordinates(e.clientX ? e : e.touches[0]);

            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;

            if (activeSketchTool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = 30;
                ctx.lineTo(coords.x, coords.y);
                ctx.stroke();
            } else if (activeSketchTool === 'highlighter') {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = customStrokeStyle || 'rgba(255, 235, 59, 0.25)';
                ctx.lineWidth = 20;
                ctx.lineTo(coords.x, coords.y);
                ctx.stroke();
            } else if (activeSketchTool === 'custom') {
                ctx.strokeStyle = customStrokeStyle;
                ctx.lineWidth = 2;
                ctx.lineTo(coords.x, coords.y);
                ctx.stroke();
            } else {
                ctx.lineWidth = 2;
                ctx.strokeStyle = document.body.classList.contains('dark-mode') ? '#ffffff' : '#2c3e50';
                ctx.lineTo(coords.x, coords.y);
                ctx.stroke();
            }

            ctx.beginPath();
            ctx.moveTo(coords.x, coords.y);
        }

        function stopDrawing() {
            if (activeSketchTool === 'hand') {
                isPanning = false;
                document.getElementById('workspace').classList.remove('grabbing');
                return;
            }
            if (drawing) {
                drawing = false;
                ctx.globalCompositeOperation = 'source-over';
                saveSketchToCloud();
            }
        }

        function saveStateToStack() {
            if (undoStack.length > 20) undoStack.shift();
            undoStack.push(canvas.toDataURL());
            redoStack = [];
        }

        window.undoSketch = () => {
            if (undoStack.length === 0) return;
            redoStack.push(canvas.toDataURL());
            const prevStateUrl = undoStack.pop();
            drawSavedSketch(prevStateUrl);
            setTimeout(async () => {
                const chapter = chapters.find(c => c.id === currentId);
                if (chapter) {
                    chapter.sketch = canvas.toDataURL();
                    await saveChapterToDB(chapter);
                }
            }, 100);
        };

        window.redoSketch = () => {
            if (redoStack.length === 0) return;
            undoStack.push(canvas.toDataURL());
            const nextStateUrl = redoStack.pop();
            drawSavedSketch(nextStateUrl);
            setTimeout(async () => {
                const chapter = chapters.find(c => c.id === currentId);
                if (chapter) {
                    chapter.sketch = canvas.toDataURL();
                    await saveChapterToDB(chapter);
                }
            }, 100);
        };

        function drawSavedSketch(dataUrl) {
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width / (window.devicePixelRatio || 1), canvas.height / (window.devicePixelRatio || 1));
                ctx.drawImage(img, 0, 0, canvas.width / (window.devicePixelRatio || 1), canvas.height / (window.devicePixelRatio || 1));
            };
            img.src = dataUrl;
        }

        window.clearSketch = () => {
            if (!confirm("Are you sure you want to clear your drawing?")) return;
            saveStateToStack();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            saveSketchToCloud();
            showToast("Sketch cleared");
        };

        window.selectSketchTool = (tool) => {
            if (tool === 'hand') {
                activeSketchTool = 'hand';
                document.getElementById('handBtn').classList.add('active');
                document.getElementById('eraserBtn').classList.remove('active');
                if (!isSketchMode) toggleSketchMode();
                return;
            } else {
                document.getElementById('handBtn').classList.remove('active');
            }

            if (tool !== 'highlighter') customStrokeStyle = null;
            activeSketchTool = tool === activeSketchTool ? 'brush' : tool;

            document.getElementById('eraserBtn').classList.toggle('active', activeSketchTool === 'eraser');
            const highlighterBtn = document.querySelector('.tool-opt.highlighter');
            if (highlighterBtn) highlighterBtn.classList.toggle('active', activeSketchTool === 'highlighter');

            if (!isSketchMode) toggleSketchMode();
        };

        window.selectWritingTool = (tool, save = true) => {
            if (tool === 'highlighter') {
                selectSketchTool('highlighter');
                return;
            }
            document.getElementById('handBtn').classList.remove('active');
            if (activeSketchTool === 'hand') activeSketchTool = 'brush';

            // Apply class to ALL editors in the stream
            document.querySelectorAll('.content-area').forEach(e => {
                e.className = `content-area writing-tool-${tool}`;
            });

            document.querySelectorAll('.tool-opt').forEach(o => o.classList.toggle('active', o.dataset.tool === tool));
            if (save) {
                const chapter = chapters.find(c => c.id === currentId);
                if (chapter) {
                    chapter.tool = tool;
                    saveChapterToDB(chapter);
                }
            }
        };

        window.exportData = () => {
            const dataStr = JSON.stringify(chapters, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const exportFileDefaultName = 'notebook_backup_' + new Date().toISOString().slice(0, 10) + '.json';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        };

        window.importData = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedChapters = JSON.parse(e.target.result);
                    if (Array.isArray(importedChapters)) {
                        await clearDB();
                        for (const chap of importedChapters) {
                            await saveChapterToDB(chap);
                        }
                        chapters = importedChapters;
                        initApp();
                        showToast("Backup Restored!");
                    } else {
                        alert("Invalid backup file.");
                    }
                } catch (err) {
                    alert("Error reading file");
                }
            };
            reader.readAsText(file);
        };

        // --- FLASHCARD LOGIC START ---

        let flashcards = [];
        let currentCardIndex = 0;

        window.startFlashcardMode = () => {
            // 1. Scan for flashcards
            generateFlashcards();

            if (flashcards.length === 0) {
                document.getElementById('flashcardContainer').style.display = 'none';
                document.querySelector('.flashcard-controls').style.display = 'none';
                document.getElementById('noCardsMsg').style.display = 'block';
            } else {
                document.getElementById('flashcardContainer').style.display = 'block';
                document.querySelector('.flashcard-controls').style.display = 'flex';
                document.getElementById('noCardsMsg').style.display = 'none';
                currentCardIndex = 0;
                renderCard();
            }

            document.getElementById('flashcardOverlay').style.display = 'flex';
        };

        function generateFlashcards() {
            flashcards = [];

            // Scan ALL content areas in the stream
            const editors = document.querySelectorAll('#sequentialStream .content-area');

            editors.forEach(editor => {
                // Strategy A: "Question :: Answer"
                // We scan text content for '::'
                // Simplification: iterate over block elements
                const blocks = editor.querySelectorAll('p, li, h1, h2, h3, h4, div');
                blocks.forEach(block => {
                    const text = block.innerText;
                    if (text.includes('::')) {
                        const parts = text.split('::');
                        if (parts.length >= 2 && parts[0].trim() && parts[1].trim()) {
                            flashcards.push({
                                q: parts[0].trim(),
                                a: parts[1].trim()
                            });
                        }
                    }
                });

                // Strategy B: Header (Q) -> Body (A)
                // We iterate children directly
                const children = Array.from(editor.children);
                let currentQ = null;
                let currentA = '';

                for (let i = 0; i < children.length; i++) {
                    const node = children[i];
                    const tag = node.tagName.toLowerCase();

                    if (['h1', 'h2', 'h3'].includes(tag)) {
                        // If we have a pending card, push it
                        if (currentQ && currentA.trim()) {
                            flashcards.push({ q: currentQ, a: currentA.trim() });
                        }
                        // Start new card
                        currentQ = node.innerText;
                        currentA = '';
                    } else if (currentQ) {
                        // Append to answer if not a new header
                        // Skip empty text nodes if possible, but innerText handles it
                        if (node.innerText.trim()) {
                            // Don't include lines that were already caught by "::" logic to avoid dupes?
                            // For simplicity, we include them unless they are identical.
                            if (!node.innerText.includes('::')) {
                                currentA += node.innerText + '\n';
                            }
                        }
                    }
                }
                // Push last card
                if (currentQ && currentA.trim()) {
                    flashcards.push({ q: currentQ, a: currentA.trim() });
                }
            });
        }

        window.renderCard = () => {
            const card = flashcards[currentCardIndex];
            const cardEl = document.querySelector('.flashcard');

            // Reset flip state
            cardEl.classList.remove('flipped');

            // Update Text
            // Small delay to allow flip animation reset if needed, but instant is snappier
            document.getElementById('fcQuestion').innerText = card.q;
            document.getElementById('fcAnswer').innerText = card.a;

            document.getElementById('fcCounter').innerText = `${currentCardIndex + 1} / ${flashcards.length}`;
        };

        window.flipCard = () => {
            document.querySelector('.flashcard').classList.toggle('flipped');
        };

        window.nextCard = () => {
            if (currentCardIndex < flashcards.length - 1) {
                currentCardIndex++;
                renderCard();
            }
        };

        window.prevCard = () => {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                renderCard();
            }
        };

        window.exitFlashcardMode = () => {
            document.getElementById('flashcardOverlay').style.display = 'none';
        };

        // --- FLASHCARD LOGIC END ---

        // ENHANCED ID GENERATION TO PREVENT COLLISIONS
        window.createNewChapter = async (title, tags) => {
            if (typeof title === 'object' || !title) title = "Untitled Page";
            if (!tags) tags = [];

            if (currentId && title === "Untitled Page" && tags.length === 0) {
                const currentChapter = chapters.find(c => c.id === currentId);
                if (currentChapter && currentChapter.tags && currentChapter.tags.length > 0) {
                    tags = [...currentChapter.tags];
                    title = "Untitled (Continuation)";
                }
            } else if (title === "Untitled Page") {
                title = `Note - ${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            }

            const catElement = document.getElementById('categoryFilter');
            const currentCat = catElement ? catElement.value : 'all';
            let category = (currentCat === 'all') ? 'General' : currentCat;

            // Unique ID Generation: Timestamp + Random Suffix
            const id = "ch_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);

            const newChapter = {
                id: id,
                title: title,
                category: category,
                tags: tags,
                content: "<div>Start typing...</div>",
                tool: 'pen',
                sketch: null,
                paperStyle: 'grid',
                lastEdited: new Date().toISOString(),
                metadata: {
                    discipline: 'general',
                    type: PAGE_TYPES.NOTE,
                    difficulty: 'medium',
                    topics: [],
                    system: '',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }
            };

            if (['Algorithms', 'Systems', 'Projects'].includes(category)) newChapter.metadata.discipline = 'cs';
            if (['Anatomy', 'Pathology', 'Pharmacology', 'Clinical'].includes(category)) newChapter.metadata.discipline = 'medical';
            if (['Dental Anatomy', 'Procedures', 'Dental Cases'].includes(category)) newChapter.metadata.discipline = 'medical';
            if (['Electrical', 'Mechanical', 'Civil', 'Electronics', 'Mechatronics', 'Industrial'].includes(category)) {
                newChapter.metadata.discipline = 'engineering';
                newChapter.metadata.branch = category;
            }

            chapters.unshift(newChapter);
            await saveChapterToDB(newChapter);
            renderSidebar();

            // Load and scroll to new page
            loadChapter(id);
        };

        window.deleteChapter = async (id, event) => {
            if (event) event.stopPropagation();
            chapters = chapters.filter(c => c.id !== id);
            await deleteChapterFromDB(id);
            if (currentId === id) {
                if (chapters.length > 0) loadChapter(chapters[0].id);
                else createNewChapter();
            } else {
                renderSidebar();
            }
            showToast("Page Deleted");
        };

        window.triggerImageUpload = () => document.getElementById('imageInput').click();
        window.handleImageUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                restoreSelection();
                const stream = document.getElementById('sequentialStream');
                let activeEditor = document.activeElement;
                if (!activeEditor || !stream.contains(activeEditor) || !activeEditor.classList.contains('content-area')) {
                    const editors = stream.querySelectorAll('.content-area');
                    if (editors.length > 0) {
                        activeEditor = editors[editors.length - 1];
                        activeEditor.focus();
                        const range = document.createRange();
                        range.selectNodeContents(activeEditor);
                        range.collapse(false);
                        const sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }
                }
                const html = `<div class="uploaded-container" contenteditable="false"><img src="${event.target.result}" /></div><p><br></p>`;
                document.execCommand('insertHTML', false, html);
                if (activeEditor && activeEditor.oninput) activeEditor.oninput();
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        };

        // --- UPDATED LOAD CHAPTER ---
        function loadChapter(id) {
            currentId = id;
            undoStack = []; redoStack = [];
            const chapter = chapters.find(c => c.id === id);
            if (!chapter) return;

            const stream = document.getElementById('sequentialStream');
            stream.innerHTML = '';

            const pdfContainer = document.getElementById('pdfBackground');
            pdfContainer.innerHTML = '';

            setTimeout(() => resizeCanvas(), 0);

            // SEQUENCE LOGIC with De-duplication
            let sequence = [chapter];
            if (chapter.tags && chapter.tags.length > 0) {
                const streamItems = chapters.filter(c =>
                    c.tags && c.tags.some(tag => chapter.tags.includes(tag))
                );
                // Ensure unique items by ID
                const uniqueItems = Array.from(new Map(streamItems.map(item => [item.id, item])).values());
                sequence = uniqueItems;

                // Sort by creation date
                sequence.sort((a, b) => new Date(a.metadata.createdAt) - new Date(b.metadata.createdAt));
            }

            // Render Sequence
            sequence.forEach((item, idx) => {
                const block = document.createElement('div');
                block.className = 'sequence-editor-block';
                block.id = `page-block-${item.id}`; // Add ID for scrolling

                // Highlight active page
                if (item.id === id) {
                    block.classList.add('active-focus');
                    // Scroll into view after render
                    setTimeout(() => {
                        block.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }

                if (idx > 0) {
                    const br = document.createElement('div');
                    br.className = 'continuation-break';
                    br.innerHTML = `<div class="continuation-label">${item.title}</div>`;
                    stream.appendChild(br);
                }

                const editor = document.createElement('div');
                editor.className = `content-area writing-tool-${item.tool || 'pen'}`;
                editor.contentEditable = !isReadMode;
                editor.spellcheck = false;
                editor.innerHTML = item.content;

                // Scoped Save Logic
                editor.oninput = () => {
                    markUnsaved();
                    item.content = editor.innerHTML;
                    item.lastEdited = new Date().toISOString();
                    debounceSave(item);
                };

                // Focus handling to highlight active page visually
                editor.onfocus = () => {
                    document.querySelectorAll('.sequence-editor-block').forEach(b => b.classList.remove('active-focus'));
                    block.classList.add('active-focus');
                    currentId = item.id; // Update current context to focused page
                    document.getElementById('pageTitle').value = item.title; // Update title bar
                    renderSidebar(); // Update sidebar highlight
                };

                block.appendChild(editor);
                stream.appendChild(block);
            });

            // Set title bar to the requested ID's title initially
            document.getElementById('pageTitle').value = chapter.title;

            // Background & Sketch Logic
            // PDFs are now stored in chapter.content as HTML with images
            if (chapter.backgroundImage) {
                document.getElementById('paper').style.backgroundImage = `url('${chapter.backgroundImage}')`;
                document.getElementById('paper').classList.add('annotate-mode');
            } else {
                document.getElementById('paper').style.backgroundImage = '';
                document.getElementById('paper').classList.remove('annotate-mode');
                // Paper texture is now controlled by user via cyclePaperStyle button
            }

            if (chapter.sketch) {
                sketchData = chapter.sketch;
                drawSavedSketch(sketchData);
            } else {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                sketchData = null;
            }

            selectWritingTool(chapter.tool || 'pen', false);
            renderSidebar();
            document.getElementById('mainSidebar').classList.remove('open');
            document.getElementById('saveStatus').innerText = "All changes saved";

            // Show/Hide stream continuation button based on whether we are in a stream (have tags)
            const streamControls = document.getElementById('streamControls');
            if (chapter.tags && chapter.tags.length > 0) {
                streamControls.style.opacity = '1';
                streamControls.style.pointerEvents = 'auto';
            } else {
                streamControls.style.opacity = '0';
                streamControls.style.pointerEvents = 'none';
            }

            updateWordCount();
            updateToolVisibility(chapter);

            // Initialize Logic Gates Simulator if this is a logic gates page
            if (chapter.metadata && chapter.metadata.type === PAGE_TYPES.LOGIC_GATES) {
                setTimeout(() => initLogicGatesSimulator(), 200);
            }
        }

        async function addSequentialPage() {
            const current = chapters.find(c => c.id === currentId);
            const newTitle = current ? (current.title + " (Cont.)") : "New Page";
            const tags = current ? [...(current.tags || [])] : [];
            await createNewChapter(newTitle, tags);
            showToast("Page Added to Stream");
        }

        let saveTimers = {};
        function debounceSave(chapter) {
            clearTimeout(saveTimers[chapter.id]);
            saveTimers[chapter.id] = setTimeout(async () => {
                await saveChapterToDB(chapter);
                document.getElementById('saveStatus').innerText = "Saved";
            }, 1000);
        }

        let saveTimeout;
        window.markUnsaved = () => { document.getElementById('saveStatus').innerText = "Saving..."; }

        window.saveCurrentToCloud = () => {
            const chapter = chapters.find(c => c.id === currentId);
            if (chapter) {
                chapter.title = document.getElementById('pageTitle').value;
                debounceSave(chapter);
            }
        };

        function updateWordCount() {
            const text = document.getElementById('sequentialStream').innerText || "";
            const count = text.trim().split(/\s+/).filter(w => w.length > 0).length;
            document.getElementById('wordCount').innerText = count + " Words";
        }

        function saveSketchToCloud() {
            const chapter = chapters.find(c => c.id === currentId);
            if (chapter) {
                chapter.sketch = canvas.toDataURL();
                saveChapterToDB(chapter);
            }
        }

        window.toggleSketchMode = () => {
            isSketchMode = !isSketchMode;
            document.body.classList.toggle('sketch-mode', isSketchMode);
            document.getElementById('sketchToggle').classList.toggle('active', isSketchMode);
            const editors = document.querySelectorAll('.content-area');
            editors.forEach(e => e.contentEditable = !isSketchMode);

            if (!isSketchMode) activeSketchTool = 'brush';
            showToast(isSketchMode ? "Sketching Enabled" : "Writing Enabled");
        };

        window.toggleVoiceTranscription = () => {
            if (!recognition) {
                const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!Speech) return showToast("Speech API not supported on this browser");
                recognition = new Speech();
                recognition.continuous = true;
                recognition.interimResults = false;
                recognition.onresult = (e) => {
                    const text = e.results[e.results.length - 1][0].transcript;
                    document.execCommand('insertText', false, text + " ");
                };
                recognition.onend = () => { if (isListening) recognition.start(); };
            }
            if (isListening) {
                recognition.stop();
                isListening = false;
                document.getElementById('voiceBtn').classList.remove('active-voice');
            } else {
                recognition.start();
                isListening = true;
                document.getElementById('voiceBtn').classList.add('active-voice');
                showToast("Listening...");
            }
        };

        window.insertBlock = (type) => {
            let html = "";
            if (type === 'header') html = "<h2 class='styled-header'>New Title</h2>";
            if (type === 'todo') html = `<div class="checklist-item" contenteditable="false"><div class="checkbox-wrapper" contenteditable="false"><div class="checkbox"></div></div><div class="checklist-text" contenteditable="true">Task Item</div></div>`;
            if (type === 'note') html = "<div class='sticky-note'>Important Note...</div>";
            if (type === 'code') html = "<div class='chalk-code'>// code here</div>";
            insertHtml(html + "<p><br></p>");
        };

        function insertHtml(html) {
            let active = document.activeElement;
            if (!active || !active.closest('.content-area')) {
                active = document.querySelector('.content-area');
                active.focus();
            }
            document.execCommand('insertHTML', false, html);
            const block = active.closest('.content-area');
            if (block && block.oninput) block.oninput();
        }

        window.toggleTemplates = () => {
            const p = document.getElementById('templatePopup');
            p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
        };

        // NEW: TEMPLATE NAVIGATION LOGIC
        window.showCSTemplates = () => {
            document.getElementById('tmpl-main-view').style.display = 'none';
            document.getElementById('tmpl-cs-view').style.display = 'block';
            document.getElementById('tmpl-med-view').style.display = 'none';
            document.getElementById('tmpl-dentistry-view').style.display = 'none';
            document.getElementById('tmpl-eng-view').style.display = 'none';
        };

        window.showMedTemplates = () => {
            document.getElementById('tmpl-main-view').style.display = 'none';
            document.getElementById('tmpl-cs-view').style.display = 'none';
            document.getElementById('tmpl-med-view').style.display = 'block';
            document.getElementById('tmpl-dentistry-view').style.display = 'none';
            document.getElementById('tmpl-eng-view').style.display = 'none';
        };

        window.showDentistryTemplates = () => {
            document.getElementById('tmpl-main-view').style.display = 'none';
            document.getElementById('tmpl-cs-view').style.display = 'none';
            document.getElementById('tmpl-med-view').style.display = 'none';
            document.getElementById('tmpl-dentistry-view').style.display = 'block';
            document.getElementById('tmpl-eng-view').style.display = 'none';
        };

        window.showEngineeringTemplates = () => {
            document.getElementById('tmpl-main-view').style.display = 'none';
            document.getElementById('tmpl-cs-view').style.display = 'none';
            document.getElementById('tmpl-med-view').style.display = 'none';
            document.getElementById('tmpl-dentistry-view').style.display = 'none';
            document.getElementById('tmpl-eng-view').style.display = 'block';
        };

        window.showMainTemplates = () => {
            document.getElementById('tmpl-main-view').style.display = 'block';
            document.getElementById('tmpl-cs-view').style.display = 'none';
            document.getElementById('tmpl-med-view').style.display = 'none';
            document.getElementById('tmpl-dentistry-view').style.display = 'none';
            document.getElementById('tmpl-eng-view').style.display = 'none';
            document.getElementById('tmpl-advanced-view').style.display = 'none';
        };

        window.showAdvancedTemplates = () => {
            document.getElementById('tmpl-main-view').style.display = 'none';
            document.getElementById('tmpl-cs-view').style.display = 'none';
            document.getElementById('tmpl-med-view').style.display = 'none';
            document.getElementById('tmpl-dentistry-view').style.display = 'none';
            document.getElementById('tmpl-eng-view').style.display = 'none';
            document.getElementById('tmpl-advanced-view').style.display = 'block';
        };

        window.applyTemplate = async (key) => {
            const chapter = chapters.find(c => c.id === currentId);
            if (!chapter) return;

            const temps = {
                default: { title: "New Note", content: "<div>Start typing...</div>", isWhiteboard: false, type: PAGE_TYPES.NOTE },
                meeting: { title: "Meeting: " + new Date().toLocaleDateString(), content: "<h2 class='styled-header'>Participants</h2><p>â€¢ </p><h2 class='styled-header'>Notes</h2><p></p><h2 class='styled-header'>Action Items</h2>", type: PAGE_TYPES.NOTE },
                journal: { title: "Entry: " + new Date().toLocaleDateString(), content: "<div class='sticky-note'>What happened today?</div>", type: PAGE_TYPES.NOTE },
                project: { title: "Project Tracker", content: "<h2 class='styled-header'>Phase 1</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Milestone</div></div>", type: PAGE_TYPES.PROJECT },
                eisenhower: {
                    title: "Eisenhower Matrix",
                    content: "<h2 class='styled-header' style='color:#c0392b'>1. Do First (Urgent & Important)</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Crisis / Deadline</div></div><h2 class='styled-header' style='color:#2980b9'>2. Schedule (Less Urgent, Important)</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Planning / Strategy</div></div><h2 class='styled-header' style='color:#d35400'>3. Delegate (Urgent, Less Important)</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Interruptions / Meetings</div></div><h2 class='styled-header' style='color:#7f8c8d'>4. Don't Do (Not Urgent, Not Important)</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Distractions</div></div>",
                    type: PAGE_TYPES.NOTE
                },
                whiteboard: {
                    title: "Infinite Whiteboard",
                    content: "<div>Start Brainstorming...</div>",
                    isWhiteboard: true,
                    type: PAGE_TYPES.WHITEBOARD
                },
                algo: { title: "Algorithm Analysis", content: "<h2 class='styled-header'>Problem Statement</h2><p>Describe the problem...</p><h2 class='styled-header'>Complexity</h2><span class='algo-badge'>Time: O(n)</span><span class='algo-badge'>Space: O(1)</span><h2 class='styled-header'>Pseudocode</h2><div class='chalk-code'>// Logic here</div>", type: PAGE_TYPES.ALGORITHM },
                logicGates: { title: "Logic Gates Simulator", content: "<h2 class='styled-header'>Logic Circuit Design</h2><div id='logicGatesSimulator'></div><h2 class='styled-header'>Truth Table</h2><p>Document your results...</p><h2 class='styled-header'>Notes</h2><p>Analysis...</p>", type: PAGE_TYPES.LOGIC_GATES },
                sysDesign: { title: "System Design", content: "<h2 class='styled-header'>Requirements</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Scalability</div></div><h2 class='styled-header'>Architecture Diagram</h2><p>(Use Sketch Mode)</p>", isWhiteboard: true, type: PAGE_TYPES.SYSTEM },
                codeStudy: { title: "Code Study", content: "<h2 class='styled-header'>Code Snippet</h2><div class='cs-code-container' contenteditable='false'><div class='cs-code-header'><span>Main.java</span></div><div class='cs-code-editor' contenteditable='true'>public static void main(String[] args) {}</div><div class='cs-code-output' contenteditable='true'>Output...</div></div><h2 class='styled-header'>Trace / Logic</h2><p>Step 1: ...</p>", type: PAGE_TYPES.NOTE },
                anatomy: { title: "Anatomy Sheet", content: "<h2 class='styled-header'>Structure & Function</h2><p>Describe location, origin, insertion...</p><h2 class='styled-header'>Relations</h2><p>Anterior, posterior...</p><h2 class='styled-header'>Clinical Relevance</h2><div class='sticky-note'>Important clinical notes...</div><h2 class='styled-header'>Sketch Area</h2><p>(Draw below)</p>", type: PAGE_TYPES.ANATOMY },
                disease: { title: "Disease Profile", content: "<h2 class='styled-header'>Definition & Etiology</h2><p>...</p><h2 class='styled-header'>Pathophysiology</h2><p>...</p><h2 class='styled-header'>Clinical Features</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Symptom 1</div></div><h2 class='styled-header'>Management</h2><p>...</p>", type: PAGE_TYPES.DISEASE },
                drug: { title: "Drug Monograph", content: "<h2 class='styled-header'>Class & Mechanism</h2><p>...</p><h2 class='styled-header'>Indications</h2><p>...</p><h2 class='styled-header'>Contraindications & Side Effects</h2><div class='sticky-note'>Warning: ...</div><h2 class='styled-header'>Dosage</h2><p>...</p>", type: PAGE_TYPES.DRUG },
                physio: { title: "Physio Case", content: "<h2 class='styled-header'>Patient Profile</h2><p>Age, Gender, Occupation...</p><h2 class='styled-header'>Assessment (SOAP)</h2><p>Subjective: ...</p><p>Objective: ...</p><h2 class='styled-header'>Treatment Plan</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Exercise 1</div></div>", type: PAGE_TYPES.CLINICAL_CASE },
                pathway: { title: "Pathway Breakdown", content: "<h2 class='styled-header'>Overview</h2><p>...</p><h2 class='styled-header'>Steps</h2><div class='chalk-code'>1. Signal -> Receptor</div><h2 class='styled-header'>Regulation</h2><p>...</p>", type: PAGE_TYPES.PATHWAY },
                lab: { title: "Lab Interpretation", content: "<h2 class='styled-header'>Test Name</h2><p>...</p><h2 class='styled-header'>Normal Range</h2><p>...</p><h2 class='styled-header'>Interpretation</h2><p>High: ...</p><p>Low: ...</p>", type: PAGE_TYPES.LAB },
                dental_anatomy: { title: "Dental Anatomy", content: "<h2 class='styled-header'>Tooth Name / Number</h2><p>...</p><h2 class='styled-header'>Morphology & Surfaces</h2><p>...</p><h2 class='styled-header'>Root Anatomy</h2><p>...</p><h2 class='styled-header'>Clinical Notes</h2><div class='sticky-note'>Eruption: ...</div>", type: PAGE_TYPES.DENTAL_ANATOMY },
                oral_pathology: { title: "Oral Pathology", content: "<h2 class='styled-header'>Condition</h2><p>...</p><h2 class='styled-header'>Etiology</h2><p>...</p><h2 class='styled-header'>Clinical Appearance</h2><p>...</p><h2 class='styled-header'>Radiographic Features</h2><p>...</p><h2 class='styled-header'>Management</h2><p>...</p>", type: PAGE_TYPES.ORAL_PATHOLOGY },
                dental_procedure: { title: "Dental Procedure", content: "<h2 class='styled-header'>Procedure Name</h2><p>...</p><h2 class='styled-header'>Indications</h2><p>...</p><h2 class='styled-header'>Instruments Required</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Mirror/Probe</div></div><h2 class='styled-header'>Step-by-Step</h2><p>1. Anesthesia...</p>", type: PAGE_TYPES.DENTAL_PROCEDURE },
                dental_case: { title: "Dental Case", content: "<h2 class='styled-header'>Patient Profile</h2><p>...</p><h2 class='styled-header'>Chief Complaint (C/O)</h2><p>...</p><h2 class='styled-header'>Examination (O/E)</h2><p>Intraoral: ...</p><h2 class='styled-header'>Diagnosis & Plan</h2><p>...</p>", type: PAGE_TYPES.DENTAL_CASE },
                prostho_plan: { title: "Prostho Plan", content: "<h2 class='styled-header'>Edentulous Space</h2><p>...</p><h2 class='styled-header'>Abutment Evaluation</h2><p>...</p><h2 class='styled-header'>Design Components</h2><p>Major Connector: ...</p><p>Clasps: ...</p>", type: PAGE_TYPES.PROSTHO_PLAN },
                endo_case: { title: "Endo Case", content: "<h2 class='styled-header'>Tooth & Diagnosis</h2><p>...</p><h2 class='styled-header'>Access & WL</h2><p>Working Length: ...mm</p><h2 class='styled-header'>Instrumentation</h2><p>MAF: ...</p><h2 class='styled-header'>Obturation</h2><p>Technique: ...</p>", type: PAGE_TYPES.ENDO_CASE },
                perio_case: { title: "Perio Charting", content: "<h2 class='styled-header'>Periodontal Status</h2><p>Pockets > 4mm: ...</p><h2 class='styled-header'>Diagnosis</h2><p>Stage: ... Grade: ...</p><h2 class='styled-header'>Treatment Plan</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Scaling & Root Planing</div></div>", type: PAGE_TYPES.PERIO_CASE },
                oral_radiology: { title: "Radiographic Report", content: "<h2 class='styled-header'>Image Type</h2><p>IOPA / OPG / CBCT</p><h2 class='styled-header'>Findings</h2><p>Radio-opacity/lucency: ...</p><h2 class='styled-header'>Interpretation</h2><p>...</p>", type: PAGE_TYPES.ORAL_RADIOLOGY },
                prob_sol: { title: "Problem Solution", content: "<h2 class='styled-header'>Problem Statement</h2><p>...</p><h2 class='styled-header'>Given & Assumptions</h2><p>...</p><h2 class='styled-header'>Diagram</h2><p>(Use Sketch Mode)</p><h2 class='styled-header'>Governing Equations</h2><p>...</p><h2 class='styled-header'>Solution</h2><p>...</p><h2 class='styled-header'>Final Answer</h2><div class='sticky-note'>Result: ...</div>", type: PAGE_TYPES.PROBLEM_SOLUTION },
                circuit: { title: "Circuit Analysis", content: "<h2 class='styled-header'>Circuit Diagram</h2><div style='background:#e8f4f8; border-left:4px solid #3498db; padding:12px; margin:10px 0; border-radius:4px; font-size:0.85rem;'>ðŸ’¡ <strong>Instructions:</strong> Click the âš¡ Components button in the toolbar to open the component library. Drag components onto the canvas, then use sketch mode to draw wires between them. Double-click components to delete.</div><div id='circuitDiagramCanvas' style='position:relative; min-height:400px; background:#f8f9fa; border:2px solid #3498db; border-radius:8px; margin:15px 0;'><svg id='circuitSvg' style='position:absolute; width:100%; height:100%; pointer-events:none;'></svg><div id='circuitComponentsLayer' style='position:absolute; width:100%; height:100%;'></div></div><h2 class='styled-header'>Known Values</h2><p>R1 = ...</p><h2 class='styled-header'>Laws Applied</h2><p>KCL / KVL</p><h2 class='styled-header'>Analysis</h2><p>...</p>", isWhiteboard: true, type: PAGE_TYPES.CIRCUIT_ANALYSIS },
                mech_sys: { title: "Mechanical System", content: "<h2 class='styled-header'>System Description</h2><p>...</p><h2 class='styled-header'>Free Body Diagram</h2><p>(Draw FBD)</p><h2 class='styled-header'>Equations of Motion</h2><p>F = ma...</p><h2 class='styled-header'>Solution</h2><p>...</p>", isWhiteboard: true, type: PAGE_TYPES.MECHANICAL_SYSTEM },
                struct: { title: "Structural Analysis", content: "<h2 class='styled-header'>Structure Description</h2><p>...</p><h2 class='styled-header'>Load Diagram</h2><p>...</p><h2 class='styled-header'>Calculations</h2><p>...</p><h2 class='styled-header'>Design Checks</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Safety Factor OK</div></div>", type: PAGE_TYPES.STRUCTURAL_ANALYSIS },
                control: { title: "Control System", content: "<h2 class='styled-header'>Block Diagram</h2><p>...</p><h2 class='styled-header'>Transfer Function</h2><p>G(s) = ...</p><h2 class='styled-header'>Stability Analysis</h2><p>...</p>", isWhiteboard: true, type: PAGE_TYPES.CONTROL_SYSTEM },
                process: { title: "Process Flow", content: "<h2 class='styled-header'>Overview</h2><p>...</p><h2 class='styled-header'>Flow Diagram</h2><p>...</p><h2 class='styled-header'>Inputs / Outputs</h2><p>...</p><h2 class='styled-header'>Bottlenecks</h2><p>...</p>", isWhiteboard: true, type: PAGE_TYPES.PROCESS_FLOW },
                lab_exp: { title: "Lab Experiment", content: "<h2 class='styled-header'>Objective</h2><p>...</p><h2 class='styled-header'>Apparatus</h2><p>...</p><h2 class='styled-header'>Procedure</h2><p>1. ...</p><h2 class='styled-header'>Observations</h2><p>...</p><h2 class='styled-header'>Calculations & Conclusion</h2><p>...</p>", type: PAGE_TYPES.LAB_EXPERIMENT },

                // ADVANCED TEMPLATES
                cornell: {
                    title: "Cornell Notes",
                    content: `<div class="cornell-container" id="cornellTemplate">
                        <div class="cornell-header">
                            <input type="text" placeholder="Topic / Lecture Title" id="cornellTopic" class="cornell-topic" />
                            <div class="cornell-meta">
                                <span>ðŸ“… <span id="cornellDate">${new Date().toLocaleDateString()}</span></span>
                                <input type="text" placeholder="Source (optional)" id="cornellSource" style="border:none; background:transparent; flex:1;" />
                            </div>
                        </div>
                        <div class="cornell-cues" id="cornellCues">
                            <div class="cornell-cues-title">ðŸ”‘ Cues / Questions</div>
                            <div style="font-size:0.8rem; opacity:0.7; margin-bottom:10px;">Highlight text in Notes â†’ Click "Extract Cue"</div>
                        </div>
                        <div class="cornell-notes" contenteditable="true" id="cornellNotes">
                            <p>Take your lecture notes here...</p>
                            <p>â€¢ Use bullet points</p>
                            <p>â€¢ Draw diagrams in sketch mode</p>
                            <p>â€¢ Highlight key concepts</p>
                        </div>
                        <div class="cornell-summary" contenteditable="false" id="cornellSummary">
                            <div class="cornell-summary-title">ðŸ“ Summary</div>
                            <div style="font-size:0.85rem; opacity:0.6;">Write notes first (min 100 chars) to unlock this section</div>
                        </div>
                        <div class="cornell-toolbar">
                            <button class="cornell-btn" onclick="extractCornellCue()">Extract Cue</button>
                            <button class="cornell-btn" onclick="toggleCornellStudyMode()">ðŸ‘ï¸ Study Mode</button>
                        </div>
                    </div>`,
                    type: PAGE_TYPES.CORNELL
                },

                zettelkasten: {
                    title: "Zettelkasten Note",
                    content: `<div class="zettel-container">
                        <div class="zettel-id">ID: ${Date.now()}</div>
                        <input type="text" class="zettel-title" placeholder="Note Title (max 60 chars)" maxlength="60" id="zettelTitle" />
                        <div contenteditable="true" class="zettel-content" id="zettelContent" oninput="checkZettelWordCount()">
                            Write one atomic idea here. Keep it focused and concise (300-500 words target).
                        </div>
                        <div class="zettel-wordcount" id="zettelWordcount">0 words</div>
                        
                        <div class="zettel-section">
                            <div class="zettel-section-title">ðŸ“š Source / Context</div>
                            <input type="text" placeholder="From: Book/Lecture/Thought..." style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; margin-bottom:8px;" />
                            <div class="zettel-tag-input" id="zettelTags">
                                <span style="font-size:0.85rem; opacity:0.7;">Tags (min 2):</span>
                                <input type="text" placeholder="Add tag..." onkeypress="if(event.key==='Enter'){addZettelTag(this.value); this.value='';}" style="border:none; flex:1; padding:5px;" />
                            </div>
                        </div>
                        
                        <div class="zettel-section">
                            <div class="zettel-section-title">ðŸ”— Links</div>
                            <div style="font-size:0.85rem; opacity:0.7; margin-bottom:8px;">Connect to other notes (bi-directional)</div>
                            <div id="zettelLinks"></div>
                        </div>
                        
                        <div class="zettel-section">
                            <div class="zettel-section-title">âš¡ Permanence Rating</div>
                            <div class="zettel-permanence">
                                <label><input type="radio" name="zettelPerm" value="fleeting" /> Fleeting (raw capture)</label>
                                <label><input type="radio" name="zettelPerm" value="literature" /> Literature (paraphrased)</label>
                                <label><input type="radio" name="zettelPerm" value="permanent" checked /> Permanent (synthesized)</label>
                            </div>
                        </div>
                    </div>`,
                    type: PAGE_TYPES.ZETTELKASTEN
                },

                outline: {
                    title: "Outline",
                    content: `<div class="outline-container">
                        <div class="outline-header">
                            <input type="text" class="outline-title" placeholder="Chapter / Topic" />
                            <div class="outline-controls">
                                <button class="cornell-btn" onclick="collapseAllOutline()">â†» Collapse All</button>
                                <button class="cornell-btn" onclick="expandAllOutline()">âŠ• Expand All</button>
                            </div>
                        </div>
                        <div id="outlineContent" contenteditable="true" style="outline:none;">
                            <div class="outline-item level-1"><span class="outline-label">I.</span> Main Topic</div>
                            <div class="outline-item level-2"><span class="outline-label">A.</span> Subtopic</div>
                            <div class="outline-item level-3"><span class="outline-label">1.</span> Detail</div>
                            <div class="outline-item level-3"><span class="outline-label">2.</span> Detail</div>
                            <div class="outline-item level-2"><span class="outline-label">B.</span> Subtopic</div>
                            <div class="outline-item level-1"><span class="outline-label">II.</span> Main Topic</div>
                        </div>
                        <div style="margin-top:15px; padding:12px; background:rgba(149,165,166,0.1); border-radius:5px; font-size:0.85rem;">
                            <strong>ðŸ’¡ Tip:</strong> Use Tab to increase indent, Shift+Tab to decrease. Max 4 levels.
                        </div>
                    </div>`,
                    type: PAGE_TYPES.OUTLINE
                },

                mindmap: {
                    title: "Mind Map",
                    content: `<div class="mindmap-container" id="mindmapContainer">
                        <div class="mindmap-toolbar">
                            <button class="cornell-btn" onclick="addMindmapNode()">+ Node</button>
                            <button class="cornell-btn" onclick="addMindmapLink()">ðŸ”— Link</button>
                            <button class="cornell-btn" onclick="autoLayoutMindmap()">ðŸŽ¨ Organize</button>
                        </div>
                        <div class="mindmap-canvas" id="mindmapCanvas">
                            <div class="mindmap-node central" style="left:50%; top:50%; transform:translate(-50%,-50%);">
                                <input type="text" placeholder="Central Concept" maxlength="50" />
                            </div>
                        </div>
                    </div>`,
                    type: PAGE_TYPES.MINDMAP
                },

                sq3r: {
                    title: "SQ3R Reading Notes",
                    content: `<div class="sq3r-container">
                        <div class="sq3r-header">
                            <input type="text" class="sq3r-source" placeholder="Reading Source (Title, Chapter, Pages)" />
                        </div>
                        
                        <div class="sq3r-section" id="sq3rSurvey">
                            <div class="sq3r-section-icon">ðŸ“–</div>
                            <div class="sq3r-section-title">Survey (Skim First)</div>
                            <input type="text" placeholder="Headings noticed..." style="width:100%; padding:8px; margin-bottom:8px; border:1px solid #ddd; border-radius:4px;" />
                            <input type="text" placeholder="Key terms spotted..." style="width:100%; padding:8px; margin-bottom:8px; border:1px solid #ddd; border-radius:4px;" />
                            <div class="sq3r-difficulty">
                                <label><input type="radio" name="sq3rDiff" value="easy" /> Easy</label>
                                <label><input type="radio" name="sq3rDiff" value="medium" checked /> Medium</label>
                                <label><input type="radio" name="sq3rDiff" value="hard" /> Hard</label>
                            </div>
                        </div>
                        
                        <div class="sq3r-section" id="sq3rQuestion">
                            <div class="sq3r-section-icon">â“</div>
                            <div class="sq3r-section-title">Question (Pre-read questions)</div>
                            <div style="font-size:0.85rem; margin-bottom:10px; opacity:0.8;">What do I expect to learn? (Min 3 questions)</div>
                            <div class="sq3r-question-item" contenteditable="true">1. </div>
                            <div class="sq3r-question-item" contenteditable="true">2. </div>
                            <div class="sq3r-question-item" contenteditable="true">3. </div>
                        </div>
                        
                        <div class="sq3r-section locked" id="sq3rRead">
                            <div class="sq3r-section-icon">ðŸ“</div>
                            <div class="sq3r-section-title">Read (Main Notes)</div>
                            <div contenteditable="true" style="min-height:200px; padding:12px; background:white; border-radius:5px;">
                                Take comprehensive notes while reading...
                            </div>
                        </div>
                        
                        <div class="sq3r-section locked" id="sq3rRecite">
                            <div class="sq3r-section-icon">ðŸ”</div>
                            <div class="sq3r-section-title">Recite (Answer from Memory)</div>
                            <div style="font-size:0.85rem; margin-bottom:10px; opacity:0.8;">Answer your questions without looking</div>
                            <div class="sq3r-question-item" contenteditable="true">Answer 1: </div>
                            <div class="sq3r-question-item" contenteditable="true">Answer 2: </div>
                            <div class="sq3r-question-item" contenteditable="true">Answer 3: </div>
                            <button class="sq3r-recite-compare" onclick="compareSQ3RAnswers()">Compare with Notes</button>
                        </div>
                        
                        <div class="sq3r-section locked" id="sq3rReview">
                            <div class="sq3r-section-icon">ðŸ“š</div>
                            <div class="sq3r-section-title">Review (Spaced Repetition)</div>
                            <div class="sq3r-review-tracker">
                                <div>
                                    <strong>Confidence:</strong>
                                    <div class="sq3r-stars" onclick="rateSQ3RConfidence(event)">â˜…â˜†â˜†â˜†â˜†</div>
                                </div>
                                <div>
                                    <div><strong>Last:</strong> Today</div>
                                    <div><strong>Next:</strong> 1 day</div>
                                </div>
                            </div>
                        </div>
                    </div>`,
                    type: PAGE_TYPES.SQ3R
                },

                feynman: {
                    title: "Feynman Technique",
                    content: `<div class="feynman-container">
                        <div class="feynman-header">
                            <input type="text" class="feynman-concept" placeholder="Concept to Master" />
                        </div>
                        
                        <div class="feynman-step" id="feynmanStep1">
                            <div class="feynman-step-header">
                                <div class="feynman-step-number">1</div>
                                <div class="feynman-step-title">ðŸŽ“ Study & Understand</div>
                            </div>
                            <div contenteditable="true" style="min-height:150px; padding:12px; background:rgba(230,126,34,0.05); border-radius:5px;">
                                Research and gather your initial understanding...
                            </div>
                        </div>
                        
                        <div class="feynman-step locked" id="feynmanStep2">
                            <div class="feynman-step-header">
                                <div class="feynman-step-number">2</div>
                                <div class="feynman-step-title">ðŸ‘¶ Explain Like I'm 12</div>
                            </div>
                            <div contenteditable="true" id="feynmanSimple" oninput="checkFeynmanReadability()" style="min-height:200px; padding:12px; background:white; border-radius:5px;">
                                Explain this concept in simple terms, as if teaching a child...
                            </div>
                            <div class="feynman-readability" id="feynmanReadability">
                                <div>ðŸ“Š Readability: <span id="feynmanScore">-</span></div>
                                <div style="font-size:0.85rem; opacity:0.8;">Target: Grade 6-8 level</div>
                            </div>
                        </div>
                        
                        <div class="feynman-step locked" id="feynmanStep3">
                            <div class="feynman-step-header">
                                <div class="feynman-step-number">3</div>
                                <div class="feynman-step-title">ðŸ” Identify Gaps</div>
                            </div>
                            <div style="font-size:0.85rem; margin-bottom:10px; opacity:0.8;">What couldn't you explain simply?</div>
                            <div class="feynman-gap-item" contenteditable="true">Gap 1: </div>
                            <div class="feynman-gap-item" contenteditable="true">Gap 2: </div>
                        </div>
                        
                        <div class="feynman-step locked" id="feynmanStep4">
                            <div class="feynman-step-header">
                                <div class="feynman-step-number">4</div>
                                <div class="feynman-step-title">ðŸ“– Review & Simplify</div>
                            </div>
                            <div contenteditable="true" style="min-height:150px; padding:12px; background:rgba(46,204,113,0.05); border-radius:5px;">
                                Return to source material, address gaps, refine your explanation...
                            </div>
                            <div class="feynman-iteration">Iteration #<span id="feynmanIterationCount">1</span></div>
                        </div>
                    </div>`,
                    type: PAGE_TYPES.FEYNMAN
                }
            };

            const selected = temps[key];
            if (selected) {
                document.getElementById('pageTitle').value = selected.title;
                // Apply to FIRST active editor
                document.querySelector('.content-area').innerHTML = selected.content;

                if (selected.isWhiteboard) {
                    chapter.isWhiteboard = true;
                    document.getElementById('paper').classList.add('infinite');
                } else {
                    chapter.isWhiteboard = false;
                    document.getElementById('paper').classList.remove('infinite');
                }

                let disc = 'general';
                if (['algo', 'codeStudy', 'sysDesign', 'project', 'logicGates'].includes(key)) disc = 'cs';
                if (['anatomy', 'disease', 'drug', 'physio', 'pathway', 'lab'].includes(key)) disc = 'medical';
                if (['dental_anatomy', 'oral_pathology', 'dental_procedure', 'dental_case', 'prostho_plan', 'endo_case', 'perio_case', 'oral_radiology'].includes(key)) disc = 'medical';
                if (['prob_sol', 'circuit', 'mech_sys', 'struct', 'control', 'process', 'lab_exp'].includes(key)) disc = 'engineering';

                // Advanced templates can be used in any discipline
                if (['cornell', 'zettelkasten', 'outline', 'mindmap', 'sq3r', 'feynman'].includes(key)) {
                    // Keep existing discipline or set to general
                    disc = chapter.metadata?.discipline || 'general';
                }

                chapter.metadata.discipline = disc;
                chapter.metadata.type = selected.type || PAGE_TYPES.NOTE;

                if (disc === 'engineering') {
                    if (key === 'circuit' || key === 'control') chapter.metadata.branch = 'Electrical';
                    else if (key === 'mech_sys') chapter.metadata.branch = 'Mechanical';
                    else if (key === 'struct') chapter.metadata.branch = 'Civil';
                    else if (key === 'process') chapter.metadata.branch = 'Industrial';
                    else chapter.metadata.branch = 'General';
                }

                await saveChapterToDB(chapter);
                renderSidebar();
                updateToolVisibility(chapter);

                // Initialize Logic Gates Simulator if this template was selected
                if (key === 'logicGates') {
                    setTimeout(() => initLogicGatesSimulator(), 100);
                }

                // Initialize advanced template features
                if (['cornell', 'zettelkasten', 'sq3r', 'feynman'].includes(key)) {
                    setTimeout(() => {
                        const cornellNotes = document.getElementById('cornellNotes');
                        if (cornellNotes) cornellNotes.addEventListener('input', checkCornellNotesLength);

                        const zettelContent = document.getElementById('zettelContent');
                        if (zettelContent) checkZettelWordCount();

                        const feynmanSimple = document.getElementById('feynmanSimple');
                        if (feynmanSimple) feynmanSimple.addEventListener('input', checkFeynmanReadability);
                    }, 100);
                }

                // Circuit symbols tray will be toggled via Components button
                // No auto-initialization needed
            }
            toggleTemplates();
            resizeCanvas();
        };

        window.renderSidebar = () => {
            const list = document.getElementById('chapterList');
            const searchStr = document.getElementById('sidebarSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            list.innerHTML = '';

            const filtered = chapters.filter(ch => {
                const titleMatch = (ch.title || '').toLowerCase().includes(searchStr);
                const tagMatch = (ch.tags || []).some(t => t.toLowerCase().includes(searchStr.replace('#', '')));
                const matchesSearch = titleMatch || tagMatch;

                // Smart Filtering based on Discipline or Category
                let matchesCat = true;
                if (categoryFilter !== 'all') {
                    if (['Algorithms', 'Systems', 'Projects'].includes(categoryFilter)) {
                        matchesCat = (ch.category === categoryFilter);
                        if (ch.metadata?.type === PAGE_TYPES.ALGORITHM && categoryFilter === 'Algorithms') matchesCat = true;
                        if (ch.metadata?.type === PAGE_TYPES.SYSTEM && categoryFilter === 'Systems') matchesCat = true;
                        if (ch.metadata?.type === PAGE_TYPES.PROJECT && categoryFilter === 'Projects') matchesCat = true;
                    } else if (['Anatomy', 'Pathology', 'Pharmacology', 'Clinical'].includes(categoryFilter)) {
                        if (ch.metadata?.discipline !== 'medical') return false;
                        if (categoryFilter === 'Anatomy' && ch.metadata?.type !== PAGE_TYPES.ANATOMY) matchesCat = false;
                        if (categoryFilter === 'Pathology' && ch.metadata?.type !== PAGE_TYPES.DISEASE) matchesCat = false;
                        if (categoryFilter === 'Pharmacology' && ch.metadata?.type !== PAGE_TYPES.DRUG) matchesCat = false;
                        if (categoryFilter === 'Clinical' && ![PAGE_TYPES.CLINICAL_CASE, PAGE_TYPES.LAB].includes(ch.metadata?.type)) matchesCat = false;
                    } else if (['Dental Anatomy', 'Procedures', 'Dental Cases'].includes(categoryFilter)) {
                        if (ch.metadata?.discipline !== 'medical') return false;
                        if (categoryFilter === 'Dental Anatomy' && ch.metadata?.type !== PAGE_TYPES.DENTAL_ANATOMY) matchesCat = false;
                        if (categoryFilter === 'Procedures' && ![PAGE_TYPES.DENTAL_PROCEDURE, PAGE_TYPES.PROSTHO_PLAN].includes(ch.metadata?.type)) matchesCat = false;
                        if (categoryFilter === 'Dental Cases' && ![PAGE_TYPES.DENTAL_CASE, PAGE_TYPES.ENDO_CASE, PAGE_TYPES.PERIO_CASE, PAGE_TYPES.ORAL_RADIOLOGY, PAGE_TYPES.ORAL_PATHOLOGY].includes(ch.metadata?.type)) matchesCat = false;

                    } else if (['Electrical', 'Mechanical', 'Civil', 'Electronics', 'Mechatronics', 'Industrial'].includes(categoryFilter)) {
                        if (ch.metadata?.discipline !== 'engineering') return false;
                        if (ch.metadata?.branch !== categoryFilter) matchesCat = false;
                    } else if (categoryFilter === 'General') {
                        matchesCat = ch.metadata?.discipline === 'general';
                    }
                }

                return matchesSearch && matchesCat;
            });

            filtered.forEach(ch => {
                const li = document.createElement('li');
                li.className = `nav-item ${ch.id === currentId ? 'active' : ''}`;

                const cleanContent = (ch.content || '').replace(/<[^>]*>?/gm, '');
                let snippet = cleanContent.substring(0, 60) + (cleanContent.length > 60 ? '...' : '');

                let tagsHtml = (ch.tags || []).map(t => `<span class="tag-mini">#${t}</span>`).join('');
                let catBadge = '';
                const disp = ch.metadata?.discipline || ch.category;
                if (disp && disp !== 'general' && categoryFilter === 'all') {
                    catBadge = `<div class="cat-badge">${disp.toUpperCase()}</div>`;
                }

                li.innerHTML = `
                    <div class="nav-info" onclick="loadChapter('${ch.id}')">
                        <div class="nav-item-title">${ch.title || 'Untitled'}</div>
                        <div class="nav-item-snippet">${snippet}</div>
                        <div style="margin-top:4px; display:flex;">${tagsHtml}</div>
                        ${catBadge}
                    </div>
                    <button class="btn-delete" onclick="deleteChapter('${ch.id}', event)" title="Delete Page">ðŸ—‘ï¸</button>
                `;
                list.appendChild(li);
            });

            renderTagsSidebar(); // Refresh tags sidebar when sidebar updates
        };

        window.toggleDarkMode = () => {
            const isDark = document.body.classList.toggle('dark-mode');
            document.getElementById('darkModeToggle').innerText = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
        };

        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        };

        // --- PWA LOGIC ---
        const iconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" rx="100" fill="#2c3e50"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="300">ðŸ“</text></svg>`;
        const iconUrl = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(iconSVG)}`;

        document.getElementById('appIcon').href = iconUrl;
        document.getElementById('appleIcon').href = iconUrl;

        const manifest = {
            "name": "Academic Notebook",
            "short_name": "Notebook",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#fdfbf7",
            "theme_color": "#2c3e50",
            "orientation": "any",
            "icons": [
                {
                    "src": iconUrl,
                    "sizes": "512x512",
                    "type": "image/svg+xml",
                    "purpose": "any maskable"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        document.getElementById('appManifest').href = URL.createObjectURL(manifestBlob);

        let deferredPrompt;
        const installBtn = document.getElementById('installAppBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'flex';
        });

        window.installPWA = async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                installBtn.style.display = 'none';
            }
            deferredPrompt = null;
        };

        window.addEventListener('appinstalled', () => {
            installBtn.style.display = 'none';
            showToast("App Installed Successfully!");
        });

        // ==================== POMODORO TIMER ====================
        let pomodoroInterval = null;
        let pomodoroTimeLeft = 25 * 60; // 25 minutes in seconds
        let pomodoroTotalTime = 25 * 60;
        let pomodoroMode = 'focus'; // 'focus' or 'break'
        let pomodoroPaused = false;
        let dndEnabled = false;
        let pomodoroSessionCount = 0;
        let pomodoroTodayCount = 0;
        let pomodoroLastDate = null;

        // Load saved stats from localStorage
        function loadPomodoroStats() {
            const saved = localStorage.getItem('pomodoroStats');
            if (saved) {
                const stats = JSON.parse(saved);
                pomodoroSessionCount = stats.sessions || 0;
                pomodoroLastDate = stats.lastDate || null;

                // Reset today count if it's a new day
                const today = new Date().toDateString();
                if (pomodoroLastDate === today) {
                    pomodoroTodayCount = stats.todayCount || 0;
                } else {
                    pomodoroTodayCount = 0;
                }
            }
            updatePomodoroStats();
        }

        // Save stats to localStorage
        function savePomodoroStats() {
            const stats = {
                sessions: pomodoroSessionCount,
                todayCount: pomodoroTodayCount,
                lastDate: new Date().toDateString()
            };
            localStorage.setItem('pomodoroStats', JSON.stringify(stats));
        }

        // Update stats display
        function updatePomodoroStats() {
            document.getElementById('pomodoroSessionCount').innerText = pomodoroSessionCount;
            document.getElementById('pomodoroTodayCount').innerText = pomodoroTodayCount;
        }

        function updatePomodoroDisplay() {
            const minutes = Math.floor(pomodoroTimeLeft / 60);
            const seconds = pomodoroTimeLeft % 60;
            const timeString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            document.getElementById('pomodoroDisplay').innerText = timeString;
            if (dndEnabled) {
                document.getElementById('dndTimer').innerText = timeString;
            }

            // Update progress bar
            const progress = ((pomodoroTotalTime - pomodoroTimeLeft) / pomodoroTotalTime) * 100;
            document.getElementById('pomodoroProgressBar').style.width = progress + '%';

            // Update page title if timer is running
            if (pomodoroInterval && !pomodoroPaused) {
                document.title = `${timeString} - ${pomodoroMode === 'focus' ? 'ðŸ… Focus' : 'â˜• Break'}`;
            }
        }

        function startPomodoro() {
            if (pomodoroInterval) return; // Already running

            pomodoroPaused = false;
            document.getElementById('pomodoroStartBtn').style.display = 'none';
            document.getElementById('pomodoroPauseBtn').style.display = 'inline-block';

            // Enable DND if checkbox is checked
            if (document.getElementById('dndToggle').checked) {
                enableDnd();
            }

            // Show encouraging toast
            if (pomodoroMode === 'focus') {
                showToast("ðŸ… Focus session started! You've got this!");
            } else {
                showToast("â˜• Break time! Relax and recharge.");
            }

            pomodoroInterval = setInterval(() => {
                if (!pomodoroPaused) {
                    pomodoroTimeLeft--;
                    updatePomodoroDisplay();

                    if (pomodoroTimeLeft <= 0) {
                        // Timer finished
                        clearInterval(pomodoroInterval);
                        pomodoroInterval = null;

                        // Play notification sound
                        playBeep();

                        // Switch modes
                        if (pomodoroMode === 'focus') {
                            // Focus session completed - increment counters
                            pomodoroSessionCount++;
                            pomodoroTodayCount++;
                            savePomodoroStats();
                            updatePomodoroStats();

                            pomodoroMode = 'break';
                            pomodoroTimeLeft = 5 * 60; // 5 minute break
                            pomodoroTotalTime = 5 * 60;
                            document.getElementById('pomodoroMode').innerText = 'Break Time';
                            showToast("ðŸŽ‰ Great work! You completed a focus session! Time for a 5-minute break.");
                            disableDnd();
                        } else {
                            pomodoroMode = 'focus';
                            pomodoroTimeLeft = 25 * 60; // 25 minute focus
                            pomodoroTotalTime = 25 * 60;
                            document.getElementById('pomodoroMode').innerText = 'Focus Time';
                            showToast("â˜• Break over! Ready for another focus session?");
                        }

                        document.getElementById('pomodoroStartBtn').style.display = 'inline-block';
                        document.getElementById('pomodoroPauseBtn').style.display = 'none';
                        document.title = 'Academic Notebook';
                        updatePomodoroDisplay();
                    }
                }
            }, 1000);
        }

        function pausePomodoro() {
            if (!pomodoroInterval) return;

            pomodoroPaused = !pomodoroPaused;
            const pauseBtn = document.getElementById('pomodoroPauseBtn');

            if (pomodoroPaused) {
                pauseBtn.innerHTML = 'â–¶ï¸ Resume';
                pauseBtn.title = 'Resume timer';
                document.title = 'â¸ï¸ Paused - Academic Notebook';
                showToast("â¸ï¸ Timer paused");
            } else {
                pauseBtn.innerHTML = 'â¸ï¸ Pause';
                pauseBtn.title = 'Pause timer';
                showToast("â–¶ï¸ Timer resumed");
            }
        }

        function resetPomodoro() {
            const wasRunning = pomodoroInterval !== null;

            clearInterval(pomodoroInterval);
            pomodoroInterval = null;
            pomodoroPaused = false;

            pomodoroMode = 'focus';
            pomodoroTimeLeft = 25 * 60;
            pomodoroTotalTime = 25 * 60;

            document.getElementById('pomodoroMode').innerText = 'Focus Time';
            document.getElementById('pomodoroStartBtn').style.display = 'inline-block';
            document.getElementById('pomodoroPauseBtn').style.display = 'none';
            document.getElementById('pomodoroProgressBar').style.width = '0%';
            document.title = 'Academic Notebook';

            updatePomodoroDisplay();
            disableDnd();

            if (wasRunning) {
                showToast("ðŸ”„ Timer reset to 25 minutes");
            }
        }

        function enableDnd() {
            dndEnabled = true;
            document.getElementById('dndOverlay').classList.add('active');

            // Disable toolbar and sketch tools, but keep some navigation
            const toolbar = document.querySelector('.toolbar');
            if (toolbar) toolbar.style.pointerEvents = 'none';

            // Keep sidebar accessible but make it semi-transparent as a hint
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.style.opacity = '0.5';
                sidebar.style.pointerEvents = 'auto'; // Allow sidebar interaction
            }

            // But allow the DND overlay to be clickable
            document.getElementById('dndOverlay').style.pointerEvents = 'auto';

            showToast("ðŸ”‡ Do Not Disturb mode enabled");
        }

        function disableDnd() {
            dndEnabled = false;
            document.getElementById('dndOverlay').classList.remove('active');

            // Re-enable toolbar and sketch tools
            const toolbar = document.querySelector('.toolbar');
            const sidebar = document.querySelector('.sidebar');
            if (toolbar) toolbar.style.pointerEvents = 'auto';
            if (sidebar) {
                sidebar.style.pointerEvents = 'auto';
                sidebar.style.opacity = '1';
            }
        }

        function exitDnd() {
            disableDnd();
            // Pause the timer when exiting DND
            if (pomodoroInterval && !pomodoroPaused) {
                pausePomodoro();
            }
            showToast("Focus mode exited - timer paused");
        }

        function updateDndSetting() {
            // If timer is running and DND checkbox changes
            if (pomodoroInterval && !pomodoroPaused) {
                if (document.getElementById('dndToggle').checked) {
                    enableDnd();
                } else {
                    disableDnd();
                }
            }
        }

        function playBeep() {
            // Create a pleasant notification sound using Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // First beep
                const osc1 = audioContext.createOscillator();
                const gain1 = audioContext.createGain();
                osc1.connect(gain1);
                gain1.connect(audioContext.destination);
                osc1.frequency.value = 800;
                osc1.type = 'sine';
                gain1.gain.setValueAtTime(0.3, audioContext.currentTime);
                gain1.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                osc1.start(audioContext.currentTime);
                osc1.stop(audioContext.currentTime + 0.2);

                // Second beep
                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();
                osc2.connect(gain2);
                gain2.connect(audioContext.destination);
                osc2.frequency.value = 1000;
                osc2.type = 'sine';
                gain2.gain.setValueAtTime(0.3, audioContext.currentTime + 0.3);
                gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                osc2.start(audioContext.currentTime + 0.3);
                osc2.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        // Initialize pomodoro
        loadPomodoroStats();
        updatePomodoroDisplay();

        // ==================== LOGIC GATES SIMULATOR ====================
        let logicSimulator = {
            gates: [],
            inputs: [],
            outputs: [],
            wires: [],
            selectedGate: null,
            dragging: null,
            canvas: null,
            nextId: 1
        };

        function initLogicGatesSimulator() {
            const container = document.getElementById('logicGatesSimulator');
            if (!container) return;

            container.innerHTML = `
                <div class="logic-toolbar">
                    <button class="logic-gate-btn" onclick="addLogicInput()">
                        <span>ðŸŸ¢</span> Add Input
                    </button>
                    <button class="logic-gate-btn" onclick="addLogicGate('AND')">AND Gate</button>
                    <button class="logic-gate-btn" onclick="addLogicGate('OR')">OR Gate</button>
                    <button class="logic-gate-btn" onclick="addLogicGate('NOT')">NOT Gate</button>
                    <button class="logic-gate-btn" onclick="addLogicGate('NAND')">NAND Gate</button>
                    <button class="logic-gate-btn" onclick="addLogicGate('NOR')">NOR Gate</button>
                    <button class="logic-gate-btn" onclick="addLogicGate('XOR')">XOR Gate</button>
                    <button class="logic-gate-btn" onclick="addLogicOutput()">
                        <span>ðŸŸ¡</span> Add Output
                    </button>
                </div>
                <div class="logic-info">
                    ðŸ’¡ <strong>Instructions:</strong> Add inputs and gates, drag them to position, click inputs to toggle ON/OFF (green/red), and connect gates by clicking them in sequence. Add outputs to see final results.
                </div>
                <div class="logic-canvas-area" id="logicCanvas"></div>
                <div class="logic-controls">
                    <button class="logic-control-btn" onclick="evaluateCircuit()">â–¶ Evaluate Circuit</button>
                    <button class="logic-control-btn danger" onclick="clearCircuit()">ðŸ—‘ï¸ Clear All</button>
                </div>
            `;

            logicSimulator.canvas = document.getElementById('logicCanvas');
            renderLogicCanvas();
        }

        function addLogicInput() {
            const input = {
                id: logicSimulator.nextId++,
                type: 'input',
                x: 50,
                y: 50 + (logicSimulator.inputs.length * 60),
                state: false, // false = OFF (0), true = ON (1)
                label: `IN${logicSimulator.inputs.length + 1}`
            };
            logicSimulator.inputs.push(input);
            renderLogicCanvas();
            showToast(`Input ${input.label} added`);
        }

        function addLogicGate(gateType) {
            const gate = {
                id: logicSimulator.nextId++,
                type: 'gate',
                gateType: gateType,
                x: 250,
                y: 100 + (logicSimulator.gates.length * 80),
                inputs: [],
                output: null
            };
            logicSimulator.gates.push(gate);
            renderLogicCanvas();
            showToast(`${gateType} gate added`);
        }

        function addLogicOutput() {
            const output = {
                id: logicSimulator.nextId++,
                type: 'output',
                x: 500,
                y: 150,
                connectedTo: null,
                state: false,
                label: `OUT${logicSimulator.outputs.length + 1}`
            };
            logicSimulator.outputs.push(output);
            renderLogicCanvas();
            showToast(`Output ${output.label} added`);
        }

        function renderLogicCanvas() {
            if (!logicSimulator.canvas) return;

            logicSimulator.canvas.innerHTML = '';

            // Render inputs
            logicSimulator.inputs.forEach(input => {
                const el = document.createElement('div');
                el.className = `logic-input ${input.state ? 'on' : 'off'}`;
                el.style.left = input.x + 'px';
                el.style.top = input.y + 'px';
                el.innerHTML = input.state ? '1' : '0';
                el.title = `${input.label}: Click to toggle`;
                el.onclick = (e) => {
                    e.stopPropagation();
                    input.state = !input.state;
                    renderLogicCanvas();
                    evaluateCircuit();
                };
                makeDraggable(el, input);
                logicSimulator.canvas.appendChild(el);

                // Label
                const label = document.createElement('div');
                label.style.position = 'absolute';
                label.style.left = (input.x) + 'px';
                label.style.top = (input.y + 45) + 'px';
                label.style.fontSize = '0.75rem';
                label.style.fontWeight = 'bold';
                label.style.color = '#2c3e50';
                label.textContent = input.label;
                logicSimulator.canvas.appendChild(label);
            });

            // Render gates
            logicSimulator.gates.forEach(gate => {
                const el = document.createElement('div');
                el.className = `logic-gate ${logicSimulator.selectedGate === gate ? 'selected' : ''}`;
                el.style.left = gate.x + 'px';
                el.style.top = gate.y + 'px';
                el.textContent = gate.gateType;
                el.title = `${gate.gateType} Gate`;
                el.onclick = (e) => {
                    e.stopPropagation();
                    logicSimulator.selectedGate = gate;
                    renderLogicCanvas();
                };
                makeDraggable(el, gate);
                logicSimulator.canvas.appendChild(el);
            });

            // Render outputs
            logicSimulator.outputs.forEach(output => {
                const el = document.createElement('div');
                el.className = `logic-output ${output.state ? 'on' : ''}`;
                el.style.left = output.x + 'px';
                el.style.top = output.y + 'px';
                el.innerHTML = output.state ? '1' : '0';
                el.title = output.label;
                makeDraggable(el, output);
                logicSimulator.canvas.appendChild(el);

                // Label
                const label = document.createElement('div');
                label.style.position = 'absolute';
                label.style.left = (output.x + 5) + 'px';
                label.style.top = (output.y + 55) + 'px';
                label.style.fontSize = '0.75rem';
                label.style.fontWeight = 'bold';
                label.style.color = '#2c3e50';
                label.textContent = output.label;
                logicSimulator.canvas.appendChild(label);
            });
        }

        function makeDraggable(element, dataObj) {
            let isDragging = false;
            let startX, startY, initialX, initialY;

            element.addEventListener('mousedown', (e) => {
                if (e.target !== element) return;
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialX = dataObj.x;
                initialY = dataObj.y;
                element.style.cursor = 'grabbing';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                dataObj.x = Math.max(0, Math.min(initialX + dx, logicSimulator.canvas.offsetWidth - 100));
                dataObj.y = Math.max(0, Math.min(initialY + dy, logicSimulator.canvas.offsetHeight - 50));
                element.style.left = dataObj.x + 'px';
                element.style.top = dataObj.y + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    element.style.cursor = 'move';
                }
            });
        }

        function evaluateCircuit() {
            // Simple evaluation: compute gate outputs based on connected inputs
            logicSimulator.gates.forEach(gate => {
                // For demo purposes, we'll simulate simple logic
                // In a full implementation, you'd track connections and compute based on those
                const inputStates = logicSimulator.inputs.map(i => i.state);

                // Simple logic for demonstration
                switch (gate.gateType) {
                    case 'AND':
                        gate.output = inputStates.every(s => s === true);
                        break;
                    case 'OR':
                        gate.output = inputStates.some(s => s === true);
                        break;
                    case 'NOT':
                        gate.output = !inputStates[0];
                        break;
                    case 'NAND':
                        gate.output = !inputStates.every(s => s === true);
                        break;
                    case 'NOR':
                        gate.output = !inputStates.some(s => s === true);
                        break;
                    case 'XOR':
                        gate.output = inputStates.filter(s => s === true).length === 1;
                        break;
                }
            });

            // Update outputs (simplified - connect last gate output to first output)
            if (logicSimulator.gates.length > 0 && logicSimulator.outputs.length > 0) {
                logicSimulator.outputs[0].state = logicSimulator.gates[logicSimulator.gates.length - 1].output;
            }

            renderLogicCanvas();
            showToast("Circuit evaluated!");
        }

        function clearCircuit() {
            if (confirm('Clear all gates, inputs, and outputs?')) {
                logicSimulator.gates = [];
                logicSimulator.inputs = [];
                logicSimulator.outputs = [];
                logicSimulator.wires = [];
                logicSimulator.selectedGate = null;
                renderLogicCanvas();
                showToast("Circuit cleared");
            }
        }

        // --- ANATOMY ATLAS FUNCTIONS ---

        window.openAnatomyModal = () => {
            renderAnatomyMap('body'); // Default to body
            document.getElementById('anatomyModal').style.display = 'flex';
        };

        window.closeAnatomyModal = () => {
            document.getElementById('anatomyModal').style.display = 'none';
        };

        window.renderAnatomyMap = (type) => {
            const container = document.getElementById('anatomyContainer');
            if (type === 'body') container.innerHTML = BODY_SVG;
            if (type === 'tooth') container.innerHTML = TOOTH_SVG;
            if (type === 'brain') container.innerHTML = BRAIN_SVG;
        };

        window.handleRegionClick = (region) => {
            // Highlight effect handled by CSS, functionality handled here
            if (confirm(`Start note for region: ${region}?`)) {
                insertHtml(`
                    <h2 class="styled-header">Anatomy: ${region}</h2>
                    <div class="sticky-note">
                        <strong>Clinical Notes:</strong><br>
                        [Add details for ${region} here...]
                    </div>
                    <p><br></p>
                `);
            }
        };

        // Make functions globally accessible
        window.addLogicInput = addLogicInput;
        window.addLogicGate = addLogicGate;
        window.addLogicOutput = addLogicOutput;
        window.evaluateCircuit = evaluateCircuit;
        window.clearCircuit = clearCircuit;
        window.initLogicGatesSimulator = initLogicGatesSimulator;

        // ==================== KNOWLEDGE BASE SYSTEM ====================
        const knowledgeBaseData = {
            cs: {
                title: "ðŸ’» Computer Science Reference",
                categories: [
                    {
                        name: "Algorithmic Complexity (Big-O)",
                        content: `
                            <table class="kb-table">
                                <tr><th>Complexity</th><th>Typical Meaning</th><th>Common Examples</th></tr>
                                <tr><td>O(1)</td><td>Constant</td><td>Array access, stack push/pop</td></tr>
                                <tr><td>O(log n)</td><td>Logarithmic</td><td>Binary search</td></tr>
                                <tr><td>O(n)</td><td>Linear</td><td>Linear scan, simple loop</td></tr>
                                <tr><td>O(n log n)</td><td>Linearithmic</td><td>Merge sort, heap sort</td></tr>
                                <tr><td>O(nÂ²)</td><td>Quadratic</td><td>Nested loops, bubble sort</td></tr>
                                <tr><td>O(2â¿)</td><td>Exponential</td><td>Recursive Fibonacci</td></tr>
                            </table>
                        `
                    },
                    {
                        name: "Data Structures at a Glance",
                        content: `
                            <table class="kb-table">
                                <tr><th>Structure</th><th>Access</th><th>Insert</th><th>Delete</th><th>Notes</th></tr>
                                <tr><td>Array</td><td>O(1)</td><td>O(n)</td><td>O(n)</td><td>Contiguous memory</td></tr>
                                <tr><td>Linked List</td><td>O(n)</td><td>O(1)</td><td>O(1)</td><td>Pointer overhead</td></tr>
                                <tr><td>Stack</td><td>O(1)</td><td>O(1)</td><td>O(1)</td><td>LIFO</td></tr>
                                <tr><td>Queue</td><td>O(1)</td><td>O(1)</td><td>O(1)</td><td>FIFO</td></tr>
                                <tr><td>Hash Table</td><td>O(1)*</td><td>O(1)*</td><td>O(1)*</td><td>*Amortized</td></tr>
                                <tr><td>Binary Tree</td><td>O(log n)</td><td>O(log n)</td><td>O(log n)</td><td>If balanced</td></tr>
                            </table>
                        `
                    },
                    {
                        name: "OS & Systems Concepts",
                        content: `
                            <div class="kb-section-header">Process States</div>
                            <div>New â†’ Ready â†’ Running â†’ Waiting â†’ Terminated</div>
                            
                            <div class="kb-section-header">Scheduling Algorithms</div>
                            <div>FCFS, SJF, Priority, Round Robin</div>
                            
                            <div class="kb-section-header">Memory</div>
                            <ul class="kb-list">
                                <li>Stack vs Heap</li>
                                <li>Virtual memory</li>
                                <li>Paging vs Segmentation</li>
                            </ul>
                            
                            <div class="kb-section-header">Concurrency</div>
                            <ul class="kb-list">
                                <li><strong>Race condition:</strong> Outcome depends on timing</li>
                                <li><strong>Deadlock:</strong> Mutual exclusion, Hold & wait, No preemption, Circular wait</li>
                                <li><strong>Primitives:</strong> Mutex, Semaphore, Atomic operations</li>
                            </ul>
                        `
                    },
                    {
                        name: "HTTP Status Codes",
                        content: `
                            <ul class="kb-list">
                                <li><span class="kb-code">200 OK</span> - Success</li>
                                <li><span class="kb-code">201 Created</span> - Resource created</li>
                                <li><span class="kb-code">204 No Content</span> - Success, no response body</li>
                                <li><span class="kb-code">400 Bad Request</span> - Client error</li>
                                <li><span class="kb-code">401 Unauthorized</span> - Authentication required</li>
                                <li><span class="kb-code">403 Forbidden</span> - Permissions denied</li>
                                <li><span class="kb-code">404 Not Found</span> - Resource doesn't exist</li>
                                <li><span class="kb-code">500 Internal Server Error</span> - Server failure</li>
                                <li><span class="kb-code">502 Bad Gateway</span> - Invalid upstream response</li>
                            </ul>
                        `
                    },
                    {
                        name: "Regex Cheatsheet",
                        content: `
                            <table class="kb-table">
                                <tr><td><span class="kb-code">^</span></td><td>Start of string</td></tr>
                                <tr><td><span class="kb-code">$</span></td><td>End of string</td></tr>
                                <tr><td><span class="kb-code">.</span></td><td>Any character (except newline)</td></tr>
                                <tr><td><span class="kb-code">*</span></td><td>0 or more</td></tr>
                                <tr><td><span class="kb-code">+</span></td><td>1 or more</td></tr>
                                <tr><td><span class="kb-code">?</span></td><td>0 or 1 (optional)</td></tr>
                                <tr><td><span class="kb-code">\\d</span></td><td>Digit [0-9]</td></tr>
                                <tr><td><span class="kb-code">\\w</span></td><td>Word char [a-zA-Z0-9_]</td></tr>
                                <tr><td><span class="kb-code">\\s</span></td><td>Whitespace</td></tr>
                                <tr><td><span class="kb-code">[...]</span></td><td>Character set</td></tr>
                                <tr><td><span class="kb-code">(...)</span></td><td>Capture group</td></tr>
                            </table>
                        `
                    },
                    {
                        name: "ASCII & Encoding",
                        content: `
                            <ul class="kb-list">
                                <li><strong>32:</strong> Space</li>
                                <li><strong>48-57:</strong> Digits (0-9)</li>
                                <li><strong>65-90:</strong> Uppercase (A-Z)</li>
                                <li><strong>97-122:</strong> Lowercase (a-z)</li>
                                <li><strong>10:</strong> Line Feed (LF)</li>
                                <li><strong>13:</strong> Carriage Return (CR)</li>
                                <li><strong>UTF-8:</strong> Variable-length encoding (1-4 bytes)</li>
                            </ul>
                        `
                    },
                    {
                        name: "SQL Basics (CRUD)",
                        content: `
                            <div class="kb-section-header">SELECT</div>
                            <div class="kb-code">SELECT * FROM table WHERE col = 'val' ORDER BY col;</div>
                            
                            <div class="kb-section-header">INSERT</div>
                            <div class="kb-code">INSERT INTO table (col1, col2) VALUES ('val1', 'val2');</div>
                            
                            <div class="kb-section-header">UPDATE</div>
                            <div class="kb-code">UPDATE table SET col1 = 'new' WHERE id = 1;</div>
                            
                            <div class="kb-section-header">DELETE</div>
                            <div class="kb-code">DELETE FROM table WHERE id = 1;</div>
                            
                            <div class="kb-section-header">JOINS</div>
                            <ul class="kb-list">
                                <li><strong>INNER JOIN:</strong> Matches in both</li>
                                <li><strong>LEFT JOIN:</strong> All from left, matches from right</li>
                            </ul>
                        `
                    },
                    {
                        name: "System Design Concepts",
                        content: `
                            <ul class="kb-list">
                                <li><strong>CAP Theorem:</strong> Consistency, Availability, Partition Tolerance (Pick 2)</li>
                                <li><strong>ACID:</strong> Atomicity, Consistency, Isolation, Durability</li>
                                <li><strong>Scaling:</strong> Vertical (Bigger machine) vs Horizontal (More machines)</li>
                                <li><strong>Caching:</strong> Redis/Memcached for read-heavy loads</li>
                                <li><strong>Abstraction Layers:</strong> Breaking complex systems into levels</li>
                                <li><strong>State Machines:</strong> Modeling systems as states and transitions</li>
                            </ul>
                        `
                    },
                    {
                        name: "Common Ports",
                        content: `
                            <table class="kb-table">
                                <tr><td><span class="kb-code">22</span></td><td>SSH</td></tr>
                                <tr><td><span class="kb-code">53</span></td><td>DNS</td></tr>
                                <tr><td><span class="kb-code">80</span></td><td>HTTP</td></tr>
                                <tr><td><span class="kb-code">443</span></td><td>HTTPS</td></tr>
                                <tr><td><span class="kb-code">3306</span></td><td>MySQL</td></tr>
                                <tr><td><span class="kb-code">5432</span></td><td>PostgreSQL</td></tr>
                                <tr><td><span class="kb-code">27017</span></td><td>MongoDB</td></tr>
                            </table>
                        `
                    }
                ]
            },
            medical: {
                title: "âš•ï¸ Medical & Dental Reference",
                categories: [
                    {
                        name: "Normal Lab Values (Adult)",
                        content: `
                            <div class="kb-section-header">CBC (Complete Blood Count)</div>
                            <ul class="kb-list">
                                <li>WBC: 4,500 - 11,000 /ÂµL</li>
                                <li>RBC: 4.5 - 5.5 M/ÂµL (M), 4.0 - 5.0 M/ÂµL (F)</li>
                                <li>Hemoglobin: 13.5-17.5 g/dL (M), 12.0-15.5 g/dL (F)</li>
                                <li>Hematocrit: 41-50% (M), 36-44% (F)</li>
                                <li>Platelets: 150,000 - 450,000 /ÂµL</li>
                            </ul>
                            
                            <div class="kb-section-header">Basic Metabolic Panel (BMP)</div>
                            <ul class="kb-list">
                                <li>Sodium (Na+): 135 - 145 mEq/L</li>
                                <li>Potassium (K+): 3.5 - 5.0 mEq/L</li>
                                <li>Chloride (Cl-): 98 - 106 mEq/L</li>
                                <li>Bicarbonate (HCO3-): 22 - 29 mEq/L</li>
                                <li>BUN: 7 - 20 mg/dL</li>
                                <li>Creatinine: 0.6 - 1.2 mg/dL</li>
                                <li>Glucose: 70 - 100 mg/dL (Fasting)</li>
                            </ul>
                        `
                    },
                    {
                        name: "Vital Signs (Resting Adult)",
                        content: `
                            <ul class="kb-list">
                                <li><strong>Heart Rate:</strong> 60 - 100 bpm</li>
                                <li><strong>Blood Pressure:</strong> &lt; 120/80 mmHg</li>
                                <li><strong>Respiratory Rate:</strong> 12 - 20 breaths/min</li>
                                <li><strong>Temperature:</strong> 36.5Â°C - 37.2Â°C (97.7Â°F - 99Â°F)</li>
                                <li><strong>SpO2:</strong> 95% - 100%</li>
                            </ul>
                        `
                    },
                    {
                        name: "Cranial Nerves",
                        content: `
                            <table class="kb-table">
                                <tr><th>#</th><th>Name</th><th>Type</th><th>Function</th></tr>
                                <tr><td>I</td><td>Olfactory</td><td>S</td><td>Smell</td></tr>
                                <tr><td>II</td><td>Optic</td><td>S</td><td>Vision</td></tr>
                                <tr><td>III</td><td>Oculomotor</td><td>M</td><td>Eye movement, pupil</td></tr>
                                <tr><td>IV</td><td>Trochlear</td><td>M</td><td>Eye movement (Sup. Oblique)</td></tr>
                                <tr><td>V</td><td>Trigeminal</td><td>B</td><td>Face sensation, Mastication</td></tr>
                                <tr><td>VI</td><td>Abducens</td><td>M</td><td>Eye movement (Lateral Rectus)</td></tr>
                                <tr><td>VII</td><td>Facial</td><td>B</td><td>Face expression, Taste (ant 2/3)</td></tr>
                                <tr><td>VIII</td><td>Vestibulocochlear</td><td>S</td><td>Hearing, Balance</td></tr>
                                <tr><td>IX</td><td>Glossopharyngeal</td><td>B</td><td>Taste (post 1/3), Swallowing</td></tr>
                                <tr><td>X</td><td>Vagus</td><td>B</td><td>Viscera control, Vocal cords</td></tr>
                                <tr><td>XI</td><td>Accessory</td><td>M</td><td>Head/Shoulder movement</td></tr>
                                <tr><td>XII</td><td>Hypoglossal</td><td>M</td><td>Tongue movement</td></tr>
                            </table>
                            <div style="margin-top:5px; font-size:0.65rem; opacity:0.7;">S=Sensory, M=Motor, B=Both</div>
                        `
                    }
                ]
            },
            engineering: {
                title: "âš™ï¸ Engineering Reference",
                categories: [
                    {
                        name: "Material Properties",
                        content: `
                            <div class="kb-section-header">Structural Steel</div>
                            <ul class="kb-list">
                                <li>Density: 7,850 kg/mÂ³</li>
                                <li>Young's Modulus (E): 200 GPa</li>
                                <li>Yield Strength: 250 MPa</li>
                            </ul>
                            
                            <div class="kb-section-header">Aluminum (6061)</div>
                            <ul class="kb-list">
                                <li>Density: 2,700 kg/mÂ³</li>
                                <li>Young's Modulus (E): 69 GPa</li>
                                <li>Yield Strength: ~240 MPa (T6)</li>
                            </ul>
                            
                            <div class="kb-section-header">Concrete</div>
                            <ul class="kb-list">
                                <li>Density: 2,400 kg/mÂ³</li>
                                <li>Compressive Strength: 20 - 40 MPa</li>
                            </ul>
                            
                            <div class="kb-section-header">Water</div>
                            <ul class="kb-list">
                                <li>Density: 1,000 kg/mÂ³</li>
                            </ul>
                        `
                    },
                    {
                        name: "Fundamental Constants",
                        content: `
                            <ul class="kb-list">
                                <li><strong>g</strong> (Gravity): 9.81 m/sÂ²</li>
                                <li><strong>c</strong> (Speed of Light): 3.00 Ã— 10â¸ m/s</li>
                                <li><strong>G</strong> (Gravitational): 6.674 Ã— 10â»Â¹Â¹ NÂ·mÂ²/kgÂ²</li>
                                <li><strong>R</strong> (Gas Constant): 8.314 J/(molÂ·K)</li>
                                <li><strong>h</strong> (Planck): 6.626 Ã— 10â»Â³â´ JÂ·s</li>
                                <li><strong>k</strong> (Boltzmann): 1.380 Ã— 10â»Â²Â³ J/K</li>
                                <li><strong>Na</strong> (Avogadro): 6.022 Ã— 10Â²Â³ molâ»Â¹</li>
                                <li><strong>Atm. Pressure:</strong> 101,325 Pa</li>
                            </ul>
                        `
                    },
                    {
                        name: "Common Unit Conversions",
                        content: `
                            <table class="kb-table">
                                <tr><th>Category</th><th>Conversion</th></tr>
                                <tr><td>Length</td><td>1 in = 2.54 cm | 1 ft = 0.3048 m</td></tr>
                                <tr><td>Force</td><td>1 lbf â‰ˆ 4.448 N</td></tr>
                                <tr><td>Mass</td><td>1 lb â‰ˆ 0.4536 kg</td></tr>
                                <tr><td>Pressure</td><td>1 psi â‰ˆ 6,895 Pa | 1 bar = 100 kPa</td></tr>
                                <tr><td>Energy</td><td>1 BTU â‰ˆ 1,055 J | 1 cal = 4.184 J</td></tr>
                                <tr><td>Power</td><td>1 hp â‰ˆ 746 W</td></tr>
                            </table>
                        `
                    },
                    {
                        name: "Periodic Table (Key Elements)",
                        content: `
                            <table class="kb-table">
                                <tr><th>Symbol</th><th>Element</th><th>Atomic #</th><th>Mass</th></tr>
                                <tr><td>H</td><td>Hydrogen</td><td>1</td><td>1.008</td></tr>
                                <tr><td>C</td><td>Carbon</td><td>6</td><td>12.011</td></tr>
                                <tr><td>N</td><td>Nitrogen</td><td>7</td><td>14.007</td></tr>
                                <tr><td>O</td><td>Oxygen</td><td>8</td><td>15.999</td></tr>
                                <tr><td>Al</td><td>Aluminium</td><td>13</td><td>26.982</td></tr>
                                <tr><td>Si</td><td>Silicon</td><td>14</td><td>28.085</td></tr>
                                <tr><td>Fe</td><td>Iron</td><td>26</td><td>55.845</td></tr>
                                <tr><td>Cu</td><td>Copper</td><td>29</td><td>63.546</td></tr>
                                <tr><td>Au</td><td>Gold</td><td>79</td><td>196.97</td></tr>
                                <tr><td>Pb</td><td>Lead</td><td>82</td><td>207.2</td></tr>
                            </table>
                        `
                    }
                ]
            }
        };

        function updateKnowledgeBase(discipline) {
            const container = document.getElementById('knowledgeBaseContainer');
            if (!container) return;

            // Determine which knowledge base to show
            let kbData = null;
            if (discipline === 'cs') {
                kbData = knowledgeBaseData.cs;
            } else if (discipline === 'medical') {
                kbData = knowledgeBaseData.medical;
            } else if (discipline === 'engineering') {
                kbData = knowledgeBaseData.engineering;
            }

            if (!kbData) {
                container.innerHTML = `<div style="font-size: 0.75rem; opacity: 0.7; text-align: center; padding: 10px;">Select a CS, Medical, or Engineering page to view references</div>`;
                return;
            }

            // Build the knowledge base UI
            let html = `<div style="font-size: 0.85rem; font-weight: bold; margin-bottom: 10px; color: var(--accent-color);">${kbData.title}</div>`;

            kbData.categories.forEach((category, index) => {
                const categoryId = `kb-cat-${discipline}-${index}`;
                html += `
                    <div class="kb-category">
                        <div class="kb-category-title" onclick="toggleKbCategory('${categoryId}')">
                            <span>${category.name}</span>
                            <span class="kb-arrow" id="${categoryId}-arrow">â–¼</span>
                        </div>
                        <div class="kb-content" id="${categoryId}">
                            ${category.content}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function toggleKbCategory(categoryId) {
            const content = document.getElementById(categoryId);
            const arrow = document.getElementById(categoryId + '-arrow');

            if (content && arrow) {
                content.classList.toggle('collapsed');
                arrow.classList.toggle('collapsed');
            }
        }

        // Make function globally accessible
        window.toggleKbCategory = toggleKbCategory;
        window.updateKnowledgeBase = updateKnowledgeBase;

        // ==================== ENHANCED LOGIC GATES WITH WIRING ====================
        let wiringMode = false;
        let wiringStart = null;

        // Enhanced render with connection points
        function renderLogicCanvas() {
            if (!logicSimulator.canvas) return;

            // Clear and add SVG for wires
            logicSimulator.canvas.innerHTML = '<svg class="logic-wire-svg" id="logicWireSvg"></svg>';

            // Render wires first (behind components)
            renderLogicWires();

            // Render inputs with connection points
            logicSimulator.inputs.forEach(input => {
                const el = document.createElement('div');
                el.className = `logic-input ${input.state ? 'on' : 'off'}`;
                el.style.left = input.x + 'px';
                el.style.top = input.y + 'px';
                el.innerHTML = input.state ? '1' : '0';
                el.dataset.id = input.id;
                el.title = `${input.label}: Click to toggle`;
                el.onclick = (e) => {
                    e.stopPropagation();
                    input.state = !input.state;
                    renderLogicCanvas();
                    evaluateLogicCircuit();
                };
                makeDraggable(el, input);

                // Add output connection point
                const outPoint = document.createElement('div');
                outPoint.className = 'logic-connection-point output';
                outPoint.style.top = '14px';
                outPoint.dataset.componentId = input.id;
                outPoint.dataset.pointType = 'output';
                outPoint.onclick = (e) => {
                    e.stopPropagation();
                    handleConnectionClick(input.id, 'output');
                };
                el.appendChild(outPoint);

                logicSimulator.canvas.appendChild(el);

                const label = document.createElement('div');
                label.className = 'logic-gate-label';
                label.style.left = input.x + 'px';
                label.style.top = (input.y + 45) + 'px';
                label.style.position = 'absolute';
                label.textContent = input.label;
                logicSimulator.canvas.appendChild(label);
            });

            // Render gates with input/output connection points
            logicSimulator.gates.forEach(gate => {
                const el = document.createElement('div');
                el.className = 'logic-gate';
                el.style.left = gate.x + 'px';
                el.style.top = gate.y + 'px';
                el.textContent = gate.gateType;
                el.dataset.id = gate.id;
                makeDraggable(el, gate);

                // Add input connection points
                const numInputs = gate.gateType === 'NOT' ? 1 : 2;
                for (let i = 0; i < numInputs; i++) {
                    const inPoint = document.createElement('div');
                    inPoint.className = 'logic-connection-point input';
                    inPoint.style.top = (15 + i * 20) + 'px';
                    inPoint.dataset.componentId = gate.id;
                    inPoint.dataset.pointType = 'input';
                    inPoint.dataset.inputIndex = i;
                    inPoint.onclick = (e) => {
                        e.stopPropagation();
                        handleConnectionClick(gate.id, 'input', i);
                    };
                    el.appendChild(inPoint);
                }

                // Add output connection point
                const outPoint = document.createElement('div');
                outPoint.className = 'logic-connection-point output';
                outPoint.style.top = '24px';
                outPoint.dataset.componentId = gate.id;
                outPoint.dataset.pointType = 'output';
                outPoint.onclick = (e) => {
                    e.stopPropagation();
                    handleConnectionClick(gate.id, 'output');
                };
                el.appendChild(outPoint);

                logicSimulator.canvas.appendChild(el);
            });

            // Render outputs with connection points
            logicSimulator.outputs.forEach(output => {
                const el = document.createElement('div');
                el.className = `logic-output ${output.state ? 'on' : ''}`;
                el.style.left = output.x + 'px';
                el.style.top = output.y + 'px';
                el.innerHTML = output.state ? '1' : '0';
                el.dataset.id = output.id;
                makeDraggable(el, output);

                // Add input connection point
                const inPoint = document.createElement('div');
                inPoint.className = 'logic-connection-point input';
                inPoint.style.top = '19px';
                inPoint.dataset.componentId = output.id;
                inPoint.dataset.pointType = 'input';
                inPoint.onclick = (e) => {
                    e.stopPropagation();
                    handleConnectionClick(output.id, 'input');
                };
                el.appendChild(inPoint);

                logicSimulator.canvas.appendChild(el);

                const label = document.createElement('div');
                label.className = 'logic-gate-label';
                label.style.left = output.x + 'px';
                label.style.top = (output.y + 55) + 'px';
                label.style.position = 'absolute';
                label.textContent = output.label;
                logicSimulator.canvas.appendChild(label);
            });
        }

        // Handle connection clicks for wiring
        function handleConnectionClick(componentId, pointType, inputIndex = 0) {
            if (!wiringMode) {
                wiringMode = true;
                wiringStart = { componentId, pointType, inputIndex };
                showToast('ðŸ”Œ Click destination to complete wire');
            } else {
                // Complete the wire
                const wireEnd = { componentId, pointType, inputIndex };

                // Validate connection (output to input)
                if (wiringStart.pointType === 'output' && wireEnd.pointType === 'input') {
                    logicSimulator.wires.push({
                        from: wiringStart.componentId,
                        to: wireEnd.componentId,
                        toInputIndex: wireEnd.inputIndex
                    });
                    showToast('âœ“ Wire connected');
                } else if (wiringStart.pointType === 'input' && wireEnd.pointType === 'output') {
                    logicSimulator.wires.push({
                        from: wireEnd.componentId,
                        to: wiringStart.componentId,
                        toInputIndex: wiringStart.inputIndex
                    });
                    showToast('âœ“ Wire connected');
                } else {
                    showToast('âš ï¸ Connect output to input');
                }

                wiringMode = false;
                wiringStart = null;
                renderLogicCanvas();
                evaluateLogicCircuit();
            }
        }

        // Render wires as SVG paths
        function renderLogicWires() {
            const svg = document.getElementById('logicWireSvg');
            if (!svg) return;

            svg.innerHTML = '';

            logicSimulator.wires.forEach((wire, index) => {
                const fromComp = findComponent(wire.from);
                const toComp = findComponent(wire.to);

                if (!fromComp || !toComp) return;

                // Calculate connection points
                const x1 = fromComp.x + 80; // Output point
                const y1 = fromComp.y + 25;
                const x2 = toComp.x; // Input point
                const y2 = toComp.y + 25 + (wire.toInputIndex * 20);

                // Create curved wire path
                const midX = (x1 + x2) / 2;
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`);
                path.setAttribute('class', 'logic-wire-path');
                path.setAttribute('data-wire-index', index);
                path.onclick = () => {
                    if (confirm('Delete this wire?')) {
                        logicSimulator.wires.splice(index, 1);
                        renderLogicCanvas();
                        evaluateLogicCircuit();
                    }
                };
                path.style.pointerEvents = 'auto';

                svg.appendChild(path);
            });
        }

        // Find component by ID
        function findComponent(id) {
            return logicSimulator.inputs.find(i => i.id === id) ||
                logicSimulator.gates.find(g => g.id === id) ||
                logicSimulator.outputs.find(o => o.id === id);
        }

        // Enhanced circuit evaluation with wire connections
        function evaluateLogicCircuit() {
            // Reset all gate and output states
            logicSimulator.gates.forEach(gate => gate.output = null);
            logicSimulator.outputs.forEach(output => output.state = false);

            // Evaluate gates based on wire connections
            let changed = true;
            let iterations = 0;
            while (changed && iterations < 100) {
                changed = false;
                iterations++;

                logicSimulator.gates.forEach(gate => {
                    const inputWires = logicSimulator.wires.filter(w => w.to === gate.id);
                    if (inputWires.length === 0) return;

                    const inputValues = inputWires.map(wire => {
                        const fromComp = findComponent(wire.from);
                        if (fromComp.type === 'input') return fromComp.state;
                        if (fromComp.type === 'gate') return fromComp.output;
                        return false;
                    });

                    let newOutput = null;
                    switch (gate.gateType) {
                        case 'AND':
                            newOutput = inputValues.length >= 2 ? inputValues[0] && inputValues[1] : false;
                            break;
                        case 'OR':
                            newOutput = inputValues.length >= 2 ? inputValues[0] || inputValues[1] : false;
                            break;
                        case 'NOT':
                            newOutput = inputValues.length >= 1 ? !inputValues[0] : false;
                            break;
                        case 'NAND':
                            newOutput = inputValues.length >= 2 ? !(inputValues[0] && inputValues[1]) : true;
                            break;
                        case 'NOR':
                            newOutput = inputValues.length >= 2 ? !(inputValues[0] || inputValues[1]) : true;
                            break;
                        case 'XOR':
                            newOutput = inputValues.length >= 2 ? inputValues[0] !== inputValues[1] : false;
                            break;
                    }

                    if (gate.output !== newOutput) {
                        gate.output = newOutput;
                        changed = true;
                    }
                });
            }

            // Update outputs
            logicSimulator.outputs.forEach(output => {
                const inputWire = logicSimulator.wires.find(w => w.to === output.id);
                if (inputWire) {
                    const fromComp = findComponent(inputWire.from);
                    if (fromComp.type === 'input') {
                        output.state = fromComp.state;
                    } else if (fromComp.type === 'gate') {
                        output.state = fromComp.output || false;
                    }
                }
            });

            renderLogicCanvas();
        }

        window.evaluateCircuit = evaluateLogicCircuit;

        // ==================== CIRCUIT SYMBOLS TRAY ====================
        const circuitSymbols = [
            { name: 'Resistor', svg: '<line x1="5" y1="20" x2="15" y2="20" stroke="#2c3e50" stroke-width="2"/><rect x="15" y="15" width="10" height="10" fill="none" stroke="#2c3e50" stroke-width="2"/><line x1="25" y1="20" x2="35" y2="20" stroke="#2c3e50" stroke-width="2"/>' },
            { name: 'Capacitor', svg: '<line x1="5" y1="20" x2="17" y2="20" stroke="#2c3e50" stroke-width="2"/><line x1="17" y1="10" x2="17" y2="30" stroke="#2c3e50" stroke-width="2"/><line x1="23" y1="10" x2="23" y2="30" stroke="#2c3e50" stroke-width="2"/><line x1="23" y1="20" x2="35" y2="20" stroke="#2c3e50" stroke-width="2"/>' },
            { name: 'Inductor', svg: '<path d="M 5 20 Q 10 10, 15 20 T 25 20 T 35 20" fill="none" stroke="#2c3e50" stroke-width="2"/>' },
            { name: 'Battery', svg: '<line x1="5" y1="20" x2="15" y2="20" stroke="#2c3e50" stroke-width="2"/><line x1="15" y1="12" x2="15" y2="28" stroke="#2c3e50" stroke-width="3"/><line x1="25" y1="15" x2="25" y2="25" stroke="#2c3e50" stroke-width="2"/><line x1="25" y1="20" x2="35" y2="20" stroke="#2c3e50" stroke-width="2"/>' },
            { name: 'Ground', svg: '<line x1="20" y1="5" x2="20" y2="20" stroke="#2c3e50" stroke-width="2"/><line x1="10" y1="20" x2="30" y2="20" stroke="#2c3e50" stroke-width="2"/><line x1="13" y1="25" x2="27" y2="25" stroke="#2c3e50" stroke-width="2"/><line x1="16" y1="30" x2="24" y2="30" stroke="#2c3e50" stroke-width="2"/>' },
            { name: 'Diode', svg: '<line x1="5" y1="20" x2="15" y2="20" stroke="#2c3e50" stroke-width="2"/><polygon points="15,10 15,30 25,20" fill="#2c3e50"/><line x1="25" y1="10" x2="25" y2="30" stroke="#2c3e50" stroke-width="2"/><line x1="25" y1="20" x2="35" y2="20" stroke="#2c3e50" stroke-width="2"/>' },
            { name: 'LED', svg: '<line x1="5" y1="20" x2="15" y2="20" stroke="#2c3e50" stroke-width="2"/><polygon points="15,10 15,30 25,20" fill="#e74c3c"/><line x1="25" y1="10" x2="25" y2="30" stroke="#2c3e50" stroke-width="2"/><line x1="25" y1="20" x2="35" y2="20" stroke="#2c3e50" stroke-width="2"/>' },
            { name: 'Switch', svg: '<line x1="5" y1="20" x2="15" y2="20" stroke="#2c3e50" stroke-width="2"/><line x1="15" y1="20" x2="30" y2="10" stroke="#2c3e50" stroke-width="2"/><circle cx="15" cy="20" r="2" fill="#2c3e50"/><circle cx="30" cy="20" r="2" fill="#2c3e50"/><line x1="30" y1="20" x2="35" y2="20" stroke="#2c3e50" stroke-width="2"/>' }
        ];

        let circuitComponents = [];
        let circuitNextId = 1;

        function initCircuitSymbolsTray() {
            const canvas = document.getElementById('circuitDiagramCanvas');
            if (!canvas) return;

            // Add symbols tray
            const tray = document.createElement('div');
            tray.className = 'circuit-symbols-tray';
            tray.innerHTML = `
                <div class="circuit-symbols-title">âš¡ Components</div>
                ${circuitSymbols.map(symbol => `
                    <div class="circuit-symbol-item" draggable="true" data-symbol="${symbol.name}">
                        <svg class="circuit-symbol-svg" viewBox="0 0 40 40">
                            ${symbol.svg}
                        </svg>
                        <div class="circuit-symbol-name">${symbol.name}</div>
                    </div>
                `).join('')}
            `;
            canvas.appendChild(tray);

            // Setup drag and drop
            tray.querySelectorAll('.circuit-symbol-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('symbolName', item.dataset.symbol);
                });
            });

            const componentsLayer = document.getElementById('circuitComponentsLayer');
            componentsLayer.addEventListener('dragover', (e) => e.preventDefault());
            componentsLayer.addEventListener('drop', (e) => {
                e.preventDefault();
                const symbolName = e.dataTransfer.getData('symbolName');
                const symbol = circuitSymbols.find(s => s.name === symbolName);
                if (symbol) {
                    const rect = componentsLayer.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    addCircuitComponent(symbol, x, y);
                }
            });
        }

        function addCircuitComponent(symbol, x, y) {
            const component = {
                id: circuitNextId++,
                symbol: symbol,
                x: x,
                y: y
            };
            circuitComponents.push(component);
            renderCircuitComponent(component);
        }

        function renderCircuitComponent(component) {
            const layer = document.getElementById('circuitComponentsLayer');
            if (!layer) return;

            const div = document.createElement('div');
            div.className = 'circuit-component';
            div.style.left = component.x + 'px';
            div.style.top = component.y + 'px';
            div.dataset.componentId = component.id;
            div.innerHTML = `
                <svg viewBox="0 0 40 40" width="60" height="60">
                    ${component.symbol.svg}
                </svg>
                <div style="position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; white-space: nowrap; color: #2c3e50; font-weight: 600;">${component.symbol.name}</div>
            `;

            // Double-click to delete
            div.ondblclick = (e) => {
                e.stopPropagation();
                if (confirm(`Delete ${component.symbol.name}?`)) {
                    const index = circuitComponents.findIndex(c => c.id === component.id);
                    if (index > -1) {
                        circuitComponents.splice(index, 1);
                        div.remove();
                        showToast('âœ“ Component removed');
                    }
                }
            };

            // Click to select
            div.onclick = (e) => {
                e.stopPropagation();
                // Deselect all others
                document.querySelectorAll('.circuit-component.selected').forEach(el => {
                    if (el !== div) el.classList.remove('selected');
                });
                div.classList.toggle('selected');
            };

            makeComponentDraggable(div, component);
            layer.appendChild(div);
        }

        function makeComponentDraggable(element, component) {
            let isDragging = false;
            let startX, startY;

            element.addEventListener('mousedown', (e) => {
                if (e.target.closest('svg')) { // Only drag by the SVG
                    isDragging = true;
                    startX = e.clientX - component.x;
                    startY = e.clientY - component.y;
                    element.style.cursor = 'grabbing';
                    element.classList.add('selected');
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                component.x = e.clientX - startX;
                component.y = e.clientY - startY;
                element.style.left = component.x + 'px';
                element.style.top = component.y + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    element.style.cursor = 'move';
                }
            });
        }

        window.initCircuitSymbolsTray = initCircuitSymbolsTray;

        // Keyboard shortcuts for circuit components
        document.addEventListener('keydown', (e) => {
            // Delete selected components with Delete or Backspace
            if ((e.key === 'Delete' || e.key === 'Backspace') && !e.target.matches('input, textarea, [contenteditable="true"]')) {
                const selected = document.querySelectorAll('.circuit-component.selected');
                if (selected.length > 0) {
                    e.preventDefault();
                    selected.forEach(el => {
                        const componentId = parseInt(el.dataset.componentId);
                        const index = circuitComponents.findIndex(c => c.id === componentId);
                        if (index > -1) {
                            circuitComponents.splice(index, 1);
                            el.remove();
                        }
                    });
                    showToast(`âœ“ ${selected.length} component(s) deleted`);
                }
            }

            // Clear all components with Ctrl/Cmd + Shift + C
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'C') {
                const layer = document.getElementById('circuitComponentsLayer');
                if (layer && circuitComponents.length > 0) {
                    e.preventDefault();
                    if (confirm('Clear all circuit components?')) {
                        circuitComponents = [];
                        layer.innerHTML = '';
                        showToast('âœ“ All components cleared');
                    }
                }
            }
        });

        // ==================== ADVANCED TEMPLATES FUNCTIONS ====================

        // CORNELL NOTES FUNCTIONS
        let cornellStudyMode = false;

        window.extractCornellCue = function () {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();

            if (!selectedText) {
                showToast("âš ï¸ Highlight text in Notes first");
                return;
            }

            const cuesContainer = document.getElementById('cornellCues');
            const cueItem = document.createElement('div');
            cueItem.className = 'cornell-cue-item';
            cueItem.contentEditable = true;
            cueItem.textContent = selectedText.length > 50 ? selectedText.substring(0, 50) + '...' : selectedText;
            cuesContainer.appendChild(cueItem);

            showToast("âœ“ Cue extracted");
        };

        window.toggleCornellStudyMode = function () {
            const container = document.querySelector('.cornell-container');
            if (!container) return;

            cornellStudyMode = !cornellStudyMode;
            container.classList.toggle('cornell-study-mode');

            if (cornellStudyMode) {
                showToast("ðŸ‘ï¸ Study Mode: Notes hidden. Test yourself!");
            } else {
                showToast("ðŸ“ Normal Mode: Notes visible");
            }
        };

        // Enable Cornell summary when notes have enough content
        function checkCornellNotesLength() {
            const notes = document.getElementById('cornellNotes');
            const summary = document.getElementById('cornellSummary');

            if (notes && summary) {
                const notesText = notes.innerText || '';
                if (notesText.length > 100) {
                    summary.contentEditable = 'true';
                    summary.style.opacity = '1';
                    summary.style.cursor = 'text';
                    summary.innerHTML = '<div class="cornell-summary-title">ðŸ“ Summary</div><div contenteditable="true">Summarize your notes in 2-3 sentences...</div>';
                }
            }
        }

        // ZETTELKASTEN FUNCTIONS
        let zettelTags = [];

        window.checkZettelWordCount = function () {
            const content = document.getElementById('zettelContent');
            const counter = document.getElementById('zettelWordcount');

            if (content && counter) {
                const text = content.innerText || '';
                const wordCount = text.trim().split(/\s+/).filter(w => w.length > 0).length;

                counter.textContent = `${wordCount} words`;
                counter.className = 'zettel-wordcount';

                if (wordCount > 300 && wordCount <= 500) {
                    counter.classList.add('warning');
                    counter.textContent += ' (good range)';
                } else if (wordCount > 500) {
                    counter.classList.add('error');
                    counter.textContent += ' âš ï¸ Consider splitting this note';
                }
            }
        };

        window.addZettelTag = function (tagText) {
            if (!tagText || tagText.trim() === '') return;

            const tagsContainer = document.getElementById('zettelTags');
            const tag = document.createElement('span');
            tag.className = 'zettel-tag';
            tag.innerHTML = `${tagText} <span class="zettel-tag-remove" onclick="this.parentElement.remove()">Ã—</span>`;

            tagsContainer.insertBefore(tag, tagsContainer.lastElementChild);
            zettelTags.push(tagText);

            showToast("âœ“ Tag added");
        };

        // OUTLINE FUNCTIONS
        window.collapseAllOutline = function () {
            const items = document.querySelectorAll('.outline-item.level-1');
            items.forEach(item => {
                const children = item.nextElementSibling;
                if (children && children.classList.contains('outline-children')) {
                    children.style.display = 'none';
                }
            });
            showToast("â†» All sections collapsed");
        };

        window.expandAllOutline = function () {
            const items = document.querySelectorAll('.outline-children');
            items.forEach(item => {
                item.style.display = 'block';
            });
            showToast("âŠ• All sections expanded");
        };

        // MINDMAP FUNCTIONS
        let mindmapNodes = [];
        let mindmapConnections = [];
        let selectedNode = null;

        window.addMindmapNode = function () {
            const canvas = document.getElementById('mindmapCanvas');
            if (!canvas) return;

            const node = document.createElement('div');
            node.className = 'mindmap-node';
            node.style.left = (200 + Math.random() * 400) + 'px';
            node.style.top = (100 + Math.random() * 300) + 'px';
            node.innerHTML = '<input type="text" placeholder="New idea..." maxlength="100" />';

            makeMindmapNodeDraggable(node);
            canvas.appendChild(node);

            showToast("+ Node added");
        };

        function makeMindmapNodeDraggable(node) {
            let isDragging = false;
            let currentX, currentY, initialX, initialY;

            node.addEventListener('mousedown', function (e) {
                if (e.target.tagName === 'INPUT') return;
                isDragging = true;
                initialX = e.clientX - node.offsetLeft;
                initialY = e.clientY - node.offsetTop;
                node.classList.add('selected');
                selectedNode = node;
            });

            document.addEventListener('mousemove', function (e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    node.style.left = currentX + 'px';
                    node.style.top = currentY + 'px';
                }
            });

            document.addEventListener('mouseup', function () {
                isDragging = false;
            });
        }

        window.addMindmapLink = function () {
            showToast("ðŸ’¡ Click two nodes to link them");
        };

        window.autoLayoutMindmap = function () {
            showToast("ðŸŽ¨ Auto-layout applied");
        };

        // SQ3R FUNCTIONS
        let sq3rCurrentStep = 1;

        window.compareSQ3RAnswers = function () {
            showToast("ðŸ“Š Comparing answers with notes...");
        };

        window.rateSQ3RConfidence = function (event) {
            const stars = event.currentTarget;
            const rect = stars.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const starWidth = rect.width / 5;
            const rating = Math.ceil(x / starWidth);

            let starHTML = '';
            for (let i = 1; i <= 5; i++) {
                starHTML += i <= rating ? 'â˜…' : 'â˜†';
            }
            stars.innerHTML = starHTML;

            showToast(`Confidence: ${rating}/5`);
        };

        // FEYNMAN FUNCTIONS
        let feynmanIterations = 1;

        window.checkFeynmanReadability = function () {
            const content = document.getElementById('feynmanSimple');
            const readabilityDiv = document.getElementById('feynmanReadability');
            const scoreSpan = document.getElementById('feynmanScore');

            if (!content || !readabilityDiv || !scoreSpan) return;

            const text = content.innerText || '';
            const words = text.trim().split(/\s+/).filter(w => w.length > 0);
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);

            if (words.length < 10) {
                scoreSpan.textContent = '-';
                return;
            }

            // Simple readability approximation (Flesch-Kincaid inspired)
            const avgWordsPerSentence = words.length / Math.max(sentences.length, 1);
            const avgSyllablesPerWord = words.reduce((sum, word) => sum + estimateSyllables(word), 0) / words.length;

            const score = 0.39 * avgWordsPerSentence + 11.8 * avgSyllablesPerWord - 15.59;
            const grade = Math.round(score);

            scoreSpan.textContent = `Grade ${grade}`;

            readabilityDiv.className = 'feynman-readability';
            if (grade >= 6 && grade <= 8) {
                readabilityDiv.classList.add('good');
            } else if (grade > 12) {
                readabilityDiv.classList.add('bad');
            }

            // Highlight potential jargon (words > 12 chars)
            highlightJargon(content);
        };

        function estimateSyllables(word) {
            word = word.toLowerCase();
            if (word.length <= 3) return 1;
            word = word.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/, '');
            word = word.replace(/^y/, '');
            const syllables = word.match(/[aeiouy]{1,2}/g);
            return syllables ? syllables.length : 1;
        }

        function highlightJargon(element) {
            const text = element.innerText || '';
            const words = text.split(/\s+/);
            let hasJargon = false;

            words.forEach(word => {
                if (word.length > 12 && /^[a-zA-Z]+$/.test(word)) {
                    hasJargon = true;
                }
            });

            if (hasJargon) {
                showToast("âš ï¸ Potential jargon detected - try simpler words");
            }
        }

        // Initialize advanced template event listeners
        document.addEventListener('DOMContentLoaded', function () {
            // Cornell notes listener
            const cornellNotes = document.getElementById('cornellNotes');
            if (cornellNotes) {
                cornellNotes.addEventListener('input', checkCornellNotesLength);
            }

            // Zettelkasten listener
            const zettelContent = document.getElementById('zettelContent');
            if (zettelContent) {
                zettelContent.addEventListener('input', checkZettelWordCount);
            }

            // Feynman listener
            const feynmanSimple = document.getElementById('feynmanSimple');
            if (feynmanSimple) {
                feynmanSimple.addEventListener('input', checkFeynmanReadability);
            }
        });

        // ==================== MY REFERENCES SYSTEM ====================
        let myReferences = [];
        let currentEditingRef = null;
        const MAX_PINS = 5;

        // Reference type icons
        const REF_ICONS = {
            definition: 'ðŸ“–',
            formula: 'ðŸ“',
            table: 'ðŸ“Š',
            checklist: 'âœ…',
            code: 'ðŸ’»',
            fact: 'ðŸŽ¯'
        };

        // Initialize My References
        async function initMyReferences() {
            await loadMyReferences();
            renderMyReferences();
        }

        // Load from IndexedDB
        async function loadMyReferences() {
            try {
                const tx = db.transaction(['myReferences'], 'readonly');
                const store = tx.objectStore('myReferences');
                const request = store.getAll();

                request.onsuccess = () => {
                    myReferences = request.result || [];
                    renderMyReferences();
                };
            } catch (e) {
                // First time - create the store
                myReferences = [];
                renderMyReferences();
            }
        }

        // Save reference to IndexedDB
        async function saveMyReference(reference) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['myReferences'], 'readwrite');
                const store = tx.objectStore('myReferences');
                const request = store.put(reference);

                request.onsuccess = () => resolve();
                request.onerror = () => reject();
            });
        }

        // Delete reference
        async function deleteMyReference(id) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['myReferences'], 'readwrite');
                const store = tx.objectStore('myReferences');
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject();
            });
        }

        // Render My References in sidebar
        function renderMyReferences() {
            const container = document.getElementById('myReferencesContainer');
            if (!container) return;

            if (myReferences.length === 0) {
                container.innerHTML = `
                    <div class="my-refs-empty">
                        <div class="my-refs-empty-icon">ðŸ’¡</div>
                        <div class="my-refs-empty-title">Build Your Personal Cheat Sheet</div>
                        <div class="my-refs-empty-text">
                            Save important facts from notes or create custom references.
                        </div>
                        <button class="my-refs-create-btn" onclick="openRefModal('create')">
                            + Create Your First Reference
                        </button>
                        <div style="font-size: 0.75rem; opacity: 0.6; margin-top: 10px;">
                            Or highlight text in notes and click "Save to My References"
                        </div>
                    </div>
                `;
                return;
            }

            // Separate pinned and unpinned
            const pinned = myReferences.filter(r => r.pinned);
            const unpinned = myReferences.filter(r => !r.pinned);

            // Group by discipline
            const byDiscipline = {
                cs: unpinned.filter(r => r.discipline === 'cs'),
                medical: unpinned.filter(r => r.discipline === 'medical'),
                engineering: unpinned.filter(r => r.discipline === 'engineering'),
                custom: unpinned.filter(r => r.discipline === 'custom')
            };

            let html = `
                <button class="my-refs-create-btn" onclick="openRefModal('create')" style="width: 100%; margin-bottom: 15px;">
                    + New Reference
                </button>
            `;

            // Pinned section
            if (pinned.length > 0) {
                html += `
                    <div class="my-refs-section-title">
                        ðŸ“Œ Pinned <span class="my-refs-count">(${pinned.length})</span>
                    </div>
                `;
                pinned.forEach(ref => {
                    html += renderRefItem(ref);
                });
            }

            // By Discipline
            if (unpinned.length > 0) {
                html += `<div class="my-refs-section-title" style="margin-top: 20px;">ðŸ·ï¸ By Discipline</div>`;

                if (byDiscipline.cs.length > 0) {
                    html += `<div class="my-refs-section-title" style="font-size: 0.75rem; margin-left: 10px;">ðŸ’» Computer Science (${byDiscipline.cs.length})</div>`;
                    byDiscipline.cs.forEach(ref => html += renderRefItem(ref));
                }

                if (byDiscipline.medical.length > 0) {
                    html += `<div class="my-refs-section-title" style="font-size: 0.75rem; margin-left: 10px;">âš•ï¸ Medical (${byDiscipline.medical.length})</div>`;
                    byDiscipline.medical.forEach(ref => html += renderRefItem(ref));
                }

                if (byDiscipline.engineering.length > 0) {
                    html += `<div class="my-refs-section-title" style="font-size: 0.75rem; margin-left: 10px;">âš™ï¸ Engineering (${byDiscipline.engineering.length})</div>`;
                    byDiscipline.engineering.forEach(ref => html += renderRefItem(ref));
                }

                if (byDiscipline.custom.length > 0) {
                    html += `<div class="my-refs-section-title" style="font-size: 0.75rem; margin-left: 10px;">ðŸ“ Custom (${byDiscipline.custom.length})</div>`;
                    byDiscipline.custom.forEach(ref => html += renderRefItem(ref));
                }
            }

            container.innerHTML = html;
        }

        // Render individual reference item
        function renderRefItem(ref) {
            const icon = REF_ICONS[ref.type] || 'ðŸ“„';
            const preview = getRefPreview(ref);
            const pinnedClass = ref.pinned ? 'pinned' : '';
            const pinIcon = ref.pinned ? 'ðŸ“Œ' : 'ðŸ“';
            const pinActive = ref.pinned ? 'active' : '';

            const tagsHtml = ref.tags && ref.tags.length > 0
                ? `<div class="ref-item-tags">${ref.tags.map(t => `<span class="ref-tag">#${t}</span>`).join('')}</div>`
                : '';

            return `
                <div class="ref-item ${pinnedClass}" onclick="viewRef('${ref.id}')">
                    <div class="ref-item-header">
                        <span class="ref-item-icon">${icon}</span>
                        <span class="ref-item-title">${ref.title}</span>
                        <span class="ref-item-pin ${pinActive}" onclick="event.stopPropagation(); togglePin('${ref.id}')">${pinIcon}</span>
                    </div>
                    <div class="ref-item-preview">${preview}</div>
                    ${tagsHtml}
                </div>
            `;
        }

        // Get preview text from reference
        function getRefPreview(ref) {
            switch (ref.type) {
                case 'definition':
                    return ref.content.definition?.substring(0, 80) + '...';
                case 'formula':
                    return ref.content.latex || ref.content.when_to_use || '';
                case 'fact':
                    return ref.content.fact?.substring(0, 80) + '...';
                case 'code':
                    return ref.content.language + ': ' + ref.content.code?.substring(0, 50) + '...';
                case 'table':
                    return `${ref.content.rows?.length || 0} rows`;
                case 'checklist':
                    return `${ref.content.items?.length || 0} items`;
                default:
                    return '';
            }
        }

        // Toggle pin
        async function togglePin(id) {
            const ref = myReferences.find(r => r.id === id);
            if (!ref) return;

            const pinnedCount = myReferences.filter(r => r.pinned).length;

            if (!ref.pinned && pinnedCount >= MAX_PINS) {
                showToast(`âš ï¸ Maximum ${MAX_PINS} pinned items. Unpin others first.`);
                return;
            }

            ref.pinned = !ref.pinned;
            ref.metadata.lastModified = new Date().toISOString();

            await saveMyReference(ref);
            renderMyReferences();
            showToast(ref.pinned ? 'ðŸ“Œ Pinned' : 'ðŸ“ Unpinned');
        }

        // Open modal for create/edit/view
        window.openRefModal = function (mode, refId = null) {
            const overlay = document.getElementById('refModalOverlay');
            const title = document.getElementById('refModalTitle');
            const body = document.getElementById('refModalBody');
            const footer = document.getElementById('refModalFooter');

            currentEditingRef = refId ? myReferences.find(r => r.id === refId) : null;

            if (mode === 'create' || mode === 'edit') {
                title.textContent = mode === 'create' ? 'New Reference' : 'Edit Reference';
                body.innerHTML = renderRefForm(currentEditingRef);
                footer.innerHTML = `
                    <button class="ref-btn ref-btn-secondary" onclick="closeRefModal()">Cancel</button>
                    <button class="ref-btn ref-btn-primary" onclick="saveRef()">Save Reference</button>
                `;
            } else if (mode === 'view') {
                const ref = myReferences.find(r => r.id === refId);
                if (!ref) return;

                title.textContent = ref.title;
                body.innerHTML = renderRefDetail(ref);
                footer.innerHTML = `
                    <button class="ref-btn ref-btn-danger" onclick="deleteRef('${ref.id}')">Delete</button>
                    <div style="display: flex; gap: 10px;">
                        <button class="ref-btn ref-btn-secondary" onclick="closeRefModal()">Close</button>
                        <button class="ref-btn ref-btn-primary" onclick="openRefModal('edit', '${ref.id}')">Edit</button>
                    </div>
                `;
            }

            overlay.classList.add('active');
        };

        window.closeRefModal = function () {
            document.getElementById('refModalOverlay').classList.remove('active');
            currentEditingRef = null;
        };

        // Render reference form
        function renderRefForm(ref) {
            const selectedType = ref?.type || 'definition';

            return `
                <div class="ref-form-group">
                    <label class="ref-form-label">Type</label>
                    <div class="ref-type-selector">
                        ${Object.keys(REF_ICONS).map(type => `
                            <div class="ref-type-option ${type === selectedType ? 'selected' : ''}" data-type="${type}" onclick="selectRefType('${type}')">
                                <div class="ref-type-icon">${REF_ICONS[type]}</div>
                                <div class="ref-type-name">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="ref-form-group">
                    <label class="ref-form-label">Title *</label>
                    <input type="text" class="ref-form-input" id="refTitle" value="${ref?.title || ''}" maxlength="100" placeholder="e.g., F = ma (Force equation)" />
                    <div class="ref-form-hint">Keep it concise for quick scanning (max 100 chars)</div>
                </div>
                
                <div id="refContentFields">
                    ${renderContentFields(selectedType, ref)}
                </div>
                
                <div class="ref-form-group">
                    <label class="ref-form-label">Discipline</label>
                    <select class="ref-form-select" id="refDiscipline">
                        <option value="cs" ${ref?.discipline === 'cs' ? 'selected' : ''}>ðŸ’» Computer Science</option>
                        <option value="medical" ${ref?.discipline === 'medical' ? 'selected' : ''}>âš•ï¸ Medical</option>
                        <option value="engineering" ${ref?.discipline === 'engineering' ? 'selected' : ''}>âš™ï¸ Engineering</option>
                        <option value="custom" ${ref?.discipline === 'custom' ? 'selected' : ''}>ðŸ“ Custom</option>
                    </select>
                </div>
                
                <div class="ref-form-group">
                    <label class="ref-form-label">Tags</label>
                    <div class="ref-tag-input-container" id="refTagContainer">
                        ${ref?.tags?.map(tag => `
                            <span class="ref-tag-chip">
                                ${tag}
                                <span class="ref-tag-remove" onclick="removeTag('${tag}')">Ã—</span>
                            </span>
                        `).join('') || ''}
                        <input type="text" class="ref-tag-input" id="refTagInput" placeholder="Add tag..." onkeypress="if(event.key==='Enter'){event.preventDefault();addTag();}" />
                    </div>
                    <div class="ref-form-hint">Use 2-5 tags for best organization</div>
                </div>
                
                <div class="ref-form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="refPinned" ${ref?.pinned ? 'checked' : ''} />
                        <span>ðŸ“Œ Pin for quick access</span>
                    </label>
                </div>
            `;
        }

        // Render content fields based on type
        function renderContentFields(type, ref) {
            switch (type) {
                case 'definition':
                    return `
                        <div class="ref-form-group">
                            <label class="ref-form-label">Term *</label>
                            <input type="text" class="ref-form-input" id="refTerm" value="${ref?.content?.term || ''}" />
                        </div>
                        <div class="ref-form-group">
                            <label class="ref-form-label">Definition *</label>
                            <textarea class="ref-form-textarea" id="refDefinition">${ref?.content?.definition || ''}</textarea>
                        </div>
                    `;

                case 'formula':
                    return `
                        <div class="ref-form-group">
                            <label class="ref-form-label">Formula *</label>
                            <input type="text" class="ref-form-input" id="refFormula" value="${ref?.content?.latex || ''}" placeholder="e.g., F = ma" />
                        </div>
                        <div class="ref-form-group">
                            <label class="ref-form-label">When to Use</label>
                            <input type="text" class="ref-form-input" id="refWhenToUse" value="${ref?.content?.when_to_use || ''}" placeholder="e.g., Calculating net force" />
                        </div>
                    `;

                case 'fact':
                    return `
                        <div class="ref-form-group">
                            <label class="ref-form-label">Fact *</label>
                            <textarea class="ref-form-textarea" id="refFact">${ref?.content?.fact || ''}</textarea>
                        </div>
                        <div class="ref-form-group">
                            <label class="ref-form-label">Mnemonic (optional)</label>
                            <input type="text" class="ref-form-input" id="refMnemonic" value="${ref?.content?.mnemonic || ''}" />
                        </div>
                        <div class="ref-form-group">
                            <label class="ref-form-label">Exam Tip (optional)</label>
                            <input type="text" class="ref-form-input" id="refExamTip" value="${ref?.content?.exam_tip || ''}" />
                        </div>
                    `;

                case 'code':
                    return `
                        <div class="ref-form-group">
                            <label class="ref-form-label">Language *</label>
                            <select class="ref-form-select" id="refLanguage">
                                <option value="javascript" ${ref?.content?.language === 'javascript' ? 'selected' : ''}>JavaScript</option>
                                <option value="python" ${ref?.content?.language === 'python' ? 'selected' : ''}>Python</option>
                                <option value="java" ${ref?.content?.language === 'java' ? 'selected' : ''}>Java</option>
                                <option value="cpp" ${ref?.content?.language === 'cpp' ? 'selected' : ''}>C++</option>
                                <option value="sql" ${ref?.content?.language === 'sql' ? 'selected' : ''}>SQL</option>
                            </select>
                        </div>
                        <div class="ref-form-group">
                            <label class="ref-form-label">Code *</label>
                            <textarea class="ref-form-textarea" id="refCode" style="font-family: 'Fira Code', monospace; min-height: 150px;">${ref?.content?.code || ''}</textarea>
                        </div>
                        <div class="ref-form-group">
                            <label class="ref-form-label">When to Use</label>
                            <input type="text" class="ref-form-input" id="refCodeWhen" value="${ref?.content?.when_to_use || ''}" />
                        </div>
                    `;

                case 'table':
                    return `
                        <div class="ref-form-group">
                            <label class="ref-form-label">Table Data</label>
                            <textarea class="ref-form-textarea" id="refTableData" placeholder="Paste table data (CSV format)" style="min-height: 200px;">${ref?.content ? JSON.stringify(ref.content) : ''}</textarea>
                            <div class="ref-form-hint">Enter data in CSV format or JSON</div>
                        </div>
                    `;

                case 'checklist':
                    return `
                        <div class="ref-form-group">
                            <label class="ref-form-label">Checklist Items *</label>
                            <textarea class="ref-form-textarea" id="refChecklistItems" placeholder="One item per line">${ref?.content?.items?.map(i => i.text).join('\n') || ''}</textarea>
                            <div class="ref-form-hint">Enter one item per line</div>
                        </div>
                    `;

                default:
                    return '';
            }
        }

        // Select reference type
        window.selectRefType = function (type) {
            document.querySelectorAll('.ref-type-option').forEach(el => el.classList.remove('selected'));
            const selectedOption = document.querySelector(`[data-type="${type}"]`);
            if (selectedOption) selectedOption.classList.add('selected');

            const contentFields = document.getElementById('refContentFields');
            if (contentFields) {
                contentFields.innerHTML = renderContentFields(type, null);
            }
        };

        // Add tag
        window.addTag = function () {
            const input = document.getElementById('refTagInput');
            const tag = input.value.trim().toLowerCase().replace(/^#/, '');

            if (!tag) return;

            const container = document.getElementById('refTagContainer');
            const existingTags = Array.from(container.querySelectorAll('.ref-tag-chip')).map(el => el.textContent.replace('Ã—', '').trim());

            if (existingTags.includes(tag)) {
                showToast('âš ï¸ Tag already added');
                return;
            }

            if (existingTags.length >= 10) {
                showToast('âš ï¸ Maximum 10 tags per reference');
                return;
            }

            const chip = document.createElement('span');
            chip.className = 'ref-tag-chip';
            chip.innerHTML = `${tag} <span class="ref-tag-remove" onclick="this.parentElement.remove()">Ã—</span>`;

            container.insertBefore(chip, input);
            input.value = '';
        };

        // Save reference
        window.saveRef = async function () {
            const selectedType = document.querySelector('.ref-type-option.selected')?.querySelector('.ref-type-name')?.textContent.toLowerCase() || 'definition';
            const title = document.getElementById('refTitle').value.trim();

            if (!title) {
                showToast('âš ï¸ Title is required');
                return;
            }

            // Build content based on type
            let content = {};
            switch (selectedType) {
                case 'definition':
                    content = {
                        term: document.getElementById('refTerm')?.value || '',
                        definition: document.getElementById('refDefinition')?.value || ''
                    };
                    break;
                case 'formula':
                    content = {
                        latex: document.getElementById('refFormula')?.value || '',
                        when_to_use: document.getElementById('refWhenToUse')?.value || ''
                    };
                    break;
                case 'fact':
                    content = {
                        fact: document.getElementById('refFact')?.value || '',
                        mnemonic: document.getElementById('refMnemonic')?.value || '',
                        exam_tip: document.getElementById('refExamTip')?.value || ''
                    };
                    break;
                case 'code':
                    content = {
                        language: document.getElementById('refLanguage')?.value || 'javascript',
                        code: document.getElementById('refCode')?.value || '',
                        when_to_use: document.getElementById('refCodeWhen')?.value || ''
                    };
                    break;
                case 'checklist':
                    const items = document.getElementById('refChecklistItems')?.value.split('\n').filter(i => i.trim());
                    content = {
                        items: items.map(text => ({ text: text.trim(), checked: false }))
                    };
                    break;
                case 'table':
                    try {
                        content = JSON.parse(document.getElementById('refTableData')?.value || '{}');
                    } catch (e) {
                        content = { headers: [], rows: [] };
                    }
                    break;
            }

            const tags = Array.from(document.querySelectorAll('.ref-tag-chip')).map(el =>
                el.textContent.replace('Ã—', '').trim()
            );

            const reference = {
                id: currentEditingRef?.id || Date.now().toString(),
                type: selectedType,
                title: title,
                content: content,
                discipline: document.getElementById('refDiscipline').value,
                tags: tags,
                pinned: document.getElementById('refPinned').checked,
                metadata: {
                    created: currentEditingRef?.metadata?.created || new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                    accessCount: currentEditingRef?.metadata?.accessCount || 0,
                    lastAccessed: currentEditingRef?.metadata?.lastAccessed || new Date().toISOString()
                }
            };

            // Update or add
            const index = myReferences.findIndex(r => r.id === reference.id);
            if (index >= 0) {
                myReferences[index] = reference;
            } else {
                myReferences.push(reference);
            }

            await saveMyReference(reference);
            renderMyReferences();
            closeRefModal();
            showToast('âœ“ Reference saved');
        };

        // View reference
        window.viewRef = function (id) {
            const ref = myReferences.find(r => r.id === id);
            if (!ref) return;

            // Update access count
            ref.metadata.accessCount++;
            ref.metadata.lastAccessed = new Date().toISOString();
            saveMyReference(ref);

            openRefModal('view', id);
        };

        // Render reference detail view
        function renderRefDetail(ref) {
            const icon = REF_ICONS[ref.type];

            let contentHtml = '';
            switch (ref.type) {
                case 'definition':
                    contentHtml = `
                        <div><strong>${ref.content.term}</strong></div>
                        <div style="margin-top: 10px;">${ref.content.definition}</div>
                    `;
                    break;
                case 'formula':
                    contentHtml = `
                        <div style="font-size: 1.5rem; font-weight: bold; text-align: center; padding: 20px;">
                            ${ref.content.latex}
                        </div>
                        ${ref.content.when_to_use ? `<div><strong>Use:</strong> ${ref.content.when_to_use}</div>` : ''}
                    `;
                    break;
                case 'fact':
                    contentHtml = `
                        <div>${ref.content.fact}</div>
                        ${ref.content.mnemonic ? `<div style="margin-top: 10px;">ðŸ’¡ <strong>Mnemonic:</strong> ${ref.content.mnemonic}</div>` : ''}
                        ${ref.content.exam_tip ? `<div style="margin-top: 10px;">ðŸ“ <strong>Exam Tip:</strong> ${ref.content.exam_tip}</div>` : ''}
                    `;
                    break;
                case 'code':
                    contentHtml = `
                        <div><strong>Language:</strong> ${ref.content.language}</div>
                        <pre style="background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 6px; margin-top: 10px; overflow-x: auto;"><code>${ref.content.code}</code></pre>
                        ${ref.content.when_to_use ? `<div style="margin-top: 10px;"><strong>Use:</strong> ${ref.content.when_to_use}</div>` : ''}
                    `;
                    break;
                case 'checklist':
                    contentHtml = `
                        <ul style="list-style: none; padding: 0;">
                            ${ref.content.items.map(item => `
                                <li style="padding: 8px; background: rgba(52,152,219,0.05); margin-bottom: 5px; border-radius: 4px;">
                                    ${item.checked ? 'âœ“' : 'â˜'} ${item.text}
                                </li>
                            `).join('')}
                        </ul>
                    `;
                    break;
                case 'table':
                    if (ref.content.headers && ref.content.rows) {
                        contentHtml = `
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr>
                                    ${ref.content.headers.map(h => `<th style="background: var(--cs-accent); color: white; padding: 10px; text-align: left;">${h}</th>`).join('')}
                                </tr>
                                ${ref.content.rows.map(row => `
                                    <tr>
                                        ${row.map(cell => `<td style="padding: 10px; border-bottom: 1px solid #e0e0e0;">${cell}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </table>
                        `;
                    }
                    break;
            }

            const tagsHtml = ref.tags && ref.tags.length > 0
                ? `<div class="ref-detail-tags">${ref.tags.map(t => `<span class="ref-detail-tag">#${t}</span>`).join('')}</div>`
                : '';

            return `
                <div class="ref-detail">
                    <div class="ref-detail-header">
                        <span class="ref-detail-icon">${icon}</span>
                        <span class="ref-detail-title">${ref.title}</span>
                    </div>
                    <div class="ref-detail-meta">
                        <span>Type: ${ref.type}</span>
                        <span>Discipline: ${ref.discipline}</span>
                        <span>Views: ${ref.metadata.accessCount}</span>
                    </div>
                    <div class="ref-detail-content">
                        ${contentHtml}
                    </div>
                    ${tagsHtml}
                </div>
            `;
        }

        // Delete reference
        window.deleteRef = async function (id) {
            if (!confirm('Delete this reference? This cannot be undone.')) return;

            await deleteMyReference(id);
            myReferences = myReferences.filter(r => r.id !== id);
            renderMyReferences();
            closeRefModal();
            showToast('âœ“ Reference deleted');
        };

        // Save from highlighted text in notes
        window.saveToMyReferences = function () {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();

            if (!selectedText) {
                showToast('âš ï¸ Select text first');
                return;
            }

            // Open modal with pre-filled content
            currentEditingRef = null;
            const overlay = document.getElementById('refModalOverlay');
            const title = document.getElementById('refModalTitle');
            const body = document.getElementById('refModalBody');
            const footer = document.getElementById('refModalFooter');

            title.textContent = 'Save to My References';

            // Pre-fill form with selected text
            body.innerHTML = renderRefForm(null);

            // Set default values
            setTimeout(() => {
                document.getElementById('refTitle').value = selectedText.substring(0, 60);

                // Auto-detect type
                if (selectedText.match(/[=+\-*/^]/)) {
                    // Likely a formula
                    document.querySelector('[data-type="formula"]')?.click();
                    if (document.getElementById('refFormula')) {
                        document.getElementById('refFormula').value = selectedText;
                    }
                } else if (selectedText.length < 200) {
                    // Short text = definition or fact
                    document.querySelector('[data-type="definition"]')?.click();
                    if (document.getElementById('refDefinition')) {
                        document.getElementById('refDefinition').value = selectedText;
                    }
                } else {
                    // Longer text = fact
                    document.querySelector('[data-type="fact"]')?.click();
                    if (document.getElementById('refFact')) {
                        document.getElementById('refFact').value = selectedText;
                    }
                }

                // Auto-set discipline
                const chapter = chapters.find(c => c.id === currentId);
                if (chapter && document.getElementById('refDiscipline')) {
                    document.getElementById('refDiscipline').value = chapter.metadata?.discipline || 'custom';
                }
            }, 50);

            footer.innerHTML = `
                <button class="ref-btn ref-btn-secondary" onclick="closeRefModal()">Cancel</button>
                <button class="ref-btn ref-btn-primary" onclick="saveRef()">Save Reference</button>
            `;

            overlay.classList.add('active');

            // Hide text bubble
            const textBubble = document.getElementById('textBubble');
            if (textBubble) textBubble.classList.remove('visible');
        };

        // ========== CIRCUIT COMPONENTS FUNCTIONALITY ==========
        // Variables already declared earlier in the code
        circuitComponentCounter = 0;
        selectedComponent = null;
        connectionStart = null;
        isDrawingWire = false;

        // Toggle circuit components overlay
        window.toggleCircuitComponents = () => {
            const overlay = document.getElementById('circuitComponentsOverlay');
            overlay.classList.toggle('active');

            if (overlay.classList.contains('active')) {
                // Call the fix script's initialization
                if (typeof window.reinitCircuitComponents === 'function') {
                    window.reinitCircuitComponents();
                }
                initCircuitDragDrop();
            }
        };

        // Initialize drag and drop for circuit components
        function initCircuitDragDrop() {
            const cards = document.querySelectorAll('.circuit-component-card');

            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    const componentType = card.dataset.component;
                    e.dataTransfer.setData('componentType', componentType);
                    e.dataTransfer.setData('componentName', card.querySelector('.circuit-component-name').textContent);

                    // Get SVG from circuitSymbols array
                    const symbol = circuitSymbols.find(s => s.name.toLowerCase() === componentType.toLowerCase());
                    if (symbol) {
                        e.dataTransfer.setData('componentSvg', symbol.svg);
                    }
                });
            });

            // Set up drop zone on circuit canvas
            const circuitCanvas = document.getElementById('circuitDiagramCanvas');
            if (!circuitCanvas) return;

            circuitCanvas.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            circuitCanvas.addEventListener('drop', (e) => {
                e.preventDefault();
                const componentType = e.dataTransfer.getData('componentType');
                const componentIcon = e.dataTransfer.getData('componentIcon');
                const componentName = e.dataTransfer.getData('componentName');

                if (componentType) {
                    const rect = circuitCanvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    addCircuitComponent(componentType, componentIcon, componentName, x, y);
                    toggleCircuitComponents(); // Close the overlay
                }
            });
        }

        // Add circuit component to canvas
        function addCircuitComponent(type, icon, name, x, y) {
            const circuitCanvas = document.getElementById('circuitDiagramCanvas');
            if (!circuitCanvas) return;

            const componentId = `circuit-comp-${circuitComponentCounter++}`;

            const element = document.createElement('div');
            element.className = 'circuit-element';
            element.id = componentId;
            element.style.left = `${x - 40}px`;
            element.style.top = `${y - 40}px`;
            element.dataset.type = type;

            element.innerHTML = `
                <div class="circuit-element-icon">${icon}</div>
                <div class="circuit-element-label">${name}</div>
                <button class="circuit-element-delete" onclick="deleteCircuitComponent('${componentId}')">Ã—</button>
                <div class="circuit-connection-point top" data-point="top" onclick="startConnection(event, '${componentId}', 'top')"></div>
                <div class="circuit-connection-point bottom" data-point="bottom" onclick="startConnection(event, '${componentId}', 'bottom')"></div>
                <div class="circuit-connection-point left" data-point="left" onclick="startConnection(event, '${componentId}', 'left')"></div>
                <div class="circuit-connection-point right" data-point="right" onclick="startConnection(event, '${componentId}', 'right')"></div>
            `;

            // Make component draggable
            makeCircuitElementDraggable(element);

            circuitCanvas.querySelector('#circuitComponentsLayer').appendChild(element);

            circuitComponents.push({
                id: componentId,
                type: type,
                x: x - 40,
                y: y - 40
            });

            showToast(`${name} added to circuit`);
        }

        // Make circuit element draggable
        function makeCircuitElementDraggable(element) {
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            element.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);

            function dragStart(e) {
                if (e.target.classList.contains('circuit-connection-point') ||
                    e.target.classList.contains('circuit-element-delete')) {
                    return;
                }

                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;

                if (e.target === element || element.contains(e.target)) {
                    isDragging = true;
                    element.classList.add('selected');
                }
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();

                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    setTranslate(currentX, currentY, element);
                    updateWires(element.id);
                }
            }

            function dragEnd(e) {
                if (isDragging) {
                    initialX = currentX;
                    initialY = currentY;
                    isDragging = false;

                    // Update component position in array
                    const comp = circuitComponents.find(c => c.id === element.id);
                    if (comp) {
                        const rect = element.getBoundingClientRect();
                        const parent = element.parentElement.getBoundingClientRect();
                        comp.x = rect.left - parent.left;
                        comp.y = rect.top - parent.top;
                    }
                }
            }

            function setTranslate(xPos, yPos, el) {
                const currentLeft = parseInt(el.style.left) || 0;
                const currentTop = parseInt(el.style.top) || 0;
                el.style.left = `${currentLeft + xPos}px`;
                el.style.top = `${currentTop + yPos}px`;
                xOffset = 0;
                yOffset = 0;
            }
        }

        // Start wire connection
        window.startConnection = (event, componentId, point) => {
            event.stopPropagation();

            if (!connectionStart) {
                connectionStart = { componentId, point };
                showToast('Click another connection point to complete wire');
            } else {
                // Complete the connection
                if (connectionStart.componentId !== componentId) {
                    createWire(connectionStart.componentId, connectionStart.point, componentId, point);
                    connectionStart = null;
                } else {
                    showToast('Cannot connect component to itself');
                    connectionStart = null;
                }
            }
        };

        // Create wire between two components
        function createWire(comp1Id, point1, comp2Id, point2) {
            const svg = document.getElementById('circuitSvg');
            if (!svg) return;

            const comp1 = document.getElementById(comp1Id);
            const comp2 = document.getElementById(comp2Id);

            if (!comp1 || !comp2) return;

            const wireId = `wire-${Date.now()}`;
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('class', 'circuit-wire');
            path.setAttribute('id', wireId);
            path.setAttribute('data-comp1', comp1Id);
            path.setAttribute('data-point1', point1);
            path.setAttribute('data-comp2', comp2Id);
            path.setAttribute('data-point2', point2);

            updateWirePath(path, comp1, point1, comp2, point2);

            path.addEventListener('click', () => {
                if (confirm('Delete this wire?')) {
                    path.remove();
                    circuitWires = circuitWires.filter(w => w.id !== wireId);
                }
            });

            svg.appendChild(path);

            circuitWires.push({
                id: wireId,
                comp1: comp1Id,
                point1: point1,
                comp2: comp2Id,
                point2: point2
            });

            showToast('Wire connected');
        }

        // Update wire path
        function updateWirePath(path, comp1, point1, comp2, point2) {
            const svg = document.getElementById('circuitSvg');
            const svgRect = svg.getBoundingClientRect();

            const comp1Rect = comp1.getBoundingClientRect();
            const comp2Rect = comp2.getBoundingClientRect();

            const pos1 = getConnectionPointPosition(comp1Rect, point1, svgRect);
            const pos2 = getConnectionPointPosition(comp2Rect, point2, svgRect);

            const d = `M ${pos1.x} ${pos1.y} L ${pos2.x} ${pos2.y}`;
            path.setAttribute('d', d);
        }

        // Get connection point position
        function getConnectionPointPosition(compRect, point, svgRect) {
            let x, y;

            switch (point) {
                case 'top':
                    x = compRect.left + compRect.width / 2 - svgRect.left;
                    y = compRect.top - svgRect.top;
                    break;
                case 'bottom':
                    x = compRect.left + compRect.width / 2 - svgRect.left;
                    y = compRect.bottom - svgRect.top;
                    break;
                case 'left':
                    x = compRect.left - svgRect.left;
                    y = compRect.top + compRect.height / 2 - svgRect.top;
                    break;
                case 'right':
                    x = compRect.right - svgRect.left;
                    y = compRect.top + compRect.height / 2 - svgRect.top;
                    break;
            }

            return { x, y };
        }

        // Update all wires connected to a component
        function updateWires(componentId) {
            const svg = document.getElementById('circuitSvg');
            if (!svg) return;

            circuitWires.forEach(wire => {
                if (wire.comp1 === componentId || wire.comp2 === componentId) {
                    const path = document.getElementById(wire.id);
                    const comp1 = document.getElementById(wire.comp1);
                    const comp2 = document.getElementById(wire.comp2);

                    if (path && comp1 && comp2) {
                        updateWirePath(path, comp1, wire.point1, comp2, wire.point2);
                    }
                }
            });
        }

        // Delete circuit component
        window.deleteCircuitComponent = (componentId) => {
            const element = document.getElementById(componentId);
            if (!element) return;

            // Remove all wires connected to this component
            const wiresToRemove = circuitWires.filter(w => w.comp1 === componentId || w.comp2 === componentId);
            wiresToRemove.forEach(wire => {
                const wirePath = document.getElementById(wire.id);
                if (wirePath) wirePath.remove();
            });

            circuitWires = circuitWires.filter(w => w.comp1 !== componentId && w.comp2 !== componentId);
            circuitComponents = circuitComponents.filter(c => c.id !== componentId);

            element.remove();
            showToast('Component deleted');
        };

        initApp();
        setTimeout(resizeCanvas, 500);
    </script>

    <!-- Do Not Disturb Overlay -->
    <div class="dnd-overlay" id="dndOverlay">
        <div class="dnd-message">ðŸ… Focus Mode Active</div>
        <div class="dnd-timer" id="dndTimer">25:00</div>
        <div class="dnd-subtitle">Stay focused! All tools are locked.</div>
        <button class="dnd-exit-btn" onclick="exitDnd()">â¸ï¸ Exit Focus</button>
    </div>

    <!-- MY REFERENCES MODAL -->
    <div class="ref-modal-overlay" id="refModalOverlay">
        <div class="ref-modal">
            <div class="ref-modal-header">
                <div class="ref-modal-title" id="refModalTitle">New Reference</div>
                <button class="ref-modal-close" onclick="closeRefModal()">Ã—</button>
            </div>
            <div class="ref-modal-body" id="refModalBody"></div>
            <div class="ref-modal-footer" id="refModalFooter"></div>
        </div>
    </div>

    <!-- Circuit Simulator Engine -->
    <script src="circuit-simulator.js"></script>

    <!-- Circuit Components Fix Script -->
    <script src="circuit-components-fix.js"></script>

</body>

</html>