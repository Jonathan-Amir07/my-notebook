<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Notebook - Engineering Math Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Indie+Flower&family=Patrick+Hand&family=Caveat:wght@400;700&family=Shadows+Into+Light&family=Permanent+Marker&family=Kalam:wght@300;400;700&family=Architects+Daughter&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <!-- PDF.js for Lecture Mode 2.0 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- Prism.js for Syntax Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>

    <!-- PWA MANIFEST & SETTINGS -->
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Notebook">
    <link rel="icon" id="appIcon" href="">
    <link rel="apple-touch-icon" id="appleIcon" href="">
    <link rel="manifest" id="appManifest" href="">

    <style>
        :root {
            --paper-bg: #fdfbf7;
            --grid-line: #e3e0d9;
            --ink-color: #2c3e50;
            --pencil-color: #5a5a5a;
            --pen-color: #1a1a1a;
            --marker-color: #000000;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --accent-color: #e74c3c;
            --cs-accent: #3498db;
            --med-accent: #2ecc71; 
            --dent-accent: #9b59b6; 
            --eng-accent: #d35400; 
            --code-bg: #282c34;
            --code-text: #abb2bf;
            --toolbar-bg: #d4a373;
            --voice-active: #e67e22;
            --template-color: #3498db;
            --workspace-bg: #e0e0e0;
            --workspace-dot: #bebebe;
            --highlight-bg: #fff9c4;
            --chalk-bg: #2d3436;
            --chalk-text: #dfe6e9;
            --save-color: #27ae60;
            --highlighter-color: rgba(255, 235, 59, 0.4);
            --math-cluster-color: rgba(52, 152, 219, 0.1);
            --math-border-color: rgba(52, 152, 219, 0.5);
        }

        body.dark-mode {
            --paper-bg: #2c3e50;
            --grid-line: #34495e;
            --ink-color: #ecf0f1;
            --pencil-color: #bdc3c7;
            --pen-color: #ffffff;
            --marker-color: #ffffff;
            --workspace-bg: #1a1a1a;
            --workspace-dot: #333333;
            --highlight-bg: #4a4a4a;
            --sidebar-bg: #1a1a1a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Patrick Hand', cursive;
            color: var(--ink-color);
            background-color: var(--workspace-bg);
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        /* --- STYLES --- */
        .writing-tool-pencil { font-family: 'Caveat', cursive; color: var(--pencil-color); }
        .writing-tool-pen { font-family: 'Patrick Hand', cursive; color: var(--pen-color); }
        .writing-tool-marker { font-family: 'Permanent Marker', cursive; color: var(--marker-color); }
        .writing-tool-brush { font-family: 'Shadows Into Light', cursive; color: var(--ink-color); }
        .writing-tool-chalk { font-family: 'Architects Daughter', cursive; color: #4a4a4a; }
        .writing-tool-elegant { font-family: 'Kalam', cursive; color: var(--ink-color); }

        /* Tagging System & Stream UI (NEW) */
        .tag-chip { background: var(--template-color); color: white; padding: 2px 10px; border-radius: 12px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 2px; }
        .tag-remove { font-weight: bold; opacity: 0.7; margin-left: 5px;}
        .tag-remove:hover { opacity: 1; }
        
        /* Pomodoro Timer Styles - Improved UX */
        .pomodoro-container {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.15), rgba(192, 57, 43, 0.1));
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 12px;
            padding: 16px 12px;
            margin: 0;
            text-align: center;
        }
        .pomodoro-display {
            font-size: 2.4rem;
            font-family: 'Fira Code', monospace;
            color: var(--sidebar-text);
            margin: 10px 0;
            font-weight: bold;
            letter-spacing: 3px;
            text-shadow: 0 2px 8px rgba(0,0,0,0.3);
            line-height: 1;
        }
        .pomodoro-mode {
            font-size: 0.85rem;
            color: var(--sidebar-text);
            opacity: 0.9;
            margin-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .pomodoro-controls {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .pomodoro-btn {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.25);
            color: var(--sidebar-text);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            flex: 1;
            min-width: 65px;
            font-weight: 500;
            white-space: nowrap;
        }
        .pomodoro-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .pomodoro-btn:active {
            transform: translateY(0);
        }
        .pomodoro-btn.active {
            background: var(--accent-color);
            border-color: var(--accent-color);
            box-shadow: 0 2px 12px rgba(231, 76, 60, 0.4);
        }
        .pomodoro-progress {
            width: 100%;
            height: 5px;
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }
        .pomodoro-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), #ff6b6b);
            transition: width 0.5s linear;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
        }
        .pomodoro-dnd-container {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .pomodoro-dnd-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            color: var(--sidebar-text);
            opacity: 0.9;
            transition: opacity 0.2s;
            padding: 5px;
            border-radius: 6px;
        }
        .pomodoro-dnd-label:hover {
            opacity: 1;
            background: rgba(255,255,255,0.05);
        }
        .pomodoro-dnd-label input[type="checkbox"] {
            cursor: pointer;
            width: 15px;
            height: 15px;
            margin: 0;
        }
        .pomodoro-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.7rem;
            opacity: 0.7;
        }
        .pomodoro-stat-item {
            text-align: center;
        }
        .pomodoro-stat-value {
            font-weight: bold;
            font-size: 0.95rem;
            display: block;
            margin-top: 2px;
            color: var(--accent-color);
        }
        .dnd-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(44, 62, 80, 0.95), rgba(52, 73, 94, 0.95));
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
            font-size: 2rem;
            backdrop-filter: blur(10px);
        }
        .dnd-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .dnd-message {
            margin-bottom: 20px;
            font-weight: 600;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .dnd-timer {
            font-size: 5rem;
            font-family: 'Fira Code', monospace;
            margin: 20px 0;
            font-weight: bold;
            letter-spacing: 4px;
            text-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .dnd-exit-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 30px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }
        .dnd-exit-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);
        }
        .dnd-exit-btn:active {
            transform: translateY(0);
        }
        .dnd-subtitle {
            opacity: 0.8;
            font-size: 1.1rem;
            margin-top: 10px;
            font-weight: 400;
        }

        /* Anatomy Atlas Styles */
        .anatomy-container { 
            width: 100%; 
            height: 400px; 
            border: 1px solid #ddd; 
            background: white; 
            border-radius: 8px; 
            position: relative; 
            overflow: hidden; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        .anatomy-svg { 
            height: 90%; 
            width: auto; 
            transition: transform 0.3s ease; 
        }
        .anatomy-region { 
            fill: #ecf0f1; 
            stroke: #2c3e50; 
            stroke-width: 2; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        .anatomy-region:hover { 
            fill: var(--med-accent); 
            fill-opacity: 0.3; 
        }
        .anatomy-region.active { 
            fill: var(--med-accent); 
            fill-opacity: 0.6; 
        }
        .atlas-controls { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 10px; 
            justify-content: center; 
        }

        /* Logic Gates Simulator Styles */
        #logicGatesSimulator {
            background: #f8f9fa;
            border: 2px solid var(--cs-accent);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            min-height: 400px;
            position: relative;
        }
        .logic-toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }
        .logic-gate-btn {
            background: white;
            border: 2px solid var(--cs-accent);
            color: var(--cs-accent);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .logic-gate-btn:hover {
            background: var(--cs-accent);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        .logic-gate-btn.active {
            background: var(--cs-accent);
            color: white;
        }
        .logic-canvas-area {
            background: white;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            min-height: 350px;
            position: relative;
            overflow: hidden;
        }
        .logic-gate {
            position: absolute;
            background: white;
            border: 3px solid var(--cs-accent);
            border-radius: 8px;
            padding: 15px 20px;
            cursor: move;
            font-weight: bold;
            color: var(--cs-accent);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            user-select: none;
            min-width: 80px;
            text-align: center;
            transition: box-shadow 0.2s;
        }
        .logic-gate:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .logic-gate.selected {
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.3);
        }
        .logic-input {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #27ae60;
            border: 3px solid #229954;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.9rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            user-select: none;
        }
        .logic-input:hover {
            transform: scale(1.1);
        }
        .logic-input.off {
            background: #e74c3c;
            border-color: #c0392b;
        }
        .logic-output {
            position: absolute;
            width: 50px;
            height: 50px;
            background: #f39c12;
            border: 3px solid #d68910;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.2rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            user-select: none;
        }
        .logic-output.on {
            background: #27ae60;
            border-color: #229954;
            box-shadow: 0 0 20px rgba(39, 174, 96, 0.5);
        }
        .logic-wire {
            position: absolute;
            height: 3px;
            background: var(--cs-accent);
            transform-origin: left center;
            pointer-events: none;
            z-index: 1;
        }
        .logic-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #dee2e6;
        }
        .logic-control-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .logic-control-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        .logic-control-btn.danger {
            background: #e74c3c;
        }
        .logic-control-btn.danger:hover {
            background: #c0392b;
        }
        .logic-info {
            background: #e8f4f8;
            border-left: 4px solid var(--cs-accent);
            padding: 12px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #2c3e50;
        }
        

        .continuation-break { 
            position: relative; 
            height: 40px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 20px 0; 
            user-select: none; 
            pointer-events: none; 
        }
        /* No lines - clean separation */
        .continuation-break::before { content: none; }
        
        .continuation-label { 
            background: rgba(0,0,0,0.5); 
            padding: 4px 12px; 
            font-size: 0.75rem; 
            color: white; 
            font-weight: bold; 
            z-index: 1; 
            border-radius: 20px; 
            opacity: 0.8;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* PAGE STYLE SEPARATION */
        .sequence-editor-block { 
            position: relative; 
            min-height: 1050px; /* A4 Ratio */
            width: 100%;
            background-color: var(--paper-bg);
            /* Each page gets its own grid */
            background-image: linear-gradient(var(--grid-line) 1px, transparent 1px), linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 25px 25px;
            
            padding: 4rem; 
            margin-bottom: 40px; /* Gap between pages */
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); /* Drop shadow for paper effect */
            border-radius: 2px;
            transition: box-shadow 0.3s ease;
        }
        
        .sequence-editor-block.active-focus {
            box-shadow: 0 0 0 2px var(--accent-color), 0 10px 30px rgba(0,0,0,0.15);
        }
        
        /* Main Paper Container is now just a transparent wrapper */
        .paper { 
            width: 100%; 
            max-width: 850px; 
            background-color: transparent; 
            background-image: none; 
            min-height: auto; 
            padding: 0; 
            box-shadow: none; 
            position: relative; 
        }
        .paper.infinite { max-width: none; width: 3000px; height: 3000px; background: var(--paper-bg); }

        /* Dark mode adjustments */
        body.dark-mode .sequence-editor-block {
            background-color: var(--paper-bg);
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }

        .tag-mini { font-size: 0.65rem; background: rgba(255,255,255,0.1); padding: 1px 5px; border-radius: 4px; color: #ccc; margin-right: 4px; }

        /* CS Code Block */
        .cs-code-container { font-family: 'Fira Code', monospace; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; margin: 15px 0; background: var(--code-bg); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .cs-code-header { background: #21252b; color: #9da5b4; padding: 5px 10px; font-size: 0.8rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #181a1f; }
        .cs-code-editor { padding: 15px; color: var(--code-text); font-size: 0.9rem; min-height: 60px; outline: none; white-space: pre-wrap; }
        /* Prism overrides */
        .cs-code-editor code, .cs-code-editor pre { font-family: 'Fira Code', monospace !important; text-shadow: none !important; }
        
        .cs-code-output { background: #1e2127; color: #98c379; padding: 10px; font-size: 0.8rem; border-top: 1px dashed #3e4451; }
        .cs-code-output::before { content: "➜ OUTPUT:"; display: block; font-size: 0.7rem; opacity: 0.5; margin-bottom: 5px; }
        
        .cs-lang-select { background: #2c3e50; color: white; border: 1px solid #444; border-radius: 4px; font-size: 0.7rem; margin-right: 5px; padding: 2px; }
        .cs-format-btn { background: #e67e22; color: white; border: none; border-radius: 4px; font-size: 0.7rem; padding: 2px 8px; cursor: pointer; }
        .cs-format-btn:hover { background: #d35400; }

        /* Trace Table */
        .trace-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-family: 'Fira Code', monospace; font-size: 0.85rem; }
        .trace-table th, .trace-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .trace-table th { background: rgba(0,0,0,0.05); }

        /* Dynamic Trace Table & Widget Controls */
        .trace-table-container, .timeline-wrapper, .comparison-wrapper { position: relative; }
        .btn-trace-add { position: absolute; top: -10px; right: 0; width: 22px; height: 22px; background: var(--cs-accent); color: white; border: 2px solid white; border-radius: 50%; font-weight: bold; font-size: 14px; line-height: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        .trace-table-container:hover .btn-trace-add, .timeline-wrapper:hover .btn-trace-add, .comparison-wrapper:hover .btn-trace-add { opacity: 1; }
        @media (hover: none) { .btn-trace-add { opacity: 0.6; } }

        /* Sidebar */
        .sidebar { width: 280px; background-color: var(--sidebar-bg); color: var(--sidebar-text); height: 100%; display: flex; flex-direction: column; padding: 0; box-shadow: 4px 0 15px rgba(0,0,0,0.3); z-index: 20; flex-shrink: 0; transition: background-color 0.3s ease, transform 0.3s ease; position: absolute; left: 0; top: 0; overflow: hidden; }
        @media (max-width: 768px) { .sidebar { transform: translateX(-100%); position: fixed; width: 80%; max-width: 300px; } .sidebar.open { transform: translateX(0); } }

        .sidebar-header { padding: 1.5rem 1.5rem 1rem 1.5rem; flex-shrink: 0; }
        .sidebar-scrollable { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 0 1.5rem 1.5rem 1.5rem; }
        .sidebar-scrollable::-webkit-scrollbar { width: 8px; }
        .sidebar-scrollable::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        .sidebar-scrollable::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
        .sidebar-scrollable::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

        .app-title { font-size: 1.6rem; margin-bottom: 1rem; text-align: center; flex-shrink: 0; font-family: 'Fira Code', monospace; }
        .search-container { margin-bottom: 0.5rem; position: relative; flex-shrink: 0; }
        .search-input { width: 100%; padding: 10px 15px; border-radius: 20px; border: none; background: rgba(255,255,255,0.1); color: white; font-family: inherit; font-size: 0.95rem; }
        .category-filter { width: 100%; padding: 8px; margin-bottom: 15px; border-radius: 6px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); font-family: inherit; }
        .category-filter option { background: var(--sidebar-bg); color: white; }
        optgroup { font-style: normal; font-weight: bold; color: #ccc; }

        .sidebar-section { display: flex; flex-direction: column; margin-bottom: 12px; min-height: 0; flex-shrink: 0; }
        .sidebar-section.pages-section { flex-grow: 0; max-height: none; }
        .section-header { padding: 8px 10px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: var(--accent-color); margin-bottom: 5px; user-select: none; flex-shrink: 0; }
        .arrow { transition: transform 0.3s ease; font-size: 0.8rem; }
        .section-content { display: flex; flex-direction: column; transition: all 0.3s ease; overflow: hidden; }
        .section-content.collapsed { display: none !important; }
        
        /* Tag Cloud Styling */
        .tag-cloud { display: flex; flex-wrap: wrap; gap: 5px; padding: 5px; }
        .tag-cloud-item { background: rgba(255,255,255,0.1); color: var(--sidebar-text); padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .tag-cloud-item:hover { background: var(--template-color); color: white; }
        .tag-cloud-item.active { border-color: var(--accent-color); background: rgba(255,255,255,0.15); }

        /* Install Button (Hidden by default) */
        #installAppBtn { display: none; background: #27ae60; color: white; font-weight: bold; margin-bottom: 10px; }

        #pagesContent { overflow-y: auto; flex-grow: 1; padding-right: 2px; }
        #pagesContent::-webkit-scrollbar { width: 4px; }
        #pagesContent::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
        
        /* New Scroll for Tags Content */
        #tagsContent { overflow-y: auto; max-height: 200px; padding-right: 2px; }
        #tagsContent::-webkit-scrollbar { width: 4px; }
        #tagsContent::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

        #toolsContent { overflow-y: auto; max-height: 45vh; padding-right: 2px; }
        #toolsContent::-webkit-scrollbar { width: 4px; }
        #toolsContent::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

        .chapter-list { list-style: none; margin-bottom: 0; padding-bottom: 10px; max-height: 300px; overflow-y: auto; overflow-x: hidden; }
        .chapter-list::-webkit-scrollbar { width: 6px; }
        .chapter-list::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 3px; }
        .chapter-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        .chapter-list::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
        .nav-item { padding: 12px; cursor: pointer; border-radius: 6px; margin-bottom: 8px; background: rgba(255,255,255,0.05); transition: 0.2s; display: flex; align-items: center; justify-content: space-between; }
        .nav-info { display: flex; flex-direction: column; gap: 4px; overflow: hidden; flex-grow: 1; min-width: 0; margin-right: 8px; }
        .nav-item.active { border-left: 4px solid var(--accent-color); background: rgba(255,255,255,0.1); }
        .nav-item-title { font-weight: bold; font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .nav-item-snippet { font-size: 0.8rem; opacity: 0.7; font-family: sans-serif; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cat-badge { font-size: 0.7rem; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; align-self: flex-start; margin-top: 2px; }
        
        .btn-delete { background: transparent; border: none; color: var(--sidebar-text); font-size: 1.2rem; opacity: 0.6; cursor: pointer; padding: 0 12px; height: 40px; transition: all 0.2s; z-index: 10; flex-shrink: 0; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
        .btn-delete:hover { opacity: 1; color: #e74c3c; background: rgba(231, 76, 60, 0.1); }

        .btn { position: relative; border: none; padding: 10px; border-radius: 6px; font-family: inherit; cursor: pointer; transition: 0.3s; width: 100%; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-add { background: var(--accent-color); color: white; }
        .btn-save-sidebar { background: var(--save-color); color: white; margin-top: 5px; }
        .btn-sketch { background: var(--toolbar-bg); color: white; }
        .btn-sketch.active { background: #e67e22; border: 2px solid white; }
        .btn-secondary { background: rgba(255,255,255,0.15); color: #ecf0f1; font-size: 0.9rem; }
        .btn-secondary:hover { background: rgba(255,255,255,0.25); }
        .btn-danger { background: rgba(231, 76, 60, 0.2); color: #e74c3c; font-size: 0.8rem; margin-top: 10px; }
        .btn-danger:hover { background: rgba(231, 76, 60, 0.4); }

        /* New Stream Button Styles */
        #streamControls {
            margin: 20px 0 80px 0;
            width: 100%;
            max-width: 800px;
            display: flex;
            justify-content: center;
        }
        .btn-stream-add {
            background: transparent;
            border: 2px dashed var(--accent-color);
            color: var(--accent-color);
            padding: 12px 30px;
            border-radius: 30px;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.7;
            font-size: 1rem;
        }
        .btn-stream-add:hover {
            opacity: 1;
            background: var(--accent-color);
            color: white;
            transform: scale(1.05);
        }

        .btn-dark-circle { position: fixed; top: 20px; right: 20px; width: 45px; height: 45px; border-radius: 50%; background: white; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer; z-index: 50; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: 0.3s; }
        body.dark-mode .btn-dark-circle { background: var(--sidebar-bg); color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .btn-dark-circle:hover { transform: scale(1.1); }

        .btn-exit-focus { position: fixed; top: 20px; right: 80px; background: var(--accent-color); color: white; padding: 10px 20px; border-radius: 30px; border: none; cursor: pointer; z-index: 60; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-weight: bold; }

        .btn-menu-mobile { position: fixed; top: 20px; left: 20px; width: 45px; height: 45px; border-radius: 50%; background: var(--sidebar-bg); color: white; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer; z-index: 60; display: none; align-items: center; justify-content: center; font-size: 1.2rem; }
        @media (max-width: 768px) { .btn-menu-mobile { display: flex; } }

        /* Layout */
        .main-container { display: flex; flex-grow: 1; margin-left: 280px; transition: margin-left 0.3s; height: 100%; position: relative; overflow: hidden; }
        @media (max-width: 768px) { .main-container { margin-left: 0; } }
        body.focus-mode .main-container { margin-left: 0; }

        .workspace { flex-grow: 1; padding: 2rem; overflow: auto; display: flex; flex-direction: column; align-items: center; background-image: radial-gradient(var(--workspace-dot) 1px, transparent 1px); background-size: 20px 20px; position: relative; width: 100%; transition: width 0.3s; }
        .lecture-pane { width: 0; height: 100%; background: #333; transition: width 0.3s; display: flex; flex-direction: column; border-left: 1px solid #ccc; overflow: hidden; }
        
        body.split-mode .workspace { width: 50%; }
        body.split-mode .lecture-pane { width: 50%; }
        @media (max-width: 768px) { body.split-mode .workspace { display: none; } body.split-mode .lecture-pane { width: 100%; } }

        .lecture-frame { flex-grow: 1; border: none; background: white; }
        .lecture-header { background: var(--sidebar-bg); color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }

        @media (max-width: 768px) { .workspace { padding: 1rem; padding-top: 5rem; } }
        .workspace.grabbing { cursor: grabbing; cursor: -webkit-grabbing; }
        
        body.focus-mode .sidebar { transform: translateX(-100%); }
        body.focus-mode .tool-tray-container { display: none; }
        body.focus-mode .btn-exit-focus { display: block; }
        body.focus-mode .btn-menu-mobile { display: none; }

        /* Paper */
        #sketchCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; }
        /* FIX: Added touch-action: none to prevent iPad scrolling while drawing */
        body.sketch-mode #sketchCanvas { pointer-events: auto; cursor: crosshair; touch-action: none; }

        /* PDF Background Layer */
        #pdfBackground {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 0; /* Behind editor and canvas */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 2rem;
            pointer-events: none; /* Allows drawing through this layer */
        }
        .pdf-page-render {
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            background: white;
            max-width: 95%;
        }

        /* Toolbar */
        .writing-tools { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: white; padding: 10px 20px; border-radius: 40px; display: flex; gap: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 15; overflow-x: auto; max-width: 90%; transition: opacity 0.3s, transform 0.3s; }
        .paper.infinite .writing-tools { position: fixed; top: 20px; left: calc(50% + 140px); }
        body.focus-mode .paper.infinite .writing-tools { left: 50%; }
        .writing-tools.collapsed { transform: translateX(-50%) scale(0); opacity: 0; pointer-events: none; }
        
        .show-tools-btn { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: white; border-radius: 50%; width: 40px; height: 40px; display: none; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer; z-index: 14; font-size: 1.2rem; }
        body.dark-mode .show-tools-btn { background: #2c3e50; color: white; }
        body.tools-hidden .show-tools-btn { display: flex; }

        .tool-opt { cursor: pointer; font-size: 1.5rem; transition: transform 0.2s; padding: 5px; border-radius: 50%; }
        .tool-opt.active { background: #eee; transform: scale(1.2); }
        .tool-opt.highlighter { color: #f1c40f; text-shadow: 1px 1px 0 #999; filter: hue-rotate(60deg) drop-shadow(0 0 2px rgba(255, 255, 0, 0.5)); }
        .sketch-only { display: none; }
        body.sketch-mode .sketch-only { display: block; }
        .tool-divider { width: 1px; background: #e0e0e0; margin: 0 5px; align-self: center; height: 30px; display: none; }
        body.sketch-mode .tool-divider { display: block; }

        .tool-tray-container { position: fixed; left: 295px; top: 50%; transform: translateY(-50%); z-index: 40; display: flex; align-items: center; transition: left 0.3s ease, opacity 0.3s; }
        @media (max-width: 768px) { .tool-tray-container { left: 0; } }
        .tool-tray-container.collapsed { left: 280px; }
        @media (max-width: 768px) { .tool-tray-container.collapsed { left: -15px; } }
        .tool-tray-toggle { background: white; border: 1px solid #ddd; width: 24px; height: 60px; border-radius: 0 8px 8px 0; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 4px 0 10px rgba(0,0,0,0.1); font-size: 0.8rem; color: #666; transition: 0.3s; }
        body.dark-mode .tool-tray-toggle { background: #34495e; color: white; border-color: #444; }
        
        /* Updated Tool Tray with Scrollbar */
        .tool-tray { 
            background: white; 
            padding: 15px 10px; 
            border-radius: 12px; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            box-shadow: 4px 4px 20px rgba(0,0,0,0.1); 
            border: 1px solid #eee; 
            transition: transform 0.3s ease, opacity 0.3s ease; 
            transform-origin: left center;
            max-height: 80vh; 
            overflow-y: auto; 
        }
        
        .tool-tray::-webkit-scrollbar { width: 4px; }
        .tool-tray::-webkit-scrollbar-track { background: transparent; }
        .tool-tray::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 2px; }
        body.dark-mode .tool-tray::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); }

        body.dark-mode .tool-tray { background: #34495e; border-color: #444; }
        .tool-tray-container.collapsed .tool-tray { transform: scaleX(0); opacity: 0; pointer-events: none; width: 0; padding: 0; margin: 0; }

        .color-picker-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 5; }

        /* REFINED TOOL BUTTONS */
        .tool-btn { 
            background: transparent; 
            border: none; 
            padding: 10px 12px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-family: inherit; 
            font-size: 0.95rem; 
            white-space: nowrap; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            transition: all 0.2s ease; 
            position: relative;
            color: var(--ink-color);
        }
        .tool-btn:hover { background: rgba(0,0,0,0.05); transform: translateX(2px); }
        body.dark-mode .tool-btn { background: transparent; color: #ecf0f1; border: none; }
        body.dark-mode .tool-btn:hover { background: rgba(255,255,255,0.1); }
        .tool-btn.active { background: var(--toolbar-bg); color: white; font-weight: bold; }
        body.dark-mode .tool-btn.active { background: var(--toolbar-bg); color: white; }
        
        /* Discipline Specific Styles for Tools */
        #tools-cs .tool-btn { color: var(--cs-accent); }
        #tools-med .tool-btn { color: var(--med-accent); }
        #tools-eng .tool-btn { color: var(--eng-accent); }
        
        .paper-title { font-size: 2.4rem; border: none; border-bottom: 2px solid var(--accent-color); width: 100%; background: transparent; font-family: inherit; margin-bottom: 2rem; color: var(--ink-color); }
        .content-area { min-height: 800px; outline: none; line-height: 1.8; font-size: 1.3rem; color: var(--ink-color); position: relative; z-index: 2; margin-bottom: 2rem; }
        
        .styled-header { color: var(--accent-color); border-bottom: 1px dashed #ccc; margin: 15px 0; }
        .sticky-note { background: var(--highlight-bg); padding: 15px; border-left: 5px solid #f1c40f; transform: rotate(-1deg); margin: 15px 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        .chalk-code { background: var(--chalk-bg); color: var(--chalk-text); padding: 15px; border-radius: 6px; font-family: 'Architects Daughter'; margin: 15px 0; }
        
        .checklist-item { display: flex; align-items: center; gap: 12px; margin: 8px 0; }
        .checklist-item .checkbox-wrapper { contenteditable: false; }
        .checkbox { width: 22px; height: 22px; border: 2px solid #555; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 4px; flex-shrink: 0; transition: all 0.2s ease; }
        .checkbox.checked { background: var(--accent-color); border-color: var(--accent-color); }
        .checkbox::after { content: '✓'; color: white; font-weight: bold; transform: scale(0); transition: transform 0.2s cubic-bezier(0.5, 0, 0, 1.5); }
        .checkbox.checked::after { transform: scale(1); }
        
        .checklist-text { position: relative; transition: opacity 0.3s ease; }
        .checklist-text.completed { opacity: 0.6; text-decoration: line-through; text-decoration-thickness: 2px; }

        /* Timeline Styles */
        .timeline-container { border-left: 3px solid var(--med-accent); padding-left: 15px; margin: 15px 0; }
        .timeline-entry { margin-bottom: 6px; display: flex; gap: 8px; align-items: baseline; }
        .time-label { white-space: nowrap; font-family: 'Fira Code', monospace; color: var(--med-accent); cursor: text; min-width: 45px; }
        .event-desc { flex-grow: 1; outline: none; }

        /* Compare Table Styles */
        .comparison-table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.9rem; }
        .comparison-table th { border-bottom: 2px solid var(--med-accent); text-align: left; padding: 8px; color: var(--med-accent); width: 50%; }
        .comparison-table td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: top; }

        /* Active Recall Stickers */
        .recall-sticker {
            position: absolute;
            background-color: #2c3e50;
            border-radius: 4px;
            cursor: pointer;
            z-index: 50;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .recall-sticker::after {
            content: '?';
            color: rgba(255,255,255,0.3);
            font-weight: bold;
            font-size: 1.2rem;
            pointer-events: none;
        }
        .recall-sticker.revealed {
            background-color: rgba(231, 76, 60, 0.1);
            border: 2px dashed #e74c3c;
            box-shadow: none;
        }
        .recall-sticker.revealed::after {
            content: '';
        }
        .recall-sticker:hover {
            transform: scale(1.02);
        }

        .uploaded-img { max-width: 100%; border-radius: 8px; margin: 10px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        /* Resizable Image Container */
        .uploaded-container {
            display: inline-block;
            resize: both;
            overflow: hidden;
            vertical-align: middle;
            margin: 10px;
            max-width: 100%;
            border: 1px solid transparent;
            position: relative;
            z-index: 10; /* Ensure handle is clickable */
        }
        .uploaded-container:hover {
            border: 1px dashed var(--accent-color); /* Visual cue */
        }
        .uploaded-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            border-radius: 8px;
        }

        .save-status { position: absolute; top: 2rem; right: 4rem; font-family: sans-serif; font-size: 0.75rem; color: #999; text-transform: uppercase; letter-spacing: 1px; pointer-events: none; }
        .word-count { font-family: sans-serif; font-size: 0.7rem; color: var(--accent-color); margin-top: 4px; opacity: 0.7; }
        .status-bar { position: absolute; top: 2rem; right: 4rem; display: flex; flex-direction: column; align-items: flex-end; pointer-events: none; }

        .floating-pane { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: none; flex-direction: column; gap: 10px; z-index: 1000; min-width: 250px; }
        .toast { position: fixed; bottom: 30px; right: 30px; background: #333; color: white; padding: 12px 24px; border-radius: 30px; transform: translateY(200%); transition: 0.5s; z-index: 2000; }
        .toast.show { transform: translateY(0); }

        .storage-footer { padding: 15px 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.8rem; color: rgba(255,255,255,0.6); flex-shrink: 0; background: var(--sidebar-bg); }
        .storage-bar-bg { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .storage-bar-fill { height: 100%; background: var(--save-color); width: 0%; transition: width 0.5s ease; }

        .text-bubble { position: absolute; background: #333; border-radius: 8px; padding: 5px; display: none; gap: 5px; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transform: translate(-50%, -120%); }
        .text-bubble.visible { display: flex; }
        .text-bubble::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); border-width: 5px 5px 0; border-style: solid; border-color: #333 transparent transparent transparent; }
        .bubble-btn { background: none; border: none; color: white; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-weight: bold; font-family: sans-serif; }
        .bubble-btn:hover { background: rgba(255,255,255,0.2); }
        
        /* Metadata Modal Styles */
        .meta-group { margin-bottom: 15px; }
        .meta-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: #777; margin-bottom: 5px; display: block; }
        .meta-value { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; }
        .meta-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        /* Tag styling handled by global classes above */

        /* Engineering Ruler */
        #engRuler {
            position: absolute;
            width: 400px;
            height: 60px;
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid #999;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            top: 300px;
            left: 200px;
            transform-origin: center;
            display: none;
            z-index: 20;
            cursor: grab;
            backdrop-filter: blur(5px);
            border-radius: 4px;
        }
        #engRuler::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 20px;
            background-image: repeating-linear-gradient(90deg, #333 0, #333 1px, transparent 1px, transparent 10px);
            opacity: 0.5;
        }
        #engRuler .rotate-handle {
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            background: var(--eng-accent);
            border-radius: 50%;
            cursor: col-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        
        /* Math Cluster Highlight */
        .math-cluster-active {
            border: 2px dashed #d35400;
            background-color: rgba(211, 84, 0, 0.05);
            position: absolute;
            pointer-events: auto;
            cursor: pointer;
            z-index: 6;
            border-radius: 4px;
        }
        
        /* Structured Math Display */
        .structured-math {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            font-size: 1.5rem;
            position: absolute;
            background: white;
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 7;
        }
        
        /* Anatomy Pin */
        .anatomy-pin {
            position: absolute;
            width: 24px;
            height: 24px;
            background: var(--med-accent);
            color: white;
            border-radius: 50% 50% 0 50%;
            transform: rotate(45deg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            z-index: 10;
            cursor: pointer;
        }
        .anatomy-pin span { transform: rotate(-45deg); }
        
        /* Math Keyboard Styles */
        .math-keyboard-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--sidebar-bg);
            color: white;
            z-index: 2000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            display: none; /* Toggled */
            flex-direction: column;
            border-top: 2px solid var(--eng-accent);
        }
        .math-input-bar {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .math-buffer {
            flex-grow: 1;
            background: white;
            color: #333;
            border: none;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            font-size: 1.1rem;
        }
        .math-preview {
            background: white;
            color: black;
            padding: 5px 10px;
            border-radius: 4px;
            min-width: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .math-tabs {
            display: flex;
            background: rgba(0,0,0,0.2);
        }
        .math-tab-btn {
            flex: 1;
            padding: 10px;
            background: transparent;
            color: #aaa;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-bottom: 2px solid transparent;
        }
        .math-tab-btn.active {
            color: white;
            background: rgba(255,255,255,0.05);
            border-bottom-color: var(--eng-accent);
        }
        .math-keys-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 5px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .math-key {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 1.2rem;
            cursor: pointer;
            font-family: 'Times New Roman', serif;
        }
        .math-key:hover { background: rgba(255,255,255,0.2); }

        /* FLASHCARD OVERLAY */
        .flashcard-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.95);
            z-index: 5000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .flashcard-container {
            perspective: 1000px;
            width: 100%;
            max-width: 600px;
            height: 400px;
            margin-bottom: 20px;
        }
        .flashcard {
            width: 100%; height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .flashcard.flipped { transform: rotateY(180deg); }
        .flashcard-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 30px; text-align: center;
            font-size: 1.5rem; color: #2c3e50;
        }
        .flashcard-front { background: white; border-radius: 15px; }
        .flashcard-back { background: #ecf0f1; border-radius: 15px; transform: rotateY(180deg); }
        .flashcard-label {
            position: absolute; top: 20px; left: 20px;
            font-size: 0.8rem; text-transform: uppercase; color: #95a5a6; letter-spacing: 1px;
        }
        .flashcard-controls {
            display: flex; gap: 20px;
        }
        .fc-btn {
            background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3);
            color: white; padding: 10px 20px; border-radius: 30px;
            cursor: pointer; font-size: 1rem; transition: 0.3s;
        }
        .fc-btn:hover { background: white; color: #2c3e50; }
        .fc-btn-exit { position: absolute; top: 30px; right: 30px; border: none; font-size: 1.5rem; background: transparent; color: white; cursor: pointer; }
        .no-cards-msg { color: white; font-size: 1.2rem; text-align: center; }

        /* Anatomy Atlas Styles */
        .anatomy-container { 
            width: 100%; 
            height: 400px; 
            border: 1px solid #ddd; 
            background: white; 
            border-radius: 8px; 
            position: relative; 
            overflow: hidden; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        .anatomy-svg { 
            height: 90%; 
            width: auto; 
            transition: transform 0.3s ease; 
        }
        .anatomy-region { 
            fill: #ecf0f1; 
            stroke: #2c3e50; 
            stroke-width: 2; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        .anatomy-region:hover { 
            fill: var(--med-accent); 
            fill-opacity: 0.3; 
        }
        .anatomy-region.active { 
            fill: var(--med-accent); 
            fill-opacity: 0.6; 
        }
        .atlas-controls { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 10px; 
            justify-content: center; 
        }
    </style>
</head>
<body class="cursor-pen">

    <button class="btn-dark-circle" id="darkModeToggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">🌙</button>
    <button class="btn-menu-mobile" id="mobileMenuBtn" onclick="toggleMobileSidebar()" title="Toggle Menu">☰</button>
    <button class="btn-exit-focus" onclick="toggleFocusMode()">Exit Focus</button>
    
    <!-- FLASHCARD OVERLAY -->
    <div id="flashcardOverlay" class="flashcard-overlay">
        <button class="fc-btn-exit" onclick="exitFlashcardMode()">✕</button>
        <div id="flashcardContainer" class="flashcard-container">
            <div class="flashcard" onclick="flipCard()">
                <div class="flashcard-face flashcard-front">
                    <span class="flashcard-label">Question</span>
                    <div id="fcQuestion">...</div>
                </div>
                <div class="flashcard-face flashcard-back">
                    <span class="flashcard-label">Answer</span>
                    <div id="fcAnswer">...</div>
                </div>
            </div>
        </div>
        <div class="flashcard-controls">
            <button class="fc-btn" onclick="prevCard()">← Prev</button>
            <span id="fcCounter" style="color:white; align-self:center; font-family:monospace;">1 / 1</span>
            <button class="fc-btn" onclick="nextCard()">Next →</button>
        </div>
        <div id="noCardsMsg" class="no-cards-msg" style="display:none;">
            No flashcards found!<br>
            <span style="font-size:0.8rem; opacity:0.7;">Use "Question :: Answer" format<br>or Headers (H1-H3) followed by text.</span>
        </div>
    </div>

    <!-- ENGINEERING RULER -->
    <div id="engRuler">
        <div class="rotate-handle" id="rulerRotate">⟳</div>
    </div>

    <!-- MATH KEYBOARD PANEL -->
    <div id="mathKeyboard" class="math-keyboard-panel">
        <div class="math-input-bar">
            <span style="font-size:0.8rem; font-weight:bold;">∑</span>
            <input type="text" id="mathBuffer" class="math-buffer" placeholder="Type LaTeX..." oninput="updateMathPreview()">
            <div id="mathPreview" class="math-preview"></div>
            <button class="btn btn-secondary" onclick="insertMathFromBuffer()" style="width:auto; padding:5px 15px; margin:0; background:var(--save-color); color:white;">Insert</button>
            <button class="btn btn-secondary" onclick="toggleMathMode()" style="width:auto; padding:5px 10px; margin:0;">▼</button>
        </div>
        <div class="math-tabs">
            <button class="math-tab-btn active" onclick="switchMathTab('basic', this)">Basic</button>
            <button class="math-tab-btn" onclick="switchMathTab('trig', this)">Trig</button>
            <button class="math-tab-btn" onclick="switchMathTab('calc', this)">Calculus</button>
            <button class="math-tab-btn" onclick="switchMathTab('geom', this)">Geometry</button>
            <button class="math-tab-btn" onclick="switchMathTab('struct', this)">Structure</button>
        </div>
        <div id="mathKeys" class="math-keys-grid"></div>
    </div>
    
    <!-- TRACE TABLE MODAL -->
    <div id="traceModal" class="floating-pane" style="display:none; width: 300px; z-index: 1002;">
        <h3 style="margin-bottom: 15px;">New Trace Table</h3>
        <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">Number of Variables:</p>
        <input type="number" id="traceVarCount" class="meta-value" value="3" min="1" max="10" style="margin-bottom:15px;">
        <div style="display:flex; gap:10px;">
            <button class="tool-btn" onclick="confirmTraceTable()" style="background: var(--save-color); color: white; justify-content: center; flex:1;">Insert</button>
            <button class="tool-btn" onclick="closeTraceModal()" style="background: #eee; justify-content: center; flex:1;">Cancel</button>
        </div>
    </div>

    <!-- CONSTANTS MODAL -->
    <div id="constantModal" class="floating-pane" style="display:none; width: 300px; z-index: 1002;">
        <h3 style="margin-bottom: 15px;">Insert Constant</h3>
        
        <div style="margin-bottom:10px;">
            <label style="font-size:0.8rem; color:#666; display:block; margin-bottom:5px;">Symbol (e.g. g, pi, c)</label>
            <input type="text" id="constInput" class="meta-value" placeholder="Type symbol..." oninput="lookupConstant()">
        </div>
        
        <div style="margin-bottom:15px;">
            <label style="font-size:0.8rem; color:#666; display:block; margin-bottom:5px;">Value (Editable)</label>
            <input type="text" id="constValue" class="meta-value" placeholder="Value will appear here...">
        </div>

        <div style="display:flex; gap:10px;">
            <button class="tool-btn" onclick="confirmConstant()" style="background: var(--save-color); color: white; justify-content: center; flex:1;">Insert</button>
            <button class="tool-btn" onclick="closeConstantModal()" style="background: #eee; justify-content: center; flex:1;">Cancel</button>
        </div>
    </div>
    
    <!-- ANATOMY ATLAS MODAL -->
    <div id="anatomyModal" class="floating-pane" style="display:none; width: 500px; max-width: 90vw; z-index: 2006;">
        <h3 style="margin-bottom: 10px;">Anatomy Atlas</h3>
        <div class="atlas-controls">
            <button class="tool-btn" onclick="renderAnatomyMap('body')" style="width:auto;">👤 Body</button>
            <button class="tool-btn" onclick="renderAnatomyMap('tooth')" style="width:auto;">🦷 Tooth</button>
            <button class="tool-btn" onclick="renderAnatomyMap('brain')" style="width:auto;">🧠 Brain</button>
        </div>
        <div id="anatomyContainer" class="anatomy-container">
            <!-- SVG injected here -->
        </div>
        <p style="font-size: 0.8rem; color: #666; margin-top: 10px; text-align: center;">Click a region to insert a study header.</p>
        <button class="tool-btn" onclick="closeAnatomyModal()" style="margin-top: 10px; background: #eee;">Close</button>
    </div>

    <!-- PDF MODE SELECTION MODAL -->
    <div id="pdfModeModal" class="floating-pane" style="display:none; width: 320px; z-index: 2005; text-align: center;">
        <h3 style="margin-bottom: 10px;">📚 Import PDF</h3>
        <p style="font-size:0.9rem; color:#666; margin-bottom:20px;">How would you like to use this file?</p>
        
        <button class="tool-btn" onclick="resolvePdfMode('annotate')" style="background: var(--template-color); color: white; justify-content: center; width:100%; margin-bottom:5px; font-weight:bold;">
            🖍 Annotate on Paper
        </button>
        <p style="font-size:0.75rem; color:#888; margin-bottom: 15px;">Render slides as background to draw over them.</p>

        <button class="tool-btn" onclick="resolvePdfMode('split')" style="background: var(--sidebar-bg); color: white; justify-content: center; width:100%; margin-bottom:5px; font-weight:bold;">
            📖 Split Screen Reader
        </button>
        <p style="font-size:0.75rem; color:#888; margin-bottom: 15px;">Open PDF on the side while you take notes.</p>
        
        <button class="tool-btn" onclick="closePdfModeModal()" style="background: #eee; justify-content: center; width:100%;">Cancel</button>
    </div>

    <div class="text-bubble" id="textBubble">
        <button class="bubble-btn" onclick="formatText('bold')">B</button>
        <button class="bubble-btn" onclick="formatText('italic')">I</button>
        <button class="bubble-btn" onclick="formatText('formatBlock', 'h2')">H1</button>
        <button class="bubble-btn" onclick="formatText('formatBlock', 'h3')">H2</button>
        <button class="bubble-btn" onclick="formatText('insertUnorderedList')">• List</button>
    </div>

    <aside class="sidebar" id="mainSidebar">
        <div class="sidebar-header">
            <div class="app-title">Academic Notebook</div>
            
            <select class="category-filter" id="categoryFilter" onchange="filterChapters()">
                <option value="all">📁 All Notes</option>
                <optgroup label="General">
                    <option value="General">📝 General</option>
                    <option value="Projects">🚀 Projects</option>
                </optgroup>
                <optgroup label="Computer Science">
                    <option value="Algorithms">📐 Algorithms</option>
                    <option value="Systems">⚙️ Systems</option>
                </optgroup>
                <optgroup label="Medical">
                    <option value="Anatomy">🧠 Anatomy</option>
                    <option value="Pathology">🦠 Pathology</option>
                    <option value="Pharmacology">💊 Pharmacology</option>
                    <option value="Clinical">🏥 Clinical</option>
                </optgroup>
                <optgroup label="Dentistry">
                    <option value="Dental Anatomy">🦷 Dental Anatomy</option>
                    <option value="Procedures">🛠️ Procedures</option>
                    <option value="Dental Cases">🧾 Cases</option>
                </optgroup>
                <optgroup label="Engineering">
                    <option value="Electrical">⚡ Electrical (EE)</option>
                    <option value="Mechanical">⚙️ Mechanical (ME)</option>
                    <option value="Civil">🏗 Civil (CE)</option>
                    <option value="Electronics">📡 Electronics (ECE)</option>
                    <option value="Mechatronics">🦾 Mechatronics</option>
                    <option value="Industrial">🏭 Industrial</option>
                </optgroup>
            </select>

            <div class="search-container">
                <input type="text" class="search-input" id="sidebarSearch" placeholder="Search or #tag..." oninput="renderSidebar()">
            </div>
        </div>

        <div class="sidebar-scrollable">

        <div class="sidebar-section pages-section" id="pagesSectionWrapper">
            <div class="section-header" onclick="toggleSection('pagesContent', 'pagesArrow', 'pagesSectionWrapper')">
                <span>📚 Notes</span>
                <span class="arrow" id="pagesArrow">▼</span>
            </div>
            <div class="section-content" id="pagesContent">
                <ul class="chapter-list" id="chapterList"></ul>
            </div>
        </div>

        <!-- NEW: TAGS SECTION -->
        <div class="sidebar-section tags-section" id="tagsSectionWrapper">
            <div class="section-header" onclick="toggleSection('tagsContent', 'tagsArrow', 'tagsSectionWrapper')">
                <span>🏷️ Tags</span>
                <span class="arrow" id="tagsArrow">▼</span>
            </div>
            <div class="section-content" id="tagsContent">
                <div class="tag-cloud" id="tagCloud"></div>
            </div>
        </div>
        
        <!-- POMODORO TIMER SECTION -->
        <div class="sidebar-section" id="pomodoroSectionWrapper">
            <div class="section-header" onclick="toggleSection('pomodoroContent', 'pomodoroArrow', 'pomodoroSectionWrapper')">
                <span>🍅 Study Timer</span>
                <span class="arrow" id="pomodoroArrow">▼</span>
            </div>
            <div class="section-content" id="pomodoroContent">
                <div class="pomodoro-container">
                    <div class="pomodoro-mode" id="pomodoroMode">Focus Time</div>
                    <div class="pomodoro-display" id="pomodoroDisplay">25:00</div>
                    <div class="pomodoro-progress">
                        <div class="pomodoro-progress-bar" id="pomodoroProgressBar"></div>
                    </div>
                    <div class="pomodoro-controls">
                        <button class="pomodoro-btn" id="pomodoroStartBtn" onclick="startPomodoro()" title="Start focus session">▶️ Start</button>
                        <button class="pomodoro-btn" id="pomodoroPauseBtn" onclick="pausePomodoro()" style="display:none;" title="Pause timer">⏸️ Pause</button>
                        <button class="pomodoro-btn" onclick="resetPomodoro()" title="Reset to 25 minutes">🔄 Reset</button>
                    </div>
                    <div class="pomodoro-dnd-container">
                        <label class="pomodoro-dnd-label" title="Block distractions during focus time">
                            <input type="checkbox" id="dndToggle" onchange="updateDndSetting()">
                            <span>🔇 Do Not Disturb</span>
                        </label>
                    </div>
                    <div class="pomodoro-stats">
                        <div class="pomodoro-stat-item">
                            <span>Sessions</span>
                            <span class="pomodoro-stat-value" id="pomodoroSessionCount">0</span>
                        </div>
                        <div class="pomodoro-stat-item">
                            <span>Today</span>
                            <span class="pomodoro-stat-value" id="pomodoroTodayCount">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="sidebar-section tools-section">
            <div class="section-header" onclick="toggleSection('toolsContent', 'toolsArrow')">
                <span>🛠️ Tools</span>
                <span class="arrow" id="toolsArrow">▼</span>
            </div>
            <div class="section-content" id="toolsContent">
                <div class="sidebar-actions">
                    <button class="btn" id="installAppBtn" onclick="installPWA()">📲 Install App</button>
                    <button class="btn btn-add" onclick="createNewChapter()">+ New Page</button>
                    <button class="btn btn-secondary" onclick="toggleFocusMode()">👁️ Focus Mode</button>
                    <button class="btn btn-secondary" onclick="startFlashcardMode()">🗂 Flashcards</button>
                    <button class="btn btn-secondary" onclick="cyclePaperStyle()" id="paperStyleBtn">📄 Paper: Grid</button>
                    <button class="btn btn-save-sidebar" onclick="window.print()">🖨️ Save as PDF</button>
                    <button class="btn btn-secondary" onclick="toggleReadMode()" id="readModeBtn">🔓 Lock / Read</button>
                    <button class="btn btn-secondary" onclick="openMetadataModal()">ⓘ Page Details</button>
                    
                    <!-- UPDATED PDF TOOLS: CONSOLIDATED -->
                    <button class="btn btn-secondary" style="position: relative; border: 1px solid var(--template-color);">
                        📚 Load Lecture
                        <input type="file" onchange="loadLecturePdf(this)" accept="application/pdf" style="position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;">
                    </button>

                    <button class="btn btn-secondary" style="position: relative;">
                        📄 Import Background
                        <input type="file" onchange="importBackgroundFile(this)" accept="image/*" style="position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;">
                    </button>
                    
                    <button class="btn btn-sketch" id="sketchToggle" onclick="toggleSketchMode()">🎨 Sketch Mode</button>
                    <button class="btn" style="background: #3498db; color: white;" onclick="toggleTemplates()">📋 Templates</button>
                    
                    <div style="margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                        <button class="btn btn-secondary" onclick="exportData()" style="font-size: 0.8rem;">⬇ Export Backup</button>
                        <button class="btn btn-secondary" style="font-size: 0.8rem; position: relative;">
                            ⬆ Import Backup
                            <input type="file" id="importFile" onchange="importData(this)" accept=".json" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                        </button>
                        
                        <button class="btn btn-danger" onclick="wipeAllData()">⚠ Wipe All Data</button>
                    </div>
                </div>
            </div>
        </div>
        </div><!-- End of sidebar-scrollable -->

        <div class="storage-footer">
            <div style="display:flex; justify-content:space-between;">
                <span>Storage Used</span>
                <span id="storageText">Checking...</span>
            </div>
            <div class="storage-bar-bg">
                <div class="storage-bar-fill" id="storageBar"></div>
            </div>
        </div>
    </aside>

    <div class="tool-tray-container" id="trayContainer">
        <div class="tool-tray">
            <!-- Global Tools -->
            <button class="tool-btn" id="voiceBtn" onclick="toggleVoiceTranscription()"><span>🎤</span> Dictate</button>
            <button class="tool-btn" id="handBtn" onclick="selectSketchTool('hand')"><span>✋</span> Pan</button>
            <button class="tool-btn" id="eraserBtn" onclick="selectSketchTool('eraser')"><span>🧼</span> Eraser</button>
            
            <div class="tool-btn" style="position: relative;">
                <span>🌈</span> Color
                <input type="color" id="customColorPicker" class="color-picker-input" onchange="setCustomColor(this.value)">
            </div>
            
            <hr style="opacity: 0.2;">
            
            <!-- Standard Block Tools -->
            <button class="tool-btn" onclick="insertBlock('header')"><span>🏷️</span> Title</button>
            <button class="tool-btn" onclick="insertBlock('note')"><span>📌</span> Note</button>
            <button class="tool-btn" onclick="insertBlock('todo')"><span>✅</span> To-Do</button>

            <!-- 1. CS TOOLBAR -->
            <div id="tools-cs" style="display:none; flex-direction:column; gap:8px;">
                <hr style="opacity: 0.2;">
                <button class="tool-btn" onclick="insertCSCodeBlock()"><span>&lt;&gt;</span> Code Block</button>
                <!-- Code button removed here as requested -->
                <button class="tool-btn" onclick="insertAlgoStep()"><span>🔢</span> Algorithm Step</button>
                <button class="tool-btn" onclick="insertComplexity()"><span>O(n)</span> Complexity</button>
                <button class="tool-btn" onclick="insertTraceTable()"><span>📉</span> Trace Table</button>
            </div>

            <!-- 2. MEDICAL TOOLBAR -->
            <div id="tools-med" style="display:none; flex-direction:column; gap:8px;">
                <hr style="opacity: 0.2;">
                <button class="tool-btn" onclick="openAnatomyModal()"><span>🧘</span> Atlas</button>
                <button class="tool-btn" onclick="activateAnatomyPin()"><span>📍</span> Pin</button>
                <button class="tool-btn" onclick="setHighlightPreset('symptom')"><span>🟡</span> Sx</button>
                <button class="tool-btn" onclick="setHighlightPreset('drug')"><span>🔴</span> Rx</button>
                <button class="tool-btn" onclick="insertTimeline()"><span>⏳</span> Timeline</button>
                <button class="tool-btn" onclick="insertComparison()"><span>⚖️</span> Compare</button>
            </div>

            <!-- 3. ENGINEERING TOOLBAR -->
            <div id="tools-eng" style="display:none; flex-direction:column; gap:8px;">
                <hr style="opacity: 0.2;">
                <button class="tool-btn" onclick="toggleMathMode()" id="mathModeBtn"><span>∑</span> Math Mode</button>
                <button class="tool-btn" onclick="toggleRuler()"><span>📏</span> Ruler</button>
                <button class="tool-btn" onclick="insertEquation()"><span>∑</span> Eq Block</button>
                <button class="tool-btn" onclick="insertAssumptions()"><span>🤔</span> Assume</button>
                <button class="tool-btn" onclick="insertConstants()"><span>π</span> Constants</button>
            </div>
            
            <button class="tool-btn" id="stickerBtn" onclick="toggleStickerMode()"><span>👁️</span> Sticker</button>
            <button class="tool-btn" onclick="triggerImageUpload()"><span>📸</span> Photo</button>
            <hr style="opacity: 0.2;">
            
            <button class="tool-btn" style="color: #e74c3c" onclick="clearSketch()"><span>🗑️</span> Clear Sketch</button>
        </div>
        <button class="tool-tray-toggle" id="trayToggle" onclick="toggleTray()">◀</button>
    </div>

    <!-- MAIN CONTAINER FOR SPLIT LAYOUT -->
    <div class="main-container" id="mainContainer">
        <main class="workspace" id="workspace">
            <div class="paper" id="paper">
                <!-- PDF BACKGROUND LAYER -->
                <div id="pdfBackground"></div>

                <!-- MATH LAYER CONTAINER -->
                <div id="mathLayer" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:6;"></div>
                
                <canvas id="sketchCanvas"></canvas>
                
                <div class="status-bar">
                    <span class="save-status" id="saveStatus">All changes saved</span>
                    <span class="word-count" id="wordCount">0 Words</span>
                </div>

                <div class="show-tools-btn" onclick="toggleTopTools()">✎</div>

                <div class="writing-tools" id="topTools">
                    <div class="tool-opt active" data-tool="pen" onclick="selectWritingTool('pen')">🖊️</div>
                    <div class="tool-opt" data-tool="pencil" onclick="selectWritingTool('pencil')">✏️</div>
                    <div class="tool-opt highlighter" data-tool="highlighter" onclick="selectWritingTool('highlighter')">🖌️</div>
                    <div class="tool-opt" data-tool="marker" onclick="selectWritingTool('marker')">🖍️</div>
                    <div class="tool-opt" data-tool="elegant" onclick="selectWritingTool('elegant')">✒️</div>
                    <div class="tool-opt" data-tool="brush" onclick="selectWritingTool('brush')">🎨</div>
                    <div class="tool-opt" data-tool="chalk" onclick="selectWritingTool('chalk')">📝</div>
                    <div class="tool-divider" style="margin: 0 10px;"></div>
                    <div class="tool-opt" onclick="toggleTopTools()" style="font-weight:bold;">_</div>
                    <div class="tool-divider sketch-only"></div>
                    <div class="tool-opt sketch-only" onclick="undoSketch()" title="Undo">↩️</div>
                    <div class="tool-opt sketch-only" onclick="redoSketch()" title="Redo">↪️</div>
                </div>

                <input type="file" id="imageInput" style="display: none;" accept="image/*" onchange="handleImageUpload(event)">

                <input type="text" class="paper-title" id="pageTitle" placeholder="Untitled Page" oninput="markUnsaved(); saveCurrentToCloud()">
                
                <!-- NEW: Sequential Stream Container -->
                <div id="sequentialStream">
                   <!-- Content Area injected here by JS -->
                </div>
            </div>

            <!-- NEW CONTROLS AT END OF STREAM (OUTSIDE PAPER) -->
            <div id="streamControls">
                <button class="btn-stream-add" onclick="addSequentialPage()">
                    ➕ Add Page to Stream
                </button>
            </div>
        </main>

        <!-- LECTURE PANE (RIGHT SPLIT) -->
        <div class="lecture-pane" id="lecturePane">
            <div class="lecture-header">
                <span>📚 Lecture Reader</span>
                <button class="bubble-btn" onclick="closeLecturePane()">✖ Close</button>
            </div>
            <iframe id="lectureFrame" class="lecture-frame"></iframe>
        </div>
    </div>

    <!-- METADATA MODAL -->
    <div id="metadataModal" class="floating-pane" style="display:none; width: 300px;">
        <h3 style="margin-bottom: 15px;">Page Details</h3>
        <div class="meta-group">
            <label class="meta-label">Tags</label>
            <div class="tag-input-container" style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="text" id="metaTagInput" class="meta-value" placeholder="Add tag..." onkeydown="handleMetaTagInput(event)">
                <button class="btn btn-secondary" style="width:auto; padding:5px 10px; margin:0;" onclick="addTagFromInput()">+</button>
            </div>
            <div id="metaTagsList" class="meta-tags"></div>
        </div>
        <div class="meta-group">
            <label class="meta-label">Discipline</label>
            <select id="metaDiscipline" class="meta-value" disabled>
                <option value="cs">Computer Science</option>
                <option value="medical">Medical</option>
                <option value="engineering">Engineering</option>
                <option value="general">General</option>
            </select>
        </div>
        <div class="meta-group">
            <label class="meta-label">Page Type</label>
            <select id="metaType" class="meta-value" onchange="updatePageMeta()">
                <option value="note">General Note</option>
                <option value="concept">Concept</option>
                <option value="algorithm">Algorithm</option>
                <option value="system">System Design</option>
                <option value="project">Project</option>
                <option value="whiteboard">Whiteboard</option>
                <optgroup label="Medical">
                    <option value="anatomy">Anatomy</option>
                    <option value="disease">Disease Profile</option>
                    <option value="drug">Drug Monograph</option>
                    <option value="pathway">Pathway</option>
                    <option value="clinical_case">Clinical Case</option>
                    <option value="lab">Lab Interpretation</option>
                </optgroup>
                <optgroup label="Dentistry">
                    <option value="dental_anatomy">Dental Anatomy</option>
                    <option value="oral_pathology">Oral Pathology</option>
                    <option value="dental_procedure">Procedure</option>
                    <option value="dental_case">Dental Case</option>
                    <option value="prostho_plan">Prostho Plan</option>
                    <option value="endo_case">Endo Case</option>
                    <option value="perio_case">Perio Case</option>
                    <option value="oral_radiology">Oral Radiology</option>
                </optgroup>
                <!-- ENGINEERING -->
                <optgroup label="Engineering">
                    <option value="problem_solution">Problem Solution</option>
                    <option value="circuit_analysis">Circuit Analysis</option>
                    <option value="mechanical_system">Mechanical System</option>
                    <option value="structural_analysis">Structural Analysis</option>
                    <option value="control_system">Control System</option>
                    <option value="process_flow">Process Flow</option>
                    <option value="design_calculation">Design Calc</option>
                    <option value="lab_experiment">Lab Experiment</option>
                </optgroup>
            </select>
        </div>
        <div class="meta-group">
            <label class="meta-label">System / Course</label>
            <input type="text" id="metaSystem" class="meta-value" placeholder="e.g. Cardio, Neuro..." onchange="updatePageMeta()">
        </div>
        <!-- DENTISTRY SPECIFIC METADATA -->
        <div id="dentalMetaGroup" style="display:none; border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px;">
            <div class="meta-group">
                <label class="meta-label">Tooth # (FDI/Universal)</label>
                <input type="text" id="metaTooth" class="meta-value" placeholder="e.g. 11, 46, #3..." onchange="updatePageMeta()">
            </div>
            <div class="meta-group">
                <label class="meta-label">Quadrant</label>
                <select id="metaQuadrant" class="meta-value" onchange="updatePageMeta()">
                    <option value="">None</option>
                    <option value="UR">UR (1)</option>
                    <option value="UL">UL (2)</option>
                    <option value="LL">LL (3)</option>
                    <option value="LR">LR (4)</option>
                </select>
            </div>
             <div class="meta-group">
                <label class="meta-label">Specialty</label>
                <select id="metaSpecialty" class="meta-value" onchange="updatePageMeta()">
                    <option value="">General</option>
                    <option value="Endo">Endodontics</option>
                    <option value="Perio">Periodontics</option>
                    <option value="Prostho">Prosthodontics</option>
                    <option value="Ortho">Orthodontics</option>
                    <option value="Surgery">Oral Surgery</option>
                    <option value="Pedo">Pedodontics</option>
                </select>
            </div>
        </div>

        <!-- ENGINEERING SPECIFIC METADATA -->
        <div id="engineeringMetaGroup" style="display:none; border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px;">
            <div class="meta-group">
                <label class="meta-label">Engineering Branch</label>
                <select id="metaEngBranch" class="meta-value" onchange="updatePageMeta()">
                    <option value="Electrical">Electrical (EE)</option>
                    <option value="Mechanical">Mechanical (ME)</option>
                    <option value="Civil">Civil (CE)</option>
                    <option value="Electronics">Electronics (ECE)</option>
                    <option value="Mechatronics">Mechatronics</option>
                    <option value="Industrial">Industrial</option>
                    <option value="General">General</option>
                </select>
            </div>
        </div>

        <div class="meta-group">
            <label class="meta-label">Difficulty</label>
            <select id="metaDifficulty" class="meta-value" onchange="updatePageMeta()">
                <option value="easy">Easy</option>
                <option value="medium">Medium</option>
                <option value="hard">Hard</option>
                <option value="exam">Exam Critical</option>
            </select>
        </div>
        <div class="meta-group">
            <label class="meta-label">Created At</label>
            <div id="metaCreated" style="font-size:0.8rem; color:#666;"></div>
        </div>
         <button class="tool-btn" onclick="closeMetadataModal()" style="margin-top: 10px; background: #eee;">Close</button>
    </div>

    <!-- UPDATED TEMPLATE POPUP -->
    <div id="templatePopup" class="floating-pane">
        <h3 style="margin-bottom: 10px;">Select Template</h3>
        
        <!-- Main Menu View -->
        <div id="tmpl-main-view">
            <button class="tool-btn" onclick="showCSTemplates()" style="justify-content:space-between; background: var(--cs-accent); color: white; border: none;">
                <span>💻 Computer Science</span>
                <span>▶</span>
            </button>
            <button class="tool-btn" onclick="showMedTemplates()" style="justify-content:space-between; background: var(--med-accent); color: white; border: none;">
                <span>⚕️ Medical</span>
                <span>▶</span>
            </button>
            <button class="tool-btn" onclick="showDentistryTemplates()" style="justify-content:space-between; background: var(--dent-accent); color: white; border: none;">
                <span>🦷 Dentistry</span>
                <span>▶</span>
            </button>
            <button class="tool-btn" onclick="showEngineeringTemplates()" style="justify-content:space-between; background: var(--eng-accent); color: white; border: none;">
                <span>⚙️ Engineering</span>
                <span>▶</span>
            </button>
            <hr style="width:100%; opacity:0.1; margin: 8px 0;">
            <button class="tool-btn" onclick="applyTemplate('default')">📄 Default Page</button>
            <button class="tool-btn" onclick="applyTemplate('whiteboard')">♾️ Infinite Whiteboard</button>
            <button class="tool-btn" onclick="applyTemplate('meeting')">📅 Meeting Notes</button>
            <button class="tool-btn" onclick="applyTemplate('journal')">📖 Daily Journal</button>
            <button class="tool-btn" onclick="applyTemplate('eisenhower')">⚖️ Eisenhower Matrix</button>
        </div>

        <!-- CS Sub-Menu View -->
        <div id="tmpl-cs-view" style="display:none;">
            <button class="tool-btn" onclick="showMainTemplates()" style="background:#eee; margin-bottom:5px; justify-content: center;">◀ Back to Main</button>
            <button class="tool-btn" onclick="applyTemplate('algo')">📐 Algorithm Sheet</button>
            <button class="tool-btn" onclick="applyTemplate('logicGates')">🔌 Logic Gates Simulator</button>
            <button class="tool-btn" onclick="applyTemplate('sysDesign')">⚙️ System Design</button>
            <button class="tool-btn" onclick="applyTemplate('codeStudy')">💻 Code Study</button>
            <button class="tool-btn" onclick="applyTemplate('project')">🚀 Project Log</button>
        </div>

        <!-- Medical Sub-Menu View -->
        <div id="tmpl-med-view" style="display:none;">
            <button class="tool-btn" onclick="showMainTemplates()" style="background:#eee; margin-bottom:5px; justify-content: center;">◀ Back to Main</button>
            <button class="tool-btn" onclick="applyTemplate('anatomy')">🧠 Anatomy Sheet</button>
            <button class="tool-btn" onclick="applyTemplate('disease')">🏥 Disease Profile</button>
            <button class="tool-btn" onclick="applyTemplate('drug')">💊 Drug Monograph</button>
            <button class="tool-btn" onclick="applyTemplate('physio')">🦵 Physiotherapy Case</button>
            <button class="tool-btn" onclick="applyTemplate('pathway')">🧬 Pathway Breakdown</button>
            <button class="tool-btn" onclick="applyTemplate('lab')">🧪 Lab Interpretation</button>
        </div>
        
        <!-- Dentistry Sub-Menu View -->
        <div id="tmpl-dentistry-view" style="display:none;">
            <button class="tool-btn" onclick="showMainTemplates()" style="background:#eee; margin-bottom:5px; justify-content: center;">◀ Back to Main</button>
            <button class="tool-btn" onclick="applyTemplate('dental_anatomy')">🦷 Dental Anatomy</button>
            <button class="tool-btn" onclick="applyTemplate('oral_pathology')">🧬 Oral Pathology</button>
            <button class="tool-btn" onclick="applyTemplate('dental_procedure')">🛠️ Procedure</button>
            <button class="tool-btn" onclick="applyTemplate('dental_case')">🧾 Dental Case</button>
            <button class="tool-btn" onclick="applyTemplate('prostho_plan')">🦷 Prostho Plan</button>
            <button class="tool-btn" onclick="applyTemplate('endo_case')">🦠 Endo Case</button>
            <button class="tool-btn" onclick="applyTemplate('perio_case')">🪥 Perio Case</button>
            <button class="tool-btn" onclick="applyTemplate('oral_radiology')">🩻 Oral Radiology</button>
        </div>

        <!-- Engineering Sub-Menu View -->
        <div id="tmpl-eng-view" style="display:none;">
            <button class="tool-btn" onclick="showMainTemplates()" style="background:#eee; margin-bottom:5px; justify-content: center;">◀ Back to Main</button>
            <button class="tool-btn" onclick="applyTemplate('prob_sol')">📐 Problem Solution</button>
            <button class="tool-btn" onclick="applyTemplate('circuit')">⚡ Circuit Analysis</button>
            <button class="tool-btn" onclick="applyTemplate('mech_sys')">⚙️ Mechanical System</button>
            <button class="tool-btn" onclick="applyTemplate('struct')">🏗 Structural Analysis</button>
            <button class="tool-btn" onclick="applyTemplate('control')">🎛 Control System</button>
            <button class="tool-btn" onclick="applyTemplate('process')">🏭 Process Flow</button>
            <button class="tool-btn" onclick="applyTemplate('lab_exp')">🧪 Lab Experiment</button>
        </div>

        <button class="tool-btn" onclick="toggleTemplates()" style="margin-top: 10px; background: #eee;">Close</button>
    </div>

    <div id="toast" class="toast">Action Successful!</div>

    <script>
        // --- CONSTANTS ---
        const MATH_KEYS = {
            basic: ['+', '-', '=', '≈', '≠', '±', '×', '÷', '(', ')', '[', ']', '{', '}'],
            trig: ['\\sin', '\\cos', '\\tan', '\\cot', '\\sec', '\\csc', '\\arcsin', '\\arccos', '\\arctan'],
            calc: ['\\int', '\\iint', '\\oint', '\\partial', '\\nabla', '\\sum', '\\prod', '\\lim', '\\to', '∞', 'dx', 'dt'],
            geom: ['\\perp', '\\parallel', '∠', '△', 'π', 'θ', 'α', 'β', 'φ', 'λ', 'Δ'],
            struct: ['\\frac{}{}', '^{}', '_{}', '\\sqrt{}', '\\vec{}', '\\bar{}', '\\hat{}']
        };

        const DISCIPLINE_REGISTRY = {
            GENERAL: { id: 'general', name: 'General' },
            CS: { id: 'cs', name: 'Computer Science' },
            MEDICAL: { id: 'medical', name: 'Medical' },
            ENGINEERING: { id: 'engineering', name: 'Engineering' }
        };

        const PAGE_TYPES = {
            NOTE: 'note', CONCEPT: 'concept', ALGORITHM: 'algorithm', SYSTEM: 'system', PROJECT: 'project', WHITEBOARD: 'whiteboard',
            ANATOMY: 'anatomy', DISEASE: 'disease', DRUG: 'drug', PATHWAY: 'pathway', CLINICAL_CASE: 'clinical_case', LAB: 'lab',
            DENTAL_ANATOMY: 'dental_anatomy', ORAL_PATHOLOGY: 'oral_pathology', DENTAL_PROCEDURE: 'dental_procedure', DENTAL_CASE: 'dental_case',
            PROSTHO_PLAN: 'prosthodontic_plan', ENDO_CASE: 'endodontic_case', PERIO_CASE: 'periodontal_case', ORAL_RADIOLOGY: 'oral_radiology',
            PROBLEM_SOLUTION: 'problem_solution', CIRCUIT_ANALYSIS: 'circuit_analysis', MECHANICAL_SYSTEM: 'mechanical_system',
            STRUCTURAL_ANALYSIS: 'structural_analysis', CONTROL_SYSTEM: 'control_system', PROCESS_FLOW: 'process_flow',
            DESIGN_CALCULATION: 'design_calculation', LAB_EXPERIMENT: 'lab_experiment', LOGIC_GATES: 'logic_gates'
        };
        
        // --- SVG DATA FOR ATLAS ---
        const BODY_SVG = `
            <svg viewBox="0 0 300 600" class="anatomy-svg">
                <path id="Head" class="anatomy-region" d="M150,20 C180,20 190,50 190,70 C190,100 170,110 150,110 C130,110 110,100 110,70 C110,50 120,20 150,20 Z" onclick="handleRegionClick('Head')"/>
                <path id="Neck" class="anatomy-region" d="M135,110 L165,110 L170,140 L130,140 Z" onclick="handleRegionClick('Neck')"/>
                <path id="Chest" class="anatomy-region" d="M110,140 L190,140 L200,220 L100,220 Z" onclick="handleRegionClick('Chest')"/>
                <path id="Abdomen" class="anatomy-region" d="M100,220 L200,220 L190,300 L110,300 Z" onclick="handleRegionClick('Abdomen')"/>
                <path id="LeftArm" class="anatomy-region" d="M200,145 L240,180 L230,280 L210,280 L220,180 L195,160 Z" onclick="handleRegionClick('Left Arm')"/>
                <path id="RightArm" class="anatomy-region" d="M100,145 L60,180 L70,280 L90,280 L80,180 L105,160 Z" onclick="handleRegionClick('Right Arm')"/>
                <path id="Pelvis" class="anatomy-region" d="M110,300 L190,300 L180,340 L120,340 Z" onclick="handleRegionClick('Pelvis')"/>
                <path id="LeftLeg" class="anatomy-region" d="M180,340 L210,550 L180,550 L160,340 Z" onclick="handleRegionClick('Left Leg')"/>
                <path id="RightLeg" class="anatomy-region" d="M120,340 L90,550 L120,550 L140,340 Z" onclick="handleRegionClick('Right Leg')"/>
            </svg>
        `;

        const TOOTH_SVG = `
            <svg viewBox="0 0 300 400" class="anatomy-svg">
                <path id="Enamel" class="anatomy-region" d="M70,120 Q150,20 230,120 L210,160 Q150,140 90,160 Z" onclick="handleRegionClick('Enamel')"/>
                <path id="Dentin" class="anatomy-region" d="M90,160 Q150,140 210,160 L200,200 L100,200 Z" onclick="handleRegionClick('Dentin')"/>
                <path id="Pulp" class="anatomy-region" d="M110,200 L190,200 L180,350 L120,350 Z" onclick="handleRegionClick('Pulp Cavity')"/>
                <path id="Root" class="anatomy-region" d="M70,120 L50,350 L120,350 L110,200 L100,200 Z M230,120 L250,350 L180,350 L190,200 L200,200 Z" onclick="handleRegionClick('Root')"/>
                <path id="Gingiva" class="anatomy-region" style="fill:#e57373; stroke:#c0392b;" d="M20,250 Q150,200 280,250 L280,380 L20,380 Z" onclick="handleRegionClick('Gingiva')"/>
            </svg>
        `;

        const BRAIN_SVG = `
            <svg viewBox="0 0 400 300" class="anatomy-svg">
                <path id="Frontal" class="anatomy-region" d="M50,150 Q50,50 150,50 L150,150 Z" onclick="handleRegionClick('Frontal Lobe')"/>
                <path id="Parietal" class="anatomy-region" d="M150,50 Q250,50 250,100 L150,150 Z" onclick="handleRegionClick('Parietal Lobe')"/>
                <path id="Occipital" class="anatomy-region" d="M250,100 Q300,150 250,200 L150,150 Z" onclick="handleRegionClick('Occipital Lobe')"/>
                <path id="Temporal" class="anatomy-region" d="M150,150 L250,200 Q150,250 100,200 Z" onclick="handleRegionClick('Temporal Lobe')"/>
                <path id="Cerebellum" class="anatomy-region" d="M200,220 Q280,220 260,280 Q180,280 200,220 Z" onclick="handleRegionClick('Cerebellum')"/>
                <path id="Brainstem" class="anatomy-region" d="M150,200 L150,280 L180,280 L180,220 Z" onclick="handleRegionClick('Brainstem')"/>
            </svg>
        `;

        // --- INDEXEDDB STORAGE ENGINE (DB v2) ---
        const DB_NAME = 'NotebookDB_vSeq';
        const STORE_NAME = 'chapters';
        let db;

        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 3); // Bumped version
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onerror = (e) => reject("DB Error");
            });
        }

        function saveChapterToDB(chapter) {
            if (!chapter.metadata) {
                chapter.metadata = { discipline: 'general', type: PAGE_TYPES.NOTE, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() };
            }
            chapter.updatedAt = new Date().toISOString();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.put(chapter);
                tx.oncomplete = () => { updateStorageQuota(); resolve(); };
                tx.onerror = () => reject();
            });
        }

        function loadAllChapters() {
            return new Promise((resolve) => {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result || []);
            });
        }

        function deleteChapterFromDB(id) {
            return new Promise((resolve) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.delete(id);
                tx.oncomplete = () => resolve();
            });
        }

        function clearDB() {
            return new Promise((resolve) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.clear();
                tx.oncomplete = () => resolve();
            });
        }

        async function updateStorageQuota() {
            if (navigator.storage && navigator.storage.estimate) {
                const estimate = await navigator.storage.estimate();
                const usage = estimate.usage || 0;
                const percent = Math.min(100, (usage / (estimate.quota || 1024*1024*1000)) * 100).toFixed(1);
                const mb = (usage / 1024 / 1024).toFixed(2);
                document.getElementById('storageBar').style.width = percent + '%';
                document.getElementById('storageText').innerText = `${mb} MB (${percent}%)`;
                if(percent > 90) document.getElementById('storageBar').style.background = '#e74c3c';
            }
        }

        // --- APP STATE ---
        let chapters = [];
        let currentId = null;
        let isSketchMode = false;
        let activeSketchTool = 'brush'; 
        let customStrokeStyle = null; 
        let isReadMode = false;
        let isListening = false;
        let recognition = null;
        let sketchData = null;
        let undoStack = [];
        let redoStack = [];
        let isTrayCollapsed = false;
        let isRulerActive = false;
        let rulerX = 200, rulerY = 300, rulerAngle = 0;
        let isDraggingRuler = false, isRotatingRuler = false;
        let rulerDragStartX, rulerDragStartY, rulerStartAngle;
        let isMathMode = false; // Toggles keyboard visibility
        let savedRange = null; // Stores cursor position
        let editingMathElement = null; // Stores reference to math element being edited

        const canvas = document.getElementById('sketchCanvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        const paperStyles = ['grid', 'lined', 'dotted', 'plain'];
        const markdownTriggers = { '#': 'h1', '##': 'h2', '###': 'h3', '-': 'unordered-list', '*': 'unordered-list', '1.': 'ordered-list', '>': 'blockquote', '[]': 'checkbox', '---': 'hr' };

        // --- GLOBAL SELECTION HELPER FUNCTIONS ---
        function saveSelection() {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                const range = sel.getRangeAt(0);
                // We need to support multiple editors now in the stream
                const stream = document.getElementById('sequentialStream');
                if (stream.contains(range.commonAncestorContainer)) {
                    savedRange = range;
                }
            }
        }

        function restoreSelection() {
            if (savedRange) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(savedRange);
            }
        }

        function handleMarkdownInput(e) {
            if (e.data === ' ') {
                const selection = window.getSelection();
                if (!selection.rangeCount) return;
                const node = selection.anchorNode;
                if (node.nodeType !== 3) return;
                const text = node.textContent;
                const parts = text.split(/[\s\u00A0]+/);
                const trigger = parts[0];
                if (markdownTriggers[trigger]) {
                    const action = markdownTriggers[trigger];
                    const cleanText = text.substring(trigger.length).trim();
                    node.textContent = cleanText; 
                    if (action === 'h1') document.execCommand('formatBlock', false, 'H1');
                    else if (action === 'h2') document.execCommand('formatBlock', false, 'H2');
                    else if (action === 'h3') document.execCommand('formatBlock', false, 'H3');
                    else if (action === 'unordered-list') document.execCommand('insertUnorderedList');
                    else if (action === 'ordered-list') document.execCommand('insertOrderedList');
                    else if (action === 'blockquote') document.execCommand('formatBlock', false, 'BLOCKQUOTE');
                    else if (action === 'hr') document.execCommand('insertHorizontalRule');
                    else if (action === 'checkbox') insertBlock('todo');
                    
                    // Mark unsaved for the specific editor block
                    const block = node.parentElement.closest('.content-area');
                    if(block && block.oninput) block.oninput();
                }
            }
        }

        async function initApp() {
            try {
                await initDB();
                chapters = await loadAllChapters();
                chapters.sort((a, b) => new Date(b.lastEdited) - new Date(a.lastEdited));

                if (chapters.length === 0) {
                    createNewChapter();
                } else {
                    renderSidebar();
                    loadChapter(chapters[0].id);
                }
                
                setupDragAndDrop();
                updateStorageQuota();
                
                document.addEventListener('selectionchange', () => {
                    saveSelection();
                    handleSelectionChange(); 
                });

                // Event delegation for checkbox toggles
                document.getElementById('sequentialStream').addEventListener('click', function(e) {
                    if (e.target.classList.contains('checkbox')) {
                        e.preventDefault(); 
                        e.target.classList.toggle('checked');
                        const wrapper = e.target.parentElement;
                        const textDiv = wrapper.nextElementSibling;
                        if(textDiv && textDiv.classList.contains('checklist-text')) {
                            textDiv.classList.toggle('completed');
                        }
                        // Trigger save on the specific editor block
                        const block = e.target.closest('.content-area');
                        if(block && block.oninput) block.oninput();
                    }
                });

                // Markdown support on stream container
                document.getElementById('sequentialStream').addEventListener('input', handleMarkdownInput);

                setupRulerEvents();
                switchMathTab('basic'); 
                
            } catch (err) {
                console.error(err);
            }
        }

        // --- TAGGING LOGIC ---
        
        // This function builds the tag list in the sidebar based on ALL chapters
        function renderTagsSidebar() {
            const container = document.getElementById('tagCloud');
            if(!container) return;
            
            const allTags = new Set();
            chapters.forEach(ch => {
                if(ch.tags && Array.isArray(ch.tags)) {
                    ch.tags.forEach(t => allTags.add(t));
                }
            });
            
            const sortedTags = Array.from(allTags).sort();
            container.innerHTML = '';
            
            if(sortedTags.length === 0) {
                container.innerHTML = '<div style="font-size:0.8rem; opacity:0.5; padding:5px;">No tags yet...</div>';
                return;
            }

            sortedTags.forEach(tag => {
                const div = document.createElement('div');
                div.className = 'tag-cloud-item';
                div.innerText = '#' + tag;
                div.onclick = () => filterByTag(tag);
                container.appendChild(div);
            });
        }

        function filterByTag(tag) {
            const searchInput = document.getElementById('sidebarSearch');
            searchInput.value = '#' + tag;
            renderSidebar(); 
        }

        // Functions for Modal-based Tag Management
        function handleMetaTagInput(e) {
            if (e.key === 'Enter') {
                addTagFromInput();
            }
        }

        async function addTagFromInput() {
            const input = document.getElementById('metaTagInput');
            const tag = input.value.trim().replace(/^#/, '');
            
            if (tag) {
                const chapter = chapters.find(c => c.id === currentId);
                if (chapter) {
                    if (!chapter.tags) chapter.tags = [];
                    if (!chapter.tags.includes(tag)) {
                        chapter.tags.push(tag);
                        await saveChapterToDB(chapter);
                        input.value = '';
                        openMetadataModal(); // Re-render modal to show new tag
                        renderSidebar(); // Update sidebar tags list
                        loadChapter(currentId); // Reload stream to reflect tag grouping
                    }
                }
            }
        }

        async function removeTagFromModal(tag) {
            const chapter = chapters.find(c => c.id === currentId);
            if (chapter && chapter.tags) {
                chapter.tags = chapter.tags.filter(t => t !== tag);
                await saveChapterToDB(chapter);
                openMetadataModal(); // Re-render
                renderSidebar(); // Update sidebar
                loadChapter(currentId); // Reload stream to update grouping
            }
        }

        // --- MATH KEYBOARD LOGIC ---
        function switchMathTab(category, btn) {
            document.querySelectorAll('.math-tab-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            else if(!btn && document.querySelector('.math-tab-btn')) document.querySelector('.math-tab-btn').classList.add('active');

            const container = document.getElementById('mathKeys');
            container.innerHTML = '';
            
            const keys = MATH_KEYS[category] || [];
            keys.forEach(k => {
                const btn = document.createElement('button');
                btn.className = 'math-key';
                let label = k.replace('\\', '');
                
                if (category === 'basic') {
                    if (k === '\\approx') label = '≈';
                    else if (k === '\\neq') label = '≠';
                    else if (k === '\\pm') label = '±';
                    else if (k === '\\times') label = '×';
                    else if (k === '\\div') label = '÷';
                } else if (category === 'calc') {
                    if (k === '\\int') label = '∫';
                    else if (k === '\\sum') label = 'Σ';
                    else if (k === '\\prod') label = 'Π';
                    else if (k === '\\partial') label = '∂';
                    else if (k === '\\nabla') label = '∇';
                    else if (k === '\\infty') label = '∞';
                } else if (category === 'geom') {
                    if (k === '\\pi') label = 'π';
                    else if (k === '\\theta') label = 'θ';
                    else if (k === '\\alpha') label = 'α';
                    else if (k === '\\beta') label = 'β';
                    else if (k === '\\phi') label = 'φ';
                    else if (k === '\\lambda') label = 'λ';
                    else if (k === '\\Delta') label = 'Δ';
                    else if (k === '\\perp') label = '⊥';
                    else if (k === '\\parallel') label = '∥';
                    else if (k === '\\angle') label = '∠';
                    else if (k === '\\triangle') label = '△';
                }
                
                if(k.includes('frac')) label = 'a/b';
                else if(k.includes('sqrt')) label = '√';
                else if(k.includes('^')) label = 'xʸ';
                else if(k.includes('_')) label = 'xₙ';
                else if(k === '\\int_{}^{}') label = '∫ₐᵇ';
                else if(k === '\\vec{}') label = 'v⃗';
                else if(k === '\\bar{}') label = 'x̄';
                else if(k === '\\hat{}') label = 'x̂';

                btn.innerText = label;
                btn.onclick = () => {
                    const buffer = document.getElementById('mathBuffer');
                    const val = k.startsWith('\\') && category === 'trig' ? k + ' ' : k;
                    buffer.value += val;
                    updateMathPreview();
                    buffer.focus();
                };
                container.appendChild(btn);
            });
        }
        
        function updateMathPreview() {
            const input = document.getElementById('mathBuffer').value;
            const preview = document.getElementById('mathPreview');
            try {
                if(window.katex) {
                    preview.innerHTML = katex.renderToString(input, { throwOnError: false });
                } else {
                    preview.innerText = input;
                }
            } catch(e) {
                preview.innerText = "...";
            }
        }
        
        function insertMathFromBuffer() {
            const buffer = document.getElementById('mathBuffer');
            const latex = buffer.value.trim();
            if(!latex) return;
            
            const isDisplay = editingMathElement && editingMathElement.classList.contains('math-display');
            
            let mathHtml = '';
            if(window.katex) {
                mathHtml = katex.renderToString(latex, { throwOnError: false, displayMode: isDisplay });
            } else {
                mathHtml = `<span style="font-family:monospace; background:#eee;">${latex}</span>`;
            }
            
            if (editingMathElement) {
                editingMathElement.setAttribute('data-latex', latex);
                editingMathElement.innerHTML = mathHtml;
                editingMathElement = null;
            } else {
                const html = `<span class="math-block" contenteditable="false" data-latex="${latex}" style="padding:0 5px; cursor:pointer;" onclick="editMathBlock(this)">${mathHtml}</span>&nbsp;`;
                
                // Check if active element is an editor
                if (document.activeElement && document.activeElement.classList.contains('content-area')) {
                    document.execCommand('insertHTML', false, html);
                } else {
                    // Fallback to primary editor
                    const editor = document.querySelector('.content-area');
                    editor.focus();
                    document.execCommand('insertHTML', false, html);
                }
            }
            
            buffer.value = '';
            updateMathPreview();
        }
        
        window.editMathBlock = (el) => {
            editingMathElement = el; 
            const latex = el.getAttribute('data-latex');
            document.getElementById('mathBuffer').value = latex;
            updateMathPreview();
            toggleMathMode(true); 
        };

        window.toggleMathMode = (forceOpen = false) => {
            const keyboard = document.getElementById('mathKeyboard');
            const btn = document.getElementById('mathModeBtn');
            
            if (forceOpen === true) {
                isMathMode = true;
            } else {
                isMathMode = !isMathMode;
            }
            
            if (isMathMode) {
                keyboard.style.display = 'flex';
                if(btn) btn.classList.add('active');
                document.querySelector('.sidebar').style.bottom = '220px'; 
            } else {
                keyboard.style.display = 'none';
                if(btn) btn.classList.remove('active');
                document.querySelector('.sidebar').style.bottom = '0';
                editingMathElement = null; 
            }
        };

        // --- DISCIPLINE TOOLBAR FUNCTIONS ---
        window.insertAlgoStep = () => { insertHtml(`<div class="chalk-code" contenteditable="true">1. Step description...<br>   ↳ Logic/Condition</div>`); }
        window.insertComplexity = () => { insertHtml(`<span class="algo-badge" contenteditable="true">Time: O(n)</span>&nbsp;`); }
        
        window.insertTraceTable = () => {
            saveSelection();
            document.getElementById('traceModal').style.display = 'flex';
            document.getElementById('traceVarCount').focus();
        }

        window.closeTraceModal = () => {
            document.getElementById('traceModal').style.display = 'none';
        }

        window.confirmTraceTable = () => {
            const count = document.getElementById('traceVarCount').value;
            const n = parseInt(count);
            if (isNaN(n) || n < 1) return;

            let headers = "";
            let cells = "";
            
            for(let i=1; i<=n; i++) {
                headers += `<th>Var ${i}</th>`;
                cells += `<td>-</td>`;
            }
            
            headers += "<th>Output</th>";
            cells += "<td>-</td>";

            const html = `
                <div class="trace-table-container" style="overflow-x:auto; margin:10px 0;">
                    <button contenteditable="false" onclick="addTraceColumn(this)" class="btn-trace-add" title="Add Variable">+</button>
                    <table class="trace-table" style="width:100%; min-width:100%;">
                        <thead><tr>${headers}</tr></thead>
                        <tbody>
                            <tr>${cells}</tr>
                            <tr>${cells}</tr>
                            <tr>${cells}</tr>
                        </tbody>
                    </table>
                </div>
                <p><br></p>
            `;
            restoreSelection(); 
            insertHtml(html);
            closeTraceModal();
        }

        window.addTraceColumn = (btn) => {
            const container = btn.closest('.trace-table-container');
            if(!container) return;
            const table = container.querySelector('table');
            if(!table) return;
            
            const headRow = table.tHead.rows[0];
            const bodyRows = table.tBodies[0].rows;
            
            let insertIndex = headRow.cells.length - 1;
            
            let maxVar = 0;
            for(let cell of headRow.cells) {
                const match = cell.innerText.trim().match(/^Var\s+(\d+)/);
                if(match) {
                    const num = parseInt(match[1]);
                    if(num > maxVar) maxVar = num;
                }
            }
            const newVarName = `Var ${maxVar + 1}`;

            const newTh = document.createElement('th');
            newTh.innerText = newVarName;
            headRow.insertBefore(newTh, headRow.cells[insertIndex]);

            for (let row of bodyRows) {
                const newTd = document.createElement('td');
                newTd.innerText = '-';
                row.insertBefore(newTd, row.cells[insertIndex]);
            }
            
            // Trigger save on the specific editor block
            const block = btn.closest('.content-area');
            if(block && block.oninput) block.oninput();
        };
        
        // Medical Tools
        window.activeAnatomyPinMode = false;
        window.activateAnatomyPin = () => {
            window.activeAnatomyPinMode = true;
            document.getElementById('paper').style.cursor = 'crosshair';
            showToast("Tap paper to place pin");
        }
        
        document.getElementById('paper').addEventListener('click', function(e) {
            if(!window.activeAnatomyPinMode) return;
            if(e.target.closest('.writing-tools') || e.target.closest('.tool-tray-container')) return;
            
            // Fix: Find the specific editor block the user clicked on
            let targetEditor = e.target.closest('.content-area');
            
            // If user clicked on a pin or something inside an editor, get the editor
            if (!targetEditor) {
                // Fallback: Check if we clicked an element inside the stream
                const streamItem = e.target.closest('.sequence-editor-block');
                if (streamItem) {
                    targetEditor = streamItem.querySelector('.content-area');
                }
            }

            // If still no editor (e.g. clicked margin/gap), default to the closest or active one
            if (!targetEditor) {
                // Try finding the element at the click coordinates again to be sure
                const elements = document.elementsFromPoint(e.clientX, e.clientY);
                targetEditor = elements.find(el => el.classList.contains('content-area'));
                
                // Ultimate fallback to the primary editor if clicking dead space
                if (!targetEditor) targetEditor = document.querySelector('.content-area');
            }
            
            const rect = targetEditor.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const globalCount = document.querySelectorAll('.anatomy-pin').length + 1;
            const pin = document.createElement('div');
            pin.className = 'anatomy-pin';
            pin.setAttribute('contenteditable', 'false'); 
            pin.style.left = (x - 12) + 'px'; // Center the 24px pin
            pin.style.top = (y - 12) + 'px';
            pin.innerHTML = `<span>${globalCount}</span>`;
            
            targetEditor.appendChild(pin);
            
            const legendHtml = `<div class="checklist-item">
                <div style="background:var(--med-accent); color:white; width:20px; height:20px; border-radius:50%; text-align:center; font-size:0.7rem; line-height:20px; margin-right:10px;">${globalCount}</div>
                <div class="checklist-text" contenteditable="true">Label...</div>
            </div>`;
            
            // Use insertAdjacentHTML to avoid breaking existing event listeners (checkboxes, etc)
            targetEditor.insertAdjacentHTML('beforeend', legendHtml);
            
            window.activeAnatomyPinMode = false;
            document.getElementById('paper').style.cursor = 'default';
            if(targetEditor.oninput) targetEditor.oninput();
        });

        window.setHighlightPreset = (type) => {
            customStrokeStyle = (type === 'symptom') ? 'rgba(255, 235, 59, 0.4)' : 'rgba(231, 76, 60, 0.4)';
            activeSketchTool = 'custom';
            const highlighterBtn = document.querySelector('.tool-opt.highlighter');
            if(highlighterBtn) highlighterBtn.click();
        }
        
        window.insertTimeline = () => { 
            const html = `
                <div class="timeline-wrapper" style="margin:15px 0;">
                    <div class="timeline-container">
                        <div class="timeline-entry">
                            <strong class="time-label" contenteditable="true">00:00</strong> - 
                            <span class="event-desc" contenteditable="true">Event...</span>
                        </div>
                    </div>
                    <button contenteditable="false" onclick="addTimelineEvent(this)" class="btn-trace-add" style="background:var(--med-accent);" title="Add Event (+10m)">+</button>
                </div>
                <p><br></p>
            `;
            insertHtml(html); 
        }

        window.addTimelineEvent = (btn) => {
            const wrapper = btn.closest('.timeline-wrapper');
            const container = wrapper.querySelector('.timeline-container');
            const lastEntry = container.lastElementChild;
            let timeStr = "00:00";
            
            if (lastEntry) {
                const label = lastEntry.querySelector('.time-label');
                if (label) timeStr = label.innerText.trim();
            }
            
            let [h, m] = timeStr.split(':').map(n => parseInt(n) || 0);
            m += 10;
            if (m >= 60) {
                h += Math.floor(m / 60);
                m = m % 60;
            }
            if (h >= 24) h = h % 24;
            
            const newTime = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            
            const newEntry = document.createElement('div');
            newEntry.className = 'timeline-entry';
            newEntry.innerHTML = `<strong class="time-label" contenteditable="true">${newTime}</strong> - <span class="event-desc" contenteditable="true">...</span>`;
            
            container.appendChild(newEntry);
            
            // Trigger save
            const block = btn.closest('.content-area');
            if(block && block.oninput) block.oninput();
        }

        window.insertComparison = () => { 
            const html = `
                <div class="comparison-wrapper" style="margin:15px 0;">
                    <table class="comparison-table">
                        <thead>
                            <tr><th contenteditable="true">Item A</th><th contenteditable="true">Item B</th></tr>
                        </thead>
                        <tbody>
                            <tr><td contenteditable="true">Value</td><td contenteditable="true">Value</td></tr>
                        </tbody>
                    </table>
                    <button contenteditable="false" onclick="addComparisonRow(this)" class="btn-trace-add" style="background:var(--med-accent);" title="Add Row">+</button>
                </div>
                <p><br></p>
            `;
            insertHtml(html); 
        }

        window.addComparisonRow = (btn) => {
            const wrapper = btn.closest('.comparison-wrapper');
            const table = wrapper.querySelector('table tbody');
            const colCount = wrapper.querySelector('table thead tr').children.length;
            
            const row = document.createElement('tr');
            let cells = "";
            for(let i=0; i<colCount; i++) cells += `<td contenteditable="true">-</td>`;
            row.innerHTML = cells;
            
            table.appendChild(row);
            
            const block = btn.closest('.content-area');
            if(block && block.oninput) block.oninput();
        }

        // Engineering Tools
        window.insertEquation = () => { 
            const latex = "x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}";
            let mathHtml = "";
            if(window.katex) {
                mathHtml = katex.renderToString(latex, { throwOnError: false, displayMode: true });
            } else {
                mathHtml = latex;
            }
            const html = `<div class="math-display" contenteditable="false" data-latex="${latex}" style="text-align:center; padding:10px; cursor:pointer; background:rgba(0,0,0,0.03); border-radius:4px; margin: 10px 0;" onclick="editMathBlock(this)">${mathHtml}</div><p><br></p>`;
            insertHtml(html); 
        }
        window.insertAssumptions = () => { insertHtml(`<h3 style="color:#7f8c8d; border-bottom:1px solid #eee;">Assumptions</h3><ul><li>Steady state</li><li>Adiabatic</li></ul>`); }
        
        // --- CONSTANTS TOOL LOGIC ---
        const ENG_CONSTANTS = {
            'g': '9.81 m/s²',
            'pi': '3.14159',
            'π': '3.14159',
            'e': '2.71828',
            'c': '3.00 × 10⁸ m/s',
            'h': '6.626 × 10⁻³⁴ J·s',
            'G': '6.674 × 10⁻¹¹ N·m²/kg²',
            'atm': '101,325 Pa',
            'R': '8.314 J/(mol·K)',
            'Na': '6.022 × 10²³ mol⁻¹',
            'k': '1.380 × 10⁻²³ J/K'
        };

        window.insertConstants = () => { 
            saveSelection();
            document.getElementById('constantModal').style.display = 'flex';
            document.getElementById('constInput').value = '';
            document.getElementById('constValue').value = '';
            document.getElementById('constInput').focus();
        }

        window.closeConstantModal = () => {
            document.getElementById('constantModal').style.display = 'none';
        };

        window.lookupConstant = () => {
            const key = document.getElementById('constInput').value.trim();
            const valInput = document.getElementById('constValue');
            
            if(ENG_CONSTANTS[key]) {
                valInput.value = ENG_CONSTANTS[key];
            } else if (ENG_CONSTANTS[key.toLowerCase()]) {
                 valInput.value = ENG_CONSTANTS[key.toLowerCase()];
            }
        };

        window.confirmConstant = () => {
            const sym = document.getElementById('constInput').value.trim();
            const val = document.getElementById('constValue').value.trim();
            
            if (sym && val) {
                restoreSelection();
                insertHtml(`<div class="chalk-code">${sym} = ${val}</div><p><br></p>`);
            }
            closeConstantModal();
        };

        window.toggleRuler = () => {
            isRulerActive = !isRulerActive;
            document.getElementById('engRuler').style.display = isRulerActive ? 'block' : 'none';
        }
        
        function setupRulerEvents() {
            const ruler = document.getElementById('engRuler');
            const rotateHandle = document.getElementById('rulerRotate');
            
            ruler.addEventListener('mousedown', (e) => {
                if(e.target === rotateHandle) return; 
                isDraggingRuler = true;
                rulerDragStartX = e.clientX - ruler.offsetLeft;
                rulerDragStartY = e.clientY - ruler.offsetTop;
            });
            
            rotateHandle.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                isRotatingRuler = true;
                const rect = ruler.getBoundingClientRect();
                const centerX = rect.left + rect.width/2;
                const centerY = rect.top + rect.height/2;
                rulerStartAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) - (rulerAngle * Math.PI / 180);
            });
            
            window.addEventListener('mousemove', (e) => {
                if(isDraggingRuler) {
                    rulerX = e.clientX - rulerDragStartX;
                    rulerY = e.clientY - rulerDragStartY;
                    ruler.style.left = rulerX + 'px';
                    ruler.style.top = rulerY + 'px';
                }
                if(isRotatingRuler) {
                    const rect = ruler.getBoundingClientRect();
                    const centerX = rect.left + rect.width/2;
                    const centerY = rect.top + rect.height/2;
                    const angle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
                    rulerAngle = (angle - rulerStartAngle) * 180 / Math.PI;
                    ruler.style.transform = `rotate(${rulerAngle}deg)`;
                }
            });
            
            window.addEventListener('mouseup', () => {
                isDraggingRuler = false;
                isRotatingRuler = false;
            });
        }
        
        // --- NEW PDF IMPORT LOGIC ---
        window.importPdfToCanvas = async (input) => {
            const file = input.files[0];
            if (!file) return;
            
            showToast("Rendering PDF...");
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                const container = document.getElementById('pdfBackground');
                container.innerHTML = ''; 
                
                const paper = document.getElementById('paper');
                paper.classList.remove('grid', 'lined', 'dotted');
                paper.classList.add('plain');
                
                const pdfPagesData = []; 

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const scale = 1.5; 
                    const viewport = page.getViewport({ scale });
                    
                    const canvas = document.createElement('canvas');
                    canvas.className = 'pdf-page-render';
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;
                    
                    container.appendChild(canvas);
                    pdfPagesData.push(canvas.toDataURL('image/jpeg', 0.8));
                }
                
                const chapter = chapters.find(c => c.id === currentId);
                if (chapter) {
                    chapter.pdfPages = pdfPagesData; 
                    await saveChapterToDB(chapter);
                }

                setTimeout(resizeCanvas, 100);
                showToast(`Imported ${pdf.numPages} pages`);
                
            } catch (err) {
                console.error(err);
                showToast("Error reading PDF");
            }
        };

        let pendingPdfInput = null;

        window.loadLecturePdf = (input) => {
            if (!input.files || !input.files[0]) return;
            pendingPdfInput = input;
            document.getElementById('pdfModeModal').style.display = 'flex';
        };

        window.closePdfModeModal = () => {
            document.getElementById('pdfModeModal').style.display = 'none';
            if (pendingPdfInput) {
                pendingPdfInput.value = ''; 
                pendingPdfInput = null;
            }
        };

        window.resolvePdfMode = (mode) => {
            if (!pendingPdfInput) return;
            
            if (mode === 'annotate') {
                importPdfToCanvas(pendingPdfInput);
            } else {
                const file = pendingPdfInput.files[0];
                const url = URL.createObjectURL(file);
                document.getElementById('lectureFrame').src = url;
                document.body.classList.add('split-mode');
                showToast("Lecture Loaded in Split View");
            }
            document.getElementById('pdfModeModal').style.display = 'none';
            pendingPdfInput = null;
        };
        
        // --- TOOLBAR SWITCHING ---
        function updateToolVisibility(chapter) {
            const csTools = document.getElementById('tools-cs');
            if(csTools) csTools.style.display = 'none';

            const medTools = document.getElementById('tools-med');
            if(medTools) medTools.style.display = 'none';

            const engTools = document.getElementById('tools-eng');
            if(engTools) engTools.style.display = 'none';
            
            document.getElementById('engRuler').style.display = 'none';
            isRulerActive = false;
            isMathMode = false; 
            const mathBtn = document.getElementById('mathModeBtn');
            if(mathBtn) mathBtn.classList.remove('active');
            
            const disc = chapter?.metadata?.discipline;
            if(disc === 'cs' && csTools) csTools.style.display = 'flex';
            if(disc === 'medical' && medTools) medTools.style.display = 'flex';
            if(disc === 'engineering' && engTools) engTools.style.display = 'flex';
        }

        window.insertCSCodeBlock = () => {
            const html = `
                <div class="cs-code-container" contenteditable="false">
                    <div class="cs-code-header">
                        <div style="display:flex; align-items:center;">
                            <span style="margin-right:10px;">Code Snippet</span>
                            <select class="cs-lang-select" onchange="updateCodeLanguage(this)">
                                <option value="javascript">JS</option>
                                <option value="python">Python</option>
                                <option value="java">Java</option>
                                <option value="cpp">C++</option>
                                <option value="html">HTML</option>
                                <option value="css">CSS</option>
                                <option value="sql">SQL</option>
                            </select>
                        </div>
                        <div>
                            <span style="font-size:0.7rem; opacity:0.7; margin-right:5px;">Editable</span>
                            <button class="cs-format-btn" onclick="formatCodeBlock(this)">⚡ Format</button>
                        </div>
                    </div>
                    <div class="cs-code-editor language-javascript" contenteditable="true" onfocus="unformatCode(this)" onblur="formatCodeBlock(this)">// Write code here...</div>
                    <div class="cs-code-output" contenteditable="true">Result...</div>
                </div>
                <p><br></p>
            `;
            insertHtml(html);
        };

        window.updateCodeLanguage = (select) => {
            const container = select.closest('.cs-code-container');
            const editor = container.querySelector('.cs-code-editor');
            editor.classList.forEach(cls => {
                if(cls.startsWith('language-')) editor.classList.remove(cls);
            });
            editor.classList.add(`language-${select.value}`);
            if(document.activeElement !== editor) {
                formatCodeBlock(select); 
            }
        };

        window.formatCodeBlock = (el) => {
            const container = el.closest('.cs-code-container');
            const editor = container.querySelector('.cs-code-editor');
            const langSelect = container.querySelector('.cs-lang-select');
            const lang = langSelect.value;
            const code = editor.innerText;
            
            if (Prism && Prism.languages[lang]) {
                const highlighted = Prism.highlight(code, Prism.languages[lang], lang);
                editor.innerHTML = highlighted;
            }
        };

        window.unformatCode = (editor) => {
            const code = editor.innerText;
            editor.innerText = code;
        };

        window.filterChapters = () => {
            renderSidebar();
        }

        // --- METADATA MODAL ---
        window.openMetadataModal = () => {
            const chapter = chapters.find(c => c.id === currentId);
            if (!chapter) return;
            
            document.getElementById('metaDiscipline').value = chapter.metadata?.discipline || 'general';
            document.getElementById('metaType').value = chapter.metadata?.type || 'note';
            document.getElementById('metaDifficulty').value = chapter.metadata?.difficulty || 'medium';
            document.getElementById('metaSystem').value = chapter.metadata?.system || '';
            document.getElementById('metaCreated').innerText = new Date(chapter.metadata?.createdAt).toLocaleString();
            
            // Populate Tags List in Modal
            const tagsList = document.getElementById('metaTagsList');
            tagsList.innerHTML = '';
            (chapter.tags || []).forEach(tag => {
                const chip = document.createElement('div');
                chip.className = 'tag-chip';
                chip.innerHTML = `<span>#${tag}</span><span class="tag-remove" onclick="removeTagFromModal('${tag}')">×</span>`;
                tagsList.appendChild(chip);
            });

            const dentalTypes = [
                PAGE_TYPES.DENTAL_ANATOMY, PAGE_TYPES.ORAL_PATHOLOGY, PAGE_TYPES.DENTAL_PROCEDURE,
                PAGE_TYPES.DENTAL_CASE, PAGE_TYPES.PROSTHO_PLAN, PAGE_TYPES.ENDO_CASE,
                PAGE_TYPES.PERIO_CASE, PAGE_TYPES.ORAL_RADIOLOGY
            ];
            const dentalGroup = document.getElementById('dentalMetaGroup');
            if(dentalTypes.includes(chapter.metadata?.type)) {
                dentalGroup.style.display = 'block';
                document.getElementById('metaTooth').value = chapter.metadata?.toothNumber || '';
                document.getElementById('metaQuadrant').value = chapter.metadata?.quadrant || '';
                document.getElementById('metaSpecialty').value = chapter.metadata?.specialty || '';
            } else {
                dentalGroup.style.display = 'none';
            }

             const engTypes = [
                PAGE_TYPES.PROBLEM_SOLUTION, PAGE_TYPES.CIRCUIT_ANALYSIS, PAGE_TYPES.MECHANICAL_SYSTEM,
                PAGE_TYPES.STRUCTURAL_ANALYSIS, PAGE_TYPES.CONTROL_SYSTEM, PAGE_TYPES.PROCESS_FLOW,
                PAGE_TYPES.DESIGN_CALCULATION, PAGE_TYPES.LAB_EXPERIMENT
            ];
            const engGroup = document.getElementById('engineeringMetaGroup');
             if(engTypes.includes(chapter.metadata?.type) || chapter.metadata?.discipline === 'engineering') {
                engGroup.style.display = 'block';
                document.getElementById('metaEngBranch').value = chapter.metadata?.branch || 'General';
            } else {
                engGroup.style.display = 'none';
            }

            document.getElementById('metadataModal').style.display = 'flex';
        };

        window.closeMetadataModal = () => {
             document.getElementById('metadataModal').style.display = 'none';
        };

        // --- ACTIVE RECALL STICKER LOGIC ---
        let isStickerMode = false;
        let stickerStartX = 0;
        let stickerStartY = 0;
        let stickerPreview = null;

        window.toggleStickerMode = () => {
            isStickerMode = !isStickerMode;
            const btn = document.getElementById('stickerBtn');
            const editor = document.querySelector('.content-area');
            
            if (isStickerMode) {
                btn.classList.add('active');
                if(editor) editor.contentEditable = "false"; 
                document.getElementById('paper').style.cursor = "crosshair";
                showToast("Draw stickers over text/images");
                if(isSketchMode) toggleSketchMode();
            } else {
                btn.classList.remove('active');
                if(editor) editor.contentEditable = "true";
                document.getElementById('paper').style.cursor = "default";
            }
        };

        const paper = document.getElementById('paper');

        function getEventCoords(e) {
            if (e.touches && e.touches.length > 0) {
                return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
            return { x: e.clientX, y: e.clientY };
        }

        function startSticker(e) {
            if (!isStickerMode) return;
            // Allow interactions with tools
            if (e.target.closest('.tool-tray') || e.target.closest('.writing-tools')) return;
            // Don't start drawing a new sticker if clicking an existing one (handled by drag logic)
            if (e.target.classList.contains('recall-sticker')) return; 
            
            // Prevent scrolling on touch
            if(e.type === 'touchstart') {
                 e.preventDefault();
            } else {
                 e.preventDefault(); // Prevent text selection on mouse
            }
            
            const coords = getEventCoords(e);
            
            // Get active editor block in the stream to attach sticker to
            let targetEl = document.elementFromPoint(coords.x, coords.y);
            
            if(!targetEl) return;

            const editor = targetEl.closest('.content-area') || document.querySelector('.content-area');
            if(!editor) return; 

            const rect = editor.getBoundingClientRect();
            stickerStartX = coords.x - rect.left;
            stickerStartY = coords.y - rect.top;
            
            stickerPreview = document.createElement('div');
            stickerPreview.className = 'recall-sticker';
            stickerPreview.style.left = stickerStartX + 'px';
            stickerPreview.style.top = stickerStartY + 'px';
            stickerPreview.style.width = '0px';
            stickerPreview.style.height = '0px';
            stickerPreview.style.opacity = '0.5';
            stickerPreview.style.pointerEvents = 'none'; 
            
            editor.appendChild(stickerPreview);
        }

        function moveSticker(e) {
            if (!isStickerMode || !stickerPreview) return;
            
            if(e.type === 'touchmove') e.preventDefault();

            const coords = getEventCoords(e);
            const editor = stickerPreview.parentElement;
            const rect = editor.getBoundingClientRect();
            
            const currentX = coords.x - rect.left;
            const currentY = coords.y - rect.top;
            
            const width = currentX - stickerStartX;
            const height = currentY - stickerStartY;
            
            stickerPreview.style.width = Math.abs(width) + 'px';
            stickerPreview.style.height = Math.abs(height) + 'px';
            stickerPreview.style.left = (width < 0 ? currentX : stickerStartX) + 'px';
            stickerPreview.style.top = (height < 0 ? currentY : stickerStartY) + 'px';
        }

        function endSticker(e) {
             if (!isStickerMode || !stickerPreview) return;
            
            const width = parseFloat(stickerPreview.style.width);
            const height = parseFloat(stickerPreview.style.height);
            
            if (width > 20 && height > 20) {
                stickerPreview.style.opacity = '1';
                stickerPreview.style.pointerEvents = 'auto'; 
                stickerPreview.setAttribute('contenteditable', 'false');
                
                // Add right click / long press handler for removal
                stickerPreview.oncontextmenu = (ev) => {
                    ev.preventDefault();
                    if(confirm('Remove this sticker?')) ev.target.remove();
                    // Save trigger
                    const block = ev.target.closest('.content-area');
                    if(block && block.oninput) block.oninput();
                };

                const block = stickerPreview.closest('.content-area');
                if(block && block.oninput) block.oninput();
            } else {
                stickerPreview.remove();
            }
            stickerPreview = null;
        }

        paper.addEventListener('mousedown', startSticker);
        paper.addEventListener('mousemove', moveSticker);
        paper.addEventListener('mouseup', endSticker);

        paper.addEventListener('touchstart', startSticker, {passive: false});
        paper.addEventListener('touchmove', moveSticker, {passive: false});
        paper.addEventListener('touchend', endSticker);

        // Sticker Drag Logic
        let dragItem = null;
        let dragStartX = 0;
        let dragStartY = 0;
        let dragInitialLeft = 0;
        let dragInitialTop = 0;
        let isDraggingObject = false;

        function handleObjectDragStart(e) {
            if (!e.target.classList.contains('recall-sticker')) return;
            
            e.preventDefault(); 
            e.stopPropagation(); 

            dragItem = e.target;
            const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
            
            dragStartX = clientX;
            dragStartY = clientY;
            
            dragInitialLeft = parseFloat(dragItem.style.left) || 0;
            dragInitialTop = parseFloat(dragItem.style.top) || 0;
            
            isDraggingObject = false; 
        }

        function handleObjectDragMove(e) {
            if (!dragItem) return;
            e.preventDefault(); 
            const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
            const dx = clientX - dragStartX;
            const dy = clientY - dragStartY;
            
            if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                isDraggingObject = true;
            }
            if (isDraggingObject) {
                dragItem.style.left = (dragInitialLeft + dx) + 'px';
                dragItem.style.top = (dragInitialTop + dy) + 'px';
            }
        }

        function handleObjectDragEnd(e) {
            if (!dragItem) return;
            if (!isDraggingObject) {
                dragItem.classList.toggle('revealed');
            } else {
                // Save position
                const block = dragItem.closest('.content-area');
                if(block && block.oninput) block.oninput();
            }
            dragItem = null;
            isDraggingObject = false;
        }

        // Apply drag listeners to the stream container
        const streamEl = document.getElementById('sequentialStream');
        streamEl.addEventListener('mousedown', handleObjectDragStart);
        window.addEventListener('mousemove', handleObjectDragMove);
        window.addEventListener('mouseup', handleObjectDragEnd);
        
        streamEl.addEventListener('touchstart', handleObjectDragStart, {passive: false});
        window.addEventListener('touchmove', handleObjectDragMove, {passive: false});
        window.addEventListener('touchend', handleObjectDragEnd);

        window.updatePageMeta = () => {
            const chapter = chapters.find(c => c.id === currentId);
            if (chapter) {
                chapter.metadata.type = document.getElementById('metaType').value;
                chapter.metadata.difficulty = document.getElementById('metaDifficulty').value;
                chapter.metadata.system = document.getElementById('metaSystem').value;
                chapter.metadata.toothNumber = document.getElementById('metaTooth').value;
                chapter.metadata.quadrant = document.getElementById('metaQuadrant').value;
                chapter.metadata.specialty = document.getElementById('metaSpecialty').value;
                chapter.metadata.branch = document.getElementById('metaEngBranch').value;

                saveChapterToDB(chapter);
                openMetadataModal(); 
            }
        };

        // --- CORE FUNCTIONS ---
        
        window.toggleTopTools = () => {
            document.body.classList.toggle('tools-hidden');
            const tools = document.getElementById('topTools');
            if (document.body.classList.contains('tools-hidden')) {
                tools.classList.add('collapsed');
            } else {
                tools.classList.remove('collapsed');
            }
        };

        window.wipeAllData = async () => {
            if(confirm("DANGER: This will delete ALL notes forever. Are you sure?")) {
                await clearDB();
                location.reload();
            }
        }

        window.closeLecturePane = () => {
            document.body.classList.remove('split-mode');
        };

        window.toggleSection = (contentId, arrowId, wrapperId = null) => {
            const content = document.getElementById(contentId);
            const arrow = document.getElementById(arrowId);
            const isCollapsed = content.classList.contains('collapsed');
            if (isCollapsed) {
                content.classList.remove('collapsed');
                arrow.style.transform = 'rotate(0deg)';
                if(wrapperId) document.getElementById(wrapperId).classList.remove('collapsed-wrapper');
            } else {
                content.classList.add('collapsed');
                arrow.style.transform = 'rotate(-90deg)';
                if(wrapperId) document.getElementById(wrapperId).classList.add('collapsed-wrapper');
            }
        };

        window.toggleTray = () => {
            isTrayCollapsed = !isTrayCollapsed;
            const container = document.getElementById('trayContainer');
            const toggleBtn = document.getElementById('trayToggle');
            container.classList.toggle('collapsed', isTrayCollapsed);
            toggleBtn.innerText = isTrayCollapsed ? '▶' : '◀';
        };

        window.toggleMobileSidebar = () => {
            document.getElementById('mainSidebar').classList.toggle('open');
        };

        window.toggleFocusMode = () => {
            document.body.classList.toggle('focus-mode');
        };

        window.toggleReadMode = () => {
            isReadMode = !isReadMode;
            document.body.classList.toggle('read-mode', isReadMode);
            const btn = document.getElementById('readModeBtn');
            const editors = document.querySelectorAll('.content-area');
            if (isReadMode) {
                btn.innerText = "🔒 Unlock / Edit";
                editors.forEach(e => e.contentEditable = "false");
                showToast("Read Mode Enabled");
            } else {
                btn.innerText = "🔓 Lock / Read";
                editors.forEach(e => e.contentEditable = "true");
                showToast("Editing Enabled");
            }
        };

        function handleSelectionChange() {
            const bubble = document.getElementById('textBubble');
            const selection = window.getSelection();
            const stream = document.getElementById('sequentialStream');

            if (selection.isCollapsed || !stream.contains(selection.anchorNode)) {
                bubble.classList.remove('visible');
                return;
            }

            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            
            bubble.classList.add('visible');
            bubble.style.top = (rect.top + window.scrollY - 10) + 'px';
            bubble.style.left = (rect.left + (rect.width / 2)) + 'px';
        }

        window.formatText = (command, value = null) => {
            document.execCommand(command, false, value);
            
            // Find which editor block is active to save
            const sel = window.getSelection();
            if(sel.anchorNode) {
                const block = sel.anchorNode.parentElement.closest('.content-area');
                if(block && block.oninput) block.oninput();
            }
        };

        function setupDragAndDrop() {
            const paper = document.getElementById('paper');
            let dragCounter = 0;

            paper.addEventListener('dragenter', (e) => { 
                e.preventDefault(); 
                dragCounter++;
                paper.classList.add('drag-over'); 
                if (e.dataTransfer) e.dataTransfer.dropEffect = 'copy'; 
            });

            paper.addEventListener('dragover', (e) => { 
                e.preventDefault(); 
                if (e.dataTransfer) e.dataTransfer.dropEffect = 'copy'; 
            });

            paper.addEventListener('dragleave', (e) => { 
                e.preventDefault(); 
                dragCounter--;
                if (dragCounter <= 0) paper.classList.remove('drag-over'); 
            });

            paper.addEventListener('drop', (e) => {
                e.preventDefault();
                dragCounter = 0;
                paper.classList.remove('drag-over');

                let range = null;
                if (document.caretRangeFromPoint) {
                    range = document.caretRangeFromPoint(e.clientX, e.clientY);
                } else if (document.caretPositionFromPoint) { 
                    const pos = document.caretPositionFromPoint(e.clientX, e.clientY);
                    if (pos) {
                        range = document.createRange();
                        range.setStart(pos.offsetNode, pos.offset);
                        range.collapse(true);
                    }
                }

                // Determine active editor
                const stream = document.getElementById('sequentialStream');
                let editor = document.querySelector('.content-area');
                
                if (range && stream.contains(range.commonAncestorContainer)) {
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                    editor = range.commonAncestorContainer.closest('.content-area') || editor;
                } else {
                    editor.focus();
                }

                // Handle Files
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    Array.from(files).forEach(file => {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                const html = `<div class="uploaded-container" contenteditable="false"><img src="${event.target.result}" /></div>`;
                                document.execCommand('insertHTML', false, html);
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                    return;
                }
            });
        }

        window.importBackgroundFile = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const chapter = chapters.find(c => c.id === currentId);
                if(chapter) {
                    chapter.backgroundImage = e.target.result;
                    await saveChapterToDB(chapter);
                    loadChapter(currentId);
                    showToast("Background Set");
                }
            };
            reader.readAsDataURL(file);
        };

        window.setCustomColor = (val) => {
            customStrokeStyle = val;
            activeSketchTool = 'custom';
            document.querySelectorAll('.tool-opt').forEach(o => o.classList.remove('active'));
            if(!isSketchMode) toggleSketchMode();
        };

        function resizeCanvas() {
            const paper = document.getElementById('paper');
            const dpr = window.devicePixelRatio || 1;
            
            if (canvas.width !== paper.offsetWidth * dpr || canvas.height !== paper.offsetHeight * dpr) {
                canvas.width = paper.offsetWidth * dpr;
                canvas.height = paper.offsetHeight * dpr;
                ctx.scale(dpr, dpr);
                if (sketchData) drawSavedSketch(sketchData);
            }
        }
        window.addEventListener('resize', resizeCanvas);

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        
        canvas.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) return;
            if (isSketchMode) e.preventDefault();
            startDrawing(e.touches[0]);
        }, { passive: false });
        
        canvas.addEventListener('touchmove', (e) => {
            if (isSketchMode) e.preventDefault(); 
            draw(e.touches[0]);
        }, { passive: false });
        
        canvas.addEventListener('touchend', stopDrawing);

        let isPanning = false;
        let startPanX = 0; let startPanY = 0;
        let scrollStartX = 0; let scrollStartY = 0;

        function getCanvasCoordinates(inputEvent) {
            let clientX = inputEvent.clientX;
            let clientY = inputEvent.clientY;

            // RULER SNAPPING LOGIC
            if (isRulerActive && !isDraggingRuler && !isRotatingRuler) {
                const ruler = document.getElementById('engRuler');
                const rRect = ruler.getBoundingClientRect();
                const rCx = rRect.left + rRect.width / 2;
                const rCy = rRect.top + rRect.height / 2;
                
                // Convert degrees to radians
                const rad = rulerAngle * (Math.PI / 180);
                
                // Calculate position relative to ruler center
                const dx = clientX - rCx;
                const dy = clientY - rCy;
                
                // Rotate to local alignment (un-rotate by rulerAngle)
                // localX is along ruler length, localY is along width/height
                const localX = dx * Math.cos(-rad) - dy * Math.sin(-rad);
                const localY = dx * Math.sin(-rad) + dy * Math.cos(-rad);
                
                // Ruler height is 60px (top at -30, bottom at +30)
                // Snap if within 15px of an edge
                const SNAP_DIST = 20; 
                
                // Ruler is 400px wide, so localX extends from -200 to +200
                if (Math.abs(localX) < 250) { // Allow snapping slightly beyond tips
                    if (Math.abs(localY - 30) < SNAP_DIST) {
                        // Snap to bottom edge
                        const snappedX = localX * Math.cos(rad) - 30 * Math.sin(rad);
                        const snappedY = localX * Math.sin(rad) + 30 * Math.cos(rad);
                        clientX = rCx + snappedX;
                        clientY = rCy + snappedY;
                    } else if (Math.abs(localY + 30) < SNAP_DIST) {
                        // Snap to top edge
                        const snappedX = localX * Math.cos(rad) - (-30) * Math.sin(rad);
                        const snappedY = localX * Math.sin(rad) + (-30) * Math.cos(rad);
                        clientX = rCx + snappedX;
                        clientY = rCy + snappedY;
                    }
                }
            }

            const rect = canvas.getBoundingClientRect();
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function startDrawing(e) {
            if (activeSketchTool === 'hand') {
                isPanning = true;
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                startPanX = clientX; startPanY = clientY;
                const ws = document.getElementById('workspace');
                scrollStartX = ws.scrollLeft; scrollStartY = ws.scrollTop;
                ws.classList.add('grabbing');
                if(e.type === 'touchstart') e.preventDefault();
                return;
            }

            if (!isSketchMode || isReadMode) return;
            if(e.type === 'touchstart') e.preventDefault();
            
            saveStateToStack();
            drawing = true;
            
            const coords = getCanvasCoordinates(e.clientX ? e : e.touches[0]);
            ctx.beginPath();
            ctx.moveTo(coords.x, coords.y);
        }

        function draw(e) {
            if (activeSketchTool === 'hand') {
                if(!isPanning) return;
                e.preventDefault();
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                const walkX = (clientX - startPanX);
                const walkY = (clientY - startPanY);
                const ws = document.getElementById('workspace');
                ws.scrollLeft = scrollStartX - walkX;
                ws.scrollTop = scrollStartY - walkY;
                return;
            }

            if (!drawing || !isSketchMode || isReadMode) return;
            if(e.type === 'touchmove') e.preventDefault();

            const coords = getCanvasCoordinates(e.clientX ? e : e.touches[0]);

            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;

            if (activeSketchTool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = 30;
                ctx.lineTo(coords.x, coords.y);
                ctx.stroke();
            } else if (activeSketchTool === 'highlighter') {
                ctx.globalCompositeOperation = 'source-over'; 
                ctx.strokeStyle = customStrokeStyle || 'rgba(255, 235, 59, 0.25)';
                ctx.lineWidth = 20;
                ctx.lineTo(coords.x, coords.y);
                ctx.stroke();
            } else if (activeSketchTool === 'custom') {
                 ctx.strokeStyle = customStrokeStyle;
                 ctx.lineWidth = 2;
                 ctx.lineTo(coords.x, coords.y);
                 ctx.stroke();
            } else {
                ctx.lineWidth = 2;
                ctx.strokeStyle = document.body.classList.contains('dark-mode') ? '#ffffff' : '#2c3e50';
                ctx.lineTo(coords.x, coords.y);
                ctx.stroke();
            }
            
            ctx.beginPath();
            ctx.moveTo(coords.x, coords.y);
        }

        function stopDrawing() {
            if (activeSketchTool === 'hand') {
                isPanning = false;
                document.getElementById('workspace').classList.remove('grabbing');
                return;
            }
            if (drawing) {
                drawing = false;
                ctx.globalCompositeOperation = 'source-over';
                saveSketchToCloud();
            }
        }

        function saveStateToStack() {
            if (undoStack.length > 20) undoStack.shift(); 
            undoStack.push(canvas.toDataURL());
            redoStack = []; 
        }

        window.undoSketch = () => {
            if (undoStack.length === 0) return;
            redoStack.push(canvas.toDataURL());
            const prevStateUrl = undoStack.pop();
            drawSavedSketch(prevStateUrl);
            setTimeout(async () => {
                const chapter = chapters.find(c => c.id === currentId);
                if (chapter) {
                    chapter.sketch = canvas.toDataURL();
                    await saveChapterToDB(chapter);
                }
            }, 100);
        };

        window.redoSketch = () => {
            if (redoStack.length === 0) return;
            undoStack.push(canvas.toDataURL());
            const nextStateUrl = redoStack.pop();
            drawSavedSketch(nextStateUrl);
             setTimeout(async () => {
                const chapter = chapters.find(c => c.id === currentId);
                if (chapter) {
                    chapter.sketch = canvas.toDataURL();
                    await saveChapterToDB(chapter);
                }
            }, 100);
        };

        function drawSavedSketch(dataUrl) {
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width / (window.devicePixelRatio||1), canvas.height / (window.devicePixelRatio||1));
                ctx.drawImage(img, 0, 0, canvas.width / (window.devicePixelRatio||1), canvas.height / (window.devicePixelRatio||1));
            };
            img.src = dataUrl;
        }

        window.clearSketch = () => {
            if(!confirm("Are you sure you want to clear your drawing?")) return;
            saveStateToStack();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            saveSketchToCloud();
            showToast("Sketch cleared");
        };

        window.selectSketchTool = (tool) => {
            if (tool === 'hand') {
                activeSketchTool = 'hand';
                document.getElementById('handBtn').classList.add('active');
                document.getElementById('eraserBtn').classList.remove('active');
                if(!isSketchMode) toggleSketchMode();
                return;
            } else {
                document.getElementById('handBtn').classList.remove('active');
            }

            if(tool !== 'highlighter') customStrokeStyle = null; 
            activeSketchTool = tool === activeSketchTool ? 'brush' : tool;
            
            document.getElementById('eraserBtn').classList.toggle('active', activeSketchTool === 'eraser');
            const highlighterBtn = document.querySelector('.tool-opt.highlighter');
            if(highlighterBtn) highlighterBtn.classList.toggle('active', activeSketchTool === 'highlighter');

            if (!isSketchMode) toggleSketchMode();
        };

        window.selectWritingTool = (tool, save = true) => {
            if (tool === 'highlighter') {
                selectSketchTool('highlighter');
                return;
            }
            document.getElementById('handBtn').classList.remove('active');
            if(activeSketchTool === 'hand') activeSketchTool = 'brush';
            
            // Apply class to ALL editors in the stream
            document.querySelectorAll('.content-area').forEach(e => {
                e.className = `content-area writing-tool-${tool}`;
            });

            document.querySelectorAll('.tool-opt').forEach(o => o.classList.toggle('active', o.dataset.tool === tool));
            if (save) {
                const chapter = chapters.find(c => c.id === currentId);
                if (chapter) {
                    chapter.tool = tool;
                    saveChapterToDB(chapter);
                }
            }
        };

        window.cyclePaperStyle = async () => {
            const chapter = chapters.find(c => c.id === currentId);
            if(!chapter) return;
            let currentStyle = chapter.paperStyle || 'grid';
            let nextIndex = (paperStyles.indexOf(currentStyle) + 1) % paperStyles.length;
            let nextStyle = paperStyles[nextIndex];
            applyPaperStyle(nextStyle);
            chapter.paperStyle = nextStyle;
            await saveChapterToDB(chapter);
        };

        function applyPaperStyle(style) {
            const paper = document.getElementById('paper');
            const btn = document.getElementById('paperStyleBtn');
            paperStyles.forEach(s => paper.classList.remove(s));
            if(style !== 'grid') paper.classList.add(style);
            btn.innerText = `📄 Paper: ${style.charAt(0).toUpperCase() + style.slice(1)}`;
        }

        window.exportData = () => {
            const dataStr = JSON.stringify(chapters, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = 'notebook_backup_' + new Date().toISOString().slice(0,10) + '.json';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        };

        window.importData = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedChapters = JSON.parse(e.target.result);
                    if (Array.isArray(importedChapters)) {
                        await clearDB();
                        for(const chap of importedChapters) {
                            await saveChapterToDB(chap);
                        }
                        chapters = importedChapters;
                        initApp();
                        showToast("Backup Restored!");
                    } else {
                        alert("Invalid backup file.");
                    }
                } catch (err) {
                    alert("Error reading file");
                }
            };
            reader.readAsText(file);
        };

        // --- FLASHCARD LOGIC START ---
        
        let flashcards = [];
        let currentCardIndex = 0;

        window.startFlashcardMode = () => {
            // 1. Scan for flashcards
            generateFlashcards();

            if (flashcards.length === 0) {
                document.getElementById('flashcardContainer').style.display = 'none';
                document.querySelector('.flashcard-controls').style.display = 'none';
                document.getElementById('noCardsMsg').style.display = 'block';
            } else {
                document.getElementById('flashcardContainer').style.display = 'block';
                document.querySelector('.flashcard-controls').style.display = 'flex';
                document.getElementById('noCardsMsg').style.display = 'none';
                currentCardIndex = 0;
                renderCard();
            }

            document.getElementById('flashcardOverlay').style.display = 'flex';
        };

        function generateFlashcards() {
            flashcards = [];
            
            // Scan ALL content areas in the stream
            const editors = document.querySelectorAll('#sequentialStream .content-area');
            
            editors.forEach(editor => {
                // Strategy A: "Question :: Answer"
                // We scan text content for '::'
                // Simplification: iterate over block elements
                const blocks = editor.querySelectorAll('p, li, h1, h2, h3, h4, div');
                blocks.forEach(block => {
                    const text = block.innerText;
                    if (text.includes('::')) {
                        const parts = text.split('::');
                        if (parts.length >= 2 && parts[0].trim() && parts[1].trim()) {
                            flashcards.push({
                                q: parts[0].trim(),
                                a: parts[1].trim()
                            });
                        }
                    }
                });

                // Strategy B: Header (Q) -> Body (A)
                // We iterate children directly
                const children = Array.from(editor.children);
                let currentQ = null;
                let currentA = '';

                for (let i = 0; i < children.length; i++) {
                    const node = children[i];
                    const tag = node.tagName.toLowerCase();
                    
                    if (['h1', 'h2', 'h3'].includes(tag)) {
                        // If we have a pending card, push it
                        if (currentQ && currentA.trim()) {
                            flashcards.push({ q: currentQ, a: currentA.trim() });
                        }
                        // Start new card
                        currentQ = node.innerText;
                        currentA = '';
                    } else if (currentQ) {
                        // Append to answer if not a new header
                        // Skip empty text nodes if possible, but innerText handles it
                        if (node.innerText.trim()) {
                            // Don't include lines that were already caught by "::" logic to avoid dupes?
                            // For simplicity, we include them unless they are identical.
                            if (!node.innerText.includes('::')) {
                                currentA += node.innerText + '\n';
                            }
                        }
                    }
                }
                // Push last card
                if (currentQ && currentA.trim()) {
                    flashcards.push({ q: currentQ, a: currentA.trim() });
                }
            });
        }

        window.renderCard = () => {
            const card = flashcards[currentCardIndex];
            const cardEl = document.querySelector('.flashcard');
            
            // Reset flip state
            cardEl.classList.remove('flipped');
            
            // Update Text
            // Small delay to allow flip animation reset if needed, but instant is snappier
            document.getElementById('fcQuestion').innerText = card.q;
            document.getElementById('fcAnswer').innerText = card.a;
            
            document.getElementById('fcCounter').innerText = `${currentCardIndex + 1} / ${flashcards.length}`;
        };

        window.flipCard = () => {
            document.querySelector('.flashcard').classList.toggle('flipped');
        };

        window.nextCard = () => {
            if (currentCardIndex < flashcards.length - 1) {
                currentCardIndex++;
                renderCard();
            }
        };

        window.prevCard = () => {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                renderCard();
            }
        };

        window.exitFlashcardMode = () => {
            document.getElementById('flashcardOverlay').style.display = 'none';
        };

        // --- FLASHCARD LOGIC END ---

        // ENHANCED ID GENERATION TO PREVENT COLLISIONS
        window.createNewChapter = async (title, tags) => {
            if (typeof title === 'object' || !title) title = "Untitled Page";
            if (!tags) tags = [];

            if (currentId && title === "Untitled Page" && tags.length === 0) {
                const currentChapter = chapters.find(c => c.id === currentId);
                if (currentChapter && currentChapter.tags && currentChapter.tags.length > 0) {
                    tags = [...currentChapter.tags];
                    title = "Untitled (Continuation)";
                }
            } else if (title === "Untitled Page") {
                 title = `Note - ${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric'})}`;
            }
            
            const catElement = document.getElementById('categoryFilter');
            const currentCat = catElement ? catElement.value : 'all';
            let category = (currentCat === 'all') ? 'General' : currentCat;
            
            // Unique ID Generation: Timestamp + Random Suffix
            const id = "ch_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
            
            const newChapter = {
                id: id,
                title: title,
                category: category, 
                tags: tags,
                content: "<div>Start typing...</div>",
                tool: 'pen',
                sketch: null,
                paperStyle: 'grid',
                lastEdited: new Date().toISOString(),
                metadata: {
                    discipline: 'general',
                    type: PAGE_TYPES.NOTE,
                    difficulty: 'medium',
                    topics: [],
                    system: '',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }
            };
            
            if(['Algorithms','Systems','Projects'].includes(category)) newChapter.metadata.discipline = 'cs';
            if(['Anatomy','Pathology','Pharmacology','Clinical'].includes(category)) newChapter.metadata.discipline = 'medical';
            if(['Dental Anatomy', 'Procedures', 'Dental Cases'].includes(category)) newChapter.metadata.discipline = 'medical'; 
            if(['Electrical','Mechanical','Civil','Electronics','Mechatronics','Industrial'].includes(category)) {
                newChapter.metadata.discipline = 'engineering';
                newChapter.metadata.branch = category;
            }

            chapters.unshift(newChapter); 
            await saveChapterToDB(newChapter);
            renderSidebar();
            
            // Load and scroll to new page
            loadChapter(id);
        };

        window.deleteChapter = async (id, event) => {
            if (event) event.stopPropagation();
            chapters = chapters.filter(c => c.id !== id);
            await deleteChapterFromDB(id);
            if (currentId === id) {
                if (chapters.length > 0) loadChapter(chapters[0].id);
                else createNewChapter();
            } else {
                renderSidebar();
            }
            showToast("Page Deleted");
        };

        window.triggerImageUpload = () => document.getElementById('imageInput').click();
        window.handleImageUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                restoreSelection();
                const stream = document.getElementById('sequentialStream');
                let activeEditor = document.activeElement;
                if (!activeEditor || !stream.contains(activeEditor) || !activeEditor.classList.contains('content-area')) {
                    const editors = stream.querySelectorAll('.content-area');
                    if(editors.length > 0) {
                        activeEditor = editors[editors.length - 1];
                        activeEditor.focus();
                        const range = document.createRange();
                        range.selectNodeContents(activeEditor);
                        range.collapse(false);
                        const sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }
                }
                const html = `<div class="uploaded-container" contenteditable="false"><img src="${event.target.result}" /></div><p><br></p>`;
                document.execCommand('insertHTML', false, html);
                if(activeEditor && activeEditor.oninput) activeEditor.oninput();
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        };

        // --- UPDATED LOAD CHAPTER ---
        function loadChapter(id) {
            currentId = id;
            undoStack = []; redoStack = [];
            const chapter = chapters.find(c => c.id === id);
            if (!chapter) return;

            const stream = document.getElementById('sequentialStream');
            stream.innerHTML = '';
            
            const pdfContainer = document.getElementById('pdfBackground');
            pdfContainer.innerHTML = '';

            setTimeout(() => resizeCanvas(), 0);

            // SEQUENCE LOGIC with De-duplication
            let sequence = [chapter];
            if (chapter.tags && chapter.tags.length > 0) {
                const streamItems = chapters.filter(c => 
                    c.tags && c.tags.some(tag => chapter.tags.includes(tag))
                );
                // Ensure unique items by ID
                const uniqueItems = Array.from(new Map(streamItems.map(item => [item.id, item])).values());
                sequence = uniqueItems;
                
                // Sort by creation date
                sequence.sort((a, b) => new Date(a.metadata.createdAt) - new Date(b.metadata.createdAt));
            }

            // Render Sequence
            sequence.forEach((item, idx) => {
                const block = document.createElement('div');
                block.className = 'sequence-editor-block';
                block.id = `page-block-${item.id}`; // Add ID for scrolling
                
                // Highlight active page
                if (item.id === id) {
                    block.classList.add('active-focus');
                    // Scroll into view after render
                    setTimeout(() => {
                        block.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }

                if (idx > 0) {
                    const br = document.createElement('div');
                    br.className = 'continuation-break';
                    br.innerHTML = `<div class="continuation-label">${item.title}</div>`;
                    stream.appendChild(br);
                }

                const editor = document.createElement('div');
                editor.className = `content-area writing-tool-${item.tool || 'pen'}`;
                editor.contentEditable = !isReadMode;
                editor.spellcheck = false;
                editor.innerHTML = item.content;
                
                // Scoped Save Logic
                editor.oninput = () => {
                    markUnsaved();
                    item.content = editor.innerHTML;
                    item.lastEdited = new Date().toISOString();
                    debounceSave(item);
                };
                
                // Focus handling to highlight active page visually
                editor.onfocus = () => {
                    document.querySelectorAll('.sequence-editor-block').forEach(b => b.classList.remove('active-focus'));
                    block.classList.add('active-focus');
                    currentId = item.id; // Update current context to focused page
                    document.getElementById('pageTitle').value = item.title; // Update title bar
                    renderSidebar(); // Update sidebar highlight
                };

                block.appendChild(editor);
                stream.appendChild(block);
            });

            // Set title bar to the requested ID's title initially
            document.getElementById('pageTitle').value = chapter.title;

            // Background & Sketch Logic (Applies globally to view for now, usually per-page in streams requires complex canvas logic)
            if (chapter.pdfPages && chapter.pdfPages.length > 0) {
                chapter.pdfPages.forEach(dataUrl => {
                    const img = document.createElement('img');
                    img.src = dataUrl;
                    img.className = 'pdf-page-render';
                    pdfContainer.appendChild(img);
                });
                document.getElementById('paper').classList.add('plain');
                document.getElementById('paper').classList.remove('annotate-mode');
            } 
            else if(chapter.backgroundImage) {
                document.getElementById('paper').style.backgroundImage = `url('${chapter.backgroundImage}')`;
                document.getElementById('paper').classList.add('annotate-mode');
            } else {
                document.getElementById('paper').style.backgroundImage = '';
                document.getElementById('paper').classList.remove('annotate-mode');
                applyPaperStyle(chapter.paperStyle || 'grid');
            }

            if (chapter.sketch) {
                sketchData = chapter.sketch;
                drawSavedSketch(sketchData);
            } else {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                sketchData = null;
            }
            
            selectWritingTool(chapter.tool || 'pen', false);
            renderSidebar();
            document.getElementById('mainSidebar').classList.remove('open');
            document.getElementById('saveStatus').innerText = "All changes saved";
            
            // Show/Hide stream continuation button based on whether we are in a stream (have tags)
            const streamControls = document.getElementById('streamControls');
            if (chapter.tags && chapter.tags.length > 0) {
                 streamControls.style.opacity = '1';
                 streamControls.style.pointerEvents = 'auto';
            } else {
                 streamControls.style.opacity = '0';
                 streamControls.style.pointerEvents = 'none';
            }

            updateWordCount();
            updateToolVisibility(chapter);
            
            // Initialize Logic Gates Simulator if this is a logic gates page
            if (chapter.metadata && chapter.metadata.type === PAGE_TYPES.LOGIC_GATES) {
                setTimeout(() => initLogicGatesSimulator(), 200);
            }
        }
        
        async function addSequentialPage() {
            const current = chapters.find(c => c.id === currentId);
            const newTitle = current ? (current.title + " (Cont.)") : "New Page";
            const tags = current ? [...(current.tags || [])] : [];
            await createNewChapter(newTitle, tags);
            showToast("Page Added to Stream");
        }

        let saveTimers = {};
        function debounceSave(chapter) {
            clearTimeout(saveTimers[chapter.id]);
            saveTimers[chapter.id] = setTimeout(async () => {
                await saveChapterToDB(chapter);
                document.getElementById('saveStatus').innerText = "Saved";
            }, 1000);
        }

        let saveTimeout;
        window.markUnsaved = () => { document.getElementById('saveStatus').innerText = "Saving..."; }

        window.saveCurrentToCloud = () => {
            const chapter = chapters.find(c => c.id === currentId);
            if (chapter) {
                chapter.title = document.getElementById('pageTitle').value;
                debounceSave(chapter);
            }
        };
        
        function updateWordCount() {
            const text = document.getElementById('sequentialStream').innerText || "";
            const count = text.trim().split(/\s+/).filter(w => w.length > 0).length;
            document.getElementById('wordCount').innerText = count + " Words";
        }

        function saveSketchToCloud() {
            const chapter = chapters.find(c => c.id === currentId);
            if (chapter) {
                chapter.sketch = canvas.toDataURL();
                saveChapterToDB(chapter);
            }
        }

        window.toggleSketchMode = () => {
            isSketchMode = !isSketchMode;
            document.body.classList.toggle('sketch-mode', isSketchMode);
            document.getElementById('sketchToggle').classList.toggle('active', isSketchMode);
            const editors = document.querySelectorAll('.content-area');
            editors.forEach(e => e.contentEditable = !isSketchMode);
            
            if (!isSketchMode) activeSketchTool = 'brush';
            showToast(isSketchMode ? "Sketching Enabled" : "Writing Enabled");
        };

        window.toggleVoiceTranscription = () => {
            if (!recognition) {
                const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!Speech) return showToast("Speech API not supported on this browser");
                recognition = new Speech();
                recognition.continuous = true;
                recognition.interimResults = false;
                recognition.onresult = (e) => {
                    const text = e.results[e.results.length - 1][0].transcript;
                    document.execCommand('insertText', false, text + " ");
                };
                recognition.onend = () => { if (isListening) recognition.start(); };
            }
            if (isListening) {
                recognition.stop();
                isListening = false;
                document.getElementById('voiceBtn').classList.remove('active-voice');
            } else {
                recognition.start();
                isListening = true;
                document.getElementById('voiceBtn').classList.add('active-voice');
                showToast("Listening...");
            }
        };

        window.insertBlock = (type) => {
            let html = "";
            if (type === 'header') html = "<h2 class='styled-header'>New Title</h2>";
            if (type === 'todo') html = `<div class="checklist-item" contenteditable="false"><div class="checkbox-wrapper" contenteditable="false"><div class="checkbox"></div></div><div class="checklist-text" contenteditable="true">Task Item</div></div>`;
            if (type === 'note') html = "<div class='sticky-note'>Important Note...</div>";
            if (type === 'code') html = "<div class='chalk-code'>// code here</div>";
            insertHtml(html + "<p><br></p>");
        };

        function insertHtml(html) {
            let active = document.activeElement;
            if (!active || !active.closest('.content-area')) {
                active = document.querySelector('.content-area');
                active.focus();
            }
            document.execCommand('insertHTML', false, html);
            const block = active.closest('.content-area');
            if(block && block.oninput) block.oninput();
        }

        window.toggleTemplates = () => {
            const p = document.getElementById('templatePopup');
            p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
        };

        // NEW: TEMPLATE NAVIGATION LOGIC
        window.showCSTemplates = () => {
            document.getElementById('tmpl-main-view').style.display = 'none';
            document.getElementById('tmpl-cs-view').style.display = 'block';
            document.getElementById('tmpl-med-view').style.display = 'none';
            document.getElementById('tmpl-dentistry-view').style.display = 'none';
            document.getElementById('tmpl-eng-view').style.display = 'none';
        };

        window.showMedTemplates = () => {
            document.getElementById('tmpl-main-view').style.display = 'none';
            document.getElementById('tmpl-cs-view').style.display = 'none';
            document.getElementById('tmpl-med-view').style.display = 'block';
            document.getElementById('tmpl-dentistry-view').style.display = 'none';
            document.getElementById('tmpl-eng-view').style.display = 'none';
        };

        window.showDentistryTemplates = () => {
            document.getElementById('tmpl-main-view').style.display = 'none';
            document.getElementById('tmpl-cs-view').style.display = 'none';
            document.getElementById('tmpl-med-view').style.display = 'none';
            document.getElementById('tmpl-dentistry-view').style.display = 'block';
            document.getElementById('tmpl-eng-view').style.display = 'none';
        };

        window.showEngineeringTemplates = () => {
            document.getElementById('tmpl-main-view').style.display = 'none';
            document.getElementById('tmpl-cs-view').style.display = 'none';
            document.getElementById('tmpl-med-view').style.display = 'none';
            document.getElementById('tmpl-dentistry-view').style.display = 'none';
            document.getElementById('tmpl-eng-view').style.display = 'block';
        };

        window.showMainTemplates = () => {
            document.getElementById('tmpl-main-view').style.display = 'block';
            document.getElementById('tmpl-cs-view').style.display = 'none';
            document.getElementById('tmpl-med-view').style.display = 'none';
            document.getElementById('tmpl-dentistry-view').style.display = 'none';
            document.getElementById('tmpl-eng-view').style.display = 'none';
        };

        window.applyTemplate = async (key) => {
            const chapter = chapters.find(c => c.id === currentId);
            if (!chapter) return;

            const temps = {
                default: { title: "New Note", content: "<div>Start typing...</div>", isWhiteboard: false, type: PAGE_TYPES.NOTE },
                meeting: { title: "Meeting: " + new Date().toLocaleDateString(), content: "<h2 class='styled-header'>Participants</h2><p>• </p><h2 class='styled-header'>Notes</h2><p></p><h2 class='styled-header'>Action Items</h2>", type: PAGE_TYPES.NOTE },
                journal: { title: "Entry: " + new Date().toLocaleDateString(), content: "<div class='sticky-note'>What happened today?</div>", type: PAGE_TYPES.NOTE },
                project: { title: "Project Tracker", content: "<h2 class='styled-header'>Phase 1</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Milestone</div></div>", type: PAGE_TYPES.PROJECT },
                eisenhower: { 
                    title: "Eisenhower Matrix", 
                    content: "<h2 class='styled-header' style='color:#c0392b'>1. Do First (Urgent & Important)</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Crisis / Deadline</div></div><h2 class='styled-header' style='color:#2980b9'>2. Schedule (Less Urgent, Important)</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Planning / Strategy</div></div><h2 class='styled-header' style='color:#d35400'>3. Delegate (Urgent, Less Important)</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Interruptions / Meetings</div></div><h2 class='styled-header' style='color:#7f8c8d'>4. Don't Do (Not Urgent, Not Important)</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Distractions</div></div>",
                    type: PAGE_TYPES.NOTE
                },
                whiteboard: {
                    title: "Infinite Whiteboard",
                    content: "<div>Start Brainstorming...</div>",
                    isWhiteboard: true,
                    type: PAGE_TYPES.WHITEBOARD
                },
                algo: { title: "Algorithm Analysis", content: "<h2 class='styled-header'>Problem Statement</h2><p>Describe the problem...</p><h2 class='styled-header'>Complexity</h2><span class='algo-badge'>Time: O(n)</span><span class='algo-badge'>Space: O(1)</span><h2 class='styled-header'>Pseudocode</h2><div class='chalk-code'>// Logic here</div>", type: PAGE_TYPES.ALGORITHM },
                logicGates: { title: "Logic Gates Simulator", content: "<h2 class='styled-header'>Logic Circuit Design</h2><div id='logicGatesSimulator'></div><h2 class='styled-header'>Truth Table</h2><p>Document your results...</p><h2 class='styled-header'>Notes</h2><p>Analysis...</p>", type: PAGE_TYPES.LOGIC_GATES },
                sysDesign: { title: "System Design", content: "<h2 class='styled-header'>Requirements</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Scalability</div></div><h2 class='styled-header'>Architecture Diagram</h2><p>(Use Sketch Mode)</p>", isWhiteboard: true, type: PAGE_TYPES.SYSTEM },
                codeStudy: { title: "Code Study", content: "<h2 class='styled-header'>Code Snippet</h2><div class='cs-code-container' contenteditable='false'><div class='cs-code-header'><span>Main.java</span></div><div class='cs-code-editor' contenteditable='true'>public static void main(String[] args) {}</div><div class='cs-code-output' contenteditable='true'>Output...</div></div><h2 class='styled-header'>Trace / Logic</h2><p>Step 1: ...</p>", type: PAGE_TYPES.NOTE },
                anatomy: { title: "Anatomy Sheet", content: "<h2 class='styled-header'>Structure & Function</h2><p>Describe location, origin, insertion...</p><h2 class='styled-header'>Relations</h2><p>Anterior, posterior...</p><h2 class='styled-header'>Clinical Relevance</h2><div class='sticky-note'>Important clinical notes...</div><h2 class='styled-header'>Sketch Area</h2><p>(Draw below)</p>", type: PAGE_TYPES.ANATOMY },
                disease: { title: "Disease Profile", content: "<h2 class='styled-header'>Definition & Etiology</h2><p>...</p><h2 class='styled-header'>Pathophysiology</h2><p>...</p><h2 class='styled-header'>Clinical Features</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Symptom 1</div></div><h2 class='styled-header'>Management</h2><p>...</p>", type: PAGE_TYPES.DISEASE },
                drug: { title: "Drug Monograph", content: "<h2 class='styled-header'>Class & Mechanism</h2><p>...</p><h2 class='styled-header'>Indications</h2><p>...</p><h2 class='styled-header'>Contraindications & Side Effects</h2><div class='sticky-note'>Warning: ...</div><h2 class='styled-header'>Dosage</h2><p>...</p>", type: PAGE_TYPES.DRUG },
                physio: { title: "Physio Case", content: "<h2 class='styled-header'>Patient Profile</h2><p>Age, Gender, Occupation...</p><h2 class='styled-header'>Assessment (SOAP)</h2><p>Subjective: ...</p><p>Objective: ...</p><h2 class='styled-header'>Treatment Plan</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Exercise 1</div></div>", type: PAGE_TYPES.CLINICAL_CASE },
                pathway: { title: "Pathway Breakdown", content: "<h2 class='styled-header'>Overview</h2><p>...</p><h2 class='styled-header'>Steps</h2><div class='chalk-code'>1. Signal -> Receptor</div><h2 class='styled-header'>Regulation</h2><p>...</p>", type: PAGE_TYPES.PATHWAY },
                lab: { title: "Lab Interpretation", content: "<h2 class='styled-header'>Test Name</h2><p>...</p><h2 class='styled-header'>Normal Range</h2><p>...</p><h2 class='styled-header'>Interpretation</h2><p>High: ...</p><p>Low: ...</p>", type: PAGE_TYPES.LAB },
                dental_anatomy: { title: "Dental Anatomy", content: "<h2 class='styled-header'>Tooth Name / Number</h2><p>...</p><h2 class='styled-header'>Morphology & Surfaces</h2><p>...</p><h2 class='styled-header'>Root Anatomy</h2><p>...</p><h2 class='styled-header'>Clinical Notes</h2><div class='sticky-note'>Eruption: ...</div>", type: PAGE_TYPES.DENTAL_ANATOMY },
                oral_pathology: { title: "Oral Pathology", content: "<h2 class='styled-header'>Condition</h2><p>...</p><h2 class='styled-header'>Etiology</h2><p>...</p><h2 class='styled-header'>Clinical Appearance</h2><p>...</p><h2 class='styled-header'>Radiographic Features</h2><p>...</p><h2 class='styled-header'>Management</h2><p>...</p>", type: PAGE_TYPES.ORAL_PATHOLOGY },
                dental_procedure: { title: "Dental Procedure", content: "<h2 class='styled-header'>Procedure Name</h2><p>...</p><h2 class='styled-header'>Indications</h2><p>...</p><h2 class='styled-header'>Instruments Required</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Mirror/Probe</div></div><h2 class='styled-header'>Step-by-Step</h2><p>1. Anesthesia...</p>", type: PAGE_TYPES.DENTAL_PROCEDURE },
                dental_case: { title: "Dental Case", content: "<h2 class='styled-header'>Patient Profile</h2><p>...</p><h2 class='styled-header'>Chief Complaint (C/O)</h2><p>...</p><h2 class='styled-header'>Examination (O/E)</h2><p>Intraoral: ...</p><h2 class='styled-header'>Diagnosis & Plan</h2><p>...</p>", type: PAGE_TYPES.DENTAL_CASE },
                prostho_plan: { title: "Prostho Plan", content: "<h2 class='styled-header'>Edentulous Space</h2><p>...</p><h2 class='styled-header'>Abutment Evaluation</h2><p>...</p><h2 class='styled-header'>Design Components</h2><p>Major Connector: ...</p><p>Clasps: ...</p>", type: PAGE_TYPES.PROSTHO_PLAN },
                endo_case: { title: "Endo Case", content: "<h2 class='styled-header'>Tooth & Diagnosis</h2><p>...</p><h2 class='styled-header'>Access & WL</h2><p>Working Length: ...mm</p><h2 class='styled-header'>Instrumentation</h2><p>MAF: ...</p><h2 class='styled-header'>Obturation</h2><p>Technique: ...</p>", type: PAGE_TYPES.ENDO_CASE },
                perio_case: { title: "Perio Charting", content: "<h2 class='styled-header'>Periodontal Status</h2><p>Pockets > 4mm: ...</p><h2 class='styled-header'>Diagnosis</h2><p>Stage: ... Grade: ...</p><h2 class='styled-header'>Treatment Plan</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Scaling & Root Planing</div></div>", type: PAGE_TYPES.PERIO_CASE },
                oral_radiology: { title: "Radiographic Report", content: "<h2 class='styled-header'>Image Type</h2><p>IOPA / OPG / CBCT</p><h2 class='styled-header'>Findings</h2><p>Radio-opacity/lucency: ...</p><h2 class='styled-header'>Interpretation</h2><p>...</p>", type: PAGE_TYPES.ORAL_RADIOLOGY },
                prob_sol: { title: "Problem Solution", content: "<h2 class='styled-header'>Problem Statement</h2><p>...</p><h2 class='styled-header'>Given & Assumptions</h2><p>...</p><h2 class='styled-header'>Diagram</h2><p>(Use Sketch Mode)</p><h2 class='styled-header'>Governing Equations</h2><p>...</p><h2 class='styled-header'>Solution</h2><p>...</p><h2 class='styled-header'>Final Answer</h2><div class='sticky-note'>Result: ...</div>", type: PAGE_TYPES.PROBLEM_SOLUTION },
                circuit: { title: "Circuit Analysis", content: "<h2 class='styled-header'>Circuit Diagram</h2><p>(Draw Schematic)</p><h2 class='styled-header'>Known Values</h2><p>R1 = ...</p><h2 class='styled-header'>Laws Applied</h2><p>KCL / KVL</p><h2 class='styled-header'>Analysis</h2><p>...</p>", isWhiteboard: true, type: PAGE_TYPES.CIRCUIT_ANALYSIS },
                mech_sys: { title: "Mechanical System", content: "<h2 class='styled-header'>System Description</h2><p>...</p><h2 class='styled-header'>Free Body Diagram</h2><p>(Draw FBD)</p><h2 class='styled-header'>Equations of Motion</h2><p>F = ma...</p><h2 class='styled-header'>Solution</h2><p>...</p>", isWhiteboard: true, type: PAGE_TYPES.MECHANICAL_SYSTEM },
                struct: { title: "Structural Analysis", content: "<h2 class='styled-header'>Structure Description</h2><p>...</p><h2 class='styled-header'>Load Diagram</h2><p>...</p><h2 class='styled-header'>Calculations</h2><p>...</p><h2 class='styled-header'>Design Checks</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Safety Factor OK</div></div>", type: PAGE_TYPES.STRUCTURAL_ANALYSIS },
                control: { title: "Control System", content: "<h2 class='styled-header'>Block Diagram</h2><p>...</p><h2 class='styled-header'>Transfer Function</h2><p>G(s) = ...</p><h2 class='styled-header'>Stability Analysis</h2><p>...</p>", isWhiteboard: true, type: PAGE_TYPES.CONTROL_SYSTEM },
                process: { title: "Process Flow", content: "<h2 class='styled-header'>Overview</h2><p>...</p><h2 class='styled-header'>Flow Diagram</h2><p>...</p><h2 class='styled-header'>Inputs / Outputs</h2><p>...</p><h2 class='styled-header'>Bottlenecks</h2><p>...</p>", isWhiteboard: true, type: PAGE_TYPES.PROCESS_FLOW },
                lab_exp: { title: "Lab Experiment", content: "<h2 class='styled-header'>Objective</h2><p>...</p><h2 class='styled-header'>Apparatus</h2><p>...</p><h2 class='styled-header'>Procedure</h2><p>1. ...</p><h2 class='styled-header'>Observations</h2><p>...</p><h2 class='styled-header'>Calculations & Conclusion</h2><p>...</p>", type: PAGE_TYPES.LAB_EXPERIMENT },
            };
            
            const selected = temps[key];
            if(selected) {
                document.getElementById('pageTitle').value = selected.title;
                // Apply to FIRST active editor
                document.querySelector('.content-area').innerHTML = selected.content;
                
                if (selected.isWhiteboard) {
                    chapter.isWhiteboard = true;
                    document.getElementById('paper').classList.add('infinite');
                } else {
                    chapter.isWhiteboard = false;
                    document.getElementById('paper').classList.remove('infinite');
                }
                
                let disc = 'general';
                if(['algo', 'codeStudy', 'sysDesign', 'project', 'logicGates'].includes(key)) disc = 'cs';
                if(['anatomy', 'disease', 'drug', 'physio', 'pathway', 'lab'].includes(key)) disc = 'medical';
                if(['dental_anatomy', 'oral_pathology', 'dental_procedure', 'dental_case', 'prostho_plan', 'endo_case', 'perio_case', 'oral_radiology'].includes(key)) disc = 'medical'; 
                if(['prob_sol', 'circuit', 'mech_sys', 'struct', 'control', 'process', 'lab_exp'].includes(key)) disc = 'engineering';
                
                chapter.metadata.discipline = disc;
                chapter.metadata.type = selected.type || PAGE_TYPES.NOTE;
                
                if (disc === 'engineering') {
                    if (key === 'circuit' || key === 'control') chapter.metadata.branch = 'Electrical';
                    else if (key === 'mech_sys') chapter.metadata.branch = 'Mechanical';
                    else if (key === 'struct') chapter.metadata.branch = 'Civil';
                    else if (key === 'process') chapter.metadata.branch = 'Industrial';
                    else chapter.metadata.branch = 'General';
                }

                await saveChapterToDB(chapter);
                renderSidebar();
                updateToolVisibility(chapter);
                
                // Initialize Logic Gates Simulator if this template was selected
                if (key === 'logicGates') {
                    setTimeout(() => initLogicGatesSimulator(), 100);
                }
            }
            toggleTemplates();
            resizeCanvas(); 
        };

        window.renderSidebar = () => {
            const list = document.getElementById('chapterList');
            const searchStr = document.getElementById('sidebarSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            list.innerHTML = '';
            
            const filtered = chapters.filter(ch => {
                const titleMatch = (ch.title || '').toLowerCase().includes(searchStr);
                const tagMatch = (ch.tags || []).some(t => t.toLowerCase().includes(searchStr.replace('#','')));
                const matchesSearch = titleMatch || tagMatch;

                // Smart Filtering based on Discipline or Category
                let matchesCat = true;
                if (categoryFilter !== 'all') {
                    if (['Algorithms', 'Systems', 'Projects'].includes(categoryFilter)) {
                        matchesCat = (ch.category === categoryFilter); 
                         if(ch.metadata?.type === PAGE_TYPES.ALGORITHM && categoryFilter === 'Algorithms') matchesCat = true;
                         if(ch.metadata?.type === PAGE_TYPES.SYSTEM && categoryFilter === 'Systems') matchesCat = true;
                         if(ch.metadata?.type === PAGE_TYPES.PROJECT && categoryFilter === 'Projects') matchesCat = true;
                    } else if (['Anatomy', 'Pathology', 'Pharmacology', 'Clinical'].includes(categoryFilter)) {
                        if (ch.metadata?.discipline !== 'medical') return false;
                        if (categoryFilter === 'Anatomy' && ch.metadata?.type !== PAGE_TYPES.ANATOMY) matchesCat = false;
                        if (categoryFilter === 'Pathology' && ch.metadata?.type !== PAGE_TYPES.DISEASE) matchesCat = false;
                        if (categoryFilter === 'Pharmacology' && ch.metadata?.type !== PAGE_TYPES.DRUG) matchesCat = false;
                        if (categoryFilter === 'Clinical' && ![PAGE_TYPES.CLINICAL_CASE, PAGE_TYPES.LAB].includes(ch.metadata?.type)) matchesCat = false;
                    } else if (['Dental Anatomy', 'Procedures', 'Dental Cases'].includes(categoryFilter)) {
                         if (ch.metadata?.discipline !== 'medical') return false; 
                         if (categoryFilter === 'Dental Anatomy' && ch.metadata?.type !== PAGE_TYPES.DENTAL_ANATOMY) matchesCat = false;
                         if (categoryFilter === 'Procedures' && ![PAGE_TYPES.DENTAL_PROCEDURE, PAGE_TYPES.PROSTHO_PLAN].includes(ch.metadata?.type)) matchesCat = false;
                         if (categoryFilter === 'Dental Cases' && ![PAGE_TYPES.DENTAL_CASE, PAGE_TYPES.ENDO_CASE, PAGE_TYPES.PERIO_CASE, PAGE_TYPES.ORAL_RADIOLOGY, PAGE_TYPES.ORAL_PATHOLOGY].includes(ch.metadata?.type)) matchesCat = false;

                    } else if (['Electrical', 'Mechanical', 'Civil', 'Electronics', 'Mechatronics', 'Industrial'].includes(categoryFilter)) {
                        if (ch.metadata?.discipline !== 'engineering') return false;
                        if (ch.metadata?.branch !== categoryFilter) matchesCat = false;
                    } else if (categoryFilter === 'General') {
                        matchesCat = ch.metadata?.discipline === 'general';
                    }
                }
                
                return matchesSearch && matchesCat;
            });

            filtered.forEach(ch => {
                const li = document.createElement('li');
                li.className = `nav-item ${ch.id === currentId ? 'active' : ''}`;
                
                const cleanContent = (ch.content || '').replace(/<[^>]*>?/gm, '');
                let snippet = cleanContent.substring(0, 60) + (cleanContent.length > 60 ? '...' : '');
                
                let tagsHtml = (ch.tags || []).map(t => `<span class="tag-mini">#${t}</span>`).join('');
                let catBadge = '';
                const disp = ch.metadata?.discipline || ch.category;
                if(disp && disp !== 'general' && categoryFilter === 'all') {
                     catBadge = `<div class="cat-badge">${disp.toUpperCase()}</div>`;
                }

                li.innerHTML = `
                    <div class="nav-info" onclick="loadChapter('${ch.id}')">
                        <div class="nav-item-title">${ch.title || 'Untitled'}</div>
                        <div class="nav-item-snippet">${snippet}</div>
                        <div style="margin-top:4px; display:flex;">${tagsHtml}</div>
                        ${catBadge}
                    </div>
                    <button class="btn-delete" onclick="deleteChapter('${ch.id}', event)" title="Delete Page">🗑️</button>
                `;
                list.appendChild(li);
            });

            renderTagsSidebar(); // Refresh tags sidebar when sidebar updates
        };

        window.toggleDarkMode = () => {
            const isDark = document.body.classList.toggle('dark-mode');
            document.getElementById('darkModeToggle').innerText = isDark ? '☀️' : '🌙';
        };

        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        };

        // --- PWA LOGIC ---
        const iconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" rx="100" fill="#2c3e50"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="300">📝</text></svg>`;
        const iconUrl = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(iconSVG)}`;
        
        document.getElementById('appIcon').href = iconUrl;
        document.getElementById('appleIcon').href = iconUrl;

        const manifest = {
            "name": "Academic Notebook",
            "short_name": "Notebook",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#fdfbf7",
            "theme_color": "#2c3e50",
            "orientation": "any",
            "icons": [
                {
                    "src": iconUrl,
                    "sizes": "512x512",
                    "type": "image/svg+xml",
                    "purpose": "any maskable"
                }
            ]
        };
        
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        document.getElementById('appManifest').href = URL.createObjectURL(manifestBlob);

        let deferredPrompt;
        const installBtn = document.getElementById('installAppBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'flex'; 
        });

        window.installPWA = async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                installBtn.style.display = 'none';
            }
            deferredPrompt = null;
        };

        window.addEventListener('appinstalled', () => {
            installBtn.style.display = 'none';
            showToast("App Installed Successfully!");
        });

        // ==================== POMODORO TIMER ====================
        let pomodoroInterval = null;
        let pomodoroTimeLeft = 25 * 60; // 25 minutes in seconds
        let pomodoroTotalTime = 25 * 60;
        let pomodoroMode = 'focus'; // 'focus' or 'break'
        let pomodoroPaused = false;
        let dndEnabled = false;
        let pomodoroSessionCount = 0;
        let pomodoroTodayCount = 0;
        let pomodoroLastDate = null;

        // Load saved stats from localStorage
        function loadPomodoroStats() {
            const saved = localStorage.getItem('pomodoroStats');
            if (saved) {
                const stats = JSON.parse(saved);
                pomodoroSessionCount = stats.sessions || 0;
                pomodoroLastDate = stats.lastDate || null;
                
                // Reset today count if it's a new day
                const today = new Date().toDateString();
                if (pomodoroLastDate === today) {
                    pomodoroTodayCount = stats.todayCount || 0;
                } else {
                    pomodoroTodayCount = 0;
                }
            }
            updatePomodoroStats();
        }

        // Save stats to localStorage
        function savePomodoroStats() {
            const stats = {
                sessions: pomodoroSessionCount,
                todayCount: pomodoroTodayCount,
                lastDate: new Date().toDateString()
            };
            localStorage.setItem('pomodoroStats', JSON.stringify(stats));
        }

        // Update stats display
        function updatePomodoroStats() {
            document.getElementById('pomodoroSessionCount').innerText = pomodoroSessionCount;
            document.getElementById('pomodoroTodayCount').innerText = pomodoroTodayCount;
        }

        function updatePomodoroDisplay() {
            const minutes = Math.floor(pomodoroTimeLeft / 60);
            const seconds = pomodoroTimeLeft % 60;
            const timeString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            document.getElementById('pomodoroDisplay').innerText = timeString;
            if (dndEnabled) {
                document.getElementById('dndTimer').innerText = timeString;
            }
            
            // Update progress bar
            const progress = ((pomodoroTotalTime - pomodoroTimeLeft) / pomodoroTotalTime) * 100;
            document.getElementById('pomodoroProgressBar').style.width = progress + '%';
            
            // Update page title if timer is running
            if (pomodoroInterval && !pomodoroPaused) {
                document.title = `${timeString} - ${pomodoroMode === 'focus' ? '🍅 Focus' : '☕ Break'}`;
            }
        }

        function startPomodoro() {
            if (pomodoroInterval) return; // Already running
            
            pomodoroPaused = false;
            document.getElementById('pomodoroStartBtn').style.display = 'none';
            document.getElementById('pomodoroPauseBtn').style.display = 'inline-block';
            
            // Enable DND if checkbox is checked
            if (document.getElementById('dndToggle').checked) {
                enableDnd();
            }
            
            // Show encouraging toast
            if (pomodoroMode === 'focus') {
                showToast("🍅 Focus session started! You've got this!");
            } else {
                showToast("☕ Break time! Relax and recharge.");
            }
            
            pomodoroInterval = setInterval(() => {
                if (!pomodoroPaused) {
                    pomodoroTimeLeft--;
                    updatePomodoroDisplay();
                    
                    if (pomodoroTimeLeft <= 0) {
                        // Timer finished
                        clearInterval(pomodoroInterval);
                        pomodoroInterval = null;
                        
                        // Play notification sound
                        playBeep();
                        
                        // Switch modes
                        if (pomodoroMode === 'focus') {
                            // Focus session completed - increment counters
                            pomodoroSessionCount++;
                            pomodoroTodayCount++;
                            savePomodoroStats();
                            updatePomodoroStats();
                            
                            pomodoroMode = 'break';
                            pomodoroTimeLeft = 5 * 60; // 5 minute break
                            pomodoroTotalTime = 5 * 60;
                            document.getElementById('pomodoroMode').innerText = 'Break Time';
                            showToast("🎉 Great work! You completed a focus session! Time for a 5-minute break.");
                            disableDnd();
                        } else {
                            pomodoroMode = 'focus';
                            pomodoroTimeLeft = 25 * 60; // 25 minute focus
                            pomodoroTotalTime = 25 * 60;
                            document.getElementById('pomodoroMode').innerText = 'Focus Time';
                            showToast("☕ Break over! Ready for another focus session?");
                        }
                        
                        document.getElementById('pomodoroStartBtn').style.display = 'inline-block';
                        document.getElementById('pomodoroPauseBtn').style.display = 'none';
                        document.title = 'Academic Notebook';
                        updatePomodoroDisplay();
                    }
                }
            }, 1000);
        }

        function pausePomodoro() {
            if (!pomodoroInterval) return;
            
            pomodoroPaused = !pomodoroPaused;
            const pauseBtn = document.getElementById('pomodoroPauseBtn');
            
            if (pomodoroPaused) {
                pauseBtn.innerHTML = '▶️ Resume';
                pauseBtn.title = 'Resume timer';
                document.title = '⏸️ Paused - Academic Notebook';
                showToast("⏸️ Timer paused");
            } else {
                pauseBtn.innerHTML = '⏸️ Pause';
                pauseBtn.title = 'Pause timer';
                showToast("▶️ Timer resumed");
            }
        }

        function resetPomodoro() {
            const wasRunning = pomodoroInterval !== null;
            
            clearInterval(pomodoroInterval);
            pomodoroInterval = null;
            pomodoroPaused = false;
            
            pomodoroMode = 'focus';
            pomodoroTimeLeft = 25 * 60;
            pomodoroTotalTime = 25 * 60;
            
            document.getElementById('pomodoroMode').innerText = 'Focus Time';
            document.getElementById('pomodoroStartBtn').style.display = 'inline-block';
            document.getElementById('pomodoroPauseBtn').style.display = 'none';
            document.getElementById('pomodoroProgressBar').style.width = '0%';
            document.title = 'Academic Notebook';
            
            updatePomodoroDisplay();
            disableDnd();
            
            if (wasRunning) {
                showToast("🔄 Timer reset to 25 minutes");
            }
        }

        function enableDnd() {
            dndEnabled = true;
            document.getElementById('dndOverlay').classList.add('active');
            
            // Disable toolbar and sketch tools, but keep some navigation
            const toolbar = document.querySelector('.toolbar');
            if (toolbar) toolbar.style.pointerEvents = 'none';
            
            // Keep sidebar accessible but make it semi-transparent as a hint
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.style.opacity = '0.5';
                sidebar.style.pointerEvents = 'auto'; // Allow sidebar interaction
            }
            
            // But allow the DND overlay to be clickable
            document.getElementById('dndOverlay').style.pointerEvents = 'auto';
            
            showToast("🔇 Do Not Disturb mode enabled");
        }

        function disableDnd() {
            dndEnabled = false;
            document.getElementById('dndOverlay').classList.remove('active');
            
            // Re-enable toolbar and sketch tools
            const toolbar = document.querySelector('.toolbar');
            const sidebar = document.querySelector('.sidebar');
            if (toolbar) toolbar.style.pointerEvents = 'auto';
            if (sidebar) {
                sidebar.style.pointerEvents = 'auto';
                sidebar.style.opacity = '1';
            }
        }

        function exitDnd() {
            disableDnd();
            // Pause the timer when exiting DND
            if (pomodoroInterval && !pomodoroPaused) {
                pausePomodoro();
            }
            showToast("Focus mode exited - timer paused");
        }

        function updateDndSetting() {
            // If timer is running and DND checkbox changes
            if (pomodoroInterval && !pomodoroPaused) {
                if (document.getElementById('dndToggle').checked) {
                    enableDnd();
                } else {
                    disableDnd();
                }
            }
        }

        function playBeep() {
            // Create a pleasant notification sound using Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // First beep
                const osc1 = audioContext.createOscillator();
                const gain1 = audioContext.createGain();
                osc1.connect(gain1);
                gain1.connect(audioContext.destination);
                osc1.frequency.value = 800;
                osc1.type = 'sine';
                gain1.gain.setValueAtTime(0.3, audioContext.currentTime);
                gain1.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                osc1.start(audioContext.currentTime);
                osc1.stop(audioContext.currentTime + 0.2);
                
                // Second beep
                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();
                osc2.connect(gain2);
                gain2.connect(audioContext.destination);
                osc2.frequency.value = 1000;
                osc2.type = 'sine';
                gain2.gain.setValueAtTime(0.3, audioContext.currentTime + 0.3);
                gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                osc2.start(audioContext.currentTime + 0.3);
                osc2.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        // Initialize pomodoro
        loadPomodoroStats();
        updatePomodoroDisplay();

        // ==================== LOGIC GATES SIMULATOR ====================
        let logicSimulator = {
            gates: [],
            inputs: [],
            outputs: [],
            wires: [],
            selectedGate: null,
            dragging: null,
            canvas: null,
            nextId: 1
        };

        function initLogicGatesSimulator() {
            const container = document.getElementById('logicGatesSimulator');
            if (!container) return;
            
            container.innerHTML = `
                <div class="logic-toolbar">
                    <button class="logic-gate-btn" onclick="addLogicInput()">
                        <span>🟢</span> Add Input
                    </button>
                    <button class="logic-gate-btn" onclick="addLogicGate('AND')">AND Gate</button>
                    <button class="logic-gate-btn" onclick="addLogicGate('OR')">OR Gate</button>
                    <button class="logic-gate-btn" onclick="addLogicGate('NOT')">NOT Gate</button>
                    <button class="logic-gate-btn" onclick="addLogicGate('NAND')">NAND Gate</button>
                    <button class="logic-gate-btn" onclick="addLogicGate('NOR')">NOR Gate</button>
                    <button class="logic-gate-btn" onclick="addLogicGate('XOR')">XOR Gate</button>
                    <button class="logic-gate-btn" onclick="addLogicOutput()">
                        <span>🟡</span> Add Output
                    </button>
                </div>
                <div class="logic-info">
                    💡 <strong>Instructions:</strong> Add inputs and gates, drag them to position, click inputs to toggle ON/OFF (green/red), and connect gates by clicking them in sequence. Add outputs to see final results.
                </div>
                <div class="logic-canvas-area" id="logicCanvas"></div>
                <div class="logic-controls">
                    <button class="logic-control-btn" onclick="evaluateCircuit()">▶ Evaluate Circuit</button>
                    <button class="logic-control-btn danger" onclick="clearCircuit()">🗑️ Clear All</button>
                </div>
            `;
            
            logicSimulator.canvas = document.getElementById('logicCanvas');
            renderLogicCanvas();
        }

        function addLogicInput() {
            const input = {
                id: logicSimulator.nextId++,
                type: 'input',
                x: 50,
                y: 50 + (logicSimulator.inputs.length * 60),
                state: false, // false = OFF (0), true = ON (1)
                label: `IN${logicSimulator.inputs.length + 1}`
            };
            logicSimulator.inputs.push(input);
            renderLogicCanvas();
            showToast(`Input ${input.label} added`);
        }

        function addLogicGate(gateType) {
            const gate = {
                id: logicSimulator.nextId++,
                type: 'gate',
                gateType: gateType,
                x: 250,
                y: 100 + (logicSimulator.gates.length * 80),
                inputs: [],
                output: null
            };
            logicSimulator.gates.push(gate);
            renderLogicCanvas();
            showToast(`${gateType} gate added`);
        }

        function addLogicOutput() {
            const output = {
                id: logicSimulator.nextId++,
                type: 'output',
                x: 500,
                y: 150,
                connectedTo: null,
                state: false,
                label: `OUT${logicSimulator.outputs.length + 1}`
            };
            logicSimulator.outputs.push(output);
            renderLogicCanvas();
            showToast(`Output ${output.label} added`);
        }

        function renderLogicCanvas() {
            if (!logicSimulator.canvas) return;
            
            logicSimulator.canvas.innerHTML = '';
            
            // Render inputs
            logicSimulator.inputs.forEach(input => {
                const el = document.createElement('div');
                el.className = `logic-input ${input.state ? 'on' : 'off'}`;
                el.style.left = input.x + 'px';
                el.style.top = input.y + 'px';
                el.innerHTML = input.state ? '1' : '0';
                el.title = `${input.label}: Click to toggle`;
                el.onclick = (e) => {
                    e.stopPropagation();
                    input.state = !input.state;
                    renderLogicCanvas();
                    evaluateCircuit();
                };
                makeDraggable(el, input);
                logicSimulator.canvas.appendChild(el);
                
                // Label
                const label = document.createElement('div');
                label.style.position = 'absolute';
                label.style.left = (input.x) + 'px';
                label.style.top = (input.y + 45) + 'px';
                label.style.fontSize = '0.75rem';
                label.style.fontWeight = 'bold';
                label.style.color = '#2c3e50';
                label.textContent = input.label;
                logicSimulator.canvas.appendChild(label);
            });
            
            // Render gates
            logicSimulator.gates.forEach(gate => {
                const el = document.createElement('div');
                el.className = `logic-gate ${logicSimulator.selectedGate === gate ? 'selected' : ''}`;
                el.style.left = gate.x + 'px';
                el.style.top = gate.y + 'px';
                el.textContent = gate.gateType;
                el.title = `${gate.gateType} Gate`;
                el.onclick = (e) => {
                    e.stopPropagation();
                    logicSimulator.selectedGate = gate;
                    renderLogicCanvas();
                };
                makeDraggable(el, gate);
                logicSimulator.canvas.appendChild(el);
            });
            
            // Render outputs
            logicSimulator.outputs.forEach(output => {
                const el = document.createElement('div');
                el.className = `logic-output ${output.state ? 'on' : ''}`;
                el.style.left = output.x + 'px';
                el.style.top = output.y + 'px';
                el.innerHTML = output.state ? '1' : '0';
                el.title = output.label;
                makeDraggable(el, output);
                logicSimulator.canvas.appendChild(el);
                
                // Label
                const label = document.createElement('div');
                label.style.position = 'absolute';
                label.style.left = (output.x + 5) + 'px';
                label.style.top = (output.y + 55) + 'px';
                label.style.fontSize = '0.75rem';
                label.style.fontWeight = 'bold';
                label.style.color = '#2c3e50';
                label.textContent = output.label;
                logicSimulator.canvas.appendChild(label);
            });
        }

        function makeDraggable(element, dataObj) {
            let isDragging = false;
            let startX, startY, initialX, initialY;
            
            element.addEventListener('mousedown', (e) => {
                if (e.target !== element) return;
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialX = dataObj.x;
                initialY = dataObj.y;
                element.style.cursor = 'grabbing';
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                dataObj.x = Math.max(0, Math.min(initialX + dx, logicSimulator.canvas.offsetWidth - 100));
                dataObj.y = Math.max(0, Math.min(initialY + dy, logicSimulator.canvas.offsetHeight - 50));
                element.style.left = dataObj.x + 'px';
                element.style.top = dataObj.y + 'px';
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    element.style.cursor = 'move';
                }
            });
        }

        function evaluateCircuit() {
            // Simple evaluation: compute gate outputs based on connected inputs
            logicSimulator.gates.forEach(gate => {
                // For demo purposes, we'll simulate simple logic
                // In a full implementation, you'd track connections and compute based on those
                const inputStates = logicSimulator.inputs.map(i => i.state);
                
                // Simple logic for demonstration
                switch(gate.gateType) {
                    case 'AND':
                        gate.output = inputStates.every(s => s === true);
                        break;
                    case 'OR':
                        gate.output = inputStates.some(s => s === true);
                        break;
                    case 'NOT':
                        gate.output = !inputStates[0];
                        break;
                    case 'NAND':
                        gate.output = !inputStates.every(s => s === true);
                        break;
                    case 'NOR':
                        gate.output = !inputStates.some(s => s === true);
                        break;
                    case 'XOR':
                        gate.output = inputStates.filter(s => s === true).length === 1;
                        break;
                }
            });
            
            // Update outputs (simplified - connect last gate output to first output)
            if (logicSimulator.gates.length > 0 && logicSimulator.outputs.length > 0) {
                logicSimulator.outputs[0].state = logicSimulator.gates[logicSimulator.gates.length - 1].output;
            }
            
            renderLogicCanvas();
            showToast("Circuit evaluated!");
        }

        function clearCircuit() {
            if (confirm('Clear all gates, inputs, and outputs?')) {
                logicSimulator.gates = [];
                logicSimulator.inputs = [];
                logicSimulator.outputs = [];
                logicSimulator.wires = [];
                logicSimulator.selectedGate = null;
                renderLogicCanvas();
                showToast("Circuit cleared");
            }
        }

        // --- ANATOMY ATLAS FUNCTIONS ---
        
        window.openAnatomyModal = () => {
            renderAnatomyMap('body'); // Default to body
            document.getElementById('anatomyModal').style.display = 'flex';
        };

        window.closeAnatomyModal = () => {
            document.getElementById('anatomyModal').style.display = 'none';
        };

        window.renderAnatomyMap = (type) => {
            const container = document.getElementById('anatomyContainer');
            if(type === 'body') container.innerHTML = BODY_SVG;
            if(type === 'tooth') container.innerHTML = TOOTH_SVG;
            if(type === 'brain') container.innerHTML = BRAIN_SVG;
        };

        window.handleRegionClick = (region) => {
            // Highlight effect handled by CSS, functionality handled here
            if(confirm(`Start note for region: ${region}?`)) {
                insertHtml(`
                    <h2 class="styled-header">Anatomy: ${region}</h2>
                    <div class="sticky-note">
                        <strong>Clinical Notes:</strong><br>
                        [Add details for ${region} here...]
                    </div>
                    <p><br></p>
                `);
            }
        };

        // Make functions globally accessible
        window.addLogicInput = addLogicInput;
        window.addLogicGate = addLogicGate;
        window.addLogicOutput = addLogicOutput;
        window.evaluateCircuit = evaluateCircuit;
        window.clearCircuit = clearCircuit;
        window.initLogicGatesSimulator = initLogicGatesSimulator;

        initApp();
        setTimeout(resizeCanvas, 500);
    </script>

    <!-- Do Not Disturb Overlay -->
    <div class="dnd-overlay" id="dndOverlay">
        <div class="dnd-message">🍅 Focus Mode Active</div>
        <div class="dnd-timer" id="dndTimer">25:00</div>
        <div class="dnd-subtitle">Stay focused! All tools are locked.</div>
        <button class="dnd-exit-btn" onclick="exitDnd()">⏸️ Exit Focus</button>
    </div>

</body>
</html>