<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Notebook - Engineering Math Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Indie+Flower&family=Patrick+Hand&family=Caveat:wght@400;700&family=Shadows+Into+Light&family=Permanent+Marker&family=Kalam:wght@300;400;700&family=Architects+Daughter&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <style>
        :root {
            --paper-bg: #fdfbf7;
            --grid-line: #e3e0d9;
            --ink-color: #2c3e50;
            --pencil-color: #5a5a5a;
            --pen-color: #1a1a1a;
            --marker-color: #000000;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --accent-color: #e74c3c;
            --cs-accent: #3498db;
            --med-accent: #2ecc71; 
            --dent-accent: #9b59b6; 
            --eng-accent: #d35400; 
            --code-bg: #282c34;
            --code-text: #abb2bf;
            --toolbar-bg: #d4a373;
            --voice-active: #e67e22;
            --template-color: #3498db;
            --workspace-bg: #e0e0e0;
            --workspace-dot: #bebebe;
            --highlight-bg: #fff9c4;
            --chalk-bg: #2d3436;
            --chalk-text: #dfe6e9;
            --save-color: #27ae60;
            --highlighter-color: rgba(255, 235, 59, 0.4);
            --math-cluster-color: rgba(52, 152, 219, 0.1);
            --math-border-color: rgba(52, 152, 219, 0.5);
        }

        body.dark-mode {
            --paper-bg: #2c3e50;
            --grid-line: #34495e;
            --ink-color: #ecf0f1;
            --pencil-color: #bdc3c7;
            --pen-color: #ffffff;
            --marker-color: #ffffff;
            --workspace-bg: #1a1a1a;
            --workspace-dot: #333333;
            --highlight-bg: #4a4a4a;
            --sidebar-bg: #1a1a1a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Patrick Hand', cursive;
            color: var(--ink-color);
            background-color: var(--workspace-bg);
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        /* --- STYLES --- */
        .writing-tool-pencil { font-family: 'Caveat', cursive; color: var(--pencil-color); }
        .writing-tool-pen { font-family: 'Patrick Hand', cursive; color: var(--pen-color); }
        .writing-tool-marker { font-family: 'Permanent Marker', cursive; color: var(--marker-color); }
        .writing-tool-brush { font-family: 'Shadows Into Light', cursive; color: var(--ink-color); }
        .writing-tool-chalk { font-family: 'Architects Daughter', cursive; color: #4a4a4a; }
        .writing-tool-elegant { font-family: 'Kalam', cursive; color: var(--ink-color); }

        /* CS Code Block */
        .cs-code-container { font-family: 'Fira Code', monospace; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; margin: 15px 0; background: var(--code-bg); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .cs-code-header { background: #21252b; color: #9da5b4; padding: 5px 10px; font-size: 0.8rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #181a1f; }
        .cs-code-editor { padding: 15px; color: var(--code-text); font-size: 0.9rem; min-height: 60px; outline: none; white-space: pre-wrap; }
        .cs-code-output { background: #1e2127; color: #98c379; padding: 10px; font-size: 0.8rem; border-top: 1px dashed #3e4451; }
        .cs-code-output::before { content: "‚ûú OUTPUT:"; display: block; font-size: 0.7rem; opacity: 0.5; margin-bottom: 5px; }
        
        /* Trace Table */
        .trace-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-family: 'Fira Code', monospace; font-size: 0.85rem; }
        .trace-table th, .trace-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .trace-table th { background: rgba(0,0,0,0.05); }

        /* Dynamic Trace Table Controls */
        .trace-table-container { position: relative; }
        .btn-trace-add { position: absolute; top: -10px; right: 0; width: 22px; height: 22px; background: var(--cs-accent); color: white; border: 2px solid white; border-radius: 50%; font-weight: bold; font-size: 14px; line-height: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        .trace-table-container:hover .btn-trace-add { opacity: 1; }
        @media (hover: none) { .btn-trace-add { opacity: 0.6; } }

        /* Sidebar */
        .sidebar { width: 280px; background-color: var(--sidebar-bg); color: var(--sidebar-text); height: 100%; display: flex; flex-direction: column; padding: 1.5rem; box-shadow: 4px 0 15px rgba(0,0,0,0.3); z-index: 20; flex-shrink: 0; transition: background-color 0.3s ease, transform 0.3s ease; position: absolute; left: 0; top: 0; overflow: hidden; }
        @media (max-width: 768px) { .sidebar { transform: translateX(-100%); position: fixed; width: 80%; max-width: 300px; } .sidebar.open { transform: translateX(0); } }

        .app-title { font-size: 1.6rem; margin-bottom: 1rem; text-align: center; flex-shrink: 0; font-family: 'Fira Code', monospace; }
        .search-container { margin-bottom: 0.5rem; position: relative; flex-shrink: 0; }
        .search-input { width: 100%; padding: 10px 15px; border-radius: 20px; border: none; background: rgba(255,255,255,0.1); color: white; font-family: inherit; font-size: 0.95rem; }
        .category-filter { width: 100%; padding: 8px; margin-bottom: 15px; border-radius: 6px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); font-family: inherit; }
        .category-filter option { background: var(--sidebar-bg); color: white; }
        optgroup { font-style: normal; font-weight: bold; color: #ccc; }

        .sidebar-section { display: flex; flex-direction: column; margin-bottom: 15px; min-height: 0; }
        .sidebar-section.pages-section { flex-grow: 1; }
        .section-header { padding: 8px 10px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: var(--accent-color); margin-bottom: 5px; user-select: none; flex-shrink: 0; }
        .arrow { transition: transform 0.3s ease; font-size: 0.8rem; }
        .section-content { display: flex; flex-direction: column; transition: all 0.3s ease; }
        .section-content.collapsed { display: none !important; }
        
        #pagesContent { overflow-y: auto; flex-grow: 1; padding-right: 2px; }
        #pagesContent::-webkit-scrollbar { width: 4px; }
        #pagesContent::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
        #toolsContent { overflow-y: auto; max-height: 45vh; padding-right: 2px; }
        #toolsContent::-webkit-scrollbar { width: 4px; }
        #toolsContent::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

        .chapter-list { list-style: none; margin-bottom: 0; padding-bottom: 10px; }
        .nav-item { padding: 12px; cursor: pointer; border-radius: 6px; margin-bottom: 8px; background: rgba(255,255,255,0.05); transition: 0.2s; display: flex; align-items: center; justify-content: space-between; }
        .nav-info { display: flex; flex-direction: column; gap: 4px; overflow: hidden; flex-grow: 1; min-width: 0; margin-right: 8px; }
        .nav-item.active { border-left: 4px solid var(--accent-color); background: rgba(255,255,255,0.1); }
        .nav-item-title { font-weight: bold; font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .nav-item-snippet { font-size: 0.8rem; opacity: 0.7; font-family: sans-serif; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cat-badge { font-size: 0.7rem; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; align-self: flex-start; margin-top: 2px; }
        
        .btn-delete { background: transparent; border: none; color: var(--sidebar-text); font-size: 1.2rem; opacity: 0.6; cursor: pointer; padding: 0 12px; height: 40px; transition: all 0.2s; z-index: 10; flex-shrink: 0; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
        .btn-delete:hover { opacity: 1; color: #e74c3c; background: rgba(231, 76, 60, 0.1); }

        .btn { position: relative; border: none; padding: 10px; border-radius: 6px; font-family: inherit; cursor: pointer; transition: 0.3s; width: 100%; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-add { background: var(--accent-color); color: white; }
        .btn-save-sidebar { background: var(--save-color); color: white; margin-top: 5px; }
        .btn-sketch { background: var(--toolbar-bg); color: white; }
        .btn-sketch.active { background: #e67e22; border: 2px solid white; }
        .btn-secondary { background: rgba(255,255,255,0.15); color: #ecf0f1; font-size: 0.9rem; }
        .btn-secondary:hover { background: rgba(255,255,255,0.25); }
        .btn-danger { background: rgba(231, 76, 60, 0.2); color: #e74c3c; font-size: 0.8rem; margin-top: 10px; }
        .btn-danger:hover { background: rgba(231, 76, 60, 0.4); }

        .btn-dark-circle { position: fixed; top: 20px; right: 20px; width: 45px; height: 45px; border-radius: 50%; background: white; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer; z-index: 50; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: 0.3s; }
        body.dark-mode .btn-dark-circle { background: var(--sidebar-bg); color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .btn-dark-circle:hover { transform: scale(1.1); }

        .btn-exit-focus { position: fixed; top: 20px; right: 80px; background: var(--accent-color); color: white; padding: 10px 20px; border-radius: 30px; border: none; cursor: pointer; z-index: 60; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-weight: bold; }

        .btn-menu-mobile { position: fixed; top: 20px; left: 20px; width: 45px; height: 45px; border-radius: 50%; background: var(--sidebar-bg); color: white; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer; z-index: 60; display: none; align-items: center; justify-content: center; font-size: 1.2rem; }
        @media (max-width: 768px) { .btn-menu-mobile { display: flex; } }

        /* Layout */
        .main-container { display: flex; flex-grow: 1; margin-left: 280px; transition: margin-left 0.3s; height: 100%; position: relative; overflow: hidden; }
        @media (max-width: 768px) { .main-container { margin-left: 0; } }
        body.focus-mode .main-container { margin-left: 0; }

        .workspace { flex-grow: 1; padding: 2rem; overflow: auto; display: flex; flex-direction: column; align-items: center; background-image: radial-gradient(var(--workspace-dot) 1px, transparent 1px); background-size: 20px 20px; position: relative; width: 100%; transition: width 0.3s; }
        .lecture-pane { width: 0; height: 100%; background: #333; transition: width 0.3s; display: flex; flex-direction: column; border-left: 1px solid #ccc; overflow: hidden; }
        
        body.split-mode .workspace { width: 50%; }
        body.split-mode .lecture-pane { width: 50%; }
        @media (max-width: 768px) { body.split-mode .workspace { display: none; } body.split-mode .lecture-pane { width: 100%; } }

        .lecture-frame { flex-grow: 1; border: none; background: white; }
        .lecture-header { background: var(--sidebar-bg); color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }

        @media (max-width: 768px) { .workspace { padding: 1rem; padding-top: 5rem; } }
        .workspace.grabbing { cursor: grabbing; cursor: -webkit-grabbing; }
        
        body.focus-mode .sidebar { transform: translateX(-100%); }
        body.focus-mode .tool-tray-container { display: none; }
        body.focus-mode .btn-exit-focus { display: block; }
        body.focus-mode .btn-menu-mobile { display: none; }

        /* Paper */
        .paper { width: 100%; max-width: 800px; background-color: var(--paper-bg); background-image: linear-gradient(var(--grid-line) 1px, transparent 1px), linear-gradient(90deg, var(--grid-line) 1px, transparent 1px); background-size: 25px 25px; min-height: 1100px; padding: 6rem 4rem; box-shadow: 0 20px 50px rgba(0,0,0,0.15); position: relative; transition: border 0.3s, box-shadow 0.3s, background-image 0.3s; }
        .paper.annotate-mode { background-size: contain; background-repeat: no-repeat; background-position: top center; }
        .paper.drag-over { border: 4px dashed var(--accent-color); background-color: rgba(231, 76, 60, 0.05); }
        .paper.lined { background-image: linear-gradient(transparent 95%, var(--grid-line) 95%); background-size: 100% 30px; }
        .paper.dotted { background-image: radial-gradient(var(--grid-line) 2px, transparent 2px); background-size: 25px 25px; }
        .paper.plain { background-image: none; }
        .paper.infinite { max-width: none; width: 3000px; height: 3000px; background-size: 40px 40px; }

        body.sketch-mode .paper { border: 3px solid var(--voice-active); box-shadow: 0 10px 40px rgba(230, 126, 34, 0.2); }
        @media (max-width: 768px) { .paper { padding: 4rem 2rem; } }

        #sketchCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; }
        body.sketch-mode #sketchCanvas { pointer-events: auto; cursor: crosshair; }

        /* Toolbar */
        .writing-tools { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: white; padding: 10px 20px; border-radius: 40px; display: flex; gap: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 15; overflow-x: auto; max-width: 90%; transition: opacity 0.3s, transform 0.3s; }
        .paper.infinite .writing-tools { position: fixed; top: 20px; left: calc(50% + 140px); }
        body.focus-mode .paper.infinite .writing-tools { left: 50%; }
        .writing-tools.collapsed { transform: translateX(-50%) scale(0); opacity: 0; pointer-events: none; }
        
        .show-tools-btn { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: white; border-radius: 50%; width: 40px; height: 40px; display: none; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer; z-index: 14; font-size: 1.2rem; }
        body.dark-mode .show-tools-btn { background: #2c3e50; color: white; }
        body.tools-hidden .show-tools-btn { display: flex; }

        .tool-opt { cursor: pointer; font-size: 1.5rem; transition: transform 0.2s; padding: 5px; border-radius: 50%; }
        .tool-opt.active { background: #eee; transform: scale(1.2); }
        .tool-opt.highlighter { color: #f1c40f; text-shadow: 1px 1px 0 #999; filter: hue-rotate(60deg) drop-shadow(0 0 2px rgba(255, 255, 0, 0.5)); }
        .sketch-only { display: none; }
        body.sketch-mode .sketch-only { display: block; }
        .tool-divider { width: 1px; background: #e0e0e0; margin: 0 5px; align-self: center; height: 30px; display: none; }
        body.sketch-mode .tool-divider { display: block; }

        .tool-tray-container { position: fixed; left: 295px; top: 50%; transform: translateY(-50%); z-index: 40; display: flex; align-items: center; transition: left 0.3s ease, opacity 0.3s; }
        @media (max-width: 768px) { .tool-tray-container { left: 0; } }
        .tool-tray-container.collapsed { left: 280px; }
        @media (max-width: 768px) { .tool-tray-container.collapsed { left: -15px; } }
        .tool-tray-toggle { background: white; border: 1px solid #ddd; width: 24px; height: 60px; border-radius: 0 8px 8px 0; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 4px 0 10px rgba(0,0,0,0.1); font-size: 0.8rem; color: #666; transition: 0.3s; }
        body.dark-mode .tool-tray-toggle { background: #34495e; color: white; border-color: #444; }
        
        /* Updated Tool Tray with Scrollbar */
        .tool-tray { 
            background: white; 
            padding: 15px 10px; 
            border-radius: 12px; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            box-shadow: 4px 4px 20px rgba(0,0,0,0.1); 
            border: 1px solid #eee; 
            transition: transform 0.3s ease, opacity 0.3s ease; 
            transform-origin: left center;
            max-height: 80vh; 
            overflow-y: auto; 
        }
        
        .tool-tray::-webkit-scrollbar { width: 4px; }
        .tool-tray::-webkit-scrollbar-track { background: transparent; }
        .tool-tray::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 2px; }
        body.dark-mode .tool-tray::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); }

        body.dark-mode .tool-tray { background: #34495e; border-color: #444; }
        .tool-tray-container.collapsed .tool-tray { transform: scaleX(0); opacity: 0; pointer-events: none; width: 0; padding: 0; margin: 0; }

        .color-picker-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 5; }

        /* REFINED TOOL BUTTONS */
        .tool-btn { 
            background: transparent; 
            border: none; 
            padding: 10px 12px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-family: inherit; 
            font-size: 0.95rem; 
            white-space: nowrap; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            transition: all 0.2s ease; 
            position: relative;
            color: var(--ink-color);
        }
        .tool-btn:hover { background: rgba(0,0,0,0.05); transform: translateX(2px); }
        body.dark-mode .tool-btn { background: transparent; color: #ecf0f1; border: none; }
        body.dark-mode .tool-btn:hover { background: rgba(255,255,255,0.1); }
        .tool-btn.active { background: var(--toolbar-bg); color: white; font-weight: bold; }
        body.dark-mode .tool-btn.active { background: var(--toolbar-bg); color: white; }
        
        /* Discipline Specific Styles for Tools */
        #tools-cs .tool-btn { color: var(--cs-accent); }
        #tools-med .tool-btn { color: var(--med-accent); }
        #tools-eng .tool-btn { color: var(--eng-accent); }
        
        .paper-title { font-size: 2.4rem; border: none; border-bottom: 2px solid var(--accent-color); width: 100%; background: transparent; font-family: inherit; margin-bottom: 2rem; color: var(--ink-color); }
        .content-area { min-height: 800px; outline: none; line-height: 1.8; font-size: 1.3rem; color: var(--ink-color); }
        
        .styled-header { color: var(--accent-color); border-bottom: 1px dashed #ccc; margin: 15px 0; }
        .sticky-note { background: var(--highlight-bg); padding: 15px; border-left: 5px solid #f1c40f; transform: rotate(-1deg); margin: 15px 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        .chalk-code { background: var(--chalk-bg); color: var(--chalk-text); padding: 15px; border-radius: 6px; font-family: 'Architects Daughter'; margin: 15px 0; }
        
        .checklist-item { display: flex; align-items: center; gap: 12px; margin: 8px 0; }
        .checklist-item .checkbox-wrapper { contenteditable: false; }
        .checkbox { width: 22px; height: 22px; border: 2px solid #555; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 4px; flex-shrink: 0; transition: all 0.2s ease; }
        .checkbox.checked { background: var(--accent-color); border-color: var(--accent-color); }
        .checkbox::after { content: '‚úì'; color: white; font-weight: bold; transform: scale(0); transition: transform 0.2s cubic-bezier(0.5, 0, 0, 1.5); }
        .checkbox.checked::after { transform: scale(1); }
        
        .checklist-text { position: relative; transition: opacity 0.3s ease; }
        .checkbox.checked + .checklist-text { opacity: 0.6; }
        .checklist-text::after { content: ''; position: absolute; left: 0; top: 50%; width: 0; height: 2px; background: currentColor; transition: width 0.3s ease; pointer-events: none; border-radius: 2px; }
        .checkbox.checked + .checklist-text::after { width: 100%; }

        .uploaded-img { max-width: 100%; border-radius: 8px; margin: 10px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .save-status { position: absolute; top: 2rem; right: 4rem; font-family: sans-serif; font-size: 0.75rem; color: #999; text-transform: uppercase; letter-spacing: 1px; pointer-events: none; }
        .word-count { font-family: sans-serif; font-size: 0.7rem; color: var(--accent-color); margin-top: 4px; opacity: 0.7; }
        .status-bar { position: absolute; top: 2rem; right: 4rem; display: flex; flex-direction: column; align-items: flex-end; pointer-events: none; }

        .floating-pane { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: none; flex-direction: column; gap: 10px; z-index: 1000; min-width: 250px; }
        .toast { position: fixed; bottom: 30px; right: 30px; background: #333; color: white; padding: 12px 24px; border-radius: 30px; transform: translateY(200%); transition: 0.5s; z-index: 2000; }
        .toast.show { transform: translateY(0); }

        .storage-footer { padding: 15px 0; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto; font-size: 0.8rem; color: rgba(255,255,255,0.6); }
        .storage-bar-bg { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .storage-bar-fill { height: 100%; background: var(--save-color); width: 0%; transition: width 0.5s ease; }

        .text-bubble { position: absolute; background: #333; border-radius: 8px; padding: 5px; display: none; gap: 5px; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transform: translate(-50%, -120%); }
        .text-bubble.visible { display: flex; }
        .text-bubble::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); border-width: 5px 5px 0; border-style: solid; border-color: #333 transparent transparent transparent; }
        .bubble-btn { background: none; border: none; color: white; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-weight: bold; font-family: sans-serif; }
        .bubble-btn:hover { background: rgba(255,255,255,0.2); }
        
        /* Metadata Modal Styles */
        .meta-group { margin-bottom: 15px; }
        .meta-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: #777; margin-bottom: 5px; display: block; }
        .meta-value { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; }
        .meta-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .tag-chip { background: var(--template-color); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; }
        .tag-remove { cursor: pointer; opacity: 0.7; }
        .tag-remove:hover { opacity: 1; }

        /* Engineering Ruler */
        #engRuler {
            position: absolute;
            width: 400px;
            height: 60px;
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid #999;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            top: 300px;
            left: 200px;
            transform-origin: center;
            display: none;
            z-index: 20;
            cursor: grab;
            backdrop-filter: blur(5px);
            border-radius: 4px;
        }
        #engRuler::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 20px;
            background-image: repeating-linear-gradient(90deg, #333 0, #333 1px, transparent 1px, transparent 10px);
            opacity: 0.5;
        }
        #engRuler .rotate-handle {
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            background: var(--eng-accent);
            border-radius: 50%;
            cursor: col-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        
        /* Math Cluster Highlight */
        .math-cluster-active {
            border: 2px dashed #d35400;
            background-color: rgba(211, 84, 0, 0.05);
            position: absolute;
            pointer-events: auto;
            cursor: pointer;
            z-index: 6;
            border-radius: 4px;
        }
        
        /* Structured Math Display */
        .structured-math {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            font-size: 1.5rem;
            position: absolute;
            background: white;
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 7;
        }
        
        /* Anatomy Pin */
        .anatomy-pin {
            position: absolute;
            width: 24px;
            height: 24px;
            background: var(--med-accent);
            color: white;
            border-radius: 50% 50% 0 50%;
            transform: rotate(45deg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            z-index: 10;
            cursor: pointer;
        }
        .anatomy-pin span { transform: rotate(-45deg); }
        
        /* Math Keyboard Styles */
        .math-keyboard-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--sidebar-bg);
            color: white;
            z-index: 2000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            display: none; /* Toggled */
            flex-direction: column;
            border-top: 2px solid var(--eng-accent);
        }
        .math-input-bar {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .math-buffer {
            flex-grow: 1;
            background: white;
            color: #333;
            border: none;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            font-size: 1.1rem;
        }
        .math-preview {
            background: white;
            color: black;
            padding: 5px 10px;
            border-radius: 4px;
            min-width: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .math-tabs {
            display: flex;
            background: rgba(0,0,0,0.2);
        }
        .math-tab-btn {
            flex: 1;
            padding: 10px;
            background: transparent;
            color: #aaa;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-bottom: 2px solid transparent;
        }
        .math-tab-btn.active {
            color: white;
            background: rgba(255,255,255,0.05);
            border-bottom-color: var(--eng-accent);
        }
        .math-keys-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 5px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .math-key {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 1.2rem;
            cursor: pointer;
            font-family: 'Times New Roman', serif;
        }
        .math-key:hover { background: rgba(255,255,255,0.2); }
    </style>
</head>
<body class="cursor-pen">

    <button class="btn-dark-circle" id="darkModeToggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">üåô</button>
    <button class="btn-menu-mobile" id="mobileMenuBtn" onclick="toggleMobileSidebar()" title="Toggle Menu">‚ò∞</button>
    <button class="btn-exit-focus" onclick="toggleFocusMode()">Exit Focus</button>
    
    <!-- ENGINEERING RULER -->
    <div id="engRuler">
        <div class="rotate-handle" id="rulerRotate">‚ü≥</div>
    </div>

    <!-- MATH KEYBOARD PANEL -->
    <div id="mathKeyboard" class="math-keyboard-panel">
        <div class="math-input-bar">
            <span style="font-size:0.8rem; font-weight:bold;">‚àë</span>
            <input type="text" id="mathBuffer" class="math-buffer" placeholder="Type LaTeX..." oninput="updateMathPreview()">
            <div id="mathPreview" class="math-preview"></div>
            <button class="btn btn-secondary" onclick="insertMathFromBuffer()" style="width:auto; padding:5px 15px; margin:0; background:var(--save-color); color:white;">Insert</button>
            <button class="btn btn-secondary" onclick="toggleMathMode()" style="width:auto; padding:5px 10px; margin:0;">‚ñº</button>
        </div>
        <div class="math-tabs">
            <button class="math-tab-btn active" onclick="switchMathTab('basic', this)">Basic</button>
            <button class="math-tab-btn" onclick="switchMathTab('trig', this)">Trig</button>
            <button class="math-tab-btn" onclick="switchMathTab('calc', this)">Calculus</button>
            <button class="math-tab-btn" onclick="switchMathTab('geom', this)">Geometry</button>
            <button class="math-tab-btn" onclick="switchMathTab('struct', this)">Structure</button>
        </div>
        <div id="mathKeys" class="math-keys-grid"></div>
    </div>
    
    <!-- TRACE TABLE MODAL -->
    <div id="traceModal" class="floating-pane" style="display:none; width: 300px; z-index: 1002;">
        <h3 style="margin-bottom: 15px;">New Trace Table</h3>
        <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">Number of Variables:</p>
        <input type="number" id="traceVarCount" class="meta-value" value="3" min="1" max="10" style="margin-bottom:15px;">
        <div style="display:flex; gap:10px;">
            <button class="tool-btn" onclick="confirmTraceTable()" style="background: var(--save-color); color: white; justify-content: center; flex:1;">Insert</button>
            <button class="tool-btn" onclick="closeTraceModal()" style="background: #eee; justify-content: center; flex:1;">Cancel</button>
        </div>
    </div>

    <div class="text-bubble" id="textBubble">
        <button class="bubble-btn" onclick="formatText('bold')">B</button>
        <button class="bubble-btn" onclick="formatText('italic')">I</button>
        <button class="bubble-btn" onclick="formatText('formatBlock', 'h2')">H1</button>
        <button class="bubble-btn" onclick="formatText('formatBlock', 'h3')">H2</button>
        <button class="bubble-btn" onclick="formatText('insertUnorderedList')">‚Ä¢ List</button>
    </div>

    <aside class="sidebar" id="mainSidebar">
        <div class="app-title">Academic Notebook</div>
        
        <select class="category-filter" id="categoryFilter" onchange="filterChapters()">
            <option value="all">üìÅ All Notes</option>
            <optgroup label="General">
                <option value="General">üìù General</option>
                <option value="Projects">üöÄ Projects</option>
            </optgroup>
            <optgroup label="Computer Science">
                <option value="Algorithms">üìê Algorithms</option>
                <option value="Systems">‚öôÔ∏è Systems</option>
            </optgroup>
            <optgroup label="Medical">
                <option value="Anatomy">üß† Anatomy</option>
                <option value="Pathology">ü¶† Pathology</option>
                <option value="Pharmacology">üíä Pharmacology</option>
                <option value="Clinical">üè• Clinical</option>
            </optgroup>
            <optgroup label="Dentistry">
                <option value="Dental Anatomy">ü¶∑ Dental Anatomy</option>
                <option value="Procedures">üõ†Ô∏è Procedures</option>
                <option value="Dental Cases">üßæ Cases</option>
            </optgroup>
            <optgroup label="Engineering">
                <option value="Electrical">‚ö° Electrical (EE)</option>
                <option value="Mechanical">‚öôÔ∏è Mechanical (ME)</option>
                <option value="Civil">üèó Civil (CE)</option>
                <option value="Electronics">üì° Electronics (ECE)</option>
                <option value="Mechatronics">ü¶æ Mechatronics</option>
                <option value="Industrial">üè≠ Industrial</option>
            </optgroup>
        </select>

        <div class="search-container">
            <input type="text" class="search-input" id="sidebarSearch" placeholder="Search titles..." oninput="renderSidebar()">
        </div>

        <div class="sidebar-section pages-section" id="pagesSectionWrapper">
            <div class="section-header" onclick="toggleSection('pagesContent', 'pagesArrow', 'pagesSectionWrapper')">
                <span>üìö Notes</span>
                <span class="arrow" id="pagesArrow">‚ñº</span>
            </div>
            <div class="section-content" id="pagesContent">
                <ul class="chapter-list" id="chapterList"></ul>
            </div>
        </div>
        
        <div class="sidebar-section tools-section">
            <div class="section-header" onclick="toggleSection('toolsContent', 'toolsArrow')">
                <span>üõ†Ô∏è Tools</span>
                <span class="arrow" id="toolsArrow">‚ñº</span>
            </div>
            <div class="section-content" id="toolsContent">
                <div class="sidebar-actions">
                    <button class="btn btn-add" onclick="createNewChapter()">+ New Page</button>
                    <button class="btn btn-secondary" onclick="toggleFocusMode()">üëÅÔ∏è Focus Mode</button>
                    <button class="btn btn-secondary" onclick="cyclePaperStyle()" id="paperStyleBtn">üìÑ Paper: Grid</button>
                    <button class="btn btn-save-sidebar" onclick="window.print()">üñ®Ô∏è Save as PDF</button>
                    <button class="btn btn-secondary" onclick="toggleReadMode()" id="readModeBtn">üîì Lock / Read</button>
                    <button class="btn btn-secondary" onclick="openMetadataModal()">‚ìò Page Details</button>
                    
                    <button class="btn btn-secondary" style="position: relative; border: 1px solid var(--template-color);">
                        üìö Load Lecture (PDF)
                        <input type="file" onchange="loadLecturePdf(this)" accept="application/pdf" style="position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;">
                    </button>

                    <button class="btn btn-secondary" style="position: relative;">
                        üìÑ Import Background
                        <input type="file" onchange="importBackgroundFile(this)" accept="image/*" style="position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;">
                    </button>
                    
                    <button class="btn btn-sketch" id="sketchToggle" onclick="toggleSketchMode()">üé® Sketch Mode</button>
                    <button class="btn" style="background: #3498db; color: white;" onclick="toggleTemplates()">üìã Templates</button>
                    
                    <div style="margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                        <button class="btn btn-secondary" onclick="exportData()" style="font-size: 0.8rem;">‚¨á Export Backup</button>
                        <button class="btn btn-secondary" style="font-size: 0.8rem; position: relative;">
                            ‚¨Ü Import Backup
                            <input type="file" id="importFile" onchange="importData(this)" accept=".json" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                        </button>
                        
                        <button class="btn btn-danger" onclick="wipeAllData()">‚ö† Wipe All Data</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="storage-footer">
            <div style="display:flex; justify-content:space-between;">
                <span>Storage Used</span>
                <span id="storageText">Checking...</span>
            </div>
            <div class="storage-bar-bg">
                <div class="storage-bar-fill" id="storageBar"></div>
            </div>
        </div>
    </aside>

    <div class="tool-tray-container" id="trayContainer">
        <div class="tool-tray">
            <!-- Global Tools -->
            <button class="tool-btn" id="voiceBtn" onclick="toggleVoiceTranscription()"><span>üé§</span> Dictate</button>
            <button class="tool-btn" id="handBtn" onclick="selectSketchTool('hand')"><span>‚úã</span> Pan</button>
            <button class="tool-btn" id="eraserBtn" onclick="selectSketchTool('eraser')"><span>üßº</span> Eraser</button>
            
            <div class="tool-btn" style="position: relative;">
                <span>üåà</span> Color
                <input type="color" id="customColorPicker" class="color-picker-input" onchange="setCustomColor(this.value)">
            </div>
            
            <hr style="opacity: 0.2;">
            
            <!-- Standard Block Tools -->
            <button class="tool-btn" onclick="insertBlock('header')"><span>üè∑Ô∏è</span> Title</button>
            <button class="tool-btn" onclick="insertBlock('note')"><span>üìå</span> Note</button>
            <button class="tool-btn" onclick="insertBlock('todo')"><span>‚úÖ</span> To-Do</button>

            <!-- 1. CS TOOLBAR -->
            <div id="tools-cs" style="display:none; flex-direction:column; gap:8px;">
                <hr style="opacity: 0.2;">
                <button class="tool-btn" onclick="insertCSCodeBlock()"><span>&lt;&gt;</span> Code Block</button>
                <!-- Code button removed here as requested -->
                <button class="tool-btn" onclick="insertAlgoStep()"><span>üî¢</span> Algorithm Step</button>
                <button class="tool-btn" onclick="insertComplexity()"><span>O(n)</span> Complexity</button>
                <button class="tool-btn" onclick="insertTraceTable()"><span>üìâ</span> Trace Table</button>
            </div>

            <!-- 2. MEDICAL TOOLBAR -->
            <div id="tools-med" style="display:none; flex-direction:column; gap:8px;">
                <hr style="opacity: 0.2;">
                <button class="tool-btn" onclick="activateAnatomyPin()"><span>üìç</span> Pin</button>
                <button class="tool-btn" onclick="setHighlightPreset('symptom')"><span>üü°</span> Sx</button>
                <button class="tool-btn" onclick="setHighlightPreset('drug')"><span>üî¥</span> Rx</button>
                <button class="tool-btn" onclick="insertTimeline()"><span>‚è≥</span> Timeline</button>
                <button class="tool-btn" onclick="insertComparison()"><span>‚öñÔ∏è</span> Compare</button>
            </div>

            <!-- 3. ENGINEERING TOOLBAR -->
            <div id="tools-eng" style="display:none; flex-direction:column; gap:8px;">
                <hr style="opacity: 0.2;">
                <button class="tool-btn" onclick="toggleMathMode()" id="mathModeBtn"><span>‚àë</span> Math Mode</button>
                <button class="tool-btn" onclick="toggleRuler()"><span>üìè</span> Ruler</button>
                <button class="tool-btn" onclick="insertEquation()"><span>‚àë</span> Eq Block</button>
                <button class="tool-btn" onclick="insertAssumptions()"><span>ü§î</span> Assume</button>
                <button class="tool-btn" onclick="insertConstants()"><span>œÄ</span> Constants</button>
            </div>
            
            <!-- Code button removed here as requested -->
            <button class="tool-btn" onclick="triggerImageUpload()"><span>üì∏</span> Photo</button>
            <hr style="opacity: 0.2;">
            <button class="tool-btn" style="color: #e74c3c" onclick="clearSketch()"><span>üóëÔ∏è</span> Clear Sketch</button>
        </div>
        <button class="tool-tray-toggle" id="trayToggle" onclick="toggleTray()">‚óÄ</button>
    </div>

    <!-- MAIN CONTAINER FOR SPLIT LAYOUT -->
    <div class="main-container" id="mainContainer">
        <main class="workspace" id="workspace">
            <div class="paper" id="paper">
                <!-- MATH LAYER CONTAINER -->
                <div id="mathLayer" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:6;"></div>
                
                <canvas id="sketchCanvas"></canvas>
                
                <div class="status-bar">
                    <span class="save-status" id="saveStatus">All changes saved</span>
                    <span class="word-count" id="wordCount">0 Words</span>
                </div>

                <div class="show-tools-btn" onclick="toggleTopTools()">‚úé</div>

                <div class="writing-tools" id="topTools">
                    <div class="tool-opt active" data-tool="pen" onclick="selectWritingTool('pen')">üñäÔ∏è</div>
                    <div class="tool-opt" data-tool="pencil" onclick="selectWritingTool('pencil')">‚úèÔ∏è</div>
                    <div class="tool-opt highlighter" data-tool="highlighter" onclick="selectWritingTool('highlighter')">üñåÔ∏è</div>
                    <div class="tool-opt" data-tool="marker" onclick="selectWritingTool('marker')">üñçÔ∏è</div>
                    <div class="tool-opt" data-tool="elegant" onclick="selectWritingTool('elegant')">‚úíÔ∏è</div>
                    <div class="tool-opt" data-tool="brush" onclick="selectWritingTool('brush')">üé®</div>
                    <div class="tool-opt" data-tool="chalk" onclick="selectWritingTool('chalk')">üìù</div>
                    <div class="tool-divider" style="margin: 0 10px;"></div>
                    <div class="tool-opt" onclick="toggleTopTools()" style="font-weight:bold;">_</div>
                    <div class="tool-divider sketch-only"></div>
                    <div class="tool-opt sketch-only" onclick="undoSketch()" title="Undo">‚Ü©Ô∏è</div>
                    <div class="tool-opt sketch-only" onclick="redoSketch()" title="Redo">‚Ü™Ô∏è</div>
                </div>

                <input type="file" id="imageInput" style="display: none;" accept="image/*" onchange="handleImageUpload(event)">
                <input type="text" class="paper-title" id="pageTitle" placeholder="Untitled Page" oninput="markUnsaved(); saveCurrentToCloud()">
                <!-- CRITICAL FOR iPAD: Event delegation added, inline handlers removed -->
                <div class="content-area writing-tool-pen" id="editor" contenteditable="true" spellcheck="false" oninput="markUnsaved(); saveCurrentToCloud()"></div>
            </div>
        </main>

        <!-- LECTURE PANE (RIGHT SPLIT) -->
        <div class="lecture-pane" id="lecturePane">
            <div class="lecture-header">
                <span>üìö Lecture Reader</span>
                <button class="bubble-btn" onclick="closeLecturePane()">‚úñ Close</button>
            </div>
            <iframe id="lectureFrame" class="lecture-frame"></iframe>
        </div>
    </div>

    <!-- METADATA MODAL -->
    <div id="metadataModal" class="floating-pane" style="display:none; width: 300px;">
        <h3 style="margin-bottom: 15px;">Page Details</h3>
        <div class="meta-group">
            <label class="meta-label">Discipline</label>
            <select id="metaDiscipline" class="meta-value" disabled>
                <option value="cs">Computer Science</option>
                <option value="medical">Medical</option>
                <option value="engineering">Engineering</option>
                <option value="general">General</option>
            </select>
        </div>
        <div class="meta-group">
            <label class="meta-label">Page Type</label>
            <select id="metaType" class="meta-value" onchange="updatePageMeta()">
                <option value="note">General Note</option>
                <option value="concept">Concept</option>
                <option value="algorithm">Algorithm</option>
                <option value="system">System Design</option>
                <option value="project">Project</option>
                <option value="whiteboard">Whiteboard</option>
                <optgroup label="Medical">
                    <option value="anatomy">Anatomy</option>
                    <option value="disease">Disease Profile</option>
                    <option value="drug">Drug Monograph</option>
                    <option value="pathway">Pathway</option>
                    <option value="clinical_case">Clinical Case</option>
                    <option value="lab">Lab Interpretation</option>
                </optgroup>
                <optgroup label="Dentistry">
                    <option value="dental_anatomy">Dental Anatomy</option>
                    <option value="oral_pathology">Oral Pathology</option>
                    <option value="dental_procedure">Procedure</option>
                    <option value="dental_case">Dental Case</option>
                    <option value="prostho_plan">Prostho Plan</option>
                    <option value="endo_case">Endo Case</option>
                    <option value="perio_case">Perio Case</option>
                    <option value="oral_radiology">Oral Radiology</option>
                </optgroup>
                <!-- ENGINEERING -->
                <optgroup label="Engineering">
                    <option value="problem_solution">Problem Solution</option>
                    <option value="circuit_analysis">Circuit Analysis</option>
                    <option value="mechanical_system">Mechanical System</option>
                    <option value="structural_analysis">Structural Analysis</option>
                    <option value="control_system">Control System</option>
                    <option value="process_flow">Process Flow</option>
                    <option value="design_calculation">Design Calc</option>
                    <option value="lab_experiment">Lab Experiment</option>
                </optgroup>
            </select>
        </div>
        <div class="meta-group">
            <label class="meta-label">System / Course</label>
            <input type="text" id="metaSystem" class="meta-value" placeholder="e.g. Cardio, Neuro..." onchange="updatePageMeta()">
        </div>
        <!-- DENTISTRY SPECIFIC METADATA -->
        <div id="dentalMetaGroup" style="display:none; border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px;">
            <div class="meta-group">
                <label class="meta-label">Tooth # (FDI/Universal)</label>
                <input type="text" id="metaTooth" class="meta-value" placeholder="e.g. 11, 46, #3..." onchange="updatePageMeta()">
            </div>
            <div class="meta-group">
                <label class="meta-label">Quadrant</label>
                <select id="metaQuadrant" class="meta-value" onchange="updatePageMeta()">
                    <option value="">None</option>
                    <option value="UR">UR (1)</option>
                    <option value="UL">UL (2)</option>
                    <option value="LL">LL (3)</option>
                    <option value="LR">LR (4)</option>
                </select>
            </div>
             <div class="meta-group">
                <label class="meta-label">Specialty</label>
                <select id="metaSpecialty" class="meta-value" onchange="updatePageMeta()">
                    <option value="">General</option>
                    <option value="Endo">Endodontics</option>
                    <option value="Perio">Periodontics</option>
                    <option value="Prostho">Prosthodontics</option>
                    <option value="Ortho">Orthodontics</option>
                    <option value="Surgery">Oral Surgery</option>
                    <option value="Pedo">Pedodontics</option>
                </select>
            </div>
        </div>

        <!-- ENGINEERING SPECIFIC METADATA -->
        <div id="engineeringMetaGroup" style="display:none; border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px;">
            <div class="meta-group">
                <label class="meta-label">Engineering Branch</label>
                <select id="metaEngBranch" class="meta-value" onchange="updatePageMeta()">
                    <option value="Electrical">Electrical (EE)</option>
                    <option value="Mechanical">Mechanical (ME)</option>
                    <option value="Civil">Civil (CE)</option>
                    <option value="Electronics">Electronics (ECE)</option>
                    <option value="Mechatronics">Mechatronics</option>
                    <option value="Industrial">Industrial</option>
                    <option value="General">General</option>
                </select>
            </div>
        </div>

        <div class="meta-group">
            <label class="meta-label">Difficulty</label>
            <select id="metaDifficulty" class="meta-value" onchange="updatePageMeta()">
                <option value="easy">Easy</option>
                <option value="medium">Medium</option>
                <option value="hard">Hard</option>
                <option value="exam">Exam Critical</option>
            </select>
        </div>
        <div class="meta-group">
            <label class="meta-label">Created At</label>
            <div id="metaCreated" style="font-size:0.8rem; color:#666;"></div>
        </div>
         <button class="tool-btn" onclick="closeMetadataModal()" style="margin-top: 10px; background: #eee;">Close</button>
    </div>

    <!-- UPDATED TEMPLATE POPUP -->
    <div id="templatePopup" class="floating-pane">
        <h3 style="margin-bottom: 10px;">Select Template</h3>
        
        <!-- Main Menu View -->
        <div id="tmpl-main-view">
            <button class="tool-btn" onclick="showCSTemplates()" style="justify-content:space-between; background: var(--cs-accent); color: white; border: none;">
                <span>üíª Computer Science</span>
                <span>‚ñ∂</span>
            </button>
            <button class="tool-btn" onclick="showMedTemplates()" style="justify-content:space-between; background: var(--med-accent); color: white; border: none;">
                <span>‚öïÔ∏è Medical</span>
                <span>‚ñ∂</span>
            </button>
            <button class="tool-btn" onclick="showDentistryTemplates()" style="justify-content:space-between; background: var(--dent-accent); color: white; border: none;">
                <span>ü¶∑ Dentistry</span>
                <span>‚ñ∂</span>
            </button>
            <button class="tool-btn" onclick="showEngineeringTemplates()" style="justify-content:space-between; background: var(--eng-accent); color: white; border: none;">
                <span>‚öôÔ∏è Engineering</span>
                <span>‚ñ∂</span>
            </button>
            <hr style="width:100%; opacity:0.1; margin: 8px 0;">
            <button class="tool-btn" onclick="applyTemplate('default')">üìÑ Default Page</button>
            <button class="tool-btn" onclick="applyTemplate('whiteboard')">‚ôæÔ∏è Infinite Whiteboard</button>
            <button class="tool-btn" onclick="applyTemplate('meeting')">üìÖ Meeting Notes</button>
            <button class="tool-btn" onclick="applyTemplate('journal')">üìñ Daily Journal</button>
            <button class="tool-btn" onclick="applyTemplate('eisenhower')">‚öñÔ∏è Eisenhower Matrix</button>
        </div>

        <!-- CS Sub-Menu View -->
        <div id="tmpl-cs-view" style="display:none;">
            <button class="tool-btn" onclick="showMainTemplates()" style="background:#eee; margin-bottom:5px; justify-content: center;">‚óÄ Back to Main</button>
            <button class="tool-btn" onclick="applyTemplate('algo')">üìê Algorithm Sheet</button>
            <button class="tool-btn" onclick="applyTemplate('sysDesign')">‚öôÔ∏è System Design</button>
            <button class="tool-btn" onclick="applyTemplate('codeStudy')">üíª Code Study</button>
            <button class="tool-btn" onclick="applyTemplate('project')">üöÄ Project Log</button>
        </div>

        <!-- Medical Sub-Menu View -->
        <div id="tmpl-med-view" style="display:none;">
            <button class="tool-btn" onclick="showMainTemplates()" style="background:#eee; margin-bottom:5px; justify-content: center;">‚óÄ Back to Main</button>
            <button class="tool-btn" onclick="applyTemplate('anatomy')">üß† Anatomy Sheet</button>
            <button class="tool-btn" onclick="applyTemplate('disease')">üè• Disease Profile</button>
            <button class="tool-btn" onclick="applyTemplate('drug')">üíä Drug Monograph</button>
            <button class="tool-btn" onclick="applyTemplate('physio')">ü¶µ Physiotherapy Case</button>
            <button class="tool-btn" onclick="applyTemplate('pathway')">üß¨ Pathway Breakdown</button>
            <button class="tool-btn" onclick="applyTemplate('lab')">üß™ Lab Interpretation</button>
        </div>
        
        <!-- Dentistry Sub-Menu View -->
        <div id="tmpl-dentistry-view" style="display:none;">
            <button class="tool-btn" onclick="showMainTemplates()" style="background:#eee; margin-bottom:5px; justify-content: center;">‚óÄ Back to Main</button>
            <button class="tool-btn" onclick="applyTemplate('dental_anatomy')">ü¶∑ Dental Anatomy</button>
            <button class="tool-btn" onclick="applyTemplate('oral_pathology')">üß¨ Oral Pathology</button>
            <button class="tool-btn" onclick="applyTemplate('dental_procedure')">üõ†Ô∏è Procedure</button>
            <button class="tool-btn" onclick="applyTemplate('dental_case')">üßæ Dental Case</button>
            <button class="tool-btn" onclick="applyTemplate('prostho_plan')">ü¶∑ Prostho Plan</button>
            <button class="tool-btn" onclick="applyTemplate('endo_case')">ü¶† Endo Case</button>
            <button class="tool-btn" onclick="applyTemplate('perio_case')">ü™• Perio Case</button>
            <button class="tool-btn" onclick="applyTemplate('oral_radiology')">ü©ª Oral Radiology</button>
        </div>

        <!-- Engineering Sub-Menu View -->
        <div id="tmpl-eng-view" style="display:none;">
            <button class="tool-btn" onclick="showMainTemplates()" style="background:#eee; margin-bottom:5px; justify-content: center;">‚óÄ Back to Main</button>
            <button class="tool-btn" onclick="applyTemplate('prob_sol')">üìê Problem Solution</button>
            <button class="tool-btn" onclick="applyTemplate('circuit')">‚ö° Circuit Analysis</button>
            <button class="tool-btn" onclick="applyTemplate('mech_sys')">‚öôÔ∏è Mechanical System</button>
            <button class="tool-btn" onclick="applyTemplate('struct')">üèó Structural Analysis</button>
            <button class="tool-btn" onclick="applyTemplate('control')">üéõ Control System</button>
            <button class="tool-btn" onclick="applyTemplate('process')">üè≠ Process Flow</button>
            <button class="tool-btn" onclick="applyTemplate('lab_exp')">üß™ Lab Experiment</button>
        </div>

        <button class="tool-btn" onclick="toggleTemplates()" style="margin-top: 10px; background: #eee;">Close</button>
    </div>

    <div id="toast" class="toast">Action Successful!</div>

    <script>
        // --- CONSTANTS ---
        const MATH_KEYS = {
            basic: ['+', '-', '=', '‚âà', '‚â†', '¬±', '√ó', '√∑', '(', ')', '[', ']', '{', '}'],
            trig: ['\\sin', '\\cos', '\\tan', '\\cot', '\\sec', '\\csc', '\\arcsin', '\\arccos', '\\arctan'],
            calc: ['\\int', '\\iint', '\\oint', '\\partial', '\\nabla', '\\sum', '\\prod', '\\lim', '\\to', '‚àû', 'dx', 'dt'],
            geom: ['\\perp', '\\parallel', '‚à†', '‚ñ≥', 'œÄ', 'Œ∏', 'Œ±', 'Œ≤', 'œÜ', 'Œª', 'Œî'],
            struct: ['\\frac{}{}', '^{}', '_{}', '\\sqrt{}', '\\vec{}', '\\bar{}', '\\hat{}']
        };

        const DISCIPLINE_REGISTRY = {
            GENERAL: { id: 'general', name: 'General' },
            CS: { id: 'cs', name: 'Computer Science' },
            MEDICAL: { id: 'medical', name: 'Medical' },
            ENGINEERING: { id: 'engineering', name: 'Engineering' }
        };

        const PAGE_TYPES = {
            NOTE: 'note', CONCEPT: 'concept', ALGORITHM: 'algorithm', SYSTEM: 'system', PROJECT: 'project', WHITEBOARD: 'whiteboard',
            ANATOMY: 'anatomy', DISEASE: 'disease', DRUG: 'drug', PATHWAY: 'pathway', CLINICAL_CASE: 'clinical_case', LAB: 'lab',
            DENTAL_ANATOMY: 'dental_anatomy', ORAL_PATHOLOGY: 'oral_pathology', DENTAL_PROCEDURE: 'dental_procedure', DENTAL_CASE: 'dental_case',
            PROSTHO_PLAN: 'prosthodontic_plan', ENDO_CASE: 'endodontic_case', PERIO_CASE: 'periodontal_case', ORAL_RADIOLOGY: 'oral_radiology',
            PROBLEM_SOLUTION: 'problem_solution', CIRCUIT_ANALYSIS: 'circuit_analysis', MECHANICAL_SYSTEM: 'mechanical_system',
            STRUCTURAL_ANALYSIS: 'structural_analysis', CONTROL_SYSTEM: 'control_system', PROCESS_FLOW: 'process_flow',
            DESIGN_CALCULATION: 'design_calculation', LAB_EXPERIMENT: 'lab_experiment'
        };

        // --- INDEXEDDB STORAGE ENGINE (DB v2) ---
        const DB_NAME = 'NotebookDB_v1';
        const STORE_NAME = 'chapters';
        let db;

        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 2); 
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onerror = (e) => reject("DB Error");
            });
        }

        function saveChapterToDB(chapter) {
            if (!chapter.metadata) {
                chapter.metadata = { discipline: 'general', type: PAGE_TYPES.NOTE, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() };
            }
            chapter.metadata.updatedAt = new Date().toISOString();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.put(chapter);
                tx.oncomplete = () => { updateStorageQuota(); resolve(); };
                tx.onerror = () => reject();
            });
        }

        function loadAllChapters() {
            return new Promise((resolve) => {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result || []);
            });
        }

        function deleteChapterFromDB(id) {
            return new Promise((resolve) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.delete(id);
                tx.oncomplete = () => resolve();
            });
        }

        function clearDB() {
            return new Promise((resolve) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.clear();
                tx.oncomplete = () => resolve();
            });
        }

        async function checkMigration() {
            const oldData = localStorage.getItem('notebook_data_v1');
            if (oldData) {
                try {
                    const oldChapters = JSON.parse(oldData);
                    if (Array.isArray(oldChapters)) {
                        for (const chap of oldChapters) {
                            chap.metadata = { discipline: 'general', type: PAGE_TYPES.NOTE, createdAt: chap.lastEdited || new Date().toISOString(), updatedAt: new Date().toISOString() };
                            await saveChapterToDB(chap);
                        }
                        showToast("Migrated LocalStorage to DB!");
                    }
                    localStorage.removeItem('notebook_data_v1'); 
                } catch (e) { console.error("Migration failed", e); }
            }
        }

        async function updateStorageQuota() {
            if (navigator.storage && navigator.storage.estimate) {
                const estimate = await navigator.storage.estimate();
                const usage = estimate.usage || 0;
                const percent = Math.min(100, (usage / (estimate.quota || 1024*1024*1000)) * 100).toFixed(1);
                const mb = (usage / 1024 / 1024).toFixed(2);
                document.getElementById('storageBar').style.width = percent + '%';
                document.getElementById('storageText').innerText = `${mb} MB (${percent}%)`;
                if(percent > 90) document.getElementById('storageBar').style.background = '#e74c3c';
            }
        }

        // --- APP STATE ---
        let chapters = [];
        let currentId = null;
        let isSketchMode = false;
        let activeSketchTool = 'brush'; 
        let customStrokeStyle = null; 
        let isReadMode = false;
        let isListening = false;
        let recognition = null;
        let sketchData = null;
        let undoStack = [];
        let redoStack = [];
        let isTrayCollapsed = false;
        let isRulerActive = false;
        let rulerX = 200, rulerY = 300, rulerAngle = 0;
        let isDraggingRuler = false, isRotatingRuler = false;
        let rulerDragStartX, rulerDragStartY, rulerStartAngle;
        let isMathMode = false; // Toggles keyboard visibility

        const canvas = document.getElementById('sketchCanvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        const paperStyles = ['grid', 'lined', 'dotted', 'plain'];
        const markdownTriggers = { '#': 'h1', '##': 'h2', '###': 'h3', '-': 'unordered-list', '*': 'unordered-list', '1.': 'ordered-list', '>': 'blockquote', '[]': 'checkbox', '---': 'hr' };

        function handleMarkdownInput(e) {
            if (e.data === ' ') {
                const selection = window.getSelection();
                if (!selection.rangeCount) return;
                const node = selection.anchorNode;
                if (node.nodeType !== 3) return;
                const text = node.textContent;
                const parts = text.split(/[\s\u00A0]+/);
                const trigger = parts[0];
                if (markdownTriggers[trigger]) {
                    const action = markdownTriggers[trigger];
                    const cleanText = text.substring(trigger.length).trim();
                    node.textContent = cleanText; 
                    if (action === 'h1') document.execCommand('formatBlock', false, 'H1');
                    else if (action === 'h2') document.execCommand('formatBlock', false, 'H2');
                    else if (action === 'h3') document.execCommand('formatBlock', false, 'H3');
                    else if (action === 'unordered-list') document.execCommand('insertUnorderedList');
                    else if (action === 'ordered-list') document.execCommand('insertOrderedList');
                    else if (action === 'blockquote') document.execCommand('formatBlock', false, 'BLOCKQUOTE');
                    else if (action === 'hr') document.execCommand('insertHorizontalRule');
                    else if (action === 'checkbox') insertBlock('todo');
                    window.markUnsaved();
                    window.saveCurrentToCloud();
                }
            }
        }

        async function initApp() {
            try {
                await initDB();
                await checkMigration();
                chapters = await loadAllChapters();
                chapters.sort((a, b) => new Date(b.lastEdited) - new Date(a.lastEdited));

                if (chapters.length === 0) {
                    createNewChapter();
                } else {
                    renderSidebar();
                    loadChapter(chapters[0].id);
                }
                
                setupDragAndDrop();
                updateStorageQuota();
                
                document.getElementById('editor').addEventListener('input', handleMarkdownInput);
                document.getElementById('editor').addEventListener('click', function(e) {
                    if (e.target.classList.contains('checkbox')) {
                        e.preventDefault(); 
                        e.target.classList.toggle('checked');
                        const wrapper = e.target.parentElement;
                        const textDiv = wrapper.nextElementSibling;
                        if(textDiv && textDiv.classList.contains('checklist-text')) {
                            textDiv.classList.toggle('completed');
                        }
                        saveCurrentToCloud();
                    }
                });
                
                setupRulerEvents();
                switchMathTab('basic'); // Init keys
                document.addEventListener('selectionchange', handleSelectionChange);
                
            } catch (err) {
                console.error(err);
            }
        }

        // --- MATH KEYBOARD LOGIC ---
        function switchMathTab(category, btn) {
            // Update UI tabs
            document.querySelectorAll('.math-tab-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            else if(!btn && document.querySelector('.math-tab-btn')) document.querySelector('.math-tab-btn').classList.add('active');

            const container = document.getElementById('mathKeys');
            container.innerHTML = '';
            
            const keys = MATH_KEYS[category] || [];
            keys.forEach(k => {
                const btn = document.createElement('button');
                btn.className = 'math-key';
                // Clean display label
                let label = k.replace('\\', '');
                
                // Specific overrides for student friendly symbols
                if (category === 'basic') {
                    if (k === '\\approx') label = '‚âà';
                    else if (k === '\\neq') label = '‚â†';
                    else if (k === '\\pm') label = '¬±';
                    else if (k === '\\times') label = '√ó';
                    else if (k === '\\div') label = '√∑';
                } else if (category === 'trig') {
                    // Remove slashes for cleaner look
                    label = label;
                } else if (category === 'calc') {
                    if (k === '\\int') label = '‚à´';
                    else if (k === '\\sum') label = 'Œ£';
                    else if (k === '\\prod') label = 'Œ†';
                    else if (k === '\\partial') label = '‚àÇ';
                    else if (k === '\\nabla') label = '‚àá';
                    else if (k === '\\infty') label = '‚àû';
                } else if (category === 'geom') {
                    if (k === '\\pi') label = 'œÄ';
                    else if (k === '\\theta') label = 'Œ∏';
                    else if (k === '\\alpha') label = 'Œ±';
                    else if (k === '\\beta') label = 'Œ≤';
                    else if (k === '\\phi') label = 'œÜ';
                    else if (k === '\\lambda') label = 'Œª';
                    else if (k === '\\Delta') label = 'Œî';
                    else if (k === '\\perp') label = '‚ä•';
                    else if (k === '\\parallel') label = '‚à•';
                    else if (k === '\\angle') label = '‚à†';
                    else if (k === '\\triangle') label = '‚ñ≥';
                }
                
                // Structure specific labels
                if(k.includes('frac')) label = 'a/b';
                else if(k.includes('sqrt')) label = '‚àö';
                else if(k.includes('^')) label = 'x ∏';
                else if(k.includes('_')) label = 'x‚Çô';
                else if(k === '\\int_{}^{}') label = '‚à´‚Çê·µá';
                else if(k === '\\vec{}') label = 'v‚Éó';
                else if(k === '\\bar{}') label = 'xÃÑ';
                else if(k === '\\hat{}') label = 'xÃÇ';

                btn.innerText = label;
                
                // Clicking key puts raw latex into buffer
                btn.onclick = () => {
                    const buffer = document.getElementById('mathBuffer');
                    // Add space for functions to avoid merging
                    const val = k.startsWith('\\') && category === 'trig' ? k + ' ' : k;
                    buffer.value += val;
                    updateMathPreview();
                    buffer.focus();
                };
                container.appendChild(btn);
            });
        }
        
        function updateMathPreview() {
            const input = document.getElementById('mathBuffer').value;
            const preview = document.getElementById('mathPreview');
            try {
                if(window.katex) {
                    preview.innerHTML = katex.renderToString(input, { throwOnError: false });
                } else {
                    preview.innerText = input;
                }
            } catch(e) {
                preview.innerText = "...";
            }
        }
        
        function insertMathFromBuffer() {
            const buffer = document.getElementById('mathBuffer');
            const latex = buffer.value.trim();
            if(!latex) return;
            
            let mathHtml = '';
            if(window.katex) {
                mathHtml = katex.renderToString(latex, { throwOnError: false });
            } else {
                mathHtml = `<span style="font-family:monospace; background:#eee;">${latex}</span>`;
            }
            
            // Insert as a non-editable block (so backspace deletes whole thing)
            const html = `<span class="math-block" contenteditable="false" data-latex="${latex}" style="padding:0 5px; cursor:pointer;" onclick="editMathBlock(this)">${mathHtml}</span>&nbsp;`;
            
            // Insert into editor at cursor
            const editor = document.getElementById('editor');
            editor.focus();
            if(document.execCommand('insertHTML', false, html)) {
                // success
            } else {
                // Fallback append
                editor.innerHTML += html;
            }
            
            buffer.value = '';
            updateMathPreview();
            saveCurrentToCloud();
        }
        
        window.editMathBlock = (el) => {
            const latex = el.getAttribute('data-latex');
            document.getElementById('mathBuffer').value = latex;
            updateMathPreview();
            toggleMathMode(true); // Open keyboard
            // Optional: Remove old block so "update" feels natural? 
            // Or just append new. Let's just open keyboard for now.
        };

        window.toggleMathMode = (forceOpen = false) => {
            const keyboard = document.getElementById('mathKeyboard');
            const btn = document.getElementById('mathModeBtn');
            
            if (forceOpen === true) {
                isMathMode = true;
            } else {
                isMathMode = !isMathMode;
            }
            
            if (isMathMode) {
                keyboard.style.display = 'flex';
                if(btn) btn.classList.add('active');
                // Adjust workspace padding so keyboard doesn't overlap text
                document.querySelector('.sidebar').style.bottom = '220px'; 
            } else {
                keyboard.style.display = 'none';
                if(btn) btn.classList.remove('active');
                document.querySelector('.sidebar').style.bottom = '0';
            }
        };

        // --- DISCIPLINE TOOLBAR FUNCTIONS ---
        // CS Tools
        window.insertAlgoStep = () => { insertHtml(`<div class="chalk-code" contenteditable="true">1. Step description...<br>   ‚Ü≥ Logic/Condition</div>`); }
        window.insertComplexity = () => { insertHtml(`<span class="algo-badge" contenteditable="true">Time: O(n)</span>&nbsp;`); }
        
        // TRACE TABLE FIX
        let savedRange = null;

        function saveSelection() {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                savedRange = sel.getRangeAt(0);
            }
        }

        function restoreSelection() {
            if (savedRange) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(savedRange);
            }
        }

        window.insertTraceTable = () => {
            saveSelection();
            document.getElementById('traceModal').style.display = 'flex';
            document.getElementById('traceVarCount').focus();
        }

        window.closeTraceModal = () => {
            document.getElementById('traceModal').style.display = 'none';
        }

        window.confirmTraceTable = () => {
            const count = document.getElementById('traceVarCount').value;
            const n = parseInt(count);
            if (isNaN(n) || n < 1) return;

            let headers = "";
            let cells = "";
            
            // Fix: No Line Column
            for(let i=1; i<=n; i++) {
                headers += `<th>Var ${i}</th>`;
                cells += `<td>-</td>`;
            }
            
            headers += "<th>Output</th>";
            cells += "<td>-</td>";

            // UPDATED: Wrapped in relative container with add button
            const html = `
                <div class="trace-table-container" style="overflow-x:auto; margin:10px 0;">
                    <button contenteditable="false" onclick="addTraceColumn(this)" class="btn-trace-add" title="Add Variable">+</button>
                    <table class="trace-table" style="width:100%; min-width:100%;">
                        <thead><tr>${headers}</tr></thead>
                        <tbody>
                            <tr>${cells}</tr>
                            <tr>${cells}</tr>
                            <tr>${cells}</tr>
                        </tbody>
                    </table>
                </div>
                <p><br></p>
            `;
            restoreSelection(); // Restore cursor position
            insertHtml(html);
            closeTraceModal();
        }

        // NEW: Helper function to add column dynamically
        window.addTraceColumn = (btn) => {
            const container = btn.closest('.trace-table-container');
            if(!container) return;
            const table = container.querySelector('table');
            if(!table) return;
            
            const headRow = table.tHead.rows[0];
            const bodyRows = table.tBodies[0].rows;
            
            // Find insert index (before Output, which is typically the last column)
            let insertIndex = headRow.cells.length - 1;
            
            // Generate new variable name based on max existing var number
            let maxVar = 0;
            for(let cell of headRow.cells) {
                const match = cell.innerText.trim().match(/^Var\s+(\d+)/);
                if(match) {
                    const num = parseInt(match[1]);
                    if(num > maxVar) maxVar = num;
                }
            }
            const newVarName = `Var ${maxVar + 1}`;

            // Insert Header
            const newTh = document.createElement('th');
            newTh.innerText = newVarName;
            headRow.insertBefore(newTh, headRow.cells[insertIndex]);

            // Insert Cells
            for (let row of bodyRows) {
                const newTd = document.createElement('td');
                newTd.innerText = '-';
                row.insertBefore(newTd, row.cells[insertIndex]);
            }
            
            window.saveCurrentToCloud();
        };
        
        // Medical Tools
        window.activeAnatomyPinMode = false;
        window.activateAnatomyPin = () => {
            window.activeAnatomyPinMode = true;
            document.getElementById('paper').style.cursor = 'crosshair';
            showToast("Tap paper to place pin");
        }
        
        document.getElementById('paper').addEventListener('click', function(e) {
            if(!window.activeAnatomyPinMode) return;
            if(e.target.closest('.writing-tools') || e.target.closest('.tool-tray-container')) return;
            
            const rect = this.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const count = document.getElementsByClassName('anatomy-pin').length + 1;
            const pin = document.createElement('div');
            pin.className = 'anatomy-pin';
            pin.setAttribute('contenteditable', 'false'); // FIX: Prevent editing inside the pin
            pin.style.left = (x - 12) + 'px';
            pin.style.top = (y - 12) + 'px';
            pin.innerHTML = `<span>${count}</span>`;
            
            // FIX: Append to editor so it is saved with page content, not stuck on paper
            document.getElementById('editor').appendChild(pin);
            
            const legendHtml = `<div class="checklist-item">
                <div style="background:var(--med-accent); color:white; width:20px; height:20px; border-radius:50%; text-align:center; font-size:0.7rem; line-height:20px; margin-right:10px;">${count}</div>
                <div class="checklist-text" contenteditable="true">Label...</div>
            </div>`;
            
            const editor = document.getElementById('editor');
            editor.innerHTML += legendHtml;
            
            window.activeAnatomyPinMode = false;
            document.getElementById('paper').style.cursor = 'default';
            saveCurrentToCloud();
        });

        window.setHighlightPreset = (type) => {
            customStrokeStyle = (type === 'symptom') ? 'rgba(255, 235, 59, 0.4)' : 'rgba(231, 76, 60, 0.4)';
            activeSketchTool = 'custom';
            const highlighterBtn = document.querySelector('.tool-opt.highlighter');
            if(highlighterBtn) highlighterBtn.click();
        }
        window.insertTimeline = () => { insertHtml(`<div style="border-left: 2px solid #ccc; padding-left: 10px; margin: 10px 0;"><p><strong>00:00</strong> - Presentation</p><p><strong>00:30</strong> - Investigation</p></div>`); }
        window.insertComparison = () => { insertHtml(`<table style="width:100%; border-collapse:collapse; margin:10px 0; font-size:0.9rem;"><tr><th style="border-bottom:2px solid #ccc; text-align:left;">Normal</th><th style="border-bottom:2px solid #ccc; text-align:left;">Abnormal</th></tr><tr><td style="padding:5px; border-bottom:1px solid #eee;">Value</td><td style="padding:5px; border-bottom:1px solid #eee;">Value</td></tr></table><p><br></p>`); }

        // Engineering Tools
        window.toggleRuler = () => {
            isRulerActive = !isRulerActive;
            document.getElementById('engRuler').style.display = isRulerActive ? 'block' : 'none';
        }
        
        function setupRulerEvents() {
            const ruler = document.getElementById('engRuler');
            const rotateHandle = document.getElementById('rulerRotate');
            
            ruler.addEventListener('mousedown', (e) => {
                if(e.target === rotateHandle) return; 
                isDraggingRuler = true;
                rulerDragStartX = e.clientX - ruler.offsetLeft;
                rulerDragStartY = e.clientY - ruler.offsetTop;
            });
            
            rotateHandle.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                isRotatingRuler = true;
                const rect = ruler.getBoundingClientRect();
                const centerX = rect.left + rect.width/2;
                const centerY = rect.top + rect.height/2;
                rulerStartAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) - (rulerAngle * Math.PI / 180);
            });
            
            window.addEventListener('mousemove', (e) => {
                if(isDraggingRuler) {
                    rulerX = e.clientX - rulerDragStartX;
                    rulerY = e.clientY - rulerDragStartY;
                    ruler.style.left = rulerX + 'px';
                    ruler.style.top = rulerY + 'px';
                }
                if(isRotatingRuler) {
                    const rect = ruler.getBoundingClientRect();
                    const centerX = rect.left + rect.width/2;
                    const centerY = rect.top + rect.height/2;
                    const angle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
                    rulerAngle = (angle - rulerStartAngle) * 180 / Math.PI;
                    ruler.style.transform = `rotate(${rulerAngle}deg)`;
                }
            });
            
            window.addEventListener('mouseup', () => {
                isDraggingRuler = false;
                isRotatingRuler = false;
            });
        }

        window.insertEquation = () => { insertHtml(`<div style="font-family:'Times New Roman', serif; font-style:italic; font-size:1.1rem; text-align:center; background:rgba(0,0,0,0.03); padding:10px; border-radius:4px;">x = (-b ¬± ‚àö(b¬≤ - 4ac)) / 2a</div><p><br></p>`); }
        window.insertAssumptions = () => { insertHtml(`<h3 style="color:#7f8c8d; border-bottom:1px solid #eee;">Assumptions</h3><ul><li>Steady state</li><li>Adiabatic</li></ul>`); }
        window.insertConstants = () => { insertHtml(`<div class="chalk-code">g = 9.81 m/s¬≤<br>œÄ = 3.14159</div>`); }
        
        // --- TOOLBAR SWITCHING ---
        function updateToolVisibility(chapter) {
            // Safe hiding
            const csTools = document.getElementById('tools-cs');
            if(csTools) csTools.style.display = 'none';

            const medTools = document.getElementById('tools-med');
            if(medTools) medTools.style.display = 'none';

            const engTools = document.getElementById('tools-eng');
            if(engTools) engTools.style.display = 'none';
            
            document.getElementById('engRuler').style.display = 'none';
            isRulerActive = false;
            isMathMode = false; 
            const mathBtn = document.getElementById('mathModeBtn');
            if(mathBtn) mathBtn.classList.remove('active');
            
            const disc = chapter?.metadata?.discipline;
            if(disc === 'cs' && csTools) csTools.style.display = 'flex';
            if(disc === 'medical' && medTools) medTools.style.display = 'flex';
            if(disc === 'engineering' && engTools) engTools.style.display = 'flex';
            
            // Legacy/Fallback for Code Button if container doesn't exist
            const btnCSCode = document.getElementById('btnCSCode');
            if(btnCSCode && !csTools) btnCSCode.style.display = (disc === 'cs') ? 'flex' : 'none';
        }

        window.insertCSCodeBlock = () => {
            const html = `
                <div class="cs-code-container" contenteditable="false">
                    <div class="cs-code-header">
                        <span>Code Snippet</span>
                        <span style="font-size:0.7rem; opacity:0.7">Editable</span>
                    </div>
                    <div class="cs-code-editor" contenteditable="true">// Write code here...</div>
                    <div class="cs-code-output" contenteditable="true">Result...</div>
                </div>
                <p><br></p>
            `;
            insertHtml(html);
        };

        window.filterChapters = () => {
            renderSidebar();
        }

        // --- METADATA MODAL ---
        window.openMetadataModal = () => {
            const chapter = chapters.find(c => c.id === currentId);
            if (!chapter) return;
            
            document.getElementById('metaDiscipline').value = chapter.metadata?.discipline || 'general';
            document.getElementById('metaType').value = chapter.metadata?.type || 'note';
            document.getElementById('metaDifficulty').value = chapter.metadata?.difficulty || 'medium';
            document.getElementById('metaSystem').value = chapter.metadata?.system || '';
            document.getElementById('metaCreated').innerText = new Date(chapter.metadata?.createdAt).toLocaleString();
            
            const dentalTypes = [
                PAGE_TYPES.DENTAL_ANATOMY, PAGE_TYPES.ORAL_PATHOLOGY, PAGE_TYPES.DENTAL_PROCEDURE,
                PAGE_TYPES.DENTAL_CASE, PAGE_TYPES.PROSTHO_PLAN, PAGE_TYPES.ENDO_CASE,
                PAGE_TYPES.PERIO_CASE, PAGE_TYPES.ORAL_RADIOLOGY
            ];
            const dentalGroup = document.getElementById('dentalMetaGroup');
            if(dentalTypes.includes(chapter.metadata?.type)) {
                dentalGroup.style.display = 'block';
                document.getElementById('metaTooth').value = chapter.metadata?.toothNumber || '';
                document.getElementById('metaQuadrant').value = chapter.metadata?.quadrant || '';
                document.getElementById('metaSpecialty').value = chapter.metadata?.specialty || '';
            } else {
                dentalGroup.style.display = 'none';
            }

             const engTypes = [
                PAGE_TYPES.PROBLEM_SOLUTION, PAGE_TYPES.CIRCUIT_ANALYSIS, PAGE_TYPES.MECHANICAL_SYSTEM,
                PAGE_TYPES.STRUCTURAL_ANALYSIS, PAGE_TYPES.CONTROL_SYSTEM, PAGE_TYPES.PROCESS_FLOW,
                PAGE_TYPES.DESIGN_CALCULATION, PAGE_TYPES.LAB_EXPERIMENT
            ];
            const engGroup = document.getElementById('engineeringMetaGroup');
             if(engTypes.includes(chapter.metadata?.type) || chapter.metadata?.discipline === 'engineering') {
                engGroup.style.display = 'block';
                document.getElementById('metaEngBranch').value = chapter.metadata?.branch || 'General';
            } else {
                engGroup.style.display = 'none';
            }

            document.getElementById('metadataModal').style.display = 'flex';
        };

        window.closeMetadataModal = () => {
             document.getElementById('metadataModal').style.display = 'none';
        };

        window.updatePageMeta = () => {
            const chapter = chapters.find(c => c.id === currentId);
            if (chapter) {
                chapter.metadata.type = document.getElementById('metaType').value;
                chapter.metadata.difficulty = document.getElementById('metaDifficulty').value;
                chapter.metadata.system = document.getElementById('metaSystem').value;
                
                // Save dental meta
                chapter.metadata.toothNumber = document.getElementById('metaTooth').value;
                chapter.metadata.quadrant = document.getElementById('metaQuadrant').value;
                chapter.metadata.specialty = document.getElementById('metaSpecialty').value;

                // Save Engineering meta
                chapter.metadata.branch = document.getElementById('metaEngBranch').value;

                saveChapterToDB(chapter);
                
                // Update UI visibility for fields
                openMetadataModal(); // Refresh modal state
            }
        };

        // --- CORE FUNCTIONS ---
        
        window.toggleTopTools = () => {
            document.body.classList.toggle('tools-hidden');
            const tools = document.getElementById('topTools');
            if (document.body.classList.contains('tools-hidden')) {
                tools.classList.add('collapsed');
            } else {
                tools.classList.remove('collapsed');
            }
        };

        window.wipeAllData = async () => {
            if(confirm("DANGER: This will delete ALL notes forever. Are you sure?")) {
                await clearDB();
                location.reload();
            }
        }

        window.loadLecturePdf = (input) => {
            const file = input.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            document.getElementById('lectureFrame').src = url;
            document.body.classList.add('split-mode');
            showToast("Lecture Loaded");
        };

        window.closeLecturePane = () => {
            document.body.classList.remove('split-mode');
        };

        window.toggleSection = (contentId, arrowId, wrapperId = null) => {
            const content = document.getElementById(contentId);
            const arrow = document.getElementById(arrowId);
            const isCollapsed = content.classList.contains('collapsed');
            if (isCollapsed) {
                content.classList.remove('collapsed');
                arrow.style.transform = 'rotate(0deg)';
                if(wrapperId) document.getElementById(wrapperId).classList.remove('collapsed-wrapper');
            } else {
                content.classList.add('collapsed');
                arrow.style.transform = 'rotate(-90deg)';
                if(wrapperId) document.getElementById(wrapperId).classList.add('collapsed-wrapper');
            }
        };

        window.toggleTray = () => {
            isTrayCollapsed = !isTrayCollapsed;
            const container = document.getElementById('trayContainer');
            const toggleBtn = document.getElementById('trayToggle');
            container.classList.toggle('collapsed', isTrayCollapsed);
            toggleBtn.innerText = isTrayCollapsed ? '‚ñ∂' : '‚óÄ';
        };

        window.toggleMobileSidebar = () => {
            document.getElementById('mainSidebar').classList.toggle('open');
        };

        window.toggleFocusMode = () => {
            document.body.classList.toggle('focus-mode');
        };

        window.toggleReadMode = () => {
            isReadMode = !isReadMode;
            document.body.classList.toggle('read-mode', isReadMode);
            const btn = document.getElementById('readModeBtn');
            const editor = document.getElementById('editor');
            if (isReadMode) {
                btn.innerText = "üîí Unlock / Edit";
                editor.contentEditable = "false";
                showToast("Read Mode Enabled");
            } else {
                btn.innerText = "üîì Lock / Read";
                editor.contentEditable = "true";
                showToast("Editing Enabled");
            }
        };

        function handleSelectionChange() {
            const bubble = document.getElementById('textBubble');
            const selection = window.getSelection();
            const editor = document.getElementById('editor');

            if (selection.isCollapsed || !editor.contains(selection.anchorNode)) {
                bubble.classList.remove('visible');
                return;
            }

            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            
            bubble.classList.add('visible');
            bubble.style.top = (rect.top + window.scrollY - 10) + 'px';
            bubble.style.left = (rect.left + (rect.width / 2)) + 'px';
        }

        window.formatText = (command, value = null) => {
            document.execCommand(command, false, value);
            window.markUnsaved();
            window.saveCurrentToCloud();
        };

        function setupDragAndDrop() {
            const paper = document.getElementById('paper');
            paper.addEventListener('dragover', (e) => { e.preventDefault(); paper.classList.add('drag-over'); });
            paper.addEventListener('dragleave', (e) => { e.preventDefault(); paper.classList.remove('drag-over'); });
            paper.addEventListener('drop', (e) => {
                e.preventDefault();
                paper.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const html = `<img src="${event.target.result}" class="uploaded-img" />`;
                        insertHtml(html);
                    };
                    reader.readAsDataURL(files[0]);
                }
            });
        }

        window.importBackgroundFile = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const chapter = chapters.find(c => c.id === currentId);
                if(chapter) {
                    chapter.backgroundImage = e.target.result;
                    await saveChapterToDB(chapter);
                    loadChapter(currentId);
                    showToast("Background Set");
                }
            };
            reader.readAsDataURL(file);
        };

        window.setCustomColor = (val) => {
            customStrokeStyle = val;
            activeSketchTool = 'custom';
            document.querySelectorAll('.tool-opt').forEach(o => o.classList.remove('active'));
            if(!isSketchMode) toggleSketchMode();
        };

        function resizeCanvas() {
            const paper = document.getElementById('paper');
            const dpr = window.devicePixelRatio || 1;
            
            if (canvas.width !== paper.offsetWidth * dpr || canvas.height !== paper.offsetHeight * dpr) {
                canvas.width = paper.offsetWidth * dpr;
                canvas.height = paper.offsetHeight * dpr;
                ctx.scale(dpr, dpr);
                if (sketchData) drawSavedSketch(sketchData);
            }
        }
        window.addEventListener('resize', resizeCanvas);

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        
        // UPDATED: Prevent drawing if multiple fingers are used (allows for gestures)
        canvas.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) return; 
            startDrawing(e.touches[0]);
        });
        
        canvas.addEventListener('touchmove', (e) => draw(e.touches[0]));
        canvas.addEventListener('touchend', stopDrawing);

        let isPanning = false;
        let startPanX = 0; let startPanY = 0;
        let scrollStartX = 0; let scrollStartY = 0;

        function startDrawing(e) {
            if (activeSketchTool === 'hand') {
                isPanning = true;
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                startPanX = clientX; startPanY = clientY;
                const ws = document.getElementById('workspace');
                scrollStartX = ws.scrollLeft; scrollStartY = ws.scrollTop;
                ws.classList.add('grabbing');
                if(e.type === 'touchstart') e.preventDefault();
                return;
            }

            if (!isSketchMode || isReadMode) return;
            if(e.type === 'touchstart') e.preventDefault();
            
            saveStateToStack();
            drawing = true;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function draw(e) {
            if (activeSketchTool === 'hand') {
                if(!isPanning) return;
                e.preventDefault();
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                const walkX = (clientX - startPanX);
                const walkY = (clientY - startPanY);
                const ws = document.getElementById('workspace');
                ws.scrollLeft = scrollStartX - walkX;
                ws.scrollTop = scrollStartY - walkY;
                return;
            }

            if (!drawing || !isSketchMode || isReadMode) return;
            if(e.type === 'touchmove') e.preventDefault();

            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;

            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;

            if (activeSketchTool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = 30;
                ctx.lineTo(x, y);
                ctx.stroke();
            } else if (activeSketchTool === 'highlighter') {
                ctx.globalCompositeOperation = 'source-over'; 
                ctx.strokeStyle = customStrokeStyle || 'rgba(255, 235, 59, 0.25)';
                ctx.lineWidth = 20;
                ctx.lineTo(x, y);
                ctx.stroke();
            } else if (activeSketchTool === 'custom') {
                 ctx.strokeStyle = customStrokeStyle;
                 ctx.lineWidth = 2;
                 ctx.lineTo(x, y);
                 ctx.stroke();
            } else {
                ctx.lineWidth = 2;
                ctx.strokeStyle = document.body.classList.contains('dark-mode') ? '#ffffff' : '#2c3e50';
                ctx.lineTo(x, y);
                ctx.stroke();
            }
            
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function stopDrawing() {
            if (activeSketchTool === 'hand') {
                isPanning = false;
                document.getElementById('workspace').classList.remove('grabbing');
                return;
            }
            if (drawing) {
                drawing = false;
                ctx.globalCompositeOperation = 'source-over';
                saveSketchToCloud();
            }
        }

        function saveStateToStack() {
            if (undoStack.length > 20) undoStack.shift(); 
            undoStack.push(canvas.toDataURL());
            redoStack = []; 
        }

        window.undoSketch = () => {
            if (undoStack.length === 0) return;
            redoStack.push(canvas.toDataURL());
            const prevStateUrl = undoStack.pop();
            drawSavedSketch(prevStateUrl);
            setTimeout(async () => {
                const chapter = chapters.find(c => c.id === currentId);
                if (chapter) {
                    chapter.sketch = canvas.toDataURL();
                    await saveChapterToDB(chapter);
                }
            }, 100);
        };

        window.redoSketch = () => {
            if (redoStack.length === 0) return;
            undoStack.push(canvas.toDataURL());
            const nextStateUrl = redoStack.pop();
            drawSavedSketch(nextStateUrl);
             setTimeout(async () => {
                const chapter = chapters.find(c => c.id === currentId);
                if (chapter) {
                    chapter.sketch = canvas.toDataURL();
                    await saveChapterToDB(chapter);
                }
            }, 100);
        };

        function drawSavedSketch(dataUrl) {
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width / (window.devicePixelRatio||1), canvas.height / (window.devicePixelRatio||1));
                ctx.drawImage(img, 0, 0, canvas.width / (window.devicePixelRatio||1), canvas.height / (window.devicePixelRatio||1));
            };
            img.src = dataUrl;
        }

        window.clearSketch = () => {
            if(!confirm("Are you sure you want to clear your drawing?")) return;
            saveStateToStack();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            saveSketchToCloud();
            showToast("Sketch cleared");
        };

        window.selectSketchTool = (tool) => {
            if (tool === 'hand') {
                activeSketchTool = 'hand';
                document.getElementById('handBtn').classList.add('active');
                document.getElementById('eraserBtn').classList.remove('active');
                if(!isSketchMode) toggleSketchMode();
                return;
            } else {
                document.getElementById('handBtn').classList.remove('active');
            }

            if(tool !== 'highlighter') customStrokeStyle = null; 
            activeSketchTool = tool === activeSketchTool ? 'brush' : tool;
            
            document.getElementById('eraserBtn').classList.toggle('active', activeSketchTool === 'eraser');
            const highlighterBtn = document.querySelector('.tool-opt.highlighter');
            if(highlighterBtn) highlighterBtn.classList.toggle('active', activeSketchTool === 'highlighter');

            if (!isSketchMode) toggleSketchMode();
        };

        window.selectWritingTool = (tool, save = true) => {
            if (tool === 'highlighter') {
                selectSketchTool('highlighter');
                return;
            }
            document.getElementById('handBtn').classList.remove('active');
            if(activeSketchTool === 'hand') activeSketchTool = 'brush';
            document.getElementById('editor').className = `content-area writing-tool-${tool}`;
            document.querySelectorAll('.tool-opt').forEach(o => o.classList.toggle('active', o.dataset.tool === tool));
            if (save) {
                const chapter = chapters.find(c => c.id === currentId);
                if (chapter) {
                    chapter.tool = tool;
                    saveChapterToDB(chapter);
                }
            }
        };

        window.cyclePaperStyle = async () => {
            const chapter = chapters.find(c => c.id === currentId);
            if(!chapter) return;
            let currentStyle = chapter.paperStyle || 'grid';
            let nextIndex = (paperStyles.indexOf(currentStyle) + 1) % paperStyles.length;
            let nextStyle = paperStyles[nextIndex];
            applyPaperStyle(nextStyle);
            chapter.paperStyle = nextStyle;
            await saveChapterToDB(chapter);
        };

        function applyPaperStyle(style) {
            const paper = document.getElementById('paper');
            const btn = document.getElementById('paperStyleBtn');
            paperStyles.forEach(s => paper.classList.remove(s));
            if(style !== 'grid') paper.classList.add(style);
            btn.innerText = `üìÑ Paper: ${style.charAt(0).toUpperCase() + style.slice(1)}`;
        }

        window.exportData = () => {
            const dataStr = JSON.stringify(chapters, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (isIOS) {
                const win = window.open();
                if(win) {
                    win.document.write('<html><body><pre>' + dataStr + '</pre></body></html>');
                    win.document.close();
                    alert("Copy the text on the next page and save it to a file.");
                } else {
                    alert("Allow popups to export.");
                }
            } else {
                const exportFileDefaultName = 'notebook_backup_' + new Date().toISOString().slice(0,10) + '.json';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            }
        };

        window.importData = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedChapters = JSON.parse(e.target.result);
                    if (Array.isArray(importedChapters)) {
                        await clearDB();
                        for(const chap of importedChapters) {
                            await saveChapterToDB(chap);
                        }
                        chapters = importedChapters;
                        initApp();
                        showToast("Backup Restored!");
                    } else {
                        alert("Invalid backup file.");
                    }
                } catch (err) {
                    alert("Error reading file");
                }
            };
            reader.readAsText(file);
        };

        window.createNewChapter = (title) => {
            if(!title) {
                const date = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                title = `Note - ${date}`;
            }
            
            // Fix: Get category correctly from dropdown
            const catElement = document.getElementById('categoryFilter');
            const currentCat = catElement ? catElement.value : 'all';
            let category = (currentCat === 'all') ? 'General' : currentCat;
            
            const id = "ch_" + Date.now();
            const newChapter = {
                id: id,
                title: title,
                // Old category prop for backward compat, new system relies on metadata
                category: category, 
                content: "<div>Start typing...</div>",
                tool: 'pen',
                sketch: null,
                paperStyle: 'grid',
                lastEdited: new Date().toISOString(),
                metadata: {
                    discipline: 'general',
                    type: PAGE_TYPES.NOTE,
                    difficulty: 'medium',
                    topics: [],
                    system: '',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }
            };
            
            // Apply discipline if category implies it
            if(['Algorithms','Systems','Projects'].includes(category)) newChapter.metadata.discipline = 'cs';
            if(['Anatomy','Pathology','Pharmacology','Clinical'].includes(category)) newChapter.metadata.discipline = 'medical';
            if(['Dental Anatomy', 'Procedures', 'Dental Cases'].includes(category)) newChapter.metadata.discipline = 'medical'; // Dentistry is a specialization of medical
            // Apply engineering discipline
            if(['Electrical','Mechanical','Civil','Electronics','Mechatronics','Industrial'].includes(category)) {
                newChapter.metadata.discipline = 'engineering';
                newChapter.metadata.branch = category;
            }

            chapters.unshift(newChapter); 
            saveChapterToDB(newChapter);
            renderSidebar();
            loadChapter(id);
            
            setTimeout(() => {
                const titleInput = document.getElementById('pageTitle');
                if (titleInput) {
                    titleInput.focus();
                    titleInput.select();
                }
            }, 100);
        };

        window.deleteChapter = async (id, event) => {
            if (event) event.stopPropagation();
            chapters = chapters.filter(c => c.id !== id);
            await deleteChapterFromDB(id);
            if (currentId === id) {
                if (chapters.length > 0) loadChapter(chapters[0].id);
                else createNewChapter();
            } else {
                renderSidebar();
            }
            showToast("Page Deleted");
        };

        function loadChapter(id) {
            currentId = id;
            undoStack = []; redoStack = [];
            const chapter = chapters.find(c => c.id === id);
            if (!chapter) return;

            // FIX: Remove stray pins from paper background (cleanup from old bug)
            document.querySelectorAll('#paper > .anatomy-pin').forEach(p => p.remove());

            setTimeout(() => resizeCanvas(), 0);

            document.getElementById('editor').innerHTML = chapter.content;
            document.getElementById('pageTitle').value = chapter.title;
            
            if(chapter.isWhiteboard) document.getElementById('paper').classList.add('infinite');
            else document.getElementById('paper').classList.remove('infinite');

            if(chapter.backgroundImage) {
                document.getElementById('paper').style.backgroundImage = `url('${chapter.backgroundImage}')`;
                document.getElementById('paper').classList.add('annotate-mode');
            } else {
                document.getElementById('paper').style.backgroundImage = '';
                document.getElementById('paper').classList.remove('annotate-mode');
                applyPaperStyle(chapter.paperStyle || 'grid');
            }

            if (chapter.sketch) {
                sketchData = chapter.sketch;
                drawSavedSketch(sketchData);
            } else {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                sketchData = null;
            }
            
            selectWritingTool(chapter.tool || 'pen', false);
            renderSidebar();
            document.getElementById('mainSidebar').classList.remove('open');
            document.getElementById('saveStatus').innerText = "All changes saved";
            
            if(isReadMode) document.getElementById('editor').contentEditable = "false";
            else document.getElementById('editor').contentEditable = "true";
            
            updateWordCount();
            updateToolVisibility(chapter);
        }

        let saveTimeout;
        window.markUnsaved = () => { document.getElementById('saveStatus').innerText = "Saving..."; }

        window.saveCurrentToCloud = () => {
            updateWordCount();
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                const chapter = chapters.find(c => c.id === currentId);
                if (chapter) {
                    chapter.content = document.getElementById('editor').innerHTML;
                    chapter.title = document.getElementById('pageTitle').value;
                    chapter.lastEdited = new Date().toISOString();
                    await saveChapterToDB(chapter);
                    document.getElementById('saveStatus').innerText = "All changes saved";
                    renderSidebar();
                }
            }, 1000);
        };
        
        function updateWordCount() {
            const text = document.getElementById('editor').innerText || "";
            const count = text.trim().split(/\s+/).filter(w => w.length > 0).length;
            document.getElementById('wordCount').innerText = count + " Words";
        }

        window.manualSave = async () => {
            const chapter = chapters.find(c => c.id === currentId);
            if (chapter) {
                chapter.content = document.getElementById('editor').innerHTML;
                chapter.title = document.getElementById('pageTitle').value;
                chapter.sketch = canvas.toDataURL();
                chapter.lastEdited = new Date().toISOString();
                await saveChapterToDB(chapter);
                showToast("Saved to Device");
                document.getElementById('saveStatus').innerText = "All changes saved";
            }
        };

        function saveSketchToCloud() {
            const chapter = chapters.find(c => c.id === currentId);
            if (chapter) {
                chapter.sketch = canvas.toDataURL();
                saveChapterToDB(chapter);
            }
        }

        window.toggleSketchMode = () => {
            isSketchMode = !isSketchMode;
            document.body.classList.toggle('sketch-mode', isSketchMode);
            document.getElementById('sketchToggle').classList.toggle('active', isSketchMode);
            if (!isSketchMode) activeSketchTool = 'brush';
            showToast(isSketchMode ? "Sketching Enabled" : "Writing Enabled");
        };

        window.toggleVoiceTranscription = () => {
            if (!recognition) {
                const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!Speech) return showToast("Speech API not supported on this browser");
                recognition = new Speech();
                recognition.continuous = true;
                recognition.interimResults = false;
                recognition.onresult = (e) => {
                    const text = e.results[e.results.length - 1][0].transcript;
                    document.getElementById('editor').focus();
                    document.execCommand('insertText', false, text + " ");
                    window.markUnsaved();
                    window.saveCurrentToCloud();
                };
                recognition.onend = () => { if (isListening) recognition.start(); };
            }
            if (isListening) {
                recognition.stop();
                isListening = false;
                document.getElementById('voiceBtn').classList.remove('active-voice');
            } else {
                recognition.start();
                isListening = true;
                document.getElementById('voiceBtn').classList.add('active-voice');
                showToast("Listening...");
            }
        };

        window.triggerImageUpload = () => document.getElementById('imageInput').click();
        window.handleImageUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const html = `<img src="${event.target.result}" class="uploaded-img" />`;
                insertHtml(html);
            };
            reader.readAsDataURL(file);
        };

        window.insertBlock = (type) => {
            let html = "";
            if (type === 'header') html = "<h2 class='styled-header'>New Title</h2>";
            
            // iPad Fix: Remove onclick, handled by delegation
            if (type === 'todo') html = `<div class="checklist-item" contenteditable="false"><div class="checkbox-wrapper" contenteditable="false"><div class="checkbox"></div></div><div class="checklist-text" contenteditable="true">Task Item</div></div>`;
            
            if (type === 'note') html = "<div class='sticky-note'>Important Note...</div>";
            if (type === 'code') html = "<div class='chalk-code'>// code here</div>";
            insertHtml(html + "<p><br></p>");
        };

        function insertHtml(html) {
            document.getElementById('editor').focus();
            document.execCommand('insertHTML', false, html);
            window.markUnsaved();
            window.saveCurrentToCloud();
        }

        window.toggleTemplates = () => {
            const p = document.getElementById('templatePopup');
            p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
        };

        // NEW: TEMPLATE NAVIGATION LOGIC
        window.showCSTemplates = () => {
            document.getElementById('tmpl-main-view').style.display = 'none';
            document.getElementById('tmpl-cs-view').style.display = 'block';
            document.getElementById('tmpl-med-view').style.display = 'none';
            document.getElementById('tmpl-dentistry-view').style.display = 'none';
            document.getElementById('tmpl-eng-view').style.display = 'none';
        };

        window.showMedTemplates = () => {
            document.getElementById('tmpl-main-view').style.display = 'none';
            document.getElementById('tmpl-cs-view').style.display = 'none';
            document.getElementById('tmpl-med-view').style.display = 'block';
            document.getElementById('tmpl-dentistry-view').style.display = 'none';
            document.getElementById('tmpl-eng-view').style.display = 'none';
        };

        window.showDentistryTemplates = () => {
            document.getElementById('tmpl-main-view').style.display = 'none';
            document.getElementById('tmpl-cs-view').style.display = 'none';
            document.getElementById('tmpl-med-view').style.display = 'none';
            document.getElementById('tmpl-dentistry-view').style.display = 'block';
            document.getElementById('tmpl-eng-view').style.display = 'none';
        };

        window.showEngineeringTemplates = () => {
            document.getElementById('tmpl-main-view').style.display = 'none';
            document.getElementById('tmpl-cs-view').style.display = 'none';
            document.getElementById('tmpl-med-view').style.display = 'none';
            document.getElementById('tmpl-dentistry-view').style.display = 'none';
            document.getElementById('tmpl-eng-view').style.display = 'block';
        };

        window.showMainTemplates = () => {
            document.getElementById('tmpl-main-view').style.display = 'block';
            document.getElementById('tmpl-cs-view').style.display = 'none';
            document.getElementById('tmpl-med-view').style.display = 'none';
            document.getElementById('tmpl-dentistry-view').style.display = 'none';
            document.getElementById('tmpl-eng-view').style.display = 'none';
        };

        window.applyTemplate = async (key) => {
            const chapter = chapters.find(c => c.id === currentId);
            if (!chapter) return;

            // iPad Fix: Templates updated to use new structure
            const temps = {
                default: { title: "New Note", content: "<div>Start typing...</div>", isWhiteboard: false, type: PAGE_TYPES.NOTE },
                meeting: { title: "Meeting: " + new Date().toLocaleDateString(), content: "<h2 class='styled-header'>Participants</h2><p>‚Ä¢ </p><h2 class='styled-header'>Notes</h2><p></p><h2 class='styled-header'>Action Items</h2>", type: PAGE_TYPES.NOTE },
                journal: { title: "Entry: " + new Date().toLocaleDateString(), content: "<div class='sticky-note'>What happened today?</div>", type: PAGE_TYPES.NOTE },
                project: { title: "Project Tracker", content: "<h2 class='styled-header'>Phase 1</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Milestone</div></div>", type: PAGE_TYPES.PROJECT },
                eisenhower: { 
                    title: "Eisenhower Matrix", 
                    content: "<h2 class='styled-header' style='color:#c0392b'>1. Do First (Urgent & Important)</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Crisis / Deadline</div></div><h2 class='styled-header' style='color:#2980b9'>2. Schedule (Less Urgent, Important)</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Planning / Strategy</div></div><h2 class='styled-header' style='color:#d35400'>3. Delegate (Urgent, Less Important)</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Interruptions / Meetings</div></div><h2 class='styled-header' style='color:#7f8c8d'>4. Don't Do (Not Urgent, Not Important)</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Distractions</div></div>",
                    type: PAGE_TYPES.NOTE
                },
                whiteboard: {
                    title: "Infinite Whiteboard",
                    content: "<div>Start Brainstorming...</div>",
                    isWhiteboard: true,
                    type: PAGE_TYPES.WHITEBOARD
                },
                algo: { title: "Algorithm Analysis", content: "<h2 class='styled-header'>Problem Statement</h2><p>Describe the problem...</p><h2 class='styled-header'>Complexity</h2><span class='algo-badge'>Time: O(n)</span><span class='algo-badge'>Space: O(1)</span><h2 class='styled-header'>Pseudocode</h2><div class='chalk-code'>// Logic here</div>", type: PAGE_TYPES.ALGORITHM },
                sysDesign: { title: "System Design", content: "<h2 class='styled-header'>Requirements</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Scalability</div></div><h2 class='styled-header'>Architecture Diagram</h2><p>(Use Sketch Mode)</p>", isWhiteboard: true, type: PAGE_TYPES.SYSTEM },
                codeStudy: { title: "Code Study", content: "<h2 class='styled-header'>Code Snippet</h2><div class='cs-code-container' contenteditable='false'><div class='cs-code-header'><span>Main.java</span></div><div class='cs-code-editor' contenteditable='true'>public static void main(String[] args) {}</div><div class='cs-code-output' contenteditable='true'>Output...</div></div><h2 class='styled-header'>Trace / Logic</h2><p>Step 1: ...</p>", type: PAGE_TYPES.NOTE },
                
                // MEDICAL TEMPLATES
                anatomy: { title: "Anatomy Sheet", content: "<h2 class='styled-header'>Structure & Function</h2><p>Describe location, origin, insertion...</p><h2 class='styled-header'>Relations</h2><p>Anterior, posterior...</p><h2 class='styled-header'>Clinical Relevance</h2><div class='sticky-note'>Important clinical notes...</div><h2 class='styled-header'>Sketch Area</h2><p>(Draw below)</p>", type: PAGE_TYPES.ANATOMY },
                disease: { title: "Disease Profile", content: "<h2 class='styled-header'>Definition & Etiology</h2><p>...</p><h2 class='styled-header'>Pathophysiology</h2><p>...</p><h2 class='styled-header'>Clinical Features</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Symptom 1</div></div><h2 class='styled-header'>Management</h2><p>...</p>", type: PAGE_TYPES.DISEASE },
                drug: { title: "Drug Monograph", content: "<h2 class='styled-header'>Class & Mechanism</h2><p>...</p><h2 class='styled-header'>Indications</h2><p>...</p><h2 class='styled-header'>Contraindications & Side Effects</h2><div class='sticky-note'>Warning: ...</div><h2 class='styled-header'>Dosage</h2><p>...</p>", type: PAGE_TYPES.DRUG },
                physio: { title: "Physio Case", content: "<h2 class='styled-header'>Patient Profile</h2><p>Age, Gender, Occupation...</p><h2 class='styled-header'>Assessment (SOAP)</h2><p>Subjective: ...</p><p>Objective: ...</p><h2 class='styled-header'>Treatment Plan</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Exercise 1</div></div>", type: PAGE_TYPES.CLINICAL_CASE },
                pathway: { title: "Pathway Breakdown", content: "<h2 class='styled-header'>Overview</h2><p>...</p><h2 class='styled-header'>Steps</h2><div class='chalk-code'>1. Signal -> Receptor</div><h2 class='styled-header'>Regulation</h2><p>...</p>", type: PAGE_TYPES.PATHWAY },
                lab: { title: "Lab Interpretation", content: "<h2 class='styled-header'>Test Name</h2><p>...</p><h2 class='styled-header'>Normal Range</h2><p>...</p><h2 class='styled-header'>Interpretation</h2><p>High: ...</p><p>Low: ...</p>", type: PAGE_TYPES.LAB },

                // DENTISTRY TEMPLATES
                dental_anatomy: { title: "Dental Anatomy", content: "<h2 class='styled-header'>Tooth Name / Number</h2><p>...</p><h2 class='styled-header'>Morphology & Surfaces</h2><p>...</p><h2 class='styled-header'>Root Anatomy</h2><p>...</p><h2 class='styled-header'>Clinical Notes</h2><div class='sticky-note'>Eruption: ...</div>", type: PAGE_TYPES.DENTAL_ANATOMY },
                oral_pathology: { title: "Oral Pathology", content: "<h2 class='styled-header'>Condition</h2><p>...</p><h2 class='styled-header'>Etiology</h2><p>...</p><h2 class='styled-header'>Clinical Appearance</h2><p>...</p><h2 class='styled-header'>Radiographic Features</h2><p>...</p><h2 class='styled-header'>Management</h2><p>...</p>", type: PAGE_TYPES.ORAL_PATHOLOGY },
                dental_procedure: { title: "Dental Procedure", content: "<h2 class='styled-header'>Procedure Name</h2><p>...</p><h2 class='styled-header'>Indications</h2><p>...</p><h2 class='styled-header'>Instruments Required</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Mirror/Probe</div></div><h2 class='styled-header'>Step-by-Step</h2><p>1. Anesthesia...</p>", type: PAGE_TYPES.DENTAL_PROCEDURE },
                dental_case: { title: "Dental Case", content: "<h2 class='styled-header'>Patient Profile</h2><p>...</p><h2 class='styled-header'>Chief Complaint (C/O)</h2><p>...</p><h2 class='styled-header'>Examination (O/E)</h2><p>Intraoral: ...</p><h2 class='styled-header'>Diagnosis & Plan</h2><p>...</p>", type: PAGE_TYPES.DENTAL_CASE },
                prostho_plan: { title: "Prostho Plan", content: "<h2 class='styled-header'>Edentulous Space</h2><p>...</p><h2 class='styled-header'>Abutment Evaluation</h2><p>...</p><h2 class='styled-header'>Design Components</h2><p>Major Connector: ...</p><p>Clasps: ...</p>", type: PAGE_TYPES.PROSTHO_PLAN },
                endo_case: { title: "Endo Case", content: "<h2 class='styled-header'>Tooth & Diagnosis</h2><p>...</p><h2 class='styled-header'>Access & WL</h2><p>Working Length: ...mm</p><h2 class='styled-header'>Instrumentation</h2><p>MAF: ...</p><h2 class='styled-header'>Obturation</h2><p>Technique: ...</p>", type: PAGE_TYPES.ENDO_CASE },
                perio_case: { title: "Perio Charting", content: "<h2 class='styled-header'>Periodontal Status</h2><p>Pockets > 4mm: ...</p><h2 class='styled-header'>Diagnosis</h2><p>Stage: ... Grade: ...</p><h2 class='styled-header'>Treatment Plan</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Scaling & Root Planing</div></div>", type: PAGE_TYPES.PERIO_CASE },
                oral_radiology: { title: "Radiographic Report", content: "<h2 class='styled-header'>Image Type</h2><p>IOPA / OPG / CBCT</p><h2 class='styled-header'>Findings</h2><p>Radio-opacity/lucency: ...</p><h2 class='styled-header'>Interpretation</h2><p>...</p>", type: PAGE_TYPES.ORAL_RADIOLOGY },
                
                // ENGINEERING TEMPLATES
                prob_sol: { title: "Problem Solution", content: "<h2 class='styled-header'>Problem Statement</h2><p>...</p><h2 class='styled-header'>Given & Assumptions</h2><p>...</p><h2 class='styled-header'>Diagram</h2><p>(Use Sketch Mode)</p><h2 class='styled-header'>Governing Equations</h2><p>...</p><h2 class='styled-header'>Solution</h2><p>...</p><h2 class='styled-header'>Final Answer</h2><div class='sticky-note'>Result: ...</div>", type: PAGE_TYPES.PROBLEM_SOLUTION },
                circuit: { title: "Circuit Analysis", content: "<h2 class='styled-header'>Circuit Diagram</h2><p>(Draw Schematic)</p><h2 class='styled-header'>Known Values</h2><p>R1 = ...</p><h2 class='styled-header'>Laws Applied</h2><p>KCL / KVL</p><h2 class='styled-header'>Analysis</h2><p>...</p>", isWhiteboard: true, type: PAGE_TYPES.CIRCUIT_ANALYSIS },
                mech_sys: { title: "Mechanical System", content: "<h2 class='styled-header'>System Description</h2><p>...</p><h2 class='styled-header'>Free Body Diagram</h2><p>(Draw FBD)</p><h2 class='styled-header'>Equations of Motion</h2><p>F = ma...</p><h2 class='styled-header'>Solution</h2><p>...</p>", isWhiteboard: true, type: PAGE_TYPES.MECHANICAL_SYSTEM },
                struct: { title: "Structural Analysis", content: "<h2 class='styled-header'>Structure Description</h2><p>...</p><h2 class='styled-header'>Load Diagram</h2><p>...</p><h2 class='styled-header'>Calculations</h2><p>...</p><h2 class='styled-header'>Design Checks</h2><div class='checklist-item' contenteditable='false'><div class='checkbox-wrapper' contenteditable='false'><div class='checkbox'></div></div><div class='checklist-text' contenteditable='true'>Safety Factor OK</div></div>", type: PAGE_TYPES.STRUCTURAL_ANALYSIS },
                control: { title: "Control System", content: "<h2 class='styled-header'>Block Diagram</h2><p>...</p><h2 class='styled-header'>Transfer Function</h2><p>G(s) = ...</p><h2 class='styled-header'>Stability Analysis</h2><p>...</p>", isWhiteboard: true, type: PAGE_TYPES.CONTROL_SYSTEM },
                process: { title: "Process Flow", content: "<h2 class='styled-header'>Overview</h2><p>...</p><h2 class='styled-header'>Flow Diagram</h2><p>...</p><h2 class='styled-header'>Inputs / Outputs</h2><p>...</p><h2 class='styled-header'>Bottlenecks</h2><p>...</p>", isWhiteboard: true, type: PAGE_TYPES.PROCESS_FLOW },
                lab_exp: { title: "Lab Experiment", content: "<h2 class='styled-header'>Objective</h2><p>...</p><h2 class='styled-header'>Apparatus</h2><p>...</p><h2 class='styled-header'>Procedure</h2><p>1. ...</p><h2 class='styled-header'>Observations</h2><p>...</p><h2 class='styled-header'>Calculations & Conclusion</h2><p>...</p>", type: PAGE_TYPES.LAB_EXPERIMENT },
            };
            
            const selected = temps[key];
            if(selected) {
                document.getElementById('pageTitle').value = selected.title;
                document.getElementById('editor').innerHTML = selected.content;
                
                if (selected.isWhiteboard) {
                    chapter.isWhiteboard = true;
                    document.getElementById('paper').classList.add('infinite');
                } else {
                    chapter.isWhiteboard = false;
                    document.getElementById('paper').classList.remove('infinite');
                }
                
                // Determine Metadata
                let disc = 'general';
                if(['algo', 'codeStudy', 'sysDesign', 'project'].includes(key)) disc = 'cs';
                if(['anatomy', 'disease', 'drug', 'physio', 'pathway', 'lab'].includes(key)) disc = 'medical';
                if(['dental_anatomy', 'oral_pathology', 'dental_procedure', 'dental_case', 'prostho_plan', 'endo_case', 'perio_case', 'oral_radiology'].includes(key)) disc = 'medical'; 
                if(['prob_sol', 'circuit', 'mech_sys', 'struct', 'control', 'process', 'lab_exp'].includes(key)) disc = 'engineering';
                
                chapter.metadata.discipline = disc;
                chapter.metadata.type = selected.type || PAGE_TYPES.NOTE;
                
                // Set default branch for engineering templates to avoid empty state
                if (disc === 'engineering') {
                    if (key === 'circuit' || key === 'control') chapter.metadata.branch = 'Electrical';
                    else if (key === 'mech_sys') chapter.metadata.branch = 'Mechanical';
                    else if (key === 'struct') chapter.metadata.branch = 'Civil';
                    else if (key === 'process') chapter.metadata.branch = 'Industrial';
                    else chapter.metadata.branch = 'General';
                }

                await saveChapterToDB(chapter);
                renderSidebar();
                updateToolVisibility(chapter);
            }
            toggleTemplates();
            resizeCanvas(); 
        };

        window.renderSidebar = () => {
            const list = document.getElementById('chapterList');
            const searchStr = document.getElementById('sidebarSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            list.innerHTML = '';
            
            const filtered = chapters.filter(ch => {
                const matchesSearch = (ch.title || '').toLowerCase().includes(searchStr);
                
                // Smart Filtering based on Discipline or Category
                let matchesCat = true;
                if (categoryFilter !== 'all') {
                    // Map filter values to discipline/category logic
                    if (['Algorithms', 'Systems', 'Projects'].includes(categoryFilter)) {
                        matchesCat = (ch.category === categoryFilter); 
                         if(ch.metadata?.type === PAGE_TYPES.ALGORITHM && categoryFilter === 'Algorithms') matchesCat = true;
                         if(ch.metadata?.type === PAGE_TYPES.SYSTEM && categoryFilter === 'Systems') matchesCat = true;
                         if(ch.metadata?.type === PAGE_TYPES.PROJECT && categoryFilter === 'Projects') matchesCat = true;
                    } else if (['Anatomy', 'Pathology', 'Pharmacology', 'Clinical'].includes(categoryFilter)) {
                        if (ch.metadata?.discipline !== 'medical') return false;
                        if (categoryFilter === 'Anatomy' && ch.metadata?.type !== PAGE_TYPES.ANATOMY) matchesCat = false;
                        if (categoryFilter === 'Pathology' && ch.metadata?.type !== PAGE_TYPES.DISEASE) matchesCat = false;
                        if (categoryFilter === 'Pharmacology' && ch.metadata?.type !== PAGE_TYPES.DRUG) matchesCat = false;
                        if (categoryFilter === 'Clinical' && ![PAGE_TYPES.CLINICAL_CASE, PAGE_TYPES.LAB].includes(ch.metadata?.type)) matchesCat = false;
                    } else if (['Dental Anatomy', 'Procedures', 'Dental Cases'].includes(categoryFilter)) {
                         if (ch.metadata?.discipline !== 'medical') return false; 
                         if (categoryFilter === 'Dental Anatomy' && ch.metadata?.type !== PAGE_TYPES.DENTAL_ANATOMY) matchesCat = false;
                         if (categoryFilter === 'Procedures' && ![PAGE_TYPES.DENTAL_PROCEDURE, PAGE_TYPES.PROSTHO_PLAN].includes(ch.metadata?.type)) matchesCat = false;
                         if (categoryFilter === 'Dental Cases' && ![PAGE_TYPES.DENTAL_CASE, PAGE_TYPES.ENDO_CASE, PAGE_TYPES.PERIO_CASE, PAGE_TYPES.ORAL_RADIOLOGY, PAGE_TYPES.ORAL_PATHOLOGY].includes(ch.metadata?.type)) matchesCat = false;

                    } else if (['Electrical', 'Mechanical', 'Civil', 'Electronics', 'Mechatronics', 'Industrial'].includes(categoryFilter)) {
                        // Engineering Filters
                        if (ch.metadata?.discipline !== 'engineering') return false;
                        if (ch.metadata?.branch !== categoryFilter) matchesCat = false;
                    } else if (categoryFilter === 'General') {
                        matchesCat = ch.metadata?.discipline === 'general';
                    }
                }
                
                return matchesSearch && matchesCat;
            });

            filtered.forEach(ch => {
                const li = document.createElement('li');
                li.className = `nav-item ${ch.id === currentId ? 'active' : ''}`;
                
                const cleanContent = (ch.content || '').replace(/<[^>]*>?/gm, '');
                let snippet = cleanContent.substring(0, 60) + (cleanContent.length > 60 ? '...' : '');
                
                let catBadge = '';
                // Use metadata discipline for badge if available, fallback to category
                const disp = ch.metadata?.discipline || ch.category;
                if(disp && disp !== 'general' && categoryFilter === 'all') {
                     catBadge = `<div class="cat-badge">${disp.toUpperCase()}</div>`;
                }

                li.innerHTML = `
                    <div class="nav-info" onclick="loadChapter('${ch.id}')">
                        <div class="nav-item-title">${ch.title || 'Untitled'}</div>
                        <div class="nav-item-snippet">${snippet}</div>
                        ${catBadge}
                    </div>
                    <button class="btn-delete" onclick="deleteChapter('${ch.id}', event)" title="Delete Page">üóëÔ∏è</button>
                `;
                list.appendChild(li);
            });
        };

        window.toggleDarkMode = () => {
            const isDark = document.body.classList.toggle('dark-mode');
            document.getElementById('darkModeToggle').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        };

        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        };

        // --- MULTI-TOUCH GESTURES (iPad/Tablet) ---
        let gestureMaxFingers = 0;
        let gestureStartTime = 0;
        let gestureIsDrag = false;
        let lastGestureTapTime = 0;
        let lastGestureTapFingers = 0;
        
        // New variables for triple tap detection
        let gestureTapCount = 0;
        let gestureTapTimeout = null;

        window.addEventListener('touchstart', (e) => {
            // FIX: Removed restriction so gestures work everywhere (text & sketch)
            
            // Track maximum fingers touching during this gesture
            if (e.touches.length > gestureMaxFingers) gestureMaxFingers = e.touches.length;
            
            // Reset gesture state on initial touch
            if (e.touches.length === 1) {
                gestureStartTime = Date.now();
                gestureIsDrag = false;
            }
        }, { passive: true });

        window.addEventListener('touchmove', (e) => {
             // If movement occurs, mark as drag to prevent accidental tap detection
             gestureIsDrag = true;
        }, { passive: true });

        window.addEventListener('touchend', (e) => {
            // FIX: Removed restriction so gestures work everywhere (text & sketch)
            
            // Execute logic only when ALL fingers have lifted
            if (e.touches.length === 0) {
                const duration = Date.now() - gestureStartTime;
                
                // Detect Short Tap (ignoring drags)
                if (duration < 300 && !gestureIsDrag) {
                    const now = Date.now();
                    const timeBetweenTaps = now - lastGestureTapTime;

                    // Check for sequential taps (Time between taps < 500ms, same finger count)
                    if (timeBetweenTaps < 500 && timeBetweenTaps > 50 && lastGestureTapFingers === gestureMaxFingers) {
                        gestureTapCount++;
                    } else {
                        gestureTapCount = 1;
                    }
                    
                    lastGestureTapTime = now;
                    lastGestureTapFingers = gestureMaxFingers;

                    // 2 FINGERS GESTURES
                    if (gestureMaxFingers === 2) {
                        if (gestureTapCount === 2) {
                            // Double Tap detected - Schedule Undo (wait for potential 3rd tap)
                            clearTimeout(gestureTapTimeout);
                            gestureTapTimeout = setTimeout(() => {
                                if (isSketchMode) undoSketch();
                                else document.execCommand('undo'); // Native Text Undo
                                showToast("Undo ‚Ü©Ô∏è");
                                gestureTapCount = 0; // Reset
                            }, 400); // 400ms window for triple tap
                        } 
                        else if (gestureTapCount === 3) {
                            // Triple Tap detected - Cancel pending Undo and trigger Redo
                            clearTimeout(gestureTapTimeout);
                            if (isSketchMode) redoSketch();
                            else document.execCommand('redo'); // Native Text Redo
                            showToast("Redo ‚Ü™Ô∏è");
                            gestureTapCount = 0; // Reset
                        }
                    }
                }
                
                // Reset gesture tracking
                gestureMaxFingers = 0;
                gestureIsDrag = false;
            }
        });

        initApp();
        setTimeout(resizeCanvas, 500);
    </script>
</body>
</html>